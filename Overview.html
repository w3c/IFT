<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <title>Incremental Font Transfer</title>
  <meta content="ED" name="w3c-status">
  <link href="https://www.w3.org/StyleSheets/TR/2021/W3C-ED" rel="stylesheet">
  <meta content="Bikeshed version d765c696b, updated Fri Mar 8 15:58:52 2024 -0800" name="generator">
  <link href="https://www.w3.org/TR/IFT/" rel="canonical">
  <meta content="523614cfa0c29f8669c96577ceba32e113159b63" name="revision">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>
.conform:hover {background: #31668f; color: white}
.conform:target {padding: 2px; border: 2px solid #AAA; background: #31668f; color: white }

table {
  width: 100%;
}

table, tr {
  border: 1px solid #aaa;
  border-collapse: collapse;
}

th, td {
  padding: 0.5rem;
}
</style>
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-var-click-highlighting */
/*
Colors were chosen in Lab using https://nixsensor.com/free-color-converter/
D50 2deg illuminant, L in [0,100], a and b in [-128, 128]
0 = lab(85,0,85)
1 = lab(85,80,30)
2 = lab(85,-40,40)
3 = lab(85,-50,0)
4 = lab(85,5,15)
5 = lab(85,-10,-50)
6 = lab(85,35,-15)
*/
[data-algorithm] var { cursor: pointer; }
var[data-var-color="0"] { background-color: #F4D200; box-shadow: 0 0 0 2px #F4D200; }
var[data-var-color="1"] { background-color: #FF87A2; box-shadow: 0 0 0 2px #FF87A2; }
var[data-var-color="2"] { background-color: #96E885; box-shadow: 0 0 0 2px #96E885; }
var[data-var-color="3"] { background-color: #3EEED2; box-shadow: 0 0 0 2px #3EEED2; }
var[data-var-color="4"] { background-color: #EACFB6; box-shadow: 0 0 0 2px #EACFB6; }
var[data-var-color="5"] { background-color: #82DDFF; box-shadow: 0 0 0 2px #82DDFF; }
var[data-var-color="6"] { background-color: #FFBCF2; box-shadow: 0 0 0 2px #FFBCF2; }
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">Incremental Font Transfer</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#ED">Editor’s Draft</a>, <time class="dt-updated" datetime="2024-04-26">26 April 2024</time></p>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://w3c.github.io/IFT/Overview.html">https://w3c.github.io/IFT/Overview.html</a>
     <dt>Latest published version:
     <dd><a href="https://www.w3.org/TR/IFT/">https://www.w3.org/TR/IFT/</a>
     <dt>Feedback:
     <dd><span><a href="mailto:public-webfonts-wg@w3.org?subject=%5BIFT%5D%20YOUR%20TOPIC%20HERE">public-webfonts-wg@w3.org</a> with subject line “<kbd>[IFT] <i data-lt>… message topic …</i></kbd>” (<a href="https://lists.w3.org/Archives/Public/public-webfonts-wg/" rel="discussion">archives</a>)</span>
     <dd><a href="https://github.com/w3c/PFE/issues/">GitHub</a>
     <dt class="editor">Editors:
     <dd class="editor p-author h-card vcard" data-editor-id="1438"><a class="p-name fn u-url url" href="https://svgees.us/">Chris Lilley</a> (<span class="p-org org">W3C</span>)
     <dd class="editor p-author h-card vcard" data-editor-id="73905"><a class="p-name fn u-email email" href="mailto:grieger@google.com">Garret Rieger</a> (<span class="p-org org">Google Inc.</span>)
     <dd class="editor p-author h-card vcard" data-editor-id="137857"><a class="p-name fn u-email email" href="mailto:siterum@adobe.com">Skef Iterum</a> (<span class="p-org org">Adobe Inc.</span>)
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 2024 <a href="https://www.w3.org/">World Wide Web Consortium</a>. <abbr title="World Wide Web Consortium">W3C</abbr><sup>®</sup> <a href="https://www.w3.org/policies/#Legal_Disclaimer">liability</a>, <a href="https://www.w3.org/policies/#W3C_Trademarks">trademark</a> and <a href="https://www.w3.org/copyright/software-license/" rel="license" title="W3C Software and Document License">permissive document license</a> rules apply. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>This specification defines a method to incrementally transfer fonts from server to client.
Incremental transfer allows clients to load only the portions of the font they actually need
which speeds up font loads and reduces data transfer needed to load the fonts. A font can
be loaded over multiple requests where each request incrementally adds additional data.</p>
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="sotd"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This is a public copy of the editors’ draft.
	It is provided for discussion only and may change at any moment.
	Its publication here does not imply endorsement of its contents by W3C.
	Don’t cite this document other than as work in progress. </p>
   <p> If you wish to make comments regarding this document, please <a href="https://github.com/w3c/PFE/issues/new">file an issue on the specification repository</a>. </p>
   <p> This document was produced by the <a href="https://www.w3.org/groups/wg/webfonts">Web Fonts Working Group</a> </p>
   <p> This document was produced by groups operating under
  the <a href="https://www.w3.org/Consortium/Patent-Policy-20200915/">W3C Patent Policy</a>.
  W3C maintains a <a href="https://www.w3.org/groups/wg/webfonts/ipr" rel="disclosure">public list of any patent disclosures</a> made in connection with the deliverables of the group;
  that page also includes instructions for disclosing a patent.
  An individual who has actual knowledge of a patent which the individual believes contains <a href="https://www.w3.org/Consortium/Patent-Policy-20200915/#def-essential">Essential Claim(s)</a> must disclose the information in accordance with <a href="https://www.w3.org/Consortium/Patent-Policy-20200915/#sec-Disclosure">section 6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>. </p>
   <p> This document is governed by the <a href="https://www.w3.org/2023/Process-20231103/" id="w3c_process_revision">03 November 2023 W3C Process Document</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li>
     <a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
     <ol class="toc">
      <li><a href="#evaluation-report"><span class="secno">1.1</span> <span class="content">Technical Motivation: Evaluation Report</span></a>
      <li><a href="#overview"><span class="secno">1.2</span> <span class="content">Overview</span></a>
      <li><a href="#making-incremental-fonts"><span class="secno">1.3</span> <span class="content">Creating an Incremental Font</span></a>
      <li>
       <a href="#performance-considerations"><span class="secno">1.4</span> <span class="content">Performance Considerations and the use of Incremental Font Transfer</span></a>
       <ol class="toc">
        <li><a href="#reduce-requests"><span class="secno">1.4.1</span> <span class="content">Reducing the Number of Network Requests</span></a>
       </ol>
     </ol>
    <li>
     <a href="#opt-in"><span class="secno">2</span> <span class="content">Opt-In Mechanism</span></a>
     <ol class="toc">
      <li><a href="#offline-usage"><span class="secno">2.1</span> <span class="content">Offline Usage</span></a>
     </ol>
    <li>
     <a href="#definitions"><span class="secno">3</span> <span class="content">Definitions</span></a>
     <ol class="toc">
      <li><a href="#font-subset-info"><span class="secno">3.1</span> <span class="content">Font Subset</span></a>
      <li><a href="#data-types"><span class="secno">3.2</span> <span class="content">Data Types</span></a>
      <li><a href="#uri-templates"><span class="secno">3.3</span> <span class="content">URI Templates</span></a>
     </ol>
    <li>
     <a href="#font-format-extensions"><span class="secno">4</span> <span class="content">Extensions to the Font Format</span></a>
     <ol class="toc">
      <li><a href="#ift-and-woff2"><span class="secno">4.1</span> <span class="content">Incremental Font Transfer and WOFF2</span></a>
      <li>
       <a href="#patch-map"><span class="secno">4.2</span> <span class="content">Patch Map Table</span></a>
       <ol class="toc">
        <li>
         <a href="#patch-map-format-1"><span class="secno">4.2.1</span> <span class="content">Patch Map Table: Format 1</span></a>
         <ol class="toc">
          <li><a href="#interpreting-patch-map-format-1"><span class="secno">4.2.1.1</span> <span class="content">Interpreting Format 1</span></a>
         </ol>
        <li>
         <a href="#patch-map-format-2"><span class="secno">4.2.2</span> <span class="content">Patch Map Table: Format 2</span></a>
         <ol class="toc">
          <li><a href="#interpreting-patch-map-format-2"><span class="secno">4.2.2.1</span> <span class="content">Interpreting Format 2</span></a>
          <li><a href="#sparse-bit-set-decoding"><span class="secno">4.2.2.2</span> <span class="content">Sparse Bit Set</span></a>
         </ol>
       </ol>
     </ol>
    <li>
     <a href="#font-patch-formats"><span class="secno">5</span> <span class="content">Font Patch Formats</span></a>
     <ol class="toc">
      <li><a href="#font-patch-definitions"><span class="secno">5.1</span> <span class="content">Definitions</span></a>
      <li><a href="#font-patch-invalidations"><span class="secno">5.2</span> <span class="content">Patch Invalidations</span></a>
      <li><a href="#font-patch-formats-summary"><span class="secno">5.3</span> <span class="content">Formats Summary</span></a>
      <li>
       <a href="#brotli"><span class="secno">5.4</span> <span class="content">Brotli Patch</span></a>
       <ol class="toc">
        <li><a href="#apply-brotli"><span class="secno">5.4.1</span> <span class="content">Applying Brotli Patches</span></a>
       </ol>
      <li>
       <a href="#per-table-brotli"><span class="secno">5.5</span> <span class="content">Per Table Brotli</span></a>
       <ol class="toc">
        <li><a href="#apply-per-table-brotli"><span class="secno">5.5.1</span> <span class="content">Applying Per Table Brotli Patches</span></a>
       </ol>
      <li>
       <a href="#glyph-keyed"><span class="secno">5.6</span> <span class="content">Glyph Keyed</span></a>
       <ol class="toc">
        <li><a href="#apply-glyph-keyed"><span class="secno">5.6.1</span> <span class="content">Applying Glyph Keyed Patches</span></a>
       </ol>
     </ol>
    <li>
     <a href="#extending-font-subset"><span class="secno">6</span> <span class="content">Extending a Font Subset</span></a>
     <ol class="toc">
      <li><a href="#fully-expanding-a-font"><span class="secno">6.1</span> <span class="content">Fully Expanding a Font</span></a>
     </ol>
    <li>
     <a href="#encoder"><span class="secno">7</span> <span class="content">Encoder</span></a>
     <ol class="toc">
      <li><a href="#encoder-considerations"><span class="secno">7.1</span> <span class="content">Encoder Considerations</span></a>
     </ol>
    <li><a href="#priv"><span class="secno"></span> <span class="content">Privacy Considerations</span></a>
    <li><a href="#sec"><span class="secno"></span> <span class="content">Security Considerations</span></a>
    <li><a href="#changes"><span class="secno"></span> <span class="content">Changes</span></a>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
      <li><a href="#w3c-conformant-algorithms"><span class="secno"></span> <span class="content">Conformant Algorithms</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
   <p><em>This section is not normative.</em></p>
   <p>Incremental Font Transfer (IFT) is a technology to improve the latency of remote fonts (or "web fonts") on
the web. Without this technology, a browser needs to download every last byte of a font before it can render
any characters using that font. IFT allows the browser to download only some of the bytes in the file, thereby
decreasing the perceived latency between the time when a browser realizes it needs a font and when the
necessary text can be rendered with that font. Unlike traditional font subsetting approaches Incremental Font Transfer
retains the encoding of layout rules between segments (<a href="https://www.w3.org/TR/PFE-evaluation/#fail-subset">Progressive Font Enrichment: Evaluation Report § fail-subset</a>).</p>
   <p>The success of WebFonts is unevenly distributed. This specification allows WebFonts to be used where
slow networks, very large fonts, or complex subsetting requirements currently preclude their use. For
example, even using WOFF 2 <a data-link-type="biblio" href="#biblio-woff2" title="WOFF File Format 2.0">[WOFF2]</a>, fonts for CJK languages can be too large to be practical.</p>
   <h3 class="heading settled" data-level="1.1" id="evaluation-report"><span class="secno">1.1. </span><span class="content">Technical Motivation: Evaluation Report</span><a class="self-link" href="#evaluation-report"></a></h3>
   <p>See the Progressive Font Enrichment: Evaluation Report <a data-link-type="biblio" href="#biblio-pfe-report" title="Progressive Font Enrichment: Evaluation Report">[PFE-report]</a> for the investigation which led
to this specification.</p>
   <h3 class="heading settled" data-level="1.2" id="overview"><span class="secno">1.2. </span><span class="content">Overview</span><a class="self-link" href="#overview"></a></h3>
   <p>An IFT font is a regular <a data-link-type="biblio" href="#biblio-open-type" title="OpenType Specification">OpenType</a> font that is reformated to include incremental functionality, partly in virtue of
of two additional <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">tables</a>. Using these new tables the font can be augmented (eg. to cover more codepoints)
by loading and applying patches to it.</p>
   <p>The IFT technology has four main pieces:</p>
   <ul>
    <li data-md>
     <p><a href="#font-format-extensions">§ 4 Extensions to the Font Format</a>: defines the new tables which contain a list of patches that are available to be applied to a font.</p>
    <li data-md>
     <p><a href="#font-patch-formats">§ 5 Font Patch Formats</a>: defines three different types of patches that can be used. Two are "generic" binary patches, one is
 specific to the font’s format for storing glyph data.</p>
    <li data-md>
     <p><a href="#extending-font-subset">§ 6 Extending a Font Subset</a>: provides the algorithm that is used by a client to select and apply patches.</p>
    <li data-md>
     <p><a href="#encoder">§ 7 Encoder</a>: creates the font and associated patches that form an incremental font.</p>
   </ul>
   <p>At a high level an IFT font is used like this:</p>
   <ol>
    <li data-md>
     <p>The client downloads an initial font file, which contains some initial subset of data from the full version of the font along with <a href="#font-format-extensions">embedded data</a> describing the set of <a href="#font-patch-formats">patches</a> which can be used to extend 
the font.</p>
    <li data-md>
     <p>Based on the content to be rendered, the client <a href="#extending-font-subset">selects, downloads, and applies</a> patches to extend
the font to cover additional characters, layout features, and/or variation space. This step is repeated each time there is new
content.</p>
   </ol>
   <h3 class="heading settled" data-level="1.3" id="making-incremental-fonts"><span class="secno">1.3. </span><span class="content">Creating an Incremental Font</span><a class="self-link" href="#making-incremental-fonts"></a></h3>
   <p>It is expected that the most common way to produce an incremental font will be to convert an existing font to use the incremental
encoding defined in this specification. At a high level converting an existing font to be incremental will look like this:</p>
   <ol>
    <li data-md>
     <p>Choose the content of the initial <a href="#font-subset-info">subset</a>, this will be included in the initial font file the client loads
and usually consists of any data from the original font that is expected to always be needed.</p>
    <li data-md>
     <p>Choose a segmentation of the font. Individual segments will be added to the base subset by the client using patches. Choosing an
appropriate segmentation is one of the most important parts of producing an efficient encoding.</p>
    <li data-md>
     <p>Based on these choices, generate a set of patches, where each patch adds the data for a particular segment relative to either
the initial font file or a previous patch.</p>
    <li data-md>
     <p>Generate the initial font file including the initial subset and a <a href="#font-format-extensions">patch mapping</a>. This mapping
lists all of the available patch files, the url they reside at, and information on what data the patch will add to the font.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> this is a highly simplified description of creating an incremental font, a more in-depth discussion of generating an encoding and
requirements on the encoding can be found in the <a href="#encoder">§ 7 Encoder</a> section.</p>
   <h3 class="heading settled" data-level="1.4" id="performance-considerations"><span class="secno">1.4. </span><span class="content">Performance Considerations and the use of Incremental Font Transfer</span><a class="self-link" href="#performance-considerations"></a></h3>
   <p>Using incremental transfer may not always be beneficial, depending on the characteristics of the font,
the network, and the content being rendered. This section provides non-normative guidance to help decide
when incremental transfer should be utilized.</p>
   <p>It is common for an incremental font to trigger the loading of multiple patches in parallel. So to maximize performance, when
serving an incremental font it is recommended that an HTTP server which is capable of multiplexing (such as <a data-link-type="biblio" href="#biblio-rfc9113" title="HTTP/2">[rfc9113]</a> or <a data-link-type="biblio" href="#biblio-rfc9114" title="HTTP/3">[rfc9114]</a>)
is used.</p>
   <p>Incrementally loading a font has a fundamental performance trade off versus loading the whole font.
Simplistically, under incremental transfer less bytes may be transferred at the potential cost of
increasing the total number of network requests being made, and/or increased request processing
latency. In general incremental font transfer will be beneficial where the reduction in latency from
sending less bytes outweighs additional latency introduced by the incremental transfer method.</p>
   <p>The first factor to consider is the language of the content being rendered. The evaluation report
contains the results of simulating incremental font transfer across three categories of languages
(<a href="https://www.w3.org/TR/PFE-evaluation/#langtype">Progressive Font Enrichment: Evaluation Report § langtype</a>). See it’s conclusions <a href="https://www.w3.org/TR/PFE-evaluation/#conclusions">Progressive Font Enrichment: Evaluation Report § conclusions</a> for a discussion of the
anticipated performance of incremental font transfer across the language categories.</p>
   <p>Next, how much of the font is expected to be needed? If it’s expected that most of the font will be
needed to render the content, then incremental font transfer is unlikely to be beneficial. In many cases
however only part of a font is expected to be needed. For example:</p>
   <ul>
    <li data-md>
     <p>If the font contains support for several languages but a user is expected to only render content
in a subset of those languages.</p>
    <li data-md>
     <p>If the content being rendered uses a small subset of the total characters in a font. This is
often the case for Chinese, Japanese, Korean, Emoji, and Icon fonts.</p>
    <li data-md>
     <p>Only a small amount of text is being rendered. For example a font that is only used for a
headline.</p>
   </ul>
   <p>An alternative to incremental transfer is to break a font into distinct subsets (typically by script)
and use the unicode range feature of @font-face to load only the subsets needed. However, this can alter
the rendering of some content <a href="https://www.w3.org/TR/PFE-evaluation/#fail-subset">Progressive Font Enrichment: Evaluation Report § fail-subset</a> if there are layout rules between characters in
different subsets. Incremental font transfer does not suffer from this issue as it can emcompass the
original font and all of it’s layout rules.</p>
   <h4 class="heading settled" data-level="1.4.1" id="reduce-requests"><span class="secno">1.4.1. </span><span class="content">Reducing the Number of Network Requests</span><a class="self-link" href="#reduce-requests"></a></h4>
   <p>As discussed in the previous section the most basic implementation of incremental font transfer will
tend to increase the total number of requests made vs traditional font loading. Since each augmentation
will typically require at least one round trip time, performance can be negatively impacted if too many requests
are made. Depending on which patch types are available and how much information is provided in the <a href="#font-format-extensions">patch mapping</a>, a client might preemptively request patches for codepoints that are not
currently needed, but expected to be needed in the future. Intelligent use of this feature by an
implementation can help reduce the total number of requests being made. The evaluation report explored
this by testing the performance of a basic character frequency based <a href="https://www.w3.org/TR/PFE-evaluation/#codepredict">codepoint prediction</a> scheme and found it improved overall performance.</p>
   <h2 class="heading settled" data-level="2" id="opt-in"><span class="secno">2. </span><span class="content">Opt-In Mechanism</span><a class="self-link" href="#opt-in"></a></h2>
   <p>Web pages can choose to opt-in to incremental transfer for a font via the use of a CSS font tech
keyword (<a href="https://drafts.csswg.org/css-fonts-4/#font-tech-definitions"><cite>CSS Fonts 4</cite> § 11.1 Font tech</a>) inside the ''@font-face'' block. The keyword <code>incremental</code> is used to indicate the referenced font contains IFT data and should
only be loaded by a user agent which supports incremental font transfer.</p>
   <div class="example" id="example-d6868efb">
    <a class="self-link" href="#example-d6868efb"></a> 
<pre>@font-face {
    font-family: "MyCoolWebFont";
    src: url("MyCoolWebFont.otf") tech(incremental);
}
</pre>
   </div>
   <p class="note" role="note"><span class="marker">Note:</span> Each individual <code>@font-face</code> block may or may not opt-in to IFT. This is due to the
variety of ways fonts are used on web pages. Authors have control over which fonts they want to use
this technology with, and which they do not.</p>
   <p class="note" role="note"><span class="marker">Note:</span> the IFT tech keyword can be used in conjunction with other font tech specifiers to perform
font feature selection. For example a <code>@font-face</code> could include two URIs one with <code>tech(incremental, color-COLRv1)</code> and the other with <code>tech(incremental, color-COLRv0)</code>.</p>
   <h3 class="heading settled" data-level="2.1" id="offline-usage"><span class="secno">2.1. </span><span class="content">Offline Usage</span><a class="self-link" href="#offline-usage"></a></h3>
   <p>Special consideration must be taken when saving a page for offline usage that uses an incrementally
transferred font since the saved page won’t be able to increment the font if content changes (eg.
due to JavaScript execution). In these cases the page saving mechanism should fully expand the incremental font
by invoking <a data-link-type="abstract-op" href="#abstract-opdef-fully-expand-a-font-subset" id="ref-for-abstract-opdef-fully-expand-a-font-subset">Fully Expand a Font Subset</a> and replace references to the incremental font with the fully expanded one.</p>
   <h2 class="heading settled" data-level="3" id="definitions"><span class="secno">3. </span><span class="content">Definitions</span><a class="self-link" href="#definitions"></a></h2>
   <h3 class="heading settled" data-level="3.1" id="font-subset-info"><span class="secno">3.1. </span><span class="content">Font Subset</span><a class="self-link" href="#font-subset-info"></a></h3>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="font-subset">font subset</dfn> is a modified version of a font file <a data-link-type="biblio" href="#biblio-iso14496-22" title="Information technology — Coding of audio-visual objects — Part 22: Open Font Format">[iso14496-22]</a> that contains only the data
needed to render a subset of:</p>
   <ul>
    <li data-md>
     <p>the codepoints,</p>
    <li data-md>
     <p><a href="https://docs.microsoft.com/en-us/typography/opentype/spec/featuretags#">layout features</a>,</p>
    <li data-md>
     <p>and <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otvaroverview#terminology">design-variation space</a>.</p>
   </ul>
   <p>supported by the original font. When a subsetted font is used to render text using any combination of the subset
codepoints, <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/featuretags#">layout features</a>, or <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otvaroverview#terminology">design-variation space</a> it should render identically to the original font. This includes rendering with the use of any optional typographic
features that a renderer may choose to use from the original font, such as hinting instructions. Design variation spaces
are specified using the user-axis scales (<a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otvaroverview#coordinate-scales-and-normalization">OpenType Specification § otvaroverview#coordinate-scales-and-normalization</a>).</p>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="font-subset-definition">font subset definition</dfn> describes the minimum data (codepoints, layout features,
variation axis space) that a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset">font subset</a> should support.</p>
   <p class="note" role="note"><span class="marker">Note:</span> For convenience the remainder of this document links to the <a data-link-type="biblio" href="#biblio-open-type" title="OpenType Specification">[open-type]</a> specification which is a copy of <a data-link-type="biblio" href="#biblio-iso14496-22" title="Information technology — Coding of audio-visual objects — Part 22: Open Font Format">[iso14496-22]</a>.</p>
   <h3 class="heading settled" data-level="3.2" id="data-types"><span class="secno">3.2. </span><span class="content">Data Types</span><a class="self-link" href="#data-types"></a></h3>
   <p>Encoded data structures in the remainder of this specification are described in terms of the data types defined
in <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#data-types">OpenType Specification § otff#data-types</a>. As with the rest of OpenType, all fields use "big-endian" byte ordering.</p>
   <h3 class="heading settled" data-level="3.3" id="uri-templates"><span class="secno">3.3. </span><span class="content">URI Templates</span><a class="self-link" href="#uri-templates"></a></h3>
   <p>URI templates <a data-link-type="biblio" href="#biblio-rfc6570" title="URI Template">[rfc6570]</a> are used to convert numeric or string IDs into URIs where patch files are located.
A string ID is a sequence of <a data-link-type="biblio" href="#biblio-unicode" title="The Unicode Standard">Unicode</a> code point values obtained from decoding a <a data-link-type="biblio" href="#biblio-utf-8" title="UTF-8, a transformation format of ISO 10646">[UTF-8]</a> string (see <a href="https://www.rfc-editor.org/rfc/rfc6570#section-1.6">URI Template § section-1.6</a>). Several variables are defined which are used to produce the
expansion of the template:</p>
   <table>
    <tbody>
     <tr>
      <th>Variable
      <th>Value
     <tr>
      <td>id
      <td> If the input id is numeric then this is the  numeric value converted to a string in hexadecimal representation
      (using the digits 0-9, A-F). No padding with 0’s is used. Otherwise, this is the string id value. 
     <tr>
      <td>d1
      <td> The last character of the string in the id variable.
      If id variable is empty then, the value is the character 0 (U+0030). 
     <tr>
      <td>d2
      <td> The second last character of the string in the id variable.
      If the id variable has less than 2 characters then, the value is the character 0 (U+0030). 
     <tr>
      <td>d3
      <td> The third last character of the string in the id variable.
      If the id variable has less than 3 characters then, the value is the character 0 (U+0030). 
     <tr>
      <td>d4
      <td> The fourth last character of the string in the id variable.
      If the id variable has less than 4 characters then, the value is the character 0 (U+0030). 
   </table>
   <p>The variables d1 through d4 select a specific character of the id variable. In this context a character is a <a data-link-type="biblio" href="#biblio-unicode" title="The Unicode Standard">[unicode]</a> code point.
If the code point is not an ASCII code point then during expansion it will need to be converted to <a data-link-type="biblio" href="#biblio-utf-8" title="UTF-8, a transformation format of ISO 10646">[UTF-8]</a> and percent encoded as required by <a href="https://www.rfc-editor.org/rfc/rfc6570#section-1.6">URI Template § section-1.6</a>.</p>
   <div class="example" id="example-096f0d2d">
    <a class="self-link" href="#example-096f0d2d"></a> 
    <p>Some example inputs and the corresponding expansions:</p>
    <table>
     <tbody>
      <tr>
       <th>Template
       <th>Input ID
       <th>Expansion
      <tr>
       <td>//foo.bar/{id}
       <td>123
       <td>//foo.bar/7B
      <tr>
       <td>//foo.bar{/d1,d2,id}
       <td>123
       <td>//foo.bar/B/7/7B
      <tr>
       <td>//foo.bar{/d1,d2,d3,id}
       <td>123
       <td>//foo.bar/B/7/0/7B
      <tr>
       <td>//foo.bar{/d1,d2,d3,id}
       <td>baz
       <td>//foo.bar/z/a/b/baz
      <tr>
       <td>//foo.bar{/d1,d2,d3,id}
       <td>az
       <td>//foo.bar/z/a/0/az
      <tr>
       <td>//foo.bar{/d1,d2,d3,id}
       <td>àbc
       <td>//foo.bar/c/b/%C3%A0/%C3%A0bc
    </table>
   </div>
   <h2 class="heading settled" data-level="4" id="font-format-extensions"><span class="secno">4. </span><span class="content">Extensions to the Font Format</span><a class="self-link" href="#font-format-extensions"></a></h2>
   <p>An <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="incremental-font">incremental font</dfn> follows the existing <a data-link-type="biblio" href="#biblio-open-type" title="OpenType Specification">OpenType</a> format, but includes two new <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">tables</a> identified by the 4-byte tags 'IFT ' and 'IFTX'. These new tables are both <a href="#patch-map">patch maps</a>, which encode a collection of mappings from <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition">font subset definitions</a> to URIs which
host <a href="#font-patch-formats">patches</a> that extend the incremental font. All incremental fonts must contain the 'IFT ' table.
The 'IFTX' table is optional. When both tables are present, the mapping of the font as a whole is the union of the mappings of
the two tables. The two new tables are used only in this specification and are not being added to the <a data-link-type="biblio" href="#biblio-open-type" title="OpenType Specification">Open-Type</a> specification.</p>
   <p class="note" role="note"><span class="marker">Note:</span> allowing the mapping to be split between two distinct tables allows an incremental font to more easily make use of multiple
patch types. For example all patches of one type can be specified in the 'IFT ' table, and all patches of a second type in the
'IFTX' table. Those patches can make updates only to one of the mapping tables and avoid making conflicting updates.</p>
   <h3 class="heading settled" data-level="4.1" id="ift-and-woff2"><span class="secno">4.1. </span><span class="content">Incremental Font Transfer and WOFF2</span><a class="self-link" href="#ift-and-woff2"></a></h3>
   <p><a data-link-type="biblio" href="#biblio-woff2" title="WOFF File Format 2.0">[WOFF2]</a> is a commonly used to encode fonts for transfer on the web. Incremental fonts can be encoded with WOFF2 as long as special care
is taken. If an incremental font will be encoded by WOFF2 for transfer:</p>
   <ol>
    <li data-md>
     <p>The incremental font should not make use of <a href="#brotli">§ 5.4 Brotli Patch</a> patches. The WOFF2 format does not guarantee the ordering of tables in
 the decoded font. <a href="#brotli">§ 5.4 Brotli Patch</a> patches are relative to a specific fixed set of bytes and thus cannot be used if the decoded font
 has unpredictable decoded bytes. <a href="#per-table-brotli">§ 5.5 Per Table Brotli</a> patches do not depend on a specific table ordering and may be used.</p>
    <li data-md>
     <p>If the WOFF2 encoding will include a transformed glyf and loca table (<a href="https://w3c.github.io/woff/woff2/#glyf_table_format"><cite>WOFF 2.0</cite> § 5.1 Transformed glyf table format</a>) then, the incremental
 font should not contain <a href="#per-table-brotli">§ 5.5 Per Table Brotli</a> patches which modify either the glyf or loca table. The WOFF2 format does not
 guarantee the specific bytes that result from decoding a transformed glyf and loca table, so as with #1 brotli patches cannot
 be used. <a href="#glyph-keyed">§ 5.6 Glyph Keyed</a> patches may be used in conjunction with a transformed glyf and loca table.</p>
    <li data-md>
     <p>When utilizing a WOFF2 encoded IFT font, the client must first fully decode the WOFF2 font before <a href="#extending-font-subset">§ 6 Extending a Font Subset</a>.</p>
   </ol>
   <p>The 'IFT ' and 'IFTX' tables can be processed and brotli encoded by a WOFF2 encoder following the standard process defined in <a href="https://w3c.github.io/woff/woff2/#table_format"><cite>WOFF 2.0</cite> § 5 Compressed data format</a>.</p>
   <h3 class="heading settled" data-level="4.2" id="patch-map"><span class="secno">4.2. </span><span class="content">Patch Map Table</span><a class="self-link" href="#patch-map"></a></h3>
   <p>A patch map table encodes a list of <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="patch-map-entries">patch map entries</dfn>, where each entry has a key and value. The key is a <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition①">font subset definition</a> and the value is a URI, the <a href="#font-patch-formats">§ 5 Font Patch Formats</a> used by the data at the URI, and the unique ID
of the patch map table. A map is encoded in one of two formats:</p>
   <ul>
    <li data-md>
     <p>Format 1: a limited, but more compact encoding. It encodes a one-to-one mapping from glyph id to patch URIs. It does
not support <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition②">font subset definitions</a> with design space or entries with overlapping subset definitions.</p>
    <li data-md>
     <p>Format 2: can encode arbitrary mappings including ones with design space or overlapping subset definitions. However, it
is typically less compact than format 1.</p>
   </ul>
   <h4 class="heading settled" data-level="4.2.1" id="patch-map-format-1"><span class="secno">4.2.1. </span><span class="content">Patch Map Table: Format 1</span><a class="self-link" href="#patch-map-format-1"></a></h4>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="format-1-patch-map">Format 1 Patch Map</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-format">format</dfn>
      <td>Set to 1, identifies this as format 1.
     <tr>
      <td>uint32
      <td>reserved
      <td>Not used, set to 0.
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-id">id</dfn>[4]
      <td>Unique ID used to identify patches that are compatible with this font.
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-entrycount">entryCount</dfn>
      <td>Number of entries encoded in this table.
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-glyphcount">glyphCount</dfn>
      <td>Number of glyphs that mappings are provided for. Must match the numGlyphs field from <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/maxp#">maxp</a>.
     <tr>
      <td>Offset32
      <td>glyphMapOffset
      <td>Offset to a <a data-link-type="dfn" href="#glyph-map" id="ref-for-glyph-map">Glyph Map</a> sub table. Offset is from the start of this table.
     <tr>
      <td>Offset32
      <td>featureMapOffset
      <td>Offset to a <a data-link-type="dfn" href="#feature-map" id="ref-for-feature-map">Feature Map</a> sub table. Offset is from the start of this table.
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-appliedentriesbitmap">appliedEntriesBitMap</dfn>[(entryCount + 7)/8]
      <td> A bit map which tracks which entries have been applied. If bit <code>i</code> is set that indicates the patch for entry <code>i</code> has been applied to this font. Bit 0 is the least significant bit of appliedEntriesBitMap[0], while bit 7 is
      the most significant bit. Bit 8 is the least significant bit of appliedEntriesBitMap[1] and so on. 
     <tr>
      <td>uint16
      <td>uriTemplateLength
      <td> Length of the uriTemplate string. 
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-uritemplate">uriTemplate</dfn>[uriTemplateLength]
      <td> A <a data-link-type="biblio" href="#biblio-utf-8" title="UTF-8, a transformation format of ISO 10646">[UTF-8]</a> encoded string. Contains a <a href="#uri-templates">§ 3.3 URI Templates</a> which is used to produce URIs associated with each entry. 
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-patchencoding">patchEncoding</dfn>
      <td> Specifies the format of the patches linked to by uriTemplate. Using the ID number from the <a href="#font-patch-formats-summary">§ 5.3 Formats Summary</a> table. 
   </table>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="glyph-map">Glyph Map</dfn> encoding:</p>
   <p>A glyph map table associates each glyph index in the font with an entry index.</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint16
      <td><dfn class="dfn-paneled" data-dfn-for="Glyph Map" data-dfn-type="dfn" data-noexport id="glyph-map-firstmappedglyph">firstMappedGlyph</dfn>
      <td>All glyph indices less than firstMappedGlyph are implicitly mapped to entry index 0.
     <tr>
      <td>uint8/uint16
      <td><dfn class="dfn-paneled" data-dfn-for="Glyph Map" data-dfn-type="dfn" data-noexport id="glyph-map-entryindex">entryIndex</dfn>[<a data-link-type="dfn" href="#format-1-patch-map-glyphcount" id="ref-for-format-1-patch-map-glyphcount">glyphCount</a> - firstMappedGlyph]
      <td> The entry index for glyph <code>i</code> is stored in entryIndex[<code>i</code> - <a data-link-type="dfn" href="#glyph-map-firstmappedglyph" id="ref-for-glyph-map-firstmappedglyph">firstMappedGlyph</a>]. Array members
      are uint8 if <a data-link-type="dfn" href="#format-1-patch-map-entrycount" id="ref-for-format-1-patch-map-entrycount">entryCount</a> is less than 256, otherwise they are uint16. 
   </table>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="feature-map">Feature Map</dfn> encoding:</p>
   <p>A feature map table associates combinations of <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/featuretags#">feature tags</a> and glyphs with an entry index.</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint16
      <td>featureCount
      <td>Number of featureRecords.
     <tr>
      <td><a data-link-type="dfn" href="#featurerecord" id="ref-for-featurerecord">FeatureRecord</a>
      <td><dfn class="dfn-paneled" data-dfn-for="Feature Map" data-dfn-type="dfn" data-noexport id="feature-map-featurerecords">featureRecords</dfn>[featureCount]
      <td> Provides mappings for a specific <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/featuretags#">feature tag</a>. Must be sorted by <a data-link-type="dfn" href="#featurerecord-featuretag" id="ref-for-featurerecord-featuretag">featureTag</a> with any feature tag occurring at most once. 
     <tr>
      <td><a data-link-type="dfn" href="#entrymaprecord" id="ref-for-entrymaprecord">EntryMapRecord</a>
      <td><dfn class="dfn-paneled" data-dfn-for="Feature Map" data-dfn-type="dfn" data-noexport id="feature-map-entrymaprecords">entryMapRecords</dfn>[variable]
      <td> Provides the key (entry index) for each feature mapping. The entryMapRecords array contains as many entries as the sum of
      the <a data-link-type="dfn" href="#featurerecord-entrymapcount" id="ref-for-featurerecord-entrymapcount">entryMapCount</a> fields in the <a data-link-type="dfn" href="#feature-map-featurerecords" id="ref-for-feature-map-featurerecords">featureRecords</a> array, with entryMapRecords[0] corresponding
      to the first entry of featureRecords[0], entryMapRecords[featureRecord[0].entryMapCount] corresponding to the first entry of
      featureRecords[1], entryMapRecords[featureRecords[0].entryMapCount + featureRecord[1].entryMapCount]] corresponding to the
      first entry of featureRecords[2], and so on. 
   </table>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="featurerecord">FeatureRecord</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>Tag
      <td><dfn class="dfn-paneled" data-dfn-for="FeatureRecord" data-dfn-type="dfn" data-noexport id="featurerecord-featuretag">featureTag</dfn>
      <td>The <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/featuretags#">feature tag</a> this mapping is for.
     <tr>
      <td>uint8/uint16
      <td><dfn class="dfn-paneled" data-dfn-for="FeatureRecord" data-dfn-type="dfn" data-noexport id="featurerecord-firstentryindex">firstEntryIndex</dfn>
      <td> uint8 if <a data-link-type="dfn" href="#format-1-patch-map-entrycount" id="ref-for-format-1-patch-map-entrycount①">entryCount</a> is less than 256, otherwise uint16.
      The first entry index this record maps too. 
     <tr>
      <td>uint8/uint16
      <td><dfn class="dfn-paneled" data-dfn-for="FeatureRecord" data-dfn-type="dfn" data-noexport id="featurerecord-entrymapcount">entryMapCount</dfn>
      <td> uint8 if <a data-link-type="dfn" href="#format-1-patch-map-entrycount" id="ref-for-format-1-patch-map-entrycount②">entryCount</a> is less than 256, otherwise uint16.
      The number of <a data-link-type="dfn" href="#entrymaprecord" id="ref-for-entrymaprecord①">EntryMapRecord</a>s associated with this feature. 
   </table>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="entrymaprecord">EntryMapRecord</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint8/uint16
      <td><dfn class="dfn-paneled" data-dfn-for="EntryMapRecord" data-dfn-type="dfn" data-noexport id="entrymaprecord-firstentryindex">firstEntryIndex</dfn>
      <td> uint8 if <a data-link-type="dfn" href="#format-1-patch-map-entrycount" id="ref-for-format-1-patch-map-entrycount③">entryCount</a> is less than 256, otherwise uint16. 
     <tr>
      <td>uint8/uint16
      <td><dfn class="dfn-paneled" data-dfn-for="EntryMapRecord" data-dfn-type="dfn" data-noexport id="entrymaprecord-lastentryindex">lastEntryIndex</dfn>
      <td> uint8 if <a data-link-type="dfn" href="#format-1-patch-map-entrycount" id="ref-for-format-1-patch-map-entrycount④">entryCount</a> is less than 256, otherwise uint16.
      Must be greater than or equal to firstEntryIndex. 
   </table>
   <p>An entry map record matches any entry indices that are greater than or equal to firstEntryIndex and less than or equal to  lastEntryIndex.</p>
   <h5 class="heading settled algorithm" data-algorithm="Interpreting Format 1" data-level="4.2.1.1" id="interpreting-patch-map-format-1"><span class="secno">4.2.1.1. </span><span class="content">Interpreting Format 1</span><a class="self-link" href="#interpreting-patch-map-format-1"></a></h5>
   <p>This algorithm is used to convert a format 1 patch map into a list of <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries">patch map entries</a>.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-interpret-format-1-patch-map">Interpret Format 1 Patch Map</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>patch map</var>: a <a data-link-type="dfn" href="#format-1-patch-map" id="ref-for-format-1-patch-map">Format 1 Patch Map</a> encoded patch map.</p>
    <li data-md>
     <p><var>font subset</var>: the <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①">font subset</a> which contains <var>patch map</var>.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>entry list</var>: a list of <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries①">patch map entries</a>.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Check that the <var>patch map</var> has <a data-link-type="dfn" href="#format-1-patch-map-format" id="ref-for-format-1-patch-map-format">format</a> equal to 1 and is valid according to the requirements in <a href="#patch-map-format-1">§ 4.2.1 Patch Map Table: Format 1</a>. If it is not return an error.</p>
    <li data-md>
     <p>For each unique <var>entry index</var> in <a data-link-type="dfn" href="#glyph-map-entryindex" id="ref-for-glyph-map-entryindex">entryIndex</a>:</p>
     <ul>
      <li data-md>
       <p>a. If the bit for <var>entry index</var> in <a data-link-type="dfn" href="#format-1-patch-map-appliedentriesbitmap" id="ref-for-format-1-patch-map-appliedentriesbitmap">appliedEntriesBitMap</a> is set to 1, skip this <var>entry index</var>.</p>
      <li data-md>
       <p>b. Collect the set of glyph indices that map to the <var>entry index</var>.</p>
      <li data-md>
       <p>c. Convert the set of glyph indices to a set of unicode code points using the code point to glyph mapping in the <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/cmap#">cmap</a> table of <var>font subset</var>. Ignore any glyph indices that are not mapped by <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/cmap#">cmap</a>.</p>
      <li data-md>
       <p>d. Convert <var>entry index</var> into a URI by applying <a data-link-type="dfn" href="#format-1-patch-map-uritemplate" id="ref-for-format-1-patch-map-uritemplate">uriTemplate</a> following <a href="#uri-templates">§ 3.3 URI Templates</a>.</p>
      <li data-md>
       <p>e. Add an <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries②">entry</a> to <var>entry list</var> whose subset definition contains only the unicode code point set and
maps to the generated URI, the patch encoding specified by <a data-link-type="dfn" href="#format-1-patch-map-patchencoding" id="ref-for-format-1-patch-map-patchencoding">patchEncoding</a>, and <a data-link-type="dfn" href="#format-1-patch-map-id" id="ref-for-format-1-patch-map-id">id</a>.</p>
     </ul>
    <li data-md>
     <p>For each <a data-link-type="dfn" href="#featurerecord" id="ref-for-featurerecord①">FeatureRecord</a> and associated <a data-link-type="dfn" href="#entrymaprecord" id="ref-for-entrymaprecord②">EntryMapRecord</a> in <a data-link-type="dfn" href="#feature-map-featurerecords" id="ref-for-feature-map-featurerecords①">featureRecords</a> and <a data-link-type="dfn" href="#feature-map-entrymaprecords" id="ref-for-feature-map-entrymaprecords">entryMapRecords</a>:</p>
     <ul>
      <li data-md>
       <p>For each <var>entry index</var> between <a data-link-type="dfn" href="#entrymaprecord-firstentryindex" id="ref-for-entrymaprecord-firstentryindex">firstEntryIndex</a> (inclusive) and <a data-link-type="dfn" href="#entrymaprecord-lastentryindex" id="ref-for-entrymaprecord-lastentryindex">lastEntryIndex</a> (inclusive), find the set of unicode codepoints associated with that entry index using the same process as in step 2b through
2c.</p>
       <ul>
        <li data-md>
         <p>Compute <var>mapped entry index</var> = <a data-link-type="dfn" href="#featurerecord-firstentryindex" id="ref-for-featurerecord-firstentryindex">FeatureRecord::firstEntryIndex</a> + <var>entry index</var> - <a data-link-type="dfn" href="#entrymaprecord-firstentryindex" id="ref-for-entrymaprecord-firstentryindex①">EntryMapRecord::firstEntryIndex</a>.</p>
        <li data-md>
         <p>Convert <var>mapped entry index</var> into a URI by applying <a data-link-type="dfn" href="#format-1-patch-map-uritemplate" id="ref-for-format-1-patch-map-uritemplate①">uriTemplate</a> following <a href="#uri-templates">§ 3.3 URI Templates</a>.</p>
        <li data-md>
         <p>If the bit for <var>mapped entry index</var> in <a data-link-type="dfn" href="#format-1-patch-map-appliedentriesbitmap" id="ref-for-format-1-patch-map-appliedentriesbitmap①">appliedEntriesBitMap</a> is set to 1, skip this <var>entry index</var>.</p>
        <li data-md>
         <p>Add an <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries③">entry</a> to <var>entry list</var> whose subset definition contains the unicode code point set and
a feature tag set containing only <a data-link-type="dfn" href="#featurerecord-featuretag" id="ref-for-featurerecord-featuretag①">featureTag</a>. The entry  maps to the generated URI, the patch encoding
specified by <a data-link-type="dfn" href="#format-1-patch-map-patchencoding" id="ref-for-format-1-patch-map-patchencoding①">patchEncoding</a>, and <a data-link-type="dfn" href="#format-1-patch-map-id" id="ref-for-format-1-patch-map-id①">id</a>.</p>
       </ul>
     </ul>
    <li data-md>
     <p>Return <var>entry list</var>.</p>
   </ol>
   <h4 class="heading settled" data-level="4.2.2" id="patch-map-format-2"><span class="secno">4.2.2. </span><span class="content">Patch Map Table: Format 2</span><a class="self-link" href="#patch-map-format-2"></a></h4>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="format-2-patch-map">Format 2 Patch Map</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Format 2 Patch Map" data-dfn-type="dfn" data-noexport id="format-2-patch-map-format">format</dfn>
      <td>Set to 2, identifies this as format 2.
     <tr>
      <td>uint32
      <td>reserved
      <td>Not used, set to 0.
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="Format 2 Patch Map" data-dfn-type="dfn" data-noexport id="format-2-patch-map-id">id</dfn>[4]
      <td>Unique ID used to identify patches that are compatible with this font.
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Format 2 Patch Map" data-dfn-type="dfn" data-noexport id="format-2-patch-map-defaultpatchencoding">defaultPatchEncoding</dfn>
      <td> Specifies the format of the patches linked to by uriTemplate (unless overridden by an entry). Uses the ID numbers from the <a href="#font-patch-formats-summary">§ 5.3 Formats Summary</a> table. 
     <tr>
      <td>uint24
      <td><dfn class="dfn-paneled" data-dfn-for="Format 2 Patch Map" data-dfn-type="dfn" data-noexport id="format-2-patch-map-entrycount">entryCount</dfn>
      <td>Number of entries encoded in this table.
     <tr>
      <td>Offset32
      <td><dfn class="dfn-paneled" data-dfn-for="Format 2 Patch Map" data-dfn-type="dfn" data-noexport id="format-2-patch-map-entries">entries</dfn>
      <td>Offset to a <a data-link-type="dfn" href="#mapping-entries" id="ref-for-mapping-entries">Mapping Entries</a> sub table. Offset is from the start of this table.
     <tr>
      <td>Offset32
      <td><dfn class="dfn-paneled" data-dfn-for="Format 2 Patch Map" data-dfn-type="dfn" data-noexport id="format-2-patch-map-entryidstringdata">entryIdStringData</dfn>
      <td> Offset to a block of data containing the concatentation of all of the entry ID strings.
      May be null (0). Offset is from the start of this table. 
     <tr>
      <td>uint16
      <td>uriTemplateLength
      <td> Length of the uriTemplate string. 
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Format 2 Patch Map" data-dfn-type="dfn" data-noexport id="format-2-patch-map-uritemplate">uriTemplate</dfn>[uriTemplateLength]
      <td> A <a data-link-type="biblio" href="#biblio-utf-8" title="UTF-8, a transformation format of ISO 10646">[UTF-8]</a> encoded string. Contains a <a href="#uri-templates">§ 3.3 URI Templates</a> which is used to produce URIs associated with each entry. 
   </table>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="mapping-entries">Mapping Entries</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entries" data-dfn-type="dfn" data-noexport id="mapping-entries-entries">entries</dfn>[variable]
      <td>Byte array containing the encoded bytes of <a data-link-type="dfn" href="#format-2-patch-map-entrycount" id="ref-for-format-2-patch-map-entrycount">entryCount</a> <a data-link-type="dfn" href="#mapping-entry" id="ref-for-mapping-entry">Mapping Entry</a>'s. Each entry has a variable
        length, which is determined following <a data-link-type="abstract-op" href="#abstract-opdef-interpret-format-2-patch-map-entry" id="ref-for-abstract-opdef-interpret-format-2-patch-map-entry">Interpret Format 2 Patch Map Entry</a>.
   </table>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="mapping-entry">Mapping Entry</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-formatflags">formatFlags</dfn>
      <td> A bit field. Bit 0 (least significant bit) through bit 5 indicate the presence of optional fields. If bit 6 is set this entry is
      ignored. Bit 7 is reserved for future use and set to 0. 
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-featurecount">featureCount</dfn>
      <td> Number of feature tags in the featureTags list. Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags">formatFlags</a> bit 0 is set. 
     <tr>
      <td>Tag
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-featuretags">featureTags</dfn>[featureCount]
      <td> List of <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/featuretags#">feature tags</a> in the entry’s <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition③">font subset definition</a>. Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①">formatFlags</a> bit 0 is set. 
     <tr>
      <td>uint16
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-designspacecount">designSpaceCount</dfn>
      <td> Number of elements in the design space list. Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags②">formatFlags</a> bit 0 is set. 
     <tr>
      <td><a data-link-type="dfn" href="#design-space-segment" id="ref-for-design-space-segment">Design Space Segment</a>
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-designspacesegments">designSpaceSegments</dfn>[designSpaceCount]
      <td> List of design space segments in the entry’s <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition④">font subset definition</a>. Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags③">formatFlags</a> bit 0 is set. 
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-copycount">copyCount</dfn>
      <td> Number of entries in the copyIndices list. Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags④">formatFlags</a> bit 1 is set. 
     <tr>
      <td>uint24
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-copyindices">copyIndices</dfn>[copyCount]
      <td> List of indices from the <a data-link-type="dfn" href="#mapping-entries-entries" id="ref-for-mapping-entries-entries">entries</a> array whose <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition⑤">font subset definition</a> should be copied into this entry. All
      values must be less than the index of this <a data-link-type="dfn" href="#mapping-entry" id="ref-for-mapping-entry①">Mapping Entry</a> in <a data-link-type="dfn" href="#mapping-entries-entries" id="ref-for-mapping-entries-entries①">entries</a>. Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags⑤">formatFlags</a> bit 1 is set. 
     <tr>
      <td>int24
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-entryiddelta">entryIdDelta</dfn>
      <td> Signed delta which is used to calculate the id for this entry. The id for this entry is the entry id of the previous <a data-link-type="dfn" href="#mapping-entry" id="ref-for-mapping-entry②">Mapping Entry</a> + 1 + entryIdDelta. Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags⑥">formatFlags</a> bit 2 is set and <a data-link-type="dfn" href="#format-2-patch-map-entryidstringdata" id="ref-for-format-2-patch-map-entryidstringdata">entryIdStringData</a> is null (0). If not present delta is assumed to be 0. 
     <tr>
      <td>uint16
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-entryidstringlength">entryIdStringLength</dfn>
      <td> The number of bytes that the id string for this entry occupies in the <a data-link-type="dfn" href="#format-2-patch-map-entryidstringdata" id="ref-for-format-2-patch-map-entryidstringdata①">entryIdStringData</a> data block.
      Strings are encoded in <a data-link-type="biblio" href="#biblio-utf-8" title="UTF-8, a transformation format of ISO 10646">[UTF-8]</a>. Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags⑦">formatFlags</a> bit 2 is set and <a data-link-type="dfn" href="#format-2-patch-map-entryidstringdata" id="ref-for-format-2-patch-map-entryidstringdata②">entryIdStringData</a> is not null (0). If not present the length is assumed to be 0. 
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-patchencoding">patchEncoding</dfn>
      <td> Specifies the format of the patch linked to by this entry. Uses the ID numbers from the <a href="#font-patch-formats-summary">§ 5.3 Formats Summary</a> table.
      Overrides <a data-link-type="dfn" href="#format-2-patch-map-defaultpatchencoding" id="ref-for-format-2-patch-map-defaultpatchencoding">defaultPatchEncoding</a>.
      Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags⑧">formatFlags</a> bit 3 is set. 
     <tr>
      <td>uint16/uint24
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-bias">bias</dfn>
      <td> Bias value which is added to all codepoint values in the codepoints set.
      If format bit 4 is 0 and bit 5 is 1, then this is present and a uint16.
      If format bit 4 is 1 and bit 5 is 1, then this is present and a uint24.
      Otherwise it is not present. 
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-codepoints">codepoints</dfn>[variable]
      <td> Set of codepoints for this mapping. Encoded as a <a data-link-type="dfn" href="#sparse-bit-set" id="ref-for-sparse-bit-set">Sparse Bit Set</a>.
      Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags⑨">formatFlags</a> bit 4 and/or 5 is set. The length is
      determined by following the decoding procedures in <a href="#sparse-bit-set-decoding">§ 4.2.2.2 Sparse Bit Set</a>. 
   </table>
   <p>If an encoder is producing patches that will be stored on a file system and then served it’s recommended that only numeric entry IDs be
used (via <a data-link-type="dfn" href="#mapping-entry-entryiddelta" id="ref-for-mapping-entry-entryiddelta">entryIdDelta</a>) as these will generally produce the smallest encoding of the format 2 patch map. String IDs
are useful in cases where patches are not being stored in advance and the ID strings can be then used to encode information about the patch
being requested.</p>
   <p>If an encoder is using string IDs via <a data-link-type="dfn" href="#format-2-patch-map-entryidstringdata" id="ref-for-format-2-patch-map-entryidstringdata③">entryIdStringData</a> and <a data-link-type="dfn" href="#mapping-entry-entryidstringlength" id="ref-for-mapping-entry-entryidstringlength">entryIdStringLength</a> then, the
encoder should only use <a href="https://www.rfc-editor.org/rfc/rfc3986#section-2.3">unreserved uri characters</a> in the ID strings. This will prevent the need for percent
encoding of the ID values when expanding the URI templates and maximize compatibility of the URLs and associated file names. Particularly,
if patch files are to be stored on a file system which does not support unicode encoded file names or is case insensitive then special care
needs to be taken when choosing the set of characters to use in the file names.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="design-space-segment">Design Space Segment</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>Tag
      <td><dfn class="dfn-paneled" data-dfn-for="Design Space Segment" data-dfn-type="dfn" data-noexport id="design-space-segment-tag">tag</dfn>
      <td> Axis tag value. 
     <tr>
      <td>Fixed
      <td><dfn class="dfn-paneled" data-dfn-for="Design Space Segment" data-dfn-type="dfn" data-noexport id="design-space-segment-start">start</dfn>
      <td> Start (inclusive) of the segment. This value uses the user axis scale: <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otvaroverview#coordinate-scales-and-normalization">OpenType Specification § otvaroverview#coordinate-scales-and-normalization</a>. 
     <tr>
      <td>Fixed
      <td><dfn class="dfn-paneled" data-dfn-for="Design Space Segment" data-dfn-type="dfn" data-noexport id="design-space-segment-end">end</dfn>
      <td> End (inclusive) of the segment. Must be greater than or equal to start. This value uses the user axis scale: <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otvaroverview#coordinate-scales-and-normalization">OpenType Specification § otvaroverview#coordinate-scales-and-normalization</a>. 
   </table>
   <h5 class="heading settled algorithm" data-algorithm="Interpreting Format 2" data-level="4.2.2.1" id="interpreting-patch-map-format-2"><span class="secno">4.2.2.1. </span><span class="content">Interpreting Format 2</span><a class="self-link" href="#interpreting-patch-map-format-2"></a></h5>
   <p>This algorithm is used to convert a format 2 patch map into a list of <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries④">patch map entries</a>.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-interpret-format-2-patch-map">Interpret Format 2 Patch Map</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>patch map</var>: a <a data-link-type="dfn" href="#format-2-patch-map" id="ref-for-format-2-patch-map">Format 2 Patch Map</a> encoded patch map.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>entry list</var>: a list of <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries⑤">patch map entries</a>.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Check that the <var>patch map</var> has <a data-link-type="dfn" href="#format-2-patch-map-format" id="ref-for-format-2-patch-map-format">format</a> equal to 2 and is valid according to the requirements in <a href="#patch-map-format-2">§ 4.2.2 Patch Map Table: Format 2</a>. If it is not return an error.</p>
    <li data-md>
     <p>Initialize <var>last entry id</var> to 0, <var>current byte</var> to 0, and <var>current id string byte</var> to 0.</p>
    <li data-md>
     <p>Invoke <a data-link-type="abstract-op" href="#abstract-opdef-interpret-format-2-patch-map-entry" id="ref-for-abstract-opdef-interpret-format-2-patch-map-entry①">Interpret Format 2 Patch Map Entry</a>, <a data-link-type="dfn" href="#format-2-patch-map-entrycount" id="ref-for-format-2-patch-map-entrycount①">entryCount</a> times. For each invocation:</p>
     <ul>
      <li data-md>
       <p>pass in the bytes from <var>patch map</var> starting from <a data-link-type="dfn" href="#format-2-patch-map-entries" id="ref-for-format-2-patch-map-entries">entries</a>[<var>current byte</var>] to
 the end of <var>patch map</var>,
 the bytes from <var>patch map</var> starting from <a data-link-type="dfn" href="#format-2-patch-map-entryidstringdata" id="ref-for-format-2-patch-map-entryidstringdata④">entryIdStringData</a>[<var>current id string byte</var>]
 to the end of <var>patch map</var> if <a data-link-type="dfn" href="#format-2-patch-map-entryidstringdata" id="ref-for-format-2-patch-map-entryidstringdata⑤">entryIdStringData</a> is non zero, <var>last entry id</var>, <a data-link-type="dfn" href="#format-2-patch-map-defaultpatchencoding" id="ref-for-format-2-patch-map-defaultpatchencoding①">defaultPatchEncoding</a>, and <a data-link-type="dfn" href="#format-2-patch-map-uritemplate" id="ref-for-format-2-patch-map-uritemplate">uriTemplate</a>.</p>
      <li data-md>
       <p>Set <var>last entry id</var> to the returned entry id.</p>
      <li data-md>
       <p>Add the returned consumed byte count to <var>current byte</var>.</p>
      <li data-md>
       <p>Add the returned consumed id string byte count to <var>current id string byte</var>.</p>
      <li data-md>
       <p>If the returned value of ignored is false, then set the unique ID of the returned entry to <a data-link-type="dfn" href="#format-2-patch-map-id" id="ref-for-format-2-patch-map-id">id</a> and add
 the  entry to <var>entry list</var>.</p>
     </ul>
    <li data-md>
     <p>Return <var>entry list</var>.</p>
   </ol>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-interpret-format-2-patch-map-entry">Interpret Format 2 Patch Map Entry</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>entry bytes</var>: a byte array that contains an encoded <a data-link-type="dfn" href="#mapping-entry" id="ref-for-mapping-entry③">Mapping Entry</a>.</p>
    <li data-md>
     <p><var>id string bytes</var> (optional): a byte array the contains entry ID strings.</p>
    <li data-md>
     <p><var>last entry id</var>: the entry id of the entry preceding this one.</p>
    <li data-md>
     <p><var>default patch encoding</var>: the default patch encoding if one isn’t specified.</p>
    <li data-md>
     <p><var>uri template</var>: the URI template used to locate patches.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>entry id</var>: the numeric or string id of this entry.</p>
    <li data-md>
     <p><var>entry</var>: a single <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries⑥">entry</a>.</p>
    <li data-md>
     <p><var>consumed bytes</var>: the number of bytes used to encode the entry.</p>
    <li data-md>
     <p><var>consumed id string bytes</var>: the number of bytes used to encode the entry id string.</p>
    <li data-md>
     <p><var>ignored</var>: if true, then this entry should be ignored.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>For the all steps whenever data is loaded from <var>entry bytes</var> increment <var>consumed bytes</var> with the
 number of bytes read.</p>
    <li data-md>
     <p>If <var>id string bytes</var> is not present then, set <var>entry id</var> = <var>last entry id</var> + 1.</p>
    <li data-md>
     <p>Set the patch encoding of <var>entry</var> to <var>default patch encoding</var>.</p>
    <li data-md>
     <p>Read <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①⓪">formatFlags</a> from <var>entry bytes</var>.</p>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①①">formatFlags</a> bit 0 is set, then the feature tag and design space lists are present:</p>
     <ul>
      <li data-md>
       <p>Read the feature tag list specified by <a data-link-type="dfn" href="#mapping-entry-featurecount" id="ref-for-mapping-entry-featurecount">featureCount</a> and <a data-link-type="dfn" href="#mapping-entry-featuretags" id="ref-for-mapping-entry-featuretags">featureTags</a> from <var>entry bytes</var> and add the loaded tags to <var>entry</var>.</p>
      <li data-md>
       <p>Read the design space segment list specified by <a data-link-type="dfn" href="#mapping-entry-designspacecount" id="ref-for-mapping-entry-designspacecount">designSpaceCount</a> and <a data-link-type="dfn" href="#mapping-entry-designspacesegments" id="ref-for-mapping-entry-designspacesegments">designSpaceSegments</a> from <var>entry bytes</var> and add the design space segments to <var>entry</var>. Each segment defines an interval from <a data-link-type="dfn" href="#design-space-segment-start" id="ref-for-design-space-segment-start">start</a> to <a data-link-type="dfn" href="#design-space-segment-end" id="ref-for-design-space-segment-end">end</a> inclusive for the axis identified by <a data-link-type="dfn" href="#design-space-segment-tag" id="ref-for-design-space-segment-tag">tag</a>.</p>
     </ul>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①②">formatFlags</a> bit 1 is set, then the copy indices list is present:</p>
     <ul>
      <li data-md>
       <p>Read the copy indices list specified by <a data-link-type="dfn" href="#mapping-entry-copycount" id="ref-for-mapping-entry-copycount">copyCount</a> and <a data-link-type="dfn" href="#mapping-entry-copyindices" id="ref-for-mapping-entry-copyindices">copyIndices</a> from <var>entry bytes</var>.</p>
      <li data-md>
       <p>The copy indices refer to previously loaded entries. 0 is the first <a data-link-type="dfn" href="#mapping-entry" id="ref-for-mapping-entry④">Mapping Entry</a> in <a data-link-type="dfn" href="#mapping-entries-entries" id="ref-for-mapping-entries-entries②">entries</a>, 1 the second
 and so on. For each index in <a data-link-type="dfn" href="#mapping-entry-copyindices" id="ref-for-mapping-entry-copyindices①">copyIndices</a> locate the previously loaded entry with a matching index and
 add all code points, feature tags, and design space segments from it to <var>entry</var>.</p>
     </ul>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①③">formatFlags</a> bit 2 is set, then an id delta or id string length is present:</p>
     <ul>
      <li data-md>
       <p>If <var>id string bytes</var> is not present then, read the id delta specified by <a data-link-type="dfn" href="#mapping-entry-entryiddelta" id="ref-for-mapping-entry-entryiddelta①">entryIdDelta</a> from <var>entry bytes</var> and add the delta to <var>entry id</var>. If <var>entry id</var> is negative this is an error
and the mapping is malformed.</p>
      <li data-md>
       <p>Otherwise if <var>id string bytes</var> is present then, read <a data-link-type="dfn" href="#mapping-entry-entryidstringlength" id="ref-for-mapping-entry-entryidstringlength①">entryIdStringLength</a> bytes from <var>id string bytes</var> and interpret the bytes as a <a data-link-type="biblio" href="#biblio-utf-8" title="UTF-8, a transformation format of ISO 10646">[UTF-8]</a> string. Set <var>entry id</var> to the result.</p>
     </ul>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①④">formatFlags</a> bit 3 is set, then a patch encoding is present. Read the encoding specified by <a data-link-type="dfn" href="#mapping-entry-patchencoding" id="ref-for-mapping-entry-patchencoding">patchEncoding</a> from <var>entry bytes</var> and set the patch encoding of <var>entry</var> to the read value.</p>
    <li data-md>
     <p>If one or both of <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①⑤">formatFlags</a> bit 4 and bit 5 are set, then a codepoint list is present:</p>
     <ul>
      <li data-md>
       <p>If <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①⑥">formatFlags</a> bit 4 is 0 and bit 5 is 1, then read the 2 byte (uint16) <a data-link-type="dfn" href="#mapping-entry-bias" id="ref-for-mapping-entry-bias">bias</a> value
from <var>entry bytes</var>.</p>
      <li data-md>
       <p>If <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①⑦">formatFlags</a> bit 4 is 1 and bit 5 is 1, then read the 3 byte (uint24) <a data-link-type="dfn" href="#mapping-entry-bias" id="ref-for-mapping-entry-bias①">bias</a> value
from <var>entry bytes</var>.</p>
      <li data-md>
       <p>Otherwise the bias is 0.</p>
      <li data-md>
       <p>Read the sparse bit set <a data-link-type="dfn" href="#mapping-entry-codepoints" id="ref-for-mapping-entry-codepoints">codepoints</a> from <var>entry bytes</var> following <a href="#sparse-bit-set-decoding">§ 4.2.2.2 Sparse Bit Set</a>. For each
codepoint add the bias value to it and then add the result to the codepoint set in <var>entry</var>.</p>
     </ul>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①⑧">formatFlags</a> bit 6 is set, then set <var>ignored</var> to true. Otherwise <var>ignored</var> is false.</p>
    <li data-md>
     <p>Convert <var>entry id</var> into a URI by applying <var>uri template</var> following <a href="#uri-templates">§ 3.3 URI Templates</a>. Set the patch uri of <var>entry</var> to the generated URI.</p>
    <li data-md>
     <p>Return <var>entry id</var>, <var>entry</var>, <var>consumed bytes</var>, <a data-link-type="dfn" href="#mapping-entry-entryidstringlength" id="ref-for-mapping-entry-entryidstringlength②">entryIdStringLength</a> as <var>consumed id string bytes</var>, and <var>ignored</var>.</p>
   </ol>
   <h5 class="heading settled algorithm" data-algorithm="Sparse Bit Set" data-level="4.2.2.2" id="sparse-bit-set-decoding"><span class="secno">4.2.2.2. </span><span class="content">Sparse Bit Set</span><a class="self-link" href="#sparse-bit-set-decoding"></a></h5>
   <p>A sparse bit set is a data structure which compactly stores a set of distinct unsigned integers. The set is represented as a tree where
each node has a fixed number of children that recursively sub-divides an interval into equal partitions. A tree of height <i>H</i> with
branching factor <i>B</i> can store set membership for integers in the interval [0 to <i>B</i><sup><i>H</i></sup>-1] inclusive. The tree
is encoded into an array of bytes for transport.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="sparse-bit-set">Sparse Bit Set</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint8
      <td>header
      <td>Bits 0 (least significant) and 1 encode the trees branch factor <i>B</i> via <a data-link-type="dfn" href="#branch-factor-encoding" id="ref-for-branch-factor-encoding">Branch Factor Encoding</a>. Bits 2 through 6 are a
        5-bit unsigned integer which encodes the value of <i>H</i>. Bit 7 is set to 0 and reserved for future use. 
     <tr>
      <td>uint8
      <td>treeData[variable]
      <td>Binary encoding of the tree.
   </table>
   <p>The exact length of <var>treeData</var> is initially unknown, it’s length is determined by executing the decoding algorithm. When using
branch factors of 2 or 4 the last node may only partially consume the bits in a byte. In that case all remaining bits are unused and
ignored.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="branch-factor-encoding">Branch Factor Encoding</dfn>:</p>
   <table>
    <tbody>
     <tr>
      <th>Bit 1
      <th>Bit 0
      <th>Branch Factor (B)
     <tr>
      <td>0
      <td>0
      <td>2
     <tr>
      <td>0
      <td>1
      <td>4
     <tr>
      <td>1
      <td>0
      <td>8
     <tr>
      <td>1
      <td>1
      <td>32
   </table>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-decoding-sparse-bit-set-treedata">Decoding sparse bit set treeData</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>H</var>: the tree height, <var>H</var>, from the header byte.</p>
    <li data-md>
     <p><var>B</var>: the branch factor, <var>B</var>, from the header byte.</p>
    <li data-md>
     <p><var>treeData</var>: array of bytes to be decoded.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>S</var>: a set of unsigned integers.</p>
   </ul>
   <p>The algorithm, using a FIFO (first in first out) queue <var>Q</var>:</p>
   <ol>
    <li data-md>
     <p>If <var>H</var> is equal to 0, then this is an empty set and no bytes of <var>treeData</var> are consumed. Return an empty set.</p>
    <li data-md>
     <p>Insert the tuple (0, 1) into <var>Q</var>.</p>
    <li data-md>
     <p>Initialize <var>S</var> to an empty set.</p>
    <li data-md>
     <p><var>treeData</var> is interpreted as a string of bits where the least significant bit of <var>treeData</var>[0] is the first bit in
 the string, the most significant bit of <var>treeData</var>[0] is the 8th bit, and so on.</p>
    <li data-md>
     <p>If <var>Q</var> is empty return <var>S</var>.</p>
    <li data-md>
     <p>Extract the next tuple <var>t</var> from <var>Q</var>. The first value of
 in <var>t</var> is <var>start</var> and the second value is <var>depth</var>.</p>
    <li data-md>
     <p>Remove the next <var>B</var> bits from the <var>treeData</var> bit string. The first removed bit is <i>v<sub>1</sub></i>,
 the second is <i>v<sub>2</sub></i>, and so on until the last removed bit which is <i>v<sub>B</sub></i>. If prior to removal there
 were less than <var>B</var> bits left in <var>treeData</var>, then <var>treeData</var> is malformed, return an error.</p>
    <li data-md>
     <p>If all bits <i>v<sub>1</sub></i> through <i>v<sub>B</sub></i> are 0, then insert all integers in the interval
[<var>start</var>, <var>start</var> + <var>B</var><sup><var>H</var> - <var>depth</var> + 1</sup>)
into <var>S</var>. Go to step 5.</p>
    <li data-md>
     <p>For each <i>v<sub>i</sub></i> which is equal to 1 in <i>v<sub>1</sub></i> through <i>v<sub>B</sub></i>:
 If <var>depth</var> is equal to <var>H</var> add
 integer <var>start</var> + <i>i</i> - 1 to <var>S</var>. Otherwise, insert the tuple
 (<var>start</var> + (i - 1) * <var>B</var><sup><var>H</var> - <var>depth</var></sup>, <var>depth</var> + 1)
 into <var>Q</var>.</p>
    <li data-md>
     <p>Go to step 5.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> when encoding sparse bit sets the encoder can use any of the possible branching factors, but it is recommended to
use 4 as that has <a href="https://github.com/w3c/PFE-analysis/blob/main/results/set_encoding_branch_factor.md">been shown</a> to give the smallest encodings for most unicode codepoint sets typically encountered.</p>
   <div class="example" id="example-eb491b43">
    <a class="self-link" href="#example-eb491b43"></a> The set {2, 33, 323} in a tree with a branching factor of 8 can be encoded as the bit string: 
<pre>bit string:
|-- header --|- lvl 0 |---- level 1 ----|------- level 2 -----------|
| B=8 H=3    |   n0   |   n1       n2   |   n3       n4       n5    |
[ 01  11000 0 10000100 10001000 10000000 00100000 01000000 00010000 ]

Which then becomes the byte string:
[
  0b00001110,
  0b00100001,
  0b00010001,
  0b00000001,
  0b00000100,
  0b00000010,
  0b00001000
]
</pre>
   </div>
   <div class="example" id="example-e803ad63">
    <a class="self-link" href="#example-e803ad63"></a> The empty set in a tree with a branching factor of 2 is encoded as the bit string: 
<pre>bit string:
|-- header -- |
| B=2 H=0     |
[ 00  00000 0 ]

Which then becomes the byte string:
[
  0b00000000,
]
</pre>
   </div>
   <div class="example" id="example-cc307778">
    <a class="self-link" href="#example-cc307778"></a> The set {0, 1, 2, ..., 17} can be encoded with a branching factor of 4 as: 
<pre>bit string:
|-- header --| l0 |- lvl 1 -| l2  |
| B=4 H=3    | n0 | n1 | n2 | n3  |
[ 10  11000 0 1100 0000 1000 1100 ]

byte string:
[
  0b00001101,
  0b00000011,
  0b00110001
]
</pre>
   </div>
   <h2 class="heading settled" data-level="5" id="font-patch-formats"><span class="secno">5. </span><span class="content">Font Patch Formats</span><a class="self-link" href="#font-patch-formats"></a></h2>
   <p>In incremental font transfer <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②">font subsets</a> are extended by applying patches.
This specification defines three patch formats, each appropriate to its own set of augmentation scenarios. A single
encoding can make use of more than one patch format.</p>
   <h3 class="heading settled" data-level="5.1" id="font-patch-definitions"><span class="secno">5.1. </span><span class="content">Definitions</span><a class="self-link" href="#font-patch-definitions"></a></h3>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="font-patch">font patch</dfn> is a file which encodes changes to be made to an IFT-encoded font. Patches are used to extend
an existing <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset③">font subset</a> and provide expanded coverage.</p>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="patch-format">patch format</dfn> is a specified encoding of changes to be applied relative to a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset④">font subset</a>. A set of
changes encoded according to the format is a <a data-link-type="dfn" href="#font-patch" id="ref-for-font-patch">font patch</a>. Each <a data-link-type="dfn" href="#patch-format" id="ref-for-patch-format">patch format</a> has an associated <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="patch-application-algorithm">patch application algorithm</dfn> which takes a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset⑤">font subset</a> and a <a data-link-type="dfn" href="#font-patch" id="ref-for-font-patch①">font patch</a> encoded in the <a data-link-type="dfn" href="#patch-format" id="ref-for-patch-format①">patch format</a> as input and outputs an extended <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset⑥">font subset</a>.</p>
   <h3 class="heading settled" data-level="5.2" id="font-patch-invalidations"><span class="secno">5.2. </span><span class="content">Patch Invalidations</span><a class="self-link" href="#font-patch-invalidations"></a></h3>
   <p>Patches in an incremental <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset⑦">font subset</a> when applied may invalidate other available patches, making them invalid to be applied
to the extended <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset⑧">font subset</a>. Patch validity is checked using the unique ID from the <a href="#patch-map">§ 4.2 Patch Map Table</a>. Every patch has a
unique ID encoded within it which needs to match the unique ID from the <a href="#patch-map">§ 4.2 Patch Map Table</a> which lists that patch. Additionally to
aid the client in determining what invalidations will occur, every patch is categorized into one of three categories:</p>
   <ul>
    <li data-md>
     <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="full-invalidation">Full Invalidation</dfn>: when this patch is applied all other patches currently listed in the <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset⑨">font subset</a> are invalidated.
The unique ID in both the 'IFT ' and 'IFTX' <a href="#patch-map">§ 4.2 Patch Map Table</a> will be changed.</p>
    <li data-md>
     <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="partial-invalidation">Partial Invalidation</dfn>: when this patch is applied all other patches in the same <a href="#patch-map">§ 4.2 Patch Map Table</a> will be invalidated.
The unique ID of only the <a href="#patch-map">§ 4.2 Patch Map Table</a> which contains this patch will be changed.</p>
    <li data-md>
     <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="no-invalidation">No Invalidation</dfn>: no other patches will be invalidated by the application of this patch. The unique ID of the
'IFT ' and 'IFTX' <a href="#patch-map">§ 4.2 Patch Map Table</a> will not change.</p>
   </ul>
   <p>The invalidation behaviour of a specific patch is encoded in its format number which can be found in the following section.</p>
   <h3 class="heading settled" data-level="5.3" id="font-patch-formats-summary"><span class="secno">5.3. </span><span class="content">Formats Summary</span><a class="self-link" href="#font-patch-formats-summary"></a></h3>
   <p>The following patch formats are defined by this specification:</p>
   <table>
    <tbody>
     <tr>
      <th>Name
      <th>ID
      <th>Invalidation
      <th>Description
     <tr>
      <td><a href="#brotli">§ 5.4 Brotli Patch</a>
      <td>1
      <td><a data-link-type="dfn" href="#full-invalidation" id="ref-for-full-invalidation">Full Invalidation</a>
      <td>A brotli encoded binary diff that uses the entire <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⓪">font subset</a> as a base.
     <tr>
      <td><a href="#brotli">§ 5.4 Brotli Patch</a>
      <td>2
      <td><a data-link-type="dfn" href="#partial-invalidation" id="ref-for-partial-invalidation">Partial Invalidation</a>
      <td>A brotli encoded binary diff that uses the entire <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①①">font subset</a> as a base.
     <tr>
      <td><a href="#per-table-brotli">§ 5.5 Per Table Brotli</a>
      <td>3
      <td><a data-link-type="dfn" href="#full-invalidation" id="ref-for-full-invalidation①">Full Invalidation</a>
      <td>A collection of brotli encoded binary diffs that use tables from the <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①②">font subset</a> as bases.
     <tr>
      <td><a href="#per-table-brotli">§ 5.5 Per Table Brotli</a>
      <td>4
      <td><a data-link-type="dfn" href="#partial-invalidation" id="ref-for-partial-invalidation①">Partial Invalidation</a>
      <td>A collection of brotli encoded binary diffs that use tables from the <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①③">font subset</a> as bases.
     <tr>
      <td><a href="#glyph-keyed">§ 5.6 Glyph Keyed</a>
      <td>5
      <td><a data-link-type="dfn" href="#no-invalidation" id="ref-for-no-invalidation">No Invalidation</a>
      <td>Contains a collection of opaque binary blobs, each associated with a glyph id and table.
   </table>
   <p>More detailed descriptions of each algorithm can be found in the following sections.</p>
   <h3 class="heading settled" data-level="5.4" id="brotli"><span class="secno">5.4. </span><span class="content">Brotli Patch</span><a class="self-link" href="#brotli"></a></h3>
   <p>In a brotli patch the target file is encoded with <a data-link-type="biblio" href="#biblio-rfc7932" title="Brotli Compressed Data Format">brotli compression</a> using the
source file as a <a href="https://datatracker.ietf.org/doc/html/draft-vandevenne-shared-brotli-format-09#section-3.2">shared LZ77 dictionary</a>. A brotli encoded patch consists
of a short header followed by brotli encoded data.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="brotli-patch">Brotli patch</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>Tag
      <td><dfn class="dfn-paneled" data-dfn-for="Brotli patch" data-dfn-type="dfn" data-noexport id="brotli-patch-format">format</dfn>
      <td>Identifies the encoding as brotli, set to 'ifbr'
     <tr>
      <td>uint32
      <td>reserved
      <td>Reserved for future use, set to 0.
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="Brotli patch" data-dfn-type="dfn" data-noexport id="brotli-patch-id">id</dfn>[4]
      <td>The id of the <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①④">font subset</a> which this patch can be applied too. See <a href="#font-patch-invalidations">§ 5.2 Patch Invalidations</a>.
     <tr>
      <td>uint32
      <td>length
      <td>The uncompressed length of <a data-link-type="dfn" href="#brotli-patch-brotlistream" id="ref-for-brotli-patch-brotlistream">brotliStream</a>.
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Brotli patch" data-dfn-type="dfn" data-noexport id="brotli-patch-brotlistream">brotliStream</dfn>[variable]
      <td>Brotli encoded byte stream.
   </table>
   <h4 class="heading settled algorithm" data-algorithm="Applying Brotli Patches" data-level="5.4.1" id="apply-brotli"><span class="secno">5.4.1. </span><span class="content">Applying Brotli Patches</span><a class="self-link" href="#apply-brotli"></a></h4>
   <p>This <a data-link-type="dfn" href="#patch-application-algorithm" id="ref-for-patch-application-algorithm">patch application algorithm</a> is used to apply a brotli patch to extend a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⑤">font subset</a> to cover additional codepoints,
features, and/or design-variation space.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-apply-brotli-patch">Apply brotli patch</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>base font subset</var>: a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⑥">font subset</a> which is to be extended.</p>
    <li data-md>
     <p><var>patch</var>: a <a data-link-type="dfn" href="#brotli-patch" id="ref-for-brotli-patch">brotli patch</a> to be applied to <var>base font subset</var>.</p>
    <li data-md>
     <p><var>id</var>: The ID number from the 'IFT ' or 'IFTX' table of <var>base font subset</var> which listed this patch.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>extended font subset</var>: a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⑦">font subset</a> that has been extended by the <var>patch</var>.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Check that the <a data-link-type="dfn" href="#brotli-patch-format" id="ref-for-brotli-patch-format">format</a> field in <var>patch</var> is equal to 'ifbr', if it is
not equal, then <var>patch</var> is not correctly formatted. Patch application has failed, return
an error.</p>
    <li data-md>
     <p>Check that the <a data-link-type="dfn" href="#brotli-patch-id" id="ref-for-brotli-patch-id">id</a> field in <var>patch</var> is equal to <var>id</var>.
If there is no match, or <var>base font subset</var> does not have either an 'IFT ' or 'IFTX' table, then patch application
has failed, return an error.</p>
    <li data-md>
     <p>Decode the brotli encoded data in <a data-link-type="dfn" href="#brotli-patch-brotlistream" id="ref-for-brotli-patch-brotlistream①">brotliStream</a> following <a href="https://www.rfc-editor.org/rfc/rfc7932#section-10">Brotli Compressed Data Format § section-10</a> and
using the <var>base font subset</var> as a <a href="https://datatracker.ietf.org/doc/html/draft-vandevenne-shared-brotli-format-09#section-3.2">shared LZ77 dictionary</a>. Return the decoded
result as the <var>extended font subset</var></p>
   </ol>
   <h3 class="heading settled" data-level="5.5" id="per-table-brotli"><span class="secno">5.5. </span><span class="content">Per Table Brotli</span><a class="self-link" href="#per-table-brotli"></a></h3>
   <p>A per table brotli patch contains a collection of patches which are applied to the individual <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">font tables</a> in the input font file. Each table patch is encoded with <a data-link-type="biblio" href="#biblio-rfc7932" title="Brotli Compressed Data Format">brotli compression</a> using the corresponding table from the input font file as a <a href="https://datatracker.ietf.org/doc/html/draft-vandevenne-shared-brotli-format-09#section-3.2">shared LZ77 dictionary</a>. A per table brotli encoded patch consists of a short header followed
by one or more brotli encoded patches. In addition to patching tables, patches may also replace (existing table data is not used)
or remove tables in a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⑧">font subset</a>.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="per-table-brotli-patch">Per table brotli patch</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>Tag
      <td><dfn class="dfn-paneled" data-dfn-for="Per table brotli patch" data-dfn-type="dfn" data-noexport id="per-table-brotli-patch-format">format</dfn>
      <td>Identifies the encoding as per table brotli, set to 'ifbt'
     <tr>
      <td>uint32
      <td>reserved
      <td>Reserved for future use, set to 0.
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="Per table brotli patch" data-dfn-type="dfn" data-noexport id="per-table-brotli-patch-id">id</dfn>[4]
      <td>The id of the <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⑨">font subset</a> which this patch can be applied too. See <a href="#font-patch-invalidations">§ 5.2 Patch Invalidations</a>.
     <tr>
      <td>uint16
      <td>patchesCount
      <td>The number of entries in the patches array.
     <tr>
      <td>Offset32
      <td><dfn class="dfn-paneled" data-dfn-for="Per table brotli patch" data-dfn-type="dfn" data-noexport id="per-table-brotli-patch-patches">patches</dfn>[patchesCount+1]
      <td>Each entry is an offset from the start of this table to a <a data-link-type="dfn" href="#tablepatch" id="ref-for-tablepatch">TablePatch</a>. Offsets must be sorted in ascending order.
   </table>
   <p>The difference between two consecutive offsets in the <a data-link-type="dfn" href="#per-table-brotli-patch-patches" id="ref-for-per-table-brotli-patch-patches">patches</a> array gives the size
of that <a data-link-type="dfn" href="#tablepatch" id="ref-for-tablepatch①">TablePatch</a>.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="tablepatch">TablePatch</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>Tag
      <td><dfn class="dfn-paneled" data-dfn-for="TablePatch" data-dfn-type="dfn" data-noexport id="tablepatch-tag">tag</dfn>
      <td>The tag that identifies the <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">font table</a> this patch applies too.
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="TablePatch" data-dfn-type="dfn" data-noexport id="tablepatch-flags">flags</dfn>
      <td>Bit-field. If bit 0 (least significant bit) is set this patch replaces the existing table. If bit 1 is set this table is removed.
     <tr>
      <td>uint32
      <td>length
      <td>The uncompressed length of <a data-link-type="dfn" href="#tablepatch-brotlistream" id="ref-for-tablepatch-brotlistream">brotliStream</a>.
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="TablePatch" data-dfn-type="dfn" data-noexport id="tablepatch-brotlistream">brotliStream</dfn>[variable]
      <td>Brotli encoded byte stream.
   </table>
   <h4 class="heading settled algorithm" data-algorithm="Applying Per Table Brotli Patches" data-level="5.5.1" id="apply-per-table-brotli"><span class="secno">5.5.1. </span><span class="content">Applying Per Table Brotli Patches</span><a class="self-link" href="#apply-per-table-brotli"></a></h4>
   <p>This <a data-link-type="dfn" href="#patch-application-algorithm" id="ref-for-patch-application-algorithm①">patch application algorithm</a> is used to apply a per table brotli patch to extend a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②⓪">font subset</a> to cover additional codepoints,
features, and/or design-variation space.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-apply-per-table-brotli-patch">Apply per table brotli patch</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>base font subset</var>: a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②①">font subset</a> which is to be extended.</p>
    <li data-md>
     <p><var>patch</var>: a <a data-link-type="dfn" href="#per-table-brotli-patch" id="ref-for-per-table-brotli-patch">per table brotli patch</a> to be applied to <var>base font subset</var>.</p>
    <li data-md>
     <p><var>id</var>: The ID number from the 'IFT ' or 'IFTX' table of <var>base font subset</var> which listed this patch.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>extended font subset</var>: a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②②">font subset</a> that has been extended by the <var>patch</var>.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Initialize <var>extended font subset</var> to be an empty font with no tables.</p>
    <li data-md>
     <p>Check that the <a data-link-type="dfn" href="#per-table-brotli-patch-format" id="ref-for-per-table-brotli-patch-format">format</a> field in <var>patch</var> is equal to 'ifbt', if it is
not equal then <var>patch</var> is not correctly formatted. Patch application has failed, return
an error.</p>
    <li data-md>
     <p>Check that the <a data-link-type="dfn" href="#per-table-brotli-patch-id" id="ref-for-per-table-brotli-patch-id">id</a> field in <var>patch</var> is equal to <var>id</var>.
If there is no match, or <var>base font subset</var> does not have either an 'IFT ' or 'IFTX' table, then patch application
has failed, return an error.</p>
    <li data-md>
     <p>In the following steps, adding a table to <var>extended font subset</var> consists of adding the table’s data to the font and
inserting a new entry into the <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table directory</a> according to the requirements of the open
type specification. That entry includes a checksum for the table data. When an existing table is copied unmodified, the client
can re-use the checksum from the entry in the source font. Otherwise a new checksum will need to be computed.</p>
    <li data-md>
     <p>For each entry in <a data-link-type="dfn" href="#per-table-brotli-patch-patches" id="ref-for-per-table-brotli-patch-patches①">patches</a>, with index <var>i</var>:</p>
     <ul>
      <li data-md>
       <p>Find the <a data-link-type="dfn" href="#tablepatch" id="ref-for-tablepatch②">TablePatch</a> associated with index <var>i</var>. The object starts at the offset <a data-link-type="dfn" href="#per-table-brotli-patch-patches" id="ref-for-per-table-brotli-patch-patches②">patches[i]</a> (inclusive) and ends at the offset <a data-link-type="dfn" href="#per-table-brotli-patch-patches" id="ref-for-per-table-brotli-patch-patches③">patches[i+1]</a> (exclusive). Both offsets are relative to the start of
the <var>patch</var>.</p>
      <li data-md>
       <p>If an entry in <a data-link-type="dfn" href="#per-table-brotli-patch-patches" id="ref-for-per-table-brotli-patch-patches④">patches</a> was previously applied that has the same <a data-link-type="dfn" href="#tablepatch-tag" id="ref-for-tablepatch-tag">tag</a> as
this entry, then ignore this entry and continue the iteration to the next one. Entries are processed in same order as they
are listed in the <a data-link-type="dfn" href="#per-table-brotli-patch-patches" id="ref-for-per-table-brotli-patch-patches⑤">patches</a> array.</p>
      <li data-md>
       <p>If bit 0 (least significant bit) of <a data-link-type="dfn" href="#tablepatch-flags" id="ref-for-tablepatch-flags">flags</a> is set, then decode <a data-link-type="dfn" href="#tablepatch-brotlistream" id="ref-for-tablepatch-brotlistream①">brotliStream</a> following <a href="https://www.rfc-editor.org/rfc/rfc7932#section-10">Brotli Compressed Data Format § section-10</a>. No shared dictionary is used. Add a <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a> to <var>extended font subset</var> identified by <a data-link-type="dfn" href="#tablepatch-tag" id="ref-for-tablepatch-tag①">tag</a> with it’s contents set to the decoded <a data-link-type="dfn" href="#tablepatch-brotlistream" id="ref-for-tablepatch-brotlistream②">brotliStream</a>.</p>
      <li data-md>
       <p>If bit 1 of <a data-link-type="dfn" href="#tablepatch-flags" id="ref-for-tablepatch-flags①">flags</a> is set, then do not copy or add a <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a> to <var>extended font subset</var> identified by <a data-link-type="dfn" href="#tablepatch-tag" id="ref-for-tablepatch-tag②">tag</a>.</p>
      <li data-md>
       <p>Otherwise, decode <a data-link-type="dfn" href="#tablepatch-brotlistream" id="ref-for-tablepatch-brotlistream③">brotliStream</a> following <a href="https://www.rfc-editor.org/rfc/rfc7932#section-10">Brotli Compressed Data Format § section-10</a> and using the <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a> identified by <a data-link-type="dfn" href="#tablepatch-tag" id="ref-for-tablepatch-tag③">tag</a> in <var>base font subset</var> as a <a href="https://datatracker.ietf.org/doc/html/draft-vandevenne-shared-brotli-format-09#section-3.2">shared LZ77 dictionary</a>. Add a <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a> to <var>extended font subset</var> identified by <a data-link-type="dfn" href="#tablepatch-tag" id="ref-for-tablepatch-tag④">tag</a> with it’s contents set to the decoded <a data-link-type="dfn" href="#tablepatch-brotlistream" id="ref-for-tablepatch-brotlistream④">brotliStream</a>.</p>
     </ul>
    <li data-md>
     <p>For each <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a> in <var>base font subset</var> which has a tag that was not found in any of
the entries processed in step 5, add a copy of that table to <var>extended font subset</var>.</p>
   </ol>
   <h3 class="heading settled" data-level="5.6" id="glyph-keyed"><span class="secno">5.6. </span><span class="content">Glyph Keyed</span><a class="self-link" href="#glyph-keyed"></a></h3>
   <p>A glyph keyed patch contains a collection of data chunks that are each associated with a glyph index and a <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">font table</a>. The encoded data replaces any existing data for that glyph index in the referenced <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a>. Glyph keyed patches can encode data for <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/glyf#">glyf</a>/<a href="https://docs.microsoft.com/en-us/typography/opentype/spec/loca#">loca</a>, <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/gvar#">gvar</a>, <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/cff#">CFF</a>, and <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/cff2#">CFF2</a> tables.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="glyph-keyed-patch">Glyph keyed patch</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>Tag
      <td><dfn class="dfn-paneled" data-dfn-for="Glyph keyed patch" data-dfn-type="dfn" data-noexport id="glyph-keyed-patch-format">format</dfn>
      <td>Identifies the encoding as glyph keyed, set to 'ifgk'
     <tr>
      <td>uint32
      <td>reserved
      <td>Reserved for future use, set to 0.
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Glyph keyed patch" data-dfn-type="dfn" data-noexport id="glyph-keyed-patch-flags">flags</dfn>
      <td>Bit-field. If bit 0 (least significant bit) is set then <a data-link-type="dfn" href="#glyphpatches-glyphids" id="ref-for-glyphpatches-glyphids">glyphIds</a> uses uint24’s, otherwise it uses uint16’s.
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="Glyph keyed patch" data-dfn-type="dfn" data-noexport id="glyph-keyed-patch-id">id</dfn>[4]
      <td>The id of the <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②③">font subset</a> which this patch can be applied too. See <a href="#font-patch-invalidations">§ 5.2 Patch Invalidations</a>.
     <tr>
      <td>uint32
      <td>length
      <td>The uncompressed length of <a data-link-type="dfn" href="#glyph-keyed-patch-brotlistream" id="ref-for-glyph-keyed-patch-brotlistream">brotliStream</a>.
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Glyph keyed patch" data-dfn-type="dfn" data-noexport id="glyph-keyed-patch-brotlistream">brotliStream</dfn>[variable]
      <td>Brotli encoded <a data-link-type="dfn" href="#glyphpatches" id="ref-for-glyphpatches">GlyphPatches</a> table.
   </table>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="glyphpatches">GlyphPatches</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="GlyphPatches" data-dfn-type="dfn" data-noexport id="glyphpatches-glyphcount">glyphCount</dfn>
      <td>The number of glyphs encoded in the patch.
     <tr>
      <td>uint8
      <td>tableCount
      <td>The number of <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">tables</a> the patch has data for.
     <tr>
      <td>uint16/uint24
      <td><dfn class="dfn-paneled" data-dfn-for="GlyphPatches" data-dfn-type="dfn" data-noexport id="glyphpatches-glyphids">glyphIds</dfn>[glyphCount]
      <td>An array of glyph indices included in the patch. Elements are uint24’s if bit 0 (least significant bit) of <a data-link-type="dfn" href="#glyph-keyed-patch-flags" id="ref-for-glyph-keyed-patch-flags">flags</a> is set, otherwise elements are uint16’s.
     <tr>
      <td>Tag
      <td><dfn class="dfn-paneled" data-dfn-for="GlyphPatches" data-dfn-type="dfn" data-noexport id="glyphpatches-tables">tables</dfn>[tableCount]
      <td>An array of <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">tables</a> (by tag) included in the patch.
     <tr>
      <td>Offset32
      <td><dfn class="dfn-paneled" data-dfn-for="GlyphPatches" data-dfn-type="dfn" data-noexport id="glyphpatches-glyphdataoffsets">glyphDataOffsets</dfn>[glyphCount * tableCount + 1]
      <td> An array of offsets of to glyph data for each table. The first <a data-link-type="dfn" href="#glyphpatches-glyphcount" id="ref-for-glyphpatches-glyphcount">glyphCount</a> offsets corresponding to <a data-link-type="dfn" href="#glyphpatches-tables" id="ref-for-glyphpatches-tables">tables[0]</a>, the next <a data-link-type="dfn" href="#glyphpatches-glyphcount" id="ref-for-glyphpatches-glyphcount①">glyphCount</a> offsets (if present) corresponding to <a data-link-type="dfn" href="#glyphpatches-tables" id="ref-for-glyphpatches-tables①">tables[1]</a>, and so on. All offsets are from the start of the <a data-link-type="dfn" href="#glyphpatches" id="ref-for-glyphpatches①">GlyphPatches</a> table.
      Offsets must be sorted in ascending order. 
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="GlyphPatches" data-dfn-type="dfn" data-noexport id="glyphpatches-glyphdata">glyphData</dfn>[variable]
      <td> The actual glyph data picked out by the offsets. 
   </table>
   <p>The difference between two consecutive offsets in the <a data-link-type="dfn" href="#glyphpatches-glyphdataoffsets" id="ref-for-glyphpatches-glyphdataoffsets">glyphDataOffsets</a> array gives the size
of that glyph data.</p>
   <h4 class="heading settled algorithm" data-algorithm="Applying Glyph Keyed Patches" data-level="5.6.1" id="apply-glyph-keyed"><span class="secno">5.6.1. </span><span class="content">Applying Glyph Keyed Patches</span><a class="self-link" href="#apply-glyph-keyed"></a></h4>
   <p>This <a data-link-type="dfn" href="#patch-application-algorithm" id="ref-for-patch-application-algorithm②">patch application algorithm</a> is used to apply a glyph keyed patch to extend a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②④">font subset</a> to cover additional codepoints,
features, and/or design-variation space.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-apply-glyph-keyed-patch">Apply glyph keyed patch</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>base font subset</var>: a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②⑤">font subset</a> which is to be extended.</p>
    <li data-md>
     <p><var>patch</var>: a <a data-link-type="dfn" href="#glyph-keyed-patch" id="ref-for-glyph-keyed-patch">glyph keyed patch</a> to be applied to <var>base font subset</var>.</p>
    <li data-md>
     <p><var>id</var>: The ID number from the 'IFT ' or 'IFTX' table of <var>base font subset</var> which listed this patch.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>extended font subset</var>: a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②⑥">font subset</a> that has been extended by the <var>patch</var>.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Check that the <a data-link-type="dfn" href="#glyph-keyed-patch-format" id="ref-for-glyph-keyed-patch-format">format</a> field in <var>patch</var> is equal to 'ifgk', if it is
not equal, then <var>patch</var> is not correctly formatted and patch application has failed, return
an error.</p>
    <li data-md>
     <p>Check that the <a data-link-type="dfn" href="#glyph-keyed-patch-id" id="ref-for-glyph-keyed-patch-id">id</a> field in <var>patch</var> is equal to <var>id</var>.
If there is no match, or <var>base font subset</var> does not have either an 'IFT ' or 'IFTX' table, then patch application has
failed, return an error.</p>
    <li data-md>
     <p>Decode the brotli encoded data in <a data-link-type="dfn" href="#glyph-keyed-patch-brotlistream" id="ref-for-glyph-keyed-patch-brotlistream①">brotliStream</a> following <a href="https://www.rfc-editor.org/rfc/rfc7932#section-10">Brotli Compressed Data Format § section-10</a>. The
decoded data is a <a data-link-type="dfn" href="#glyphpatches" id="ref-for-glyphpatches②">GlyphPatches</a> table.</p>
    <li data-md>
     <p>For each <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">font table</a> listed in <a data-link-type="dfn" href="#glyphpatches-tables" id="ref-for-glyphpatches-tables②">tables</a>, with index <code>i</code>:</p>
     <ul>
      <li data-md>
       <p>Using the corresponding table in <var>base font subset</var>, synthesize
a new table where the data for each glyph is replaced with the data corresponding to that glyph index
from <a data-link-type="dfn" href="#glyphpatches-glyphdata" id="ref-for-glyphpatches-glyphdata">glyphData</a> if present, otherwise copied from the corresponding table in <var>base font subset</var> for
that glyph index.</p>
      <li data-md>
       <p>The patch glyph data for a glyph index is located by finding <a data-link-type="dfn" href="#glyphpatches-glyphids" id="ref-for-glyphpatches-glyphids①">glyphIds[j]</a> equal to the glyph index. The
offset to the associated glyph data is <a data-link-type="dfn" href="#glyphpatches-glyphdataoffsets" id="ref-for-glyphpatches-glyphdataoffsets①">glyphDataOffsets[i * glyphCount + j]</a>. The length
of the associated glyph data is <a data-link-type="dfn" href="#glyphpatches-glyphdataoffsets" id="ref-for-glyphpatches-glyphdataoffsets②">glyphDataOffsets[i * glyphCount + j + 1]</a> minus <a data-link-type="dfn" href="#glyphpatches-glyphdataoffsets" id="ref-for-glyphpatches-glyphdataoffsets③">glyphDataOffsets[i * glyphCount + j]</a>.</p>
      <li data-md>
       <p>The specific process for synthesizing the new table, depends on the specified format of the <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a>. Any non-glyph associated data should be copied from the table in <var>base font subset</var>. Tables of the type <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/glyf#">glyf</a>/<a href="https://docs.microsoft.com/en-us/typography/opentype/spec/loca#">loca</a>, <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/gvar#">gvar</a>, <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/cff#">CFF</a>, or <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/cff2#">CFF2</a> are supported. Entries for tables
of any other types must be ignored.</p>
      <li data-md>
       <p>If <var>base font subset</var> does not have a matching table, return an error.</p>
      <li data-md>
       <p>Insert the synthesized table into <var>extended font subset</var>.</p>
     </ul>
    <li data-md>
     <p>For each <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a> in <var>base font subset</var> which has a tag that was not found in any of
the entries processed in step 4, add a copy of that table to <var>extended font subset</var>.</p>
    <li data-md>
     <p>Modify the mappings in the 'IFT ' or 'IFTX' table which has an <a data-link-type="dfn" href="#glyph-keyed-patch-id" id="ref-for-glyph-keyed-patch-id①">id</a> which matches <var>id</var> to remove any
entries that map to this patch. The entries to be removed can be determined by finding entries which have a URI that matches the
URI associated with this patch (see: <a href="#patch-map">§ 4.2 Patch Map Table</a>). For <a href="#patch-map-format-1">§ 4.2.1 Patch Map Table: Format 1</a> entries are removed by setting the appropriate
bit in <a data-link-type="dfn" href="#format-1-patch-map-appliedentriesbitmap" id="ref-for-format-1-patch-map-appliedentriesbitmap②">appliedEntriesBitMap</a>. For <a href="#patch-map-format-2">§ 4.2.2 Patch Map Table: Format 2</a> entries are removed by setting the "ignored" bit
in the entry’s <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①⑨">formatFlags</a>.</p>
    <li data-md>
     <p>If the contents of any <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">fonts table</a> was modified during the previous steps then,
for each modified table: update the checksums in the <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">fonts table directory</a> to match the table’s
new contents.</p>
   </ol>
   <h2 class="heading settled algorithm" data-algorithm="Extending a Font Subset" data-level="6" id="extending-font-subset"><span class="secno">6. </span><span class="content">Extending a Font Subset</span><a class="self-link" href="#extending-font-subset"></a></h2>
   <p>This sections defines the algorithm that a client uses to extend an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font">incremental</a> <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②⑦">font subset</a> to cover additional
codepoints, layout features and/or design space.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-extend-a-font-subset">Extend a Font Subset</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>font subset</var>: an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font①">incremental</a> <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②⑧">font subset</a>.</p>
    <li data-md>
     <p><var>font subset URI</var>: an <a href="https://www.rfc-editor.org/rfc/rfc3986#section-4.3">abslolute URI</a> which identifies the location of <var>font subset</var>.</p>
    <li data-md>
     <p><var>target subset definition</var>: the <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition⑥">font subset definition</a> that the client wants to extend <var>font subset</var> to cover.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>extended font subset</var>: an extended version of <var>font subset</var>. May or may not be an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font②">incremental font</a>.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Set <var>extended font subset</var> to <var>font subset</var>.</p>
    <li data-md>
     <p>Load the 'IFT ' and 'IFTX' (if present) mapping <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">tables</a> from <var>extended font subset</var>. Both
tables are formatted as a <a href="#patch-map">§ 4.2 Patch Map Table</a>. Check that they are valid according to the requirements in <a href="#patch-map">§ 4.2 Patch Map Table</a>. If either table
is not valid, invoke <a data-link-type="abstract-op" href="#abstract-opdef-handle-errors" id="ref-for-abstract-opdef-handle-errors">Handle errors</a>. If <var>extended font subset</var> does not have an 'IFT ' table, then it is not an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font③">incremental font</a> and cannot be extended, return <var>extended font subset</var>.</p>
    <li data-md>
     <p>For each of <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">tables</a> 'IFT ' and 'IFTX' (if present): convert the table into a list of entries by
invoking <a data-link-type="abstract-op" href="#abstract-opdef-interpret-format-1-patch-map" id="ref-for-abstract-opdef-interpret-format-1-patch-map">Interpret Format 1 Patch Map</a> or <a data-link-type="abstract-op" href="#abstract-opdef-interpret-format-2-patch-map" id="ref-for-abstract-opdef-interpret-format-2-patch-map">Interpret Format 2 Patch Map</a>. Concatenate the returned entry lists into a single list, <var>entry list</var>.</p>
    <li data-md>
     <p>For each <var>entry</var> in <var>entry list</var> invoke <a data-link-type="abstract-op" href="#abstract-opdef-check-entry-intersection" id="ref-for-abstract-opdef-check-entry-intersection">Check entry intersection</a> with <var>entry</var> and <var>target subset definition</var> as inputs, if it returns false remove <var>entry</var> from <var>entry list</var>.</p>
    <li data-md>
     <p>If <var>entry list</var> is empty, then the extension operation is finished, return <var>extended font subset</var>.</p>
    <li data-md>
     <p>Pick one <var>entry</var> from <var>entry list</var> with the following procedure:</p>
     <ul>
      <li data-md>
       <p>If <var>entry list</var> contains one or more <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries⑦">patch map entries</a> which have a patch format that is <a data-link-type="dfn" href="#full-invalidation" id="ref-for-full-invalidation②">Full Invalidation</a> then, select exactly one of the <a data-link-type="dfn" href="#full-invalidation" id="ref-for-full-invalidation③">Full Invalidation</a> entries in <var>entry list</var>. The criteria for selecting the single
entry is left up to the implementation to decide.</p>
      <li data-md>
       <p>Otherwise if <var>entry list</var> contains one or more <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries⑧">patch map entries</a> which have a patch format that is <a data-link-type="dfn" href="#partial-invalidation" id="ref-for-partial-invalidation②">Partial Invalidation</a> then, select exactly one of the <a data-link-type="dfn" href="#partial-invalidation" id="ref-for-partial-invalidation③">Partial Invalidation</a> entries in <var>entry list</var>.
The criteria for selecting the single entry is left up to the implementation to decide.</p>
      <li data-md>
       <p>Otherwise select exactly one of the <a data-link-type="dfn" href="#no-invalidation" id="ref-for-no-invalidation①">No Invalidation</a> entries in <var>entry list</var>.
The criteria for selecting the single entry is left up to the implementation to decide.</p>
     </ul>
    <li data-md>
     <p>Load <var>patch file</var> by invoking <a data-link-type="abstract-op" href="#abstract-opdef-load-patch-file" id="ref-for-abstract-opdef-load-patch-file">Load patch file</a> with the <var>font subset URI</var> as the incremental font URI and the <var>entry</var> patch URI as the patch URI.</p>
    <li data-md>
     <p>Apply <var>patch file</var> using the appropriate application algorithm (matching the patches format in <var>entry</var>) from <a href="#font-patch-formats">§ 5 Font Patch Formats</a> to apply the <var>patch file</var> using the id from <var>entry</var> to <var>extended font subset</var>.</p>
    <li data-md>
     <p>Go to step 2.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> the algorithm here presents patch loads as being done one at a time; however, to improve performance client implementations are
encouraged to pre-fetch patch files that will be applied in later iterations by the algorithm. The <a href="#font-patch-invalidations">invalidation categories</a> can be used to predict which intersecting patches from step 4 will remain be valid
to be applied.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-check-entry-intersection">Check entry intersection</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>mapping entry</var>: a <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries⑨">patch map entry</a>.</p>
    <li data-md>
     <p><var>subset definition</var>: a <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition⑦">font subset definition</a>.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>intersects</var>: true if <var>subset definition</var> intersects <var>mapping entry</var>, otherwise false.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>For each set in <var>subset definition</var> (codepoints, feature tags, design space) check if the set intersects
 the corresponding set from <var>mapping entry</var>. A set intersects when:</p>
     <table>
      <tbody>
       <tr>
        <th>
        <th>subset definition set is empty
        <th>subset definition set is not empty
       <tr>
        <th>mapping entry set is empty
        <td>true
        <td>true
       <tr>
        <th>mapping entry set is not empty
        <td>false
        <td>true if the two sets intersect
     </table>
    <li data-md>
     <p>If all sets checked in step 1 intersect, then return true for <var>intersects</var> otherwise false.</p>
   </ol>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-load-patch-file">Load patch file</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>Patch URI</var>: A <a href="https://www.rfc-editor.org/rfc/rfc3986#section-4.1">URI Reference</a> identifying the patch file to load. As a URI reference this may be a
 relative path.</p>
    <li data-md>
     <p><var>Incremental Font URI</var>: An <a href="https://www.rfc-editor.org/rfc/rfc3986#section-4.3">abslolute URI</a> which identifies the incremental font which contains
 the reference to <var>Patch URI</var>.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>patch file</var>: the content (bytes) identified by <var>Patch URI</var>.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Perform <a href="https://www.rfc-editor.org/rfc/rfc3986#section-5">reference resolution</a> on <var>Patch URI</var> using <var>Incremental Font URI</var> as the base URI to
 produce the <var>target URI</var>.</p>
    <li data-md>
     <p>Retrieve the contents of <var>target URI</var> using the fetching capabilities of the implementing user agent. For web browsers, <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[fetch]</a> should be used. Return the retrieved contents as <var>patch file</var>, or an error if the fetch resulted in an error.</p>
   </ol>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-handle-errors">Handle errors</dfn></p>
   <p>Coming soon.</p>
   <h3 class="heading settled algorithm" data-algorithm="Fully Expanding a Font" data-level="6.1" id="fully-expanding-a-font"><span class="secno">6.1. </span><span class="content">Fully Expanding a Font</span><a class="self-link" href="#fully-expanding-a-font"></a></h3>
   <p>This sections defines an algorithm that can be used to transform an incremental font into a fully expanded non-incremental font. This
process loads all available data provided by the incremental font and produces a single static font file that contains no further
patches to be applied.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-fully-expand-a-font-subset">Fully Expand a Font Subset</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>font subset</var>: an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font④">incremental</a> <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②⑨">font subset</a>.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>expanded font</var>: an <a data-link-type="biblio" href="#biblio-open-type" title="OpenType Specification">[open-type]</a> font that is not incremental.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Invoke <a data-link-type="abstract-op" href="#abstract-opdef-extend-a-font-subset" id="ref-for-abstract-opdef-extend-a-font-subset">Extend a Font Subset</a> with <var>font subset</var>. The input target subset definition is a special one which
is considered to intersect all entries in the <a data-link-type="abstract-op" href="#abstract-opdef-check-entry-intersection" id="ref-for-abstract-opdef-check-entry-intersection①">Check entry intersection</a> step. Return the resulting font subset as
the <var>expanded font</var>.</p>
   </ol>
   <h2 class="heading settled" data-level="7" id="encoder"><span class="secno">7. </span><span class="content">Encoder</span><a class="self-link" href="#encoder"></a></h2>
   <p>An encoder is a tool which produces an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font⑤">incremental font</a> and set of associated <a data-link-type="dfn" href="#font-patch" id="ref-for-font-patch②">patches</a>.
The <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font⑥">incremental font</a> and associated patches produced by a compliant encoder:</p>
   <ol>
    <li data-md>
     <p>Must meet all of the requirements in <a href="#font-format-extensions">§ 4 Extensions to the Font Format</a> and <a href="#font-patch-formats">§ 5 Font Patch Formats</a>.</p>
    <li data-md>
     <p>Must be consistent, that is: for any possible <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition⑧">font subset definition</a> the result of invoking <a data-link-type="abstract-op" href="#abstract-opdef-extend-a-font-subset" id="ref-for-abstract-opdef-extend-a-font-subset①">Extend a Font Subset</a> with that subset definition and the <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font⑦">incremental font</a> must always be the same regardless of the particular order
of patch selection chosen in step 6 of <a data-link-type="abstract-op" href="#abstract-opdef-extend-a-font-subset" id="ref-for-abstract-opdef-extend-a-font-subset②">Extend a Font Subset</a>.</p>
    <li data-md>
     <p>Should preserve the functionality of the fully expanded font, that is:
 given the <a data-link-type="abstract-op" href="#abstract-opdef-fully-expand-a-font-subset" id="ref-for-abstract-opdef-fully-expand-a-font-subset①">fully expanded font</a> derived from the <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font⑧">incremental font</a> and any content, then the <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset③⓪">font subset</a> produced by invoking <a data-link-type="abstract-op" href="#abstract-opdef-extend-a-font-subset" id="ref-for-abstract-opdef-extend-a-font-subset③">Extend a Font Subset</a> with the <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font⑨">incremental font</a> and the minimal subset definition covering that content should
 render identically to the fully expanded font for that content.</p>
    <li data-md>
     <p>When an encoder is used to transform an existing font into an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font①⓪">incremental font</a> the associated <a data-link-type="abstract-op" href="#abstract-opdef-fully-expand-a-font-subset" id="ref-for-abstract-opdef-fully-expand-a-font-subset②">fully expanded font</a> should be equivalent to the existing font. An equivalent fully expanded font
 should have all of the same <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">tables</a> as the existing font (excluding the incremental IFT/IFTX
 tables) and each of those tables should be functionally equivalent to the corresponding table in the existing font. Note: the fully
 expanded may not always be an exact binary match with the existing font.</p>
   </ol>
   <p>When an encoder is used to transform an existing font file into and <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font①①">incremental font</a> and a client is implemented according to the
other sections of this document, the intent of the IFT specification is that appearance and behavior of the font in the client will be the
same as if the entire file were transferred to the client. A primary goal of the IFT specification is that the IFT format and protocol can
serve as a neutral medium for font transfer, comparable to WOFF2. If an encoder produces an encoding from a source font which meets all of
the above requirements (1. through 4.), then the encoding will preserve all of the functionality of the original font.</p>
   <p>This may be important for cases where a foundry or other rights-owner of a font wants be confident that the encoding and transfer of that
font using IFT will not change its behavior and therefore the intent of the font’s creators. Licenses or contracts might then include
requirements about IFT conformance, and situations in which re-encoding a font in WOFF2 format is de facto permissible due to its
content-neutrality might also permit IFT encoding of that font.</p>
   <p>However, nothing about these requirements on encoding conformance is meant to rule out or deprecate the possibility and practical use of
encodings that do not preserve all of the functionality of a source font. Any encoding meeting the minimum requirements (1. and 2. above)
is valid and may have an appropriate use. Under some circumstances it might be desirable for an encoded font to omit support for some
functionality/data from all of its patch files even if those were included in the original font file. In other cases a font might be
directly encoded into the IFT format from font authoring source files.</p>
   <h3 class="heading settled" data-level="7.1" id="encoder-considerations"><span class="secno">7.1. </span><span class="content">Encoder Considerations</span><a class="self-link" href="#encoder-considerations"></a></h3>
   <p><em>This section is not normative.</em></p>
   <p>The details of the encoding process may differ by encoder and are beyond the scope of this document. However, this section provides
guidance that encoder implementations may want to consider.</p>
   <p><b>Utilize an existing font subsetter implementation</b></p>
   <p>As discussed in <a href="#encoder">§ 7 Encoder</a> a high quality encoder should preserve the functionality of the original font. One way to
achieve this is to leverage an existing font subsetter implementation to produce font subsets that retain the functionality
of the original font. The IFT patches can then be derived from these subsets.</p>
   <p>A font subsetter produces a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset③①">font subset</a> from an input font based on a desired <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition⑨">font subset definition</a>. The practice of reliably
subsetting a font is well understood and has multiple open-source implementations (a full formal description is
beyond the scope of this document). It typically involves a reachability analysis, where the data in tables is examined
relative to the font subset definition to see which portions can be reached by any possible content covered by the subset definition.
Any reachable data is retained in the generated font subset, while any unreachable data may be removed.</p>
   <p>In the following example psuedo code a font subsetter is used to generate an IFT encoded font that utilizes only brotli patches:</p>
<pre># Encodes a font (full_font) into an incremental font that starts at base_subset_def
# and can incrementally add any of subset_definitions. Returns the IFT encoded font
# and set of associated patches.
encode_as_ift(full_font, base_subset_def, subset_definitions):
  base_font = subset(full_font, base_subset_def)
  base_font, patches  = encode_node(full_font, base_font, base_subset_def, subset_definitions)
  return base_font, patches

# Update base_font to add all of the ift patch mappings to reach any of
# subset_definitions and produces the associated patches.
encode_node(full_font, base_font, cur_def, subset_definitions):
  patches = []
  next_fonts = []
  
  for each subset_def in subset_definitions not fully covered by cur_def:
    next_def = subset_def union cur_def
    next_font = subset(full_font, next_def)
    let patch_url be a new unique url

    add a mapping from, (subset_def - cur_def) to patch_url, into base_font
    next_font, patches += encode_node(full_font, next_font, next_def, subset_definitions)

    next_fonts += (next_font, next_def, patch_url)

  for each (next_font, next_def, patch_url) in next_fonts:
    patch = brotli_patch_diff(base_font, next_font)
    patches += (patch, patch_url)
  
  return base_font, patches
</pre>
   <p>In this example implementation if the union of the input base subset definition and the list of subset definitions fully covers the input
full font, and the subsetter implementation used correctly retains all functionality then, the above implementation should meet the
requirements in <a href="#encoder">§ 7 Encoder</a> to be a neutral encoding. This basic encoder implementation is for demonstration purposes and not meant
to be representative of all possible encoder implementations. Notably it does not make use of nor demonstrate utilizing glyph keyed
patches. Most encoders will likely be more complex and need to consider additional factors some of which are discussed in the remaining
sections.</p>
   <p><b>Choosing segmentations</b></p>
   <p>One of the most important and complex decisions an encoder needs to make is how to segment the data in the encoded font. To maximize
efficiency the encoder should try and group data (eg. codepoints) that are commonly used together into the same segments. This will
reduce the amount of unneeded data load by clients when extending the font. The encoder must also decide the size of segments. Smaller
segments will produce more patches, and thus incur more overhead by requiring more network requests, but will typically result in less
unneeded data in each segment compared to larger segments. When segmenting codepoints, data on codepoint usage frequency can be helpful
to guide segmentation.</p>
   <p>During segmentation an encoder should also consider how codepoints interact with each other in the font. Keeping interacting codepoints
in the same segment can avoid having to duplicate data between patches, which may be necessary to preserve the functionality of the
original font when interacting codepoints reside in different segments.</p>
   <p><b>Patches can form graphs</b></p>
   <p>Brotli based patches can modify the mapping table in the current font subset, which allows a patch to update the mapping table
to point to a different set of patches which are valid against the result of the patch application. This allows a graph to be formed
where a font subset is the node and each patch is an edge.</p>
   <p><b>Choosing patch formats</b></p>
   <p>An encoder must choose the appropriate patch type to use. Brotli patches allow all types of data in the font to be patched, while
glyph keyed patches are limited to updating outline and variation delta data. However, using brotli patches can cause the number of
patches to increase exponentially as the number of segments increases.  Glyph keyed patches on the other hand scale linearly with the
number of segments.</p>
   <p>Brotli patches are most useful when a font has sizable non-outline data and requires only a small number of segments. Glyph keyed
patches are most useful when a fonts data is primarily in the outline tables and the font would benefit from using a large segment count.</p>
   <p>Using per-table brotli patches and two mapping tables it becomes possible to mix both brotli and glyph keyed patching in the same
incremental font. This can be accomplished by:</p>
   <ol>
    <li data-md>
     <p>Keep all brotli patch entries in one mapping table and all glyph keyed entries in the other mapping table.</p>
    <li data-md>
     <p>Use per-table brotli patches to update all tables except for the tables touched by the glyph keyed patches (outline,
variation deltas, and the glyph keyed patch mapping table). These patches should use a small number of large segments to keep
the patch count reasonable.</p>
    <li data-md>
     <p>Lastly, use glyph keyed patches to update the remaining tables, here much smaller fine-grained segments can be utilized without
required too many patches.</p>
   </ol>
   <p><b>Managing the number of patches</b></p>
   <h2 class="no-num heading settled" id="priv"><span class="content">Privacy Considerations</span><a class="self-link" href="#priv"></a></h2>
   <p>Coming soon.</p>
   <h2 class="no-num heading settled" id="sec"><span class="content">Security Considerations</span><a class="self-link" href="#sec"></a></h2>
   <p>Coming soon.</p>
   <h2 class="no-num heading settled" id="changes"><span class="content">Changes</span><a class="self-link" href="#changes"></a></h2>
   <p>Since the <a href="https://www.w3.org/TR/2023/WD-IFT-20230530/">Working
  Draft of 30 May 2023</a> (see <a href="https://github.com/w3c/IFT/commits/main/Overview.bs">commit history</a>):</p>
   <ul>
    <li>Complete rewrite of the specification. Separate 'Patch Subset' and 'Range Request' methods have been removed in favour
      of a single unified approach.
   </ul>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
   <section>
    <h3 class="no-ref no-num heading settled" id="w3c-conformant-algorithms"><span class="content">Conformant Algorithms</span><a class="self-link" href="#w3c-conformant-algorithms"></a></h3>
    <p>Requirements phrased in the imperative as part of algorithms
    (such as "strip any leading space characters"
    or "return false and abort these steps")
    are to be interpreted with the meaning of the key word
    ("must", "should", "may", etc)
    used in introducing the algorithm. </p>
    <p>Conformance requirements phrased as algorithms or specific steps
    can be implemented in any manner,
    so long as the end result is equivalent.
    In particular, the algorithms defined in this specification
    are intended to be easy to understand
    and are not intended to be performant.
    Implementers are encouraged to optimize. </p>
   </section>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#format-1-patch-map-appliedentriesbitmap">appliedEntriesBitMap</a><span>, in § 4.2.1</span>
   <li><a href="#abstract-opdef-apply-brotli-patch">Apply brotli patch</a><span>, in § 5.4.1</span>
   <li><a href="#abstract-opdef-apply-glyph-keyed-patch">Apply glyph keyed patch</a><span>, in § 5.6.1</span>
   <li><a href="#abstract-opdef-apply-per-table-brotli-patch">Apply per table brotli patch</a><span>, in § 5.5.1</span>
   <li><a href="#mapping-entry-bias">bias</a><span>, in § 4.2.2</span>
   <li><a href="#branch-factor-encoding">Branch Factor Encoding</a><span>, in § 4.2.2.2</span>
   <li><a href="#brotli-patch">Brotli patch</a><span>, in § 5.4</span>
   <li>
    brotliStream
    <ul>
     <li><a href="#brotli-patch-brotlistream">dfn for Brotli patch</a><span>, in § 5.4</span>
     <li><a href="#glyph-keyed-patch-brotlistream">dfn for Glyph keyed patch</a><span>, in § 5.6</span>
     <li><a href="#tablepatch-brotlistream">dfn for TablePatch</a><span>, in § 5.5</span>
    </ul>
   <li><a href="#abstract-opdef-check-entry-intersection">Check entry intersection</a><span>, in § 6</span>
   <li><a href="#mapping-entry-codepoints">codepoints</a><span>, in § 4.2.2</span>
   <li><a href="#mapping-entry-copycount">copyCount</a><span>, in § 4.2.2</span>
   <li><a href="#mapping-entry-copyindices">copyIndices</a><span>, in § 4.2.2</span>
   <li><a href="#abstract-opdef-decoding-sparse-bit-set-treedata">Decoding sparse bit set treeData</a><span>, in § 4.2.2.2</span>
   <li><a href="#format-2-patch-map-defaultpatchencoding">defaultPatchEncoding</a><span>, in § 4.2.2</span>
   <li><a href="#mapping-entry-designspacecount">designSpaceCount</a><span>, in § 4.2.2</span>
   <li><a href="#design-space-segment">Design Space Segment</a><span>, in § 4.2.2</span>
   <li><a href="#mapping-entry-designspacesegments">designSpaceSegments</a><span>, in § 4.2.2</span>
   <li><a href="#design-space-segment-end">end</a><span>, in § 4.2.2</span>
   <li>
    entries
    <ul>
     <li><a href="#format-2-patch-map-entries">dfn for Format 2 Patch Map</a><span>, in § 4.2.2</span>
     <li><a href="#mapping-entries-entries">dfn for Mapping Entries</a><span>, in § 4.2.2</span>
    </ul>
   <li>
    entryCount
    <ul>
     <li><a href="#format-1-patch-map-entrycount">dfn for Format 1 Patch Map</a><span>, in § 4.2.1</span>
     <li><a href="#format-2-patch-map-entrycount">dfn for Format 2 Patch Map</a><span>, in § 4.2.2</span>
    </ul>
   <li><a href="#mapping-entry-entryiddelta">entryIdDelta</a><span>, in § 4.2.2</span>
   <li><a href="#format-2-patch-map-entryidstringdata">entryIdStringData</a><span>, in § 4.2.2</span>
   <li><a href="#mapping-entry-entryidstringlength">entryIdStringLength</a><span>, in § 4.2.2</span>
   <li><a href="#glyph-map-entryindex">entryIndex</a><span>, in § 4.2.1</span>
   <li><a href="#featurerecord-entrymapcount">entryMapCount</a><span>, in § 4.2.1</span>
   <li><a href="#entrymaprecord">EntryMapRecord</a><span>, in § 4.2.1</span>
   <li><a href="#feature-map-entrymaprecords">entryMapRecords</a><span>, in § 4.2.1</span>
   <li><a href="#abstract-opdef-extend-a-font-subset">Extend a Font Subset</a><span>, in § 6</span>
   <li><a href="#mapping-entry-featurecount">featureCount</a><span>, in § 4.2.2</span>
   <li><a href="#feature-map">Feature Map</a><span>, in § 4.2.1</span>
   <li><a href="#featurerecord">FeatureRecord</a><span>, in § 4.2.1</span>
   <li><a href="#feature-map-featurerecords">featureRecords</a><span>, in § 4.2.1</span>
   <li><a href="#featurerecord-featuretag">featureTag</a><span>, in § 4.2.1</span>
   <li><a href="#mapping-entry-featuretags">featureTags</a><span>, in § 4.2.2</span>
   <li>
    firstEntryIndex
    <ul>
     <li><a href="#entrymaprecord-firstentryindex">dfn for EntryMapRecord</a><span>, in § 4.2.1</span>
     <li><a href="#featurerecord-firstentryindex">dfn for FeatureRecord</a><span>, in § 4.2.1</span>
    </ul>
   <li><a href="#glyph-map-firstmappedglyph">firstMappedGlyph</a><span>, in § 4.2.1</span>
   <li>
    flags
    <ul>
     <li><a href="#glyph-keyed-patch-flags">dfn for Glyph keyed patch</a><span>, in § 5.6</span>
     <li><a href="#tablepatch-flags">dfn for TablePatch</a><span>, in § 5.5</span>
    </ul>
   <li><a href="#font-patch">font patch</a><span>, in § 5.1</span>
   <li><a href="#font-subset">font subset</a><span>, in § 3.1</span>
   <li><a href="#font-subset-definition">font subset definition</a><span>, in § 3.1</span>
   <li>
    format
    <ul>
     <li><a href="#brotli-patch-format">dfn for Brotli patch</a><span>, in § 5.4</span>
     <li><a href="#format-1-patch-map-format">dfn for Format 1 Patch Map</a><span>, in § 4.2.1</span>
     <li><a href="#format-2-patch-map-format">dfn for Format 2 Patch Map</a><span>, in § 4.2.2</span>
     <li><a href="#glyph-keyed-patch-format">dfn for Glyph keyed patch</a><span>, in § 5.6</span>
     <li><a href="#per-table-brotli-patch-format">dfn for Per table brotli patch</a><span>, in § 5.5</span>
    </ul>
   <li><a href="#format-1-patch-map">Format 1 Patch Map</a><span>, in § 4.2.1</span>
   <li><a href="#format-2-patch-map">Format 2 Patch Map</a><span>, in § 4.2.2</span>
   <li><a href="#mapping-entry-formatflags">formatFlags</a><span>, in § 4.2.2</span>
   <li><a href="#full-invalidation">Full Invalidation</a><span>, in § 5.2</span>
   <li><a href="#abstract-opdef-fully-expand-a-font-subset">Fully Expand a Font Subset</a><span>, in § 6.1</span>
   <li>
    glyphCount
    <ul>
     <li><a href="#format-1-patch-map-glyphcount">dfn for Format 1 Patch Map</a><span>, in § 4.2.1</span>
     <li><a href="#glyphpatches-glyphcount">dfn for GlyphPatches</a><span>, in § 5.6</span>
    </ul>
   <li><a href="#glyphpatches-glyphdata">glyphData</a><span>, in § 5.6</span>
   <li><a href="#glyphpatches-glyphdataoffsets">glyphDataOffsets</a><span>, in § 5.6</span>
   <li><a href="#glyphpatches-glyphids">glyphIds</a><span>, in § 5.6</span>
   <li><a href="#glyph-keyed-patch">Glyph keyed patch</a><span>, in § 5.6</span>
   <li><a href="#glyph-map">Glyph Map</a><span>, in § 4.2.1</span>
   <li><a href="#glyphpatches">GlyphPatches</a><span>, in § 5.6</span>
   <li><a href="#abstract-opdef-handle-errors">Handle errors</a><span>, in § 6</span>
   <li>
    id
    <ul>
     <li><a href="#brotli-patch-id">dfn for Brotli patch</a><span>, in § 5.4</span>
     <li><a href="#format-1-patch-map-id">dfn for Format 1 Patch Map</a><span>, in § 4.2.1</span>
     <li><a href="#format-2-patch-map-id">dfn for Format 2 Patch Map</a><span>, in § 4.2.2</span>
     <li><a href="#glyph-keyed-patch-id">dfn for Glyph keyed patch</a><span>, in § 5.6</span>
     <li><a href="#per-table-brotli-patch-id">dfn for Per table brotli patch</a><span>, in § 5.5</span>
    </ul>
   <li><a href="#incremental-font">incremental font</a><span>, in § 4</span>
   <li><a href="#abstract-opdef-interpret-format-1-patch-map">Interpret Format 1 Patch Map</a><span>, in § 4.2.1.1</span>
   <li><a href="#abstract-opdef-interpret-format-2-patch-map">Interpret Format 2 Patch Map</a><span>, in § 4.2.2.1</span>
   <li><a href="#abstract-opdef-interpret-format-2-patch-map-entry">Interpret Format 2 Patch Map Entry</a><span>, in § 4.2.2.1</span>
   <li><a href="#entrymaprecord-lastentryindex">lastEntryIndex</a><span>, in § 4.2.1</span>
   <li><a href="#abstract-opdef-load-patch-file">Load patch file</a><span>, in § 6</span>
   <li><a href="#mapping-entries">Mapping Entries</a><span>, in § 4.2.2</span>
   <li><a href="#mapping-entry">Mapping Entry</a><span>, in § 4.2.2</span>
   <li><a href="#no-invalidation">No Invalidation</a><span>, in § 5.2</span>
   <li><a href="#partial-invalidation">Partial Invalidation</a><span>, in § 5.2</span>
   <li><a href="#patch-application-algorithm">patch application algorithm</a><span>, in § 5.1</span>
   <li>
    patchEncoding
    <ul>
     <li><a href="#format-1-patch-map-patchencoding">dfn for Format 1 Patch Map</a><span>, in § 4.2.1</span>
     <li><a href="#mapping-entry-patchencoding">dfn for Mapping Entry</a><span>, in § 4.2.2</span>
    </ul>
   <li><a href="#per-table-brotli-patch-patches">patches</a><span>, in § 5.5</span>
   <li><a href="#patch-format">patch format</a><span>, in § 5.1</span>
   <li><a href="#patch-map-entries">patch map entries</a><span>, in § 4.2</span>
   <li><a href="#per-table-brotli-patch">Per table brotli patch</a><span>, in § 5.5</span>
   <li><a href="#sparse-bit-set">Sparse Bit Set</a><span>, in § 4.2.2.2</span>
   <li><a href="#design-space-segment-start">start</a><span>, in § 4.2.2</span>
   <li><a href="#tablepatch">TablePatch</a><span>, in § 5.5</span>
   <li><a href="#glyphpatches-tables">tables</a><span>, in § 5.6</span>
   <li>
    tag
    <ul>
     <li><a href="#design-space-segment-tag">dfn for Design Space Segment</a><span>, in § 4.2.2</span>
     <li><a href="#tablepatch-tag">dfn for TablePatch</a><span>, in § 5.5</span>
    </ul>
   <li>
    uriTemplate
    <ul>
     <li><a href="#format-1-patch-map-uritemplate">dfn for Format 1 Patch Map</a><span>, in § 4.2.1</span>
     <li><a href="#format-2-patch-map-uritemplate">dfn for Format 2 Patch Map</a><span>, in § 4.2.2</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-css-fonts-4">[CSS-FONTS-4]
   <dd>Chris Lilley. <a href="https://drafts.csswg.org/css-fonts-4/"><cite>CSS Fonts Module Level 4</cite></a>. URL: <a href="https://drafts.csswg.org/css-fonts-4/">https://drafts.csswg.org/css-fonts-4/</a>
   <dt id="biblio-iso14496-22">[ISO14496-22]
   <dd><a href="https://www.iso.org/standard/87621.html"><cite>Information technology — Coding of audio-visual objects — Part 22: Open Font Format</cite></a>. Under development. URL: <a href="https://www.iso.org/standard/87621.html">https://www.iso.org/standard/87621.html</a>
   <dt id="biblio-open-type">[OPEN-TYPE]
   <dd><a href="https://docs.microsoft.com/en-us/typography/opentype/spec"><cite>OpenType Specification</cite></a>. December 2021. Note. URL: <a href="https://docs.microsoft.com/en-us/typography/opentype/spec">https://docs.microsoft.com/en-us/typography/opentype/spec</a>
   <dt id="biblio-pfe-report">[PFE-report]
   <dd>Chris Lilley. <a href="https://www.w3.org/TR/PFE-evaluation/"><cite>Progressive Font Enrichment: Evaluation Report</cite></a>. 15 October 2020. Note. URL: <a href="https://www.w3.org/TR/PFE-evaluation/">https://www.w3.org/TR/PFE-evaluation/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-rfc3986">[RFC3986]
   <dd>T. Berners-Lee; R. Fielding; L. Masinter. <a href="https://www.rfc-editor.org/rfc/rfc3986"><cite>Uniform Resource Identifier (URI): Generic Syntax</cite></a>. January 2005. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc3986">https://www.rfc-editor.org/rfc/rfc3986</a>
   <dt id="biblio-rfc6570">[RFC6570]
   <dd>J. Gregorio; et al. <a href="https://www.rfc-editor.org/rfc/rfc6570"><cite>URI Template</cite></a>. March 2012. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc6570">https://www.rfc-editor.org/rfc/rfc6570</a>
   <dt id="biblio-rfc7932">[RFC7932]
   <dd>J. Alakuijala; Z. Szabadka. <a href="https://www.rfc-editor.org/rfc/rfc7932"><cite>Brotli Compressed Data Format</cite></a>. July 2016. Informational. URL: <a href="https://www.rfc-editor.org/rfc/rfc7932">https://www.rfc-editor.org/rfc/rfc7932</a>
   <dt id="biblio-shared-brotli">[Shared-Brotli]
   <dd>J. Alakuijala; et al. <a href="https://datatracker.ietf.org/doc/html/draft-vandevenne-shared-brotli-format-09"><cite>Shared Brotli Compressed Data Format</cite></a>. 27 Jul 2021. Internet Draft. URL: <a href="https://datatracker.ietf.org/doc/html/draft-vandevenne-shared-brotli-format-09">https://datatracker.ietf.org/doc/html/draft-vandevenne-shared-brotli-format-09</a>
   <dt id="biblio-unicode">[UNICODE]
   <dd><a href="https://www.unicode.org/versions/latest/"><cite>The Unicode Standard</cite></a>. URL: <a href="https://www.unicode.org/versions/latest/">https://www.unicode.org/versions/latest/</a>
   <dt id="biblio-utf-8">[UTF-8]
   <dd>F. Yergeau. <a href="https://www.rfc-editor.org/rfc/rfc3629"><cite>UTF-8, a transformation format of ISO 10646</cite></a>. November 2003. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc3629">https://www.rfc-editor.org/rfc/rfc3629</a>
   <dt id="biblio-woff2">[WOFF2]
   <dd>Vladimir Levantovsky; Raph Levien. <a href="https://w3c.github.io/woff/woff2/"><cite>WOFF File Format 2.0</cite></a>. URL: <a href="https://w3c.github.io/woff/woff2/">https://w3c.github.io/woff/woff2/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-fetch">[FETCH]
   <dd><a href="https://fetch.spec.whatwg.org/"><cite>Fetch Standard</cite></a>. 22 May 2023. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-rfc9113">[RFC9113]
   <dd>M. Thomson, Ed.; C. Benfield, Ed.. <a href="https://httpwg.org/specs/rfc9113.html"><cite>HTTP/2</cite></a>. June 2022. Proposed Standard. URL: <a href="https://httpwg.org/specs/rfc9113.html">https://httpwg.org/specs/rfc9113.html</a>
   <dt id="biblio-rfc9114">[RFC9114]
   <dd>M. Bishop, Ed.. <a href="https://httpwg.org/specs/rfc9114.html"><cite>HTTP/3</cite></a>. June 2022. Proposed Standard. URL: <a href="https://httpwg.org/specs/rfc9114.html">https://httpwg.org/specs/rfc9114.html</a>
  </dl>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"abstract-opdef-apply-brotli-patch": {"dfnID":"abstract-opdef-apply-brotli-patch","dfnText":"Apply brotli patch","external":false,"refSections":[],"url":"#abstract-opdef-apply-brotli-patch"},
"abstract-opdef-apply-glyph-keyed-patch": {"dfnID":"abstract-opdef-apply-glyph-keyed-patch","dfnText":"Apply glyph keyed patch","external":false,"refSections":[],"url":"#abstract-opdef-apply-glyph-keyed-patch"},
"abstract-opdef-apply-per-table-brotli-patch": {"dfnID":"abstract-opdef-apply-per-table-brotli-patch","dfnText":"Apply per table brotli patch","external":false,"refSections":[],"url":"#abstract-opdef-apply-per-table-brotli-patch"},
"abstract-opdef-check-entry-intersection": {"dfnID":"abstract-opdef-check-entry-intersection","dfnText":"Check entry intersection","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-check-entry-intersection"}],"title":"6. Extending a Font Subset"},{"refs":[{"id":"ref-for-abstract-opdef-check-entry-intersection\u2460"}],"title":"6.1. Fully Expanding a Font"}],"url":"#abstract-opdef-check-entry-intersection"},
"abstract-opdef-decoding-sparse-bit-set-treedata": {"dfnID":"abstract-opdef-decoding-sparse-bit-set-treedata","dfnText":"Decoding sparse bit set treeData","external":false,"refSections":[],"url":"#abstract-opdef-decoding-sparse-bit-set-treedata"},
"abstract-opdef-extend-a-font-subset": {"dfnID":"abstract-opdef-extend-a-font-subset","dfnText":"Extend a Font Subset","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-extend-a-font-subset"}],"title":"6.1. Fully Expanding a Font"},{"refs":[{"id":"ref-for-abstract-opdef-extend-a-font-subset\u2460"},{"id":"ref-for-abstract-opdef-extend-a-font-subset\u2461"},{"id":"ref-for-abstract-opdef-extend-a-font-subset\u2462"}],"title":"7. Encoder"}],"url":"#abstract-opdef-extend-a-font-subset"},
"abstract-opdef-fully-expand-a-font-subset": {"dfnID":"abstract-opdef-fully-expand-a-font-subset","dfnText":"Fully Expand a Font Subset","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-fully-expand-a-font-subset"}],"title":"2.1. Offline Usage"},{"refs":[{"id":"ref-for-abstract-opdef-fully-expand-a-font-subset\u2460"},{"id":"ref-for-abstract-opdef-fully-expand-a-font-subset\u2461"}],"title":"7. Encoder"}],"url":"#abstract-opdef-fully-expand-a-font-subset"},
"abstract-opdef-handle-errors": {"dfnID":"abstract-opdef-handle-errors","dfnText":"Handle errors","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-handle-errors"}],"title":"6. Extending a Font Subset"}],"url":"#abstract-opdef-handle-errors"},
"abstract-opdef-interpret-format-1-patch-map": {"dfnID":"abstract-opdef-interpret-format-1-patch-map","dfnText":"Interpret Format 1 Patch Map","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-interpret-format-1-patch-map"}],"title":"6. Extending a Font Subset"}],"url":"#abstract-opdef-interpret-format-1-patch-map"},
"abstract-opdef-interpret-format-2-patch-map": {"dfnID":"abstract-opdef-interpret-format-2-patch-map","dfnText":"Interpret Format 2 Patch Map","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-interpret-format-2-patch-map"}],"title":"6. Extending a Font Subset"}],"url":"#abstract-opdef-interpret-format-2-patch-map"},
"abstract-opdef-interpret-format-2-patch-map-entry": {"dfnID":"abstract-opdef-interpret-format-2-patch-map-entry","dfnText":"Interpret Format 2 Patch Map Entry","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-interpret-format-2-patch-map-entry"}],"title":"4.2.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-abstract-opdef-interpret-format-2-patch-map-entry\u2460"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#abstract-opdef-interpret-format-2-patch-map-entry"},
"abstract-opdef-load-patch-file": {"dfnID":"abstract-opdef-load-patch-file","dfnText":"Load patch file","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-load-patch-file"}],"title":"6. Extending a Font Subset"}],"url":"#abstract-opdef-load-patch-file"},
"branch-factor-encoding": {"dfnID":"branch-factor-encoding","dfnText":"Branch Factor Encoding","external":false,"refSections":[{"refs":[{"id":"ref-for-branch-factor-encoding"}],"title":"4.2.2.2. Sparse Bit Set"}],"url":"#branch-factor-encoding"},
"brotli-patch": {"dfnID":"brotli-patch","dfnText":"Brotli patch","external":false,"refSections":[{"refs":[{"id":"ref-for-brotli-patch"}],"title":"5.4.1. Applying Brotli Patches"}],"url":"#brotli-patch"},
"brotli-patch-brotlistream": {"dfnID":"brotli-patch-brotlistream","dfnText":"brotliStream","external":false,"refSections":[{"refs":[{"id":"ref-for-brotli-patch-brotlistream"}],"title":"5.4. Brotli Patch"},{"refs":[{"id":"ref-for-brotli-patch-brotlistream\u2460"}],"title":"5.4.1. Applying Brotli Patches"}],"url":"#brotli-patch-brotlistream"},
"brotli-patch-format": {"dfnID":"brotli-patch-format","dfnText":"format","external":false,"refSections":[{"refs":[{"id":"ref-for-brotli-patch-format"}],"title":"5.4.1. Applying Brotli Patches"}],"url":"#brotli-patch-format"},
"brotli-patch-id": {"dfnID":"brotli-patch-id","dfnText":"id","external":false,"refSections":[{"refs":[{"id":"ref-for-brotli-patch-id"}],"title":"5.4.1. Applying Brotli Patches"}],"url":"#brotli-patch-id"},
"design-space-segment": {"dfnID":"design-space-segment","dfnText":"Design Space Segment","external":false,"refSections":[{"refs":[{"id":"ref-for-design-space-segment"}],"title":"4.2.2. Patch Map Table: Format 2"}],"url":"#design-space-segment"},
"design-space-segment-end": {"dfnID":"design-space-segment-end","dfnText":"end","external":false,"refSections":[{"refs":[{"id":"ref-for-design-space-segment-end"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#design-space-segment-end"},
"design-space-segment-start": {"dfnID":"design-space-segment-start","dfnText":"start","external":false,"refSections":[{"refs":[{"id":"ref-for-design-space-segment-start"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#design-space-segment-start"},
"design-space-segment-tag": {"dfnID":"design-space-segment-tag","dfnText":"tag","external":false,"refSections":[{"refs":[{"id":"ref-for-design-space-segment-tag"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#design-space-segment-tag"},
"entrymaprecord": {"dfnID":"entrymaprecord","dfnText":"EntryMapRecord","external":false,"refSections":[{"refs":[{"id":"ref-for-entrymaprecord"},{"id":"ref-for-entrymaprecord\u2460"}],"title":"4.2.1. Patch Map Table: Format 1"},{"refs":[{"id":"ref-for-entrymaprecord\u2461"}],"title":"4.2.1.1. Interpreting Format 1"}],"url":"#entrymaprecord"},
"entrymaprecord-firstentryindex": {"dfnID":"entrymaprecord-firstentryindex","dfnText":"firstEntryIndex","external":false,"refSections":[{"refs":[{"id":"ref-for-entrymaprecord-firstentryindex"},{"id":"ref-for-entrymaprecord-firstentryindex\u2460"}],"title":"4.2.1.1. Interpreting Format 1"}],"url":"#entrymaprecord-firstentryindex"},
"entrymaprecord-lastentryindex": {"dfnID":"entrymaprecord-lastentryindex","dfnText":"lastEntryIndex","external":false,"refSections":[{"refs":[{"id":"ref-for-entrymaprecord-lastentryindex"}],"title":"4.2.1.1. Interpreting Format 1"}],"url":"#entrymaprecord-lastentryindex"},
"feature-map": {"dfnID":"feature-map","dfnText":"Feature Map","external":false,"refSections":[{"refs":[{"id":"ref-for-feature-map"}],"title":"4.2.1. Patch Map Table: Format 1"}],"url":"#feature-map"},
"feature-map-entrymaprecords": {"dfnID":"feature-map-entrymaprecords","dfnText":"entryMapRecords","external":false,"refSections":[{"refs":[{"id":"ref-for-feature-map-entrymaprecords"}],"title":"4.2.1.1. Interpreting Format 1"}],"url":"#feature-map-entrymaprecords"},
"feature-map-featurerecords": {"dfnID":"feature-map-featurerecords","dfnText":"featureRecords","external":false,"refSections":[{"refs":[{"id":"ref-for-feature-map-featurerecords"}],"title":"4.2.1. Patch Map Table: Format 1"},{"refs":[{"id":"ref-for-feature-map-featurerecords\u2460"}],"title":"4.2.1.1. Interpreting Format 1"}],"url":"#feature-map-featurerecords"},
"featurerecord": {"dfnID":"featurerecord","dfnText":"FeatureRecord","external":false,"refSections":[{"refs":[{"id":"ref-for-featurerecord"}],"title":"4.2.1. Patch Map Table: Format 1"},{"refs":[{"id":"ref-for-featurerecord\u2460"}],"title":"4.2.1.1. Interpreting Format 1"}],"url":"#featurerecord"},
"featurerecord-entrymapcount": {"dfnID":"featurerecord-entrymapcount","dfnText":"entryMapCount","external":false,"refSections":[{"refs":[{"id":"ref-for-featurerecord-entrymapcount"}],"title":"4.2.1. Patch Map Table: Format 1"}],"url":"#featurerecord-entrymapcount"},
"featurerecord-featuretag": {"dfnID":"featurerecord-featuretag","dfnText":"featureTag","external":false,"refSections":[{"refs":[{"id":"ref-for-featurerecord-featuretag"}],"title":"4.2.1. Patch Map Table: Format 1"},{"refs":[{"id":"ref-for-featurerecord-featuretag\u2460"}],"title":"4.2.1.1. Interpreting Format 1"}],"url":"#featurerecord-featuretag"},
"featurerecord-firstentryindex": {"dfnID":"featurerecord-firstentryindex","dfnText":"firstEntryIndex","external":false,"refSections":[{"refs":[{"id":"ref-for-featurerecord-firstentryindex"}],"title":"4.2.1.1. Interpreting Format 1"}],"url":"#featurerecord-firstentryindex"},
"font-patch": {"dfnID":"font-patch","dfnText":"font patch","external":false,"refSections":[{"refs":[{"id":"ref-for-font-patch"},{"id":"ref-for-font-patch\u2460"}],"title":"5.1. Definitions"},{"refs":[{"id":"ref-for-font-patch\u2461"}],"title":"7. Encoder"}],"url":"#font-patch"},
"font-subset": {"dfnID":"font-subset","dfnText":"font subset","external":false,"refSections":[{"refs":[{"id":"ref-for-font-subset"}],"title":"3.1. Font Subset"},{"refs":[{"id":"ref-for-font-subset\u2460"}],"title":"4.2.1.1. Interpreting Format 1"},{"refs":[{"id":"ref-for-font-subset\u2461"}],"title":"5. Font Patch Formats"},{"refs":[{"id":"ref-for-font-subset\u2462"},{"id":"ref-for-font-subset\u2463"},{"id":"ref-for-font-subset\u2464"},{"id":"ref-for-font-subset\u2465"}],"title":"5.1. Definitions"},{"refs":[{"id":"ref-for-font-subset\u2466"},{"id":"ref-for-font-subset\u2467"},{"id":"ref-for-font-subset\u2468"}],"title":"5.2. Patch Invalidations"},{"refs":[{"id":"ref-for-font-subset\u2460\u24ea"},{"id":"ref-for-font-subset\u2460\u2460"},{"id":"ref-for-font-subset\u2460\u2461"},{"id":"ref-for-font-subset\u2460\u2462"}],"title":"5.3. Formats Summary"},{"refs":[{"id":"ref-for-font-subset\u2460\u2463"}],"title":"5.4. Brotli Patch"},{"refs":[{"id":"ref-for-font-subset\u2460\u2464"},{"id":"ref-for-font-subset\u2460\u2465"},{"id":"ref-for-font-subset\u2460\u2466"}],"title":"5.4.1. Applying Brotli Patches"},{"refs":[{"id":"ref-for-font-subset\u2460\u2467"},{"id":"ref-for-font-subset\u2460\u2468"}],"title":"5.5. Per Table Brotli"},{"refs":[{"id":"ref-for-font-subset\u2461\u24ea"},{"id":"ref-for-font-subset\u2461\u2460"},{"id":"ref-for-font-subset\u2461\u2461"}],"title":"5.5.1. Applying Per Table Brotli Patches"},{"refs":[{"id":"ref-for-font-subset\u2461\u2462"}],"title":"5.6. Glyph Keyed"},{"refs":[{"id":"ref-for-font-subset\u2461\u2463"},{"id":"ref-for-font-subset\u2461\u2464"},{"id":"ref-for-font-subset\u2461\u2465"}],"title":"5.6.1. Applying Glyph Keyed Patches"},{"refs":[{"id":"ref-for-font-subset\u2461\u2466"},{"id":"ref-for-font-subset\u2461\u2467"}],"title":"6. Extending a Font Subset"},{"refs":[{"id":"ref-for-font-subset\u2461\u2468"}],"title":"6.1. Fully Expanding a Font"},{"refs":[{"id":"ref-for-font-subset\u2462\u24ea"}],"title":"7. Encoder"},{"refs":[{"id":"ref-for-font-subset\u2462\u2460"}],"title":"7.1. Encoder Considerations"}],"url":"#font-subset"},
"font-subset-definition": {"dfnID":"font-subset-definition","dfnText":"font subset definition","external":false,"refSections":[{"refs":[{"id":"ref-for-font-subset-definition"}],"title":"4. Extensions to the Font Format"},{"refs":[{"id":"ref-for-font-subset-definition\u2460"},{"id":"ref-for-font-subset-definition\u2461"}],"title":"4.2. Patch Map Table"},{"refs":[{"id":"ref-for-font-subset-definition\u2462"},{"id":"ref-for-font-subset-definition\u2463"},{"id":"ref-for-font-subset-definition\u2464"}],"title":"4.2.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-font-subset-definition\u2465"},{"id":"ref-for-font-subset-definition\u2466"}],"title":"6. Extending a Font Subset"},{"refs":[{"id":"ref-for-font-subset-definition\u2467"}],"title":"7. Encoder"},{"refs":[{"id":"ref-for-font-subset-definition\u2468"}],"title":"7.1. Encoder Considerations"}],"url":"#font-subset-definition"},
"format-1-patch-map": {"dfnID":"format-1-patch-map","dfnText":"Format 1 Patch Map","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map"}],"title":"4.2.1.1. Interpreting Format 1"}],"url":"#format-1-patch-map"},
"format-1-patch-map-appliedentriesbitmap": {"dfnID":"format-1-patch-map-appliedentriesbitmap","dfnText":"appliedEntriesBitMap","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-appliedentriesbitmap"},{"id":"ref-for-format-1-patch-map-appliedentriesbitmap\u2460"}],"title":"4.2.1.1. Interpreting Format 1"},{"refs":[{"id":"ref-for-format-1-patch-map-appliedentriesbitmap\u2461"}],"title":"5.6.1. Applying Glyph Keyed Patches"}],"url":"#format-1-patch-map-appliedentriesbitmap"},
"format-1-patch-map-entrycount": {"dfnID":"format-1-patch-map-entrycount","dfnText":"entryCount","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-entrycount"},{"id":"ref-for-format-1-patch-map-entrycount\u2460"},{"id":"ref-for-format-1-patch-map-entrycount\u2461"},{"id":"ref-for-format-1-patch-map-entrycount\u2462"},{"id":"ref-for-format-1-patch-map-entrycount\u2463"}],"title":"4.2.1. Patch Map Table: Format 1"}],"url":"#format-1-patch-map-entrycount"},
"format-1-patch-map-format": {"dfnID":"format-1-patch-map-format","dfnText":"format","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-format"}],"title":"4.2.1.1. Interpreting Format 1"}],"url":"#format-1-patch-map-format"},
"format-1-patch-map-glyphcount": {"dfnID":"format-1-patch-map-glyphcount","dfnText":"glyphCount","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-glyphcount"}],"title":"4.2.1. Patch Map Table: Format 1"}],"url":"#format-1-patch-map-glyphcount"},
"format-1-patch-map-id": {"dfnID":"format-1-patch-map-id","dfnText":"id","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-id"},{"id":"ref-for-format-1-patch-map-id\u2460"}],"title":"4.2.1.1. Interpreting Format 1"}],"url":"#format-1-patch-map-id"},
"format-1-patch-map-patchencoding": {"dfnID":"format-1-patch-map-patchencoding","dfnText":"patchEncoding","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-patchencoding"},{"id":"ref-for-format-1-patch-map-patchencoding\u2460"}],"title":"4.2.1.1. Interpreting Format 1"}],"url":"#format-1-patch-map-patchencoding"},
"format-1-patch-map-uritemplate": {"dfnID":"format-1-patch-map-uritemplate","dfnText":"uriTemplate","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-uritemplate"},{"id":"ref-for-format-1-patch-map-uritemplate\u2460"}],"title":"4.2.1.1. Interpreting Format 1"}],"url":"#format-1-patch-map-uritemplate"},
"format-2-patch-map": {"dfnID":"format-2-patch-map","dfnText":"Format 2 Patch Map","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#format-2-patch-map"},
"format-2-patch-map-defaultpatchencoding": {"dfnID":"format-2-patch-map-defaultpatchencoding","dfnText":"defaultPatchEncoding","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map-defaultpatchencoding"}],"title":"4.2.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-format-2-patch-map-defaultpatchencoding\u2460"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#format-2-patch-map-defaultpatchencoding"},
"format-2-patch-map-entries": {"dfnID":"format-2-patch-map-entries","dfnText":"entries","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map-entries"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#format-2-patch-map-entries"},
"format-2-patch-map-entrycount": {"dfnID":"format-2-patch-map-entrycount","dfnText":"entryCount","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map-entrycount"}],"title":"4.2.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-format-2-patch-map-entrycount\u2460"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#format-2-patch-map-entrycount"},
"format-2-patch-map-entryidstringdata": {"dfnID":"format-2-patch-map-entryidstringdata","dfnText":"entryIdStringData","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map-entryidstringdata"},{"id":"ref-for-format-2-patch-map-entryidstringdata\u2460"},{"id":"ref-for-format-2-patch-map-entryidstringdata\u2461"},{"id":"ref-for-format-2-patch-map-entryidstringdata\u2462"}],"title":"4.2.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-format-2-patch-map-entryidstringdata\u2463"},{"id":"ref-for-format-2-patch-map-entryidstringdata\u2464"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#format-2-patch-map-entryidstringdata"},
"format-2-patch-map-format": {"dfnID":"format-2-patch-map-format","dfnText":"format","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map-format"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#format-2-patch-map-format"},
"format-2-patch-map-id": {"dfnID":"format-2-patch-map-id","dfnText":"id","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map-id"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#format-2-patch-map-id"},
"format-2-patch-map-uritemplate": {"dfnID":"format-2-patch-map-uritemplate","dfnText":"uriTemplate","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map-uritemplate"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#format-2-patch-map-uritemplate"},
"full-invalidation": {"dfnID":"full-invalidation","dfnText":"Full Invalidation","external":false,"refSections":[{"refs":[{"id":"ref-for-full-invalidation"},{"id":"ref-for-full-invalidation\u2460"}],"title":"5.3. Formats Summary"},{"refs":[{"id":"ref-for-full-invalidation\u2461"},{"id":"ref-for-full-invalidation\u2462"}],"title":"6. Extending a Font Subset"}],"url":"#full-invalidation"},
"glyph-keyed-patch": {"dfnID":"glyph-keyed-patch","dfnText":"Glyph keyed patch","external":false,"refSections":[{"refs":[{"id":"ref-for-glyph-keyed-patch"}],"title":"5.6.1. Applying Glyph Keyed Patches"}],"url":"#glyph-keyed-patch"},
"glyph-keyed-patch-brotlistream": {"dfnID":"glyph-keyed-patch-brotlistream","dfnText":"brotliStream","external":false,"refSections":[{"refs":[{"id":"ref-for-glyph-keyed-patch-brotlistream"}],"title":"5.6. Glyph Keyed"},{"refs":[{"id":"ref-for-glyph-keyed-patch-brotlistream\u2460"}],"title":"5.6.1. Applying Glyph Keyed Patches"}],"url":"#glyph-keyed-patch-brotlistream"},
"glyph-keyed-patch-flags": {"dfnID":"glyph-keyed-patch-flags","dfnText":"flags","external":false,"refSections":[{"refs":[{"id":"ref-for-glyph-keyed-patch-flags"}],"title":"5.6. Glyph Keyed"}],"url":"#glyph-keyed-patch-flags"},
"glyph-keyed-patch-format": {"dfnID":"glyph-keyed-patch-format","dfnText":"format","external":false,"refSections":[{"refs":[{"id":"ref-for-glyph-keyed-patch-format"}],"title":"5.6.1. Applying Glyph Keyed Patches"}],"url":"#glyph-keyed-patch-format"},
"glyph-keyed-patch-id": {"dfnID":"glyph-keyed-patch-id","dfnText":"id","external":false,"refSections":[{"refs":[{"id":"ref-for-glyph-keyed-patch-id"},{"id":"ref-for-glyph-keyed-patch-id\u2460"}],"title":"5.6.1. Applying Glyph Keyed Patches"}],"url":"#glyph-keyed-patch-id"},
"glyph-map": {"dfnID":"glyph-map","dfnText":"Glyph Map","external":false,"refSections":[{"refs":[{"id":"ref-for-glyph-map"}],"title":"4.2.1. Patch Map Table: Format 1"}],"url":"#glyph-map"},
"glyph-map-entryindex": {"dfnID":"glyph-map-entryindex","dfnText":"entryIndex","external":false,"refSections":[{"refs":[{"id":"ref-for-glyph-map-entryindex"}],"title":"4.2.1.1. Interpreting Format 1"}],"url":"#glyph-map-entryindex"},
"glyph-map-firstmappedglyph": {"dfnID":"glyph-map-firstmappedglyph","dfnText":"firstMappedGlyph","external":false,"refSections":[{"refs":[{"id":"ref-for-glyph-map-firstmappedglyph"}],"title":"4.2.1. Patch Map Table: Format 1"}],"url":"#glyph-map-firstmappedglyph"},
"glyphpatches": {"dfnID":"glyphpatches","dfnText":"GlyphPatches","external":false,"refSections":[{"refs":[{"id":"ref-for-glyphpatches"},{"id":"ref-for-glyphpatches\u2460"}],"title":"5.6. Glyph Keyed"},{"refs":[{"id":"ref-for-glyphpatches\u2461"}],"title":"5.6.1. Applying Glyph Keyed Patches"}],"url":"#glyphpatches"},
"glyphpatches-glyphcount": {"dfnID":"glyphpatches-glyphcount","dfnText":"glyphCount","external":false,"refSections":[{"refs":[{"id":"ref-for-glyphpatches-glyphcount"},{"id":"ref-for-glyphpatches-glyphcount\u2460"}],"title":"5.6. Glyph Keyed"}],"url":"#glyphpatches-glyphcount"},
"glyphpatches-glyphdata": {"dfnID":"glyphpatches-glyphdata","dfnText":"glyphData","external":false,"refSections":[{"refs":[{"id":"ref-for-glyphpatches-glyphdata"}],"title":"5.6.1. Applying Glyph Keyed Patches"}],"url":"#glyphpatches-glyphdata"},
"glyphpatches-glyphdataoffsets": {"dfnID":"glyphpatches-glyphdataoffsets","dfnText":"glyphDataOffsets","external":false,"refSections":[{"refs":[{"id":"ref-for-glyphpatches-glyphdataoffsets"}],"title":"5.6. Glyph Keyed"},{"refs":[{"id":"ref-for-glyphpatches-glyphdataoffsets\u2460"},{"id":"ref-for-glyphpatches-glyphdataoffsets\u2461"},{"id":"ref-for-glyphpatches-glyphdataoffsets\u2462"}],"title":"5.6.1. Applying Glyph Keyed Patches"}],"url":"#glyphpatches-glyphdataoffsets"},
"glyphpatches-glyphids": {"dfnID":"glyphpatches-glyphids","dfnText":"glyphIds","external":false,"refSections":[{"refs":[{"id":"ref-for-glyphpatches-glyphids"}],"title":"5.6. Glyph Keyed"},{"refs":[{"id":"ref-for-glyphpatches-glyphids\u2460"}],"title":"5.6.1. Applying Glyph Keyed Patches"}],"url":"#glyphpatches-glyphids"},
"glyphpatches-tables": {"dfnID":"glyphpatches-tables","dfnText":"tables","external":false,"refSections":[{"refs":[{"id":"ref-for-glyphpatches-tables"},{"id":"ref-for-glyphpatches-tables\u2460"}],"title":"5.6. Glyph Keyed"},{"refs":[{"id":"ref-for-glyphpatches-tables\u2461"}],"title":"5.6.1. Applying Glyph Keyed Patches"}],"url":"#glyphpatches-tables"},
"incremental-font": {"dfnID":"incremental-font","dfnText":"incremental font","external":false,"refSections":[{"refs":[{"id":"ref-for-incremental-font"},{"id":"ref-for-incremental-font\u2460"},{"id":"ref-for-incremental-font\u2461"},{"id":"ref-for-incremental-font\u2462"}],"title":"6. Extending a Font Subset"},{"refs":[{"id":"ref-for-incremental-font\u2463"}],"title":"6.1. Fully Expanding a Font"},{"refs":[{"id":"ref-for-incremental-font\u2464"},{"id":"ref-for-incremental-font\u2465"},{"id":"ref-for-incremental-font\u2466"},{"id":"ref-for-incremental-font\u2467"},{"id":"ref-for-incremental-font\u2468"},{"id":"ref-for-incremental-font\u2460\u24ea"},{"id":"ref-for-incremental-font\u2460\u2460"}],"title":"7. Encoder"}],"url":"#incremental-font"},
"mapping-entries": {"dfnID":"mapping-entries","dfnText":"Mapping Entries","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entries"}],"title":"4.2.2. Patch Map Table: Format 2"}],"url":"#mapping-entries"},
"mapping-entries-entries": {"dfnID":"mapping-entries-entries","dfnText":"entries","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entries-entries"},{"id":"ref-for-mapping-entries-entries\u2460"}],"title":"4.2.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-mapping-entries-entries\u2461"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#mapping-entries-entries"},
"mapping-entry": {"dfnID":"mapping-entry","dfnText":"Mapping Entry","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry"},{"id":"ref-for-mapping-entry\u2460"},{"id":"ref-for-mapping-entry\u2461"}],"title":"4.2.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-mapping-entry\u2462"},{"id":"ref-for-mapping-entry\u2463"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#mapping-entry"},
"mapping-entry-bias": {"dfnID":"mapping-entry-bias","dfnText":"bias","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-bias"},{"id":"ref-for-mapping-entry-bias\u2460"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#mapping-entry-bias"},
"mapping-entry-codepoints": {"dfnID":"mapping-entry-codepoints","dfnText":"codepoints","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-codepoints"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#mapping-entry-codepoints"},
"mapping-entry-copycount": {"dfnID":"mapping-entry-copycount","dfnText":"copyCount","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-copycount"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#mapping-entry-copycount"},
"mapping-entry-copyindices": {"dfnID":"mapping-entry-copyindices","dfnText":"copyIndices","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-copyindices"},{"id":"ref-for-mapping-entry-copyindices\u2460"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#mapping-entry-copyindices"},
"mapping-entry-designspacecount": {"dfnID":"mapping-entry-designspacecount","dfnText":"designSpaceCount","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-designspacecount"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#mapping-entry-designspacecount"},
"mapping-entry-designspacesegments": {"dfnID":"mapping-entry-designspacesegments","dfnText":"designSpaceSegments","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-designspacesegments"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#mapping-entry-designspacesegments"},
"mapping-entry-entryiddelta": {"dfnID":"mapping-entry-entryiddelta","dfnText":"entryIdDelta","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-entryiddelta"}],"title":"4.2.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-mapping-entry-entryiddelta\u2460"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#mapping-entry-entryiddelta"},
"mapping-entry-entryidstringlength": {"dfnID":"mapping-entry-entryidstringlength","dfnText":"entryIdStringLength","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-entryidstringlength"}],"title":"4.2.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-mapping-entry-entryidstringlength\u2460"},{"id":"ref-for-mapping-entry-entryidstringlength\u2461"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#mapping-entry-entryidstringlength"},
"mapping-entry-featurecount": {"dfnID":"mapping-entry-featurecount","dfnText":"featureCount","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-featurecount"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#mapping-entry-featurecount"},
"mapping-entry-featuretags": {"dfnID":"mapping-entry-featuretags","dfnText":"featureTags","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-featuretags"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#mapping-entry-featuretags"},
"mapping-entry-formatflags": {"dfnID":"mapping-entry-formatflags","dfnText":"formatFlags","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-formatflags"},{"id":"ref-for-mapping-entry-formatflags\u2460"},{"id":"ref-for-mapping-entry-formatflags\u2461"},{"id":"ref-for-mapping-entry-formatflags\u2462"},{"id":"ref-for-mapping-entry-formatflags\u2463"},{"id":"ref-for-mapping-entry-formatflags\u2464"},{"id":"ref-for-mapping-entry-formatflags\u2465"},{"id":"ref-for-mapping-entry-formatflags\u2466"},{"id":"ref-for-mapping-entry-formatflags\u2467"},{"id":"ref-for-mapping-entry-formatflags\u2468"}],"title":"4.2.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-mapping-entry-formatflags\u2460\u24ea"},{"id":"ref-for-mapping-entry-formatflags\u2460\u2460"},{"id":"ref-for-mapping-entry-formatflags\u2460\u2461"},{"id":"ref-for-mapping-entry-formatflags\u2460\u2462"},{"id":"ref-for-mapping-entry-formatflags\u2460\u2463"},{"id":"ref-for-mapping-entry-formatflags\u2460\u2464"},{"id":"ref-for-mapping-entry-formatflags\u2460\u2465"},{"id":"ref-for-mapping-entry-formatflags\u2460\u2466"},{"id":"ref-for-mapping-entry-formatflags\u2460\u2467"}],"title":"4.2.2.1. Interpreting Format 2"},{"refs":[{"id":"ref-for-mapping-entry-formatflags\u2460\u2468"}],"title":"5.6.1. Applying Glyph Keyed Patches"}],"url":"#mapping-entry-formatflags"},
"mapping-entry-patchencoding": {"dfnID":"mapping-entry-patchencoding","dfnText":"patchEncoding","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-patchencoding"}],"title":"4.2.2.1. Interpreting Format 2"}],"url":"#mapping-entry-patchencoding"},
"no-invalidation": {"dfnID":"no-invalidation","dfnText":"No Invalidation","external":false,"refSections":[{"refs":[{"id":"ref-for-no-invalidation"}],"title":"5.3. Formats Summary"},{"refs":[{"id":"ref-for-no-invalidation\u2460"}],"title":"6. Extending a Font Subset"}],"url":"#no-invalidation"},
"partial-invalidation": {"dfnID":"partial-invalidation","dfnText":"Partial Invalidation","external":false,"refSections":[{"refs":[{"id":"ref-for-partial-invalidation"},{"id":"ref-for-partial-invalidation\u2460"}],"title":"5.3. Formats Summary"},{"refs":[{"id":"ref-for-partial-invalidation\u2461"},{"id":"ref-for-partial-invalidation\u2462"}],"title":"6. Extending a Font Subset"}],"url":"#partial-invalidation"},
"patch-application-algorithm": {"dfnID":"patch-application-algorithm","dfnText":"patch application algorithm","external":false,"refSections":[{"refs":[{"id":"ref-for-patch-application-algorithm"}],"title":"5.4.1. Applying Brotli Patches"},{"refs":[{"id":"ref-for-patch-application-algorithm\u2460"}],"title":"5.5.1. Applying Per Table Brotli Patches"},{"refs":[{"id":"ref-for-patch-application-algorithm\u2461"}],"title":"5.6.1. Applying Glyph Keyed Patches"}],"url":"#patch-application-algorithm"},
"patch-format": {"dfnID":"patch-format","dfnText":"patch format","external":false,"refSections":[{"refs":[{"id":"ref-for-patch-format"},{"id":"ref-for-patch-format\u2460"}],"title":"5.1. Definitions"}],"url":"#patch-format"},
"patch-map-entries": {"dfnID":"patch-map-entries","dfnText":"patch map entries","external":false,"refSections":[{"refs":[{"id":"ref-for-patch-map-entries"},{"id":"ref-for-patch-map-entries\u2460"},{"id":"ref-for-patch-map-entries\u2461"},{"id":"ref-for-patch-map-entries\u2462"}],"title":"4.2.1.1. Interpreting Format 1"},{"refs":[{"id":"ref-for-patch-map-entries\u2463"},{"id":"ref-for-patch-map-entries\u2464"},{"id":"ref-for-patch-map-entries\u2465"}],"title":"4.2.2.1. Interpreting Format 2"},{"refs":[{"id":"ref-for-patch-map-entries\u2466"},{"id":"ref-for-patch-map-entries\u2467"},{"id":"ref-for-patch-map-entries\u2468"}],"title":"6. Extending a Font Subset"}],"url":"#patch-map-entries"},
"per-table-brotli-patch": {"dfnID":"per-table-brotli-patch","dfnText":"Per table brotli patch","external":false,"refSections":[{"refs":[{"id":"ref-for-per-table-brotli-patch"}],"title":"5.5.1. Applying Per Table Brotli Patches"}],"url":"#per-table-brotli-patch"},
"per-table-brotli-patch-format": {"dfnID":"per-table-brotli-patch-format","dfnText":"format","external":false,"refSections":[{"refs":[{"id":"ref-for-per-table-brotli-patch-format"}],"title":"5.5.1. Applying Per Table Brotli Patches"}],"url":"#per-table-brotli-patch-format"},
"per-table-brotli-patch-id": {"dfnID":"per-table-brotli-patch-id","dfnText":"id","external":false,"refSections":[{"refs":[{"id":"ref-for-per-table-brotli-patch-id"}],"title":"5.5.1. Applying Per Table Brotli Patches"}],"url":"#per-table-brotli-patch-id"},
"per-table-brotli-patch-patches": {"dfnID":"per-table-brotli-patch-patches","dfnText":"patches","external":false,"refSections":[{"refs":[{"id":"ref-for-per-table-brotli-patch-patches"}],"title":"5.5. Per Table Brotli"},{"refs":[{"id":"ref-for-per-table-brotli-patch-patches\u2460"},{"id":"ref-for-per-table-brotli-patch-patches\u2461"},{"id":"ref-for-per-table-brotli-patch-patches\u2462"},{"id":"ref-for-per-table-brotli-patch-patches\u2463"},{"id":"ref-for-per-table-brotli-patch-patches\u2464"}],"title":"5.5.1. Applying Per Table Brotli Patches"}],"url":"#per-table-brotli-patch-patches"},
"sparse-bit-set": {"dfnID":"sparse-bit-set","dfnText":"Sparse Bit Set","external":false,"refSections":[{"refs":[{"id":"ref-for-sparse-bit-set"}],"title":"4.2.2. Patch Map Table: Format 2"}],"url":"#sparse-bit-set"},
"tablepatch": {"dfnID":"tablepatch","dfnText":"TablePatch","external":false,"refSections":[{"refs":[{"id":"ref-for-tablepatch"},{"id":"ref-for-tablepatch\u2460"}],"title":"5.5. Per Table Brotli"},{"refs":[{"id":"ref-for-tablepatch\u2461"}],"title":"5.5.1. Applying Per Table Brotli Patches"}],"url":"#tablepatch"},
"tablepatch-brotlistream": {"dfnID":"tablepatch-brotlistream","dfnText":"brotliStream","external":false,"refSections":[{"refs":[{"id":"ref-for-tablepatch-brotlistream"}],"title":"5.5. Per Table Brotli"},{"refs":[{"id":"ref-for-tablepatch-brotlistream\u2460"},{"id":"ref-for-tablepatch-brotlistream\u2461"},{"id":"ref-for-tablepatch-brotlistream\u2462"},{"id":"ref-for-tablepatch-brotlistream\u2463"}],"title":"5.5.1. Applying Per Table Brotli Patches"}],"url":"#tablepatch-brotlistream"},
"tablepatch-flags": {"dfnID":"tablepatch-flags","dfnText":"flags","external":false,"refSections":[{"refs":[{"id":"ref-for-tablepatch-flags"},{"id":"ref-for-tablepatch-flags\u2460"}],"title":"5.5.1. Applying Per Table Brotli Patches"}],"url":"#tablepatch-flags"},
"tablepatch-tag": {"dfnID":"tablepatch-tag","dfnText":"tag","external":false,"refSections":[{"refs":[{"id":"ref-for-tablepatch-tag"},{"id":"ref-for-tablepatch-tag\u2460"},{"id":"ref-for-tablepatch-tag\u2461"},{"id":"ref-for-tablepatch-tag\u2462"},{"id":"ref-for-tablepatch-tag\u2463"}],"title":"5.5.1. Applying Per Table Brotli Patches"}],"url":"#tablepatch-tag"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#abstract-opdef-check-entry-intersection": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Check entry intersection","type":"abstract-op","url":"#abstract-opdef-check-entry-intersection"},
"#abstract-opdef-extend-a-font-subset": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Extend a Font Subset","type":"abstract-op","url":"#abstract-opdef-extend-a-font-subset"},
"#abstract-opdef-fully-expand-a-font-subset": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Fully Expand a Font Subset","type":"abstract-op","url":"#abstract-opdef-fully-expand-a-font-subset"},
"#abstract-opdef-handle-errors": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Handle errors","type":"abstract-op","url":"#abstract-opdef-handle-errors"},
"#abstract-opdef-interpret-format-1-patch-map": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Interpret Format 1 Patch Map","type":"abstract-op","url":"#abstract-opdef-interpret-format-1-patch-map"},
"#abstract-opdef-interpret-format-2-patch-map": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Interpret Format 2 Patch Map","type":"abstract-op","url":"#abstract-opdef-interpret-format-2-patch-map"},
"#abstract-opdef-interpret-format-2-patch-map-entry": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Interpret Format 2 Patch Map Entry","type":"abstract-op","url":"#abstract-opdef-interpret-format-2-patch-map-entry"},
"#abstract-opdef-load-patch-file": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Load patch file","type":"abstract-op","url":"#abstract-opdef-load-patch-file"},
"#branch-factor-encoding": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"branch factor encoding","type":"dfn","url":"#branch-factor-encoding"},
"#brotli-patch": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"brotli patch","type":"dfn","url":"#brotli-patch"},
"#brotli-patch-brotlistream": {"export":true,"for_":["Brotli patch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"brotlistream","type":"dfn","url":"#brotli-patch-brotlistream"},
"#brotli-patch-format": {"export":true,"for_":["Brotli patch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"format","type":"dfn","url":"#brotli-patch-format"},
"#brotli-patch-id": {"export":true,"for_":["Brotli patch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"id","type":"dfn","url":"#brotli-patch-id"},
"#design-space-segment": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"design space segment","type":"dfn","url":"#design-space-segment"},
"#design-space-segment-end": {"export":true,"for_":["Design Space Segment"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"end","type":"dfn","url":"#design-space-segment-end"},
"#design-space-segment-start": {"export":true,"for_":["Design Space Segment"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"start","type":"dfn","url":"#design-space-segment-start"},
"#design-space-segment-tag": {"export":true,"for_":["Design Space Segment"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"tag","type":"dfn","url":"#design-space-segment-tag"},
"#entrymaprecord": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entrymaprecord","type":"dfn","url":"#entrymaprecord"},
"#entrymaprecord-firstentryindex": {"export":true,"for_":["EntryMapRecord"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"firstentryindex","type":"dfn","url":"#entrymaprecord-firstentryindex"},
"#entrymaprecord-lastentryindex": {"export":true,"for_":["EntryMapRecord"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"lastentryindex","type":"dfn","url":"#entrymaprecord-lastentryindex"},
"#feature-map": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"feature map","type":"dfn","url":"#feature-map"},
"#feature-map-entrymaprecords": {"export":true,"for_":["Feature Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entrymaprecords","type":"dfn","url":"#feature-map-entrymaprecords"},
"#feature-map-featurerecords": {"export":true,"for_":["Feature Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"featurerecords","type":"dfn","url":"#feature-map-featurerecords"},
"#featurerecord": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"featurerecord","type":"dfn","url":"#featurerecord"},
"#featurerecord-entrymapcount": {"export":true,"for_":["FeatureRecord"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entrymapcount","type":"dfn","url":"#featurerecord-entrymapcount"},
"#featurerecord-featuretag": {"export":true,"for_":["FeatureRecord"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"featuretag","type":"dfn","url":"#featurerecord-featuretag"},
"#featurerecord-firstentryindex": {"export":true,"for_":["FeatureRecord"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"firstentryindex","type":"dfn","url":"#featurerecord-firstentryindex"},
"#font-patch": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"font patch","type":"dfn","url":"#font-patch"},
"#font-subset": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"font subset","type":"dfn","url":"#font-subset"},
"#font-subset-definition": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"font subset definition","type":"dfn","url":"#font-subset-definition"},
"#format-1-patch-map": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"format 1 patch map","type":"dfn","url":"#format-1-patch-map"},
"#format-1-patch-map-appliedentriesbitmap": {"export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"appliedentriesbitmap","type":"dfn","url":"#format-1-patch-map-appliedentriesbitmap"},
"#format-1-patch-map-entrycount": {"export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entrycount","type":"dfn","url":"#format-1-patch-map-entrycount"},
"#format-1-patch-map-format": {"export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"format","type":"dfn","url":"#format-1-patch-map-format"},
"#format-1-patch-map-glyphcount": {"export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"glyphcount","type":"dfn","url":"#format-1-patch-map-glyphcount"},
"#format-1-patch-map-id": {"export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"id","type":"dfn","url":"#format-1-patch-map-id"},
"#format-1-patch-map-patchencoding": {"export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"patchencoding","type":"dfn","url":"#format-1-patch-map-patchencoding"},
"#format-1-patch-map-uritemplate": {"export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"uritemplate","type":"dfn","url":"#format-1-patch-map-uritemplate"},
"#format-2-patch-map": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"format 2 patch map","type":"dfn","url":"#format-2-patch-map"},
"#format-2-patch-map-defaultpatchencoding": {"export":true,"for_":["Format 2 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"defaultpatchencoding","type":"dfn","url":"#format-2-patch-map-defaultpatchencoding"},
"#format-2-patch-map-entries": {"export":true,"for_":["Format 2 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entries","type":"dfn","url":"#format-2-patch-map-entries"},
"#format-2-patch-map-entrycount": {"export":true,"for_":["Format 2 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entrycount","type":"dfn","url":"#format-2-patch-map-entrycount"},
"#format-2-patch-map-entryidstringdata": {"export":true,"for_":["Format 2 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entryidstringdata","type":"dfn","url":"#format-2-patch-map-entryidstringdata"},
"#format-2-patch-map-format": {"export":true,"for_":["Format 2 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"format","type":"dfn","url":"#format-2-patch-map-format"},
"#format-2-patch-map-id": {"export":true,"for_":["Format 2 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"id","type":"dfn","url":"#format-2-patch-map-id"},
"#format-2-patch-map-uritemplate": {"export":true,"for_":["Format 2 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"uritemplate","type":"dfn","url":"#format-2-patch-map-uritemplate"},
"#full-invalidation": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"full invalidation","type":"dfn","url":"#full-invalidation"},
"#glyph-keyed-patch": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"glyph keyed patch","type":"dfn","url":"#glyph-keyed-patch"},
"#glyph-keyed-patch-brotlistream": {"export":true,"for_":["Glyph keyed patch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"brotlistream","type":"dfn","url":"#glyph-keyed-patch-brotlistream"},
"#glyph-keyed-patch-flags": {"export":true,"for_":["Glyph keyed patch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"flags","type":"dfn","url":"#glyph-keyed-patch-flags"},
"#glyph-keyed-patch-format": {"export":true,"for_":["Glyph keyed patch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"format","type":"dfn","url":"#glyph-keyed-patch-format"},
"#glyph-keyed-patch-id": {"export":true,"for_":["Glyph keyed patch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"id","type":"dfn","url":"#glyph-keyed-patch-id"},
"#glyph-map": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"glyph map","type":"dfn","url":"#glyph-map"},
"#glyph-map-entryindex": {"export":true,"for_":["Glyph Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entryindex","type":"dfn","url":"#glyph-map-entryindex"},
"#glyph-map-firstmappedglyph": {"export":true,"for_":["Glyph Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"firstmappedglyph","type":"dfn","url":"#glyph-map-firstmappedglyph"},
"#glyphpatches": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"glyphpatches","type":"dfn","url":"#glyphpatches"},
"#glyphpatches-glyphcount": {"export":true,"for_":["GlyphPatches"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"glyphcount","type":"dfn","url":"#glyphpatches-glyphcount"},
"#glyphpatches-glyphdata": {"export":true,"for_":["GlyphPatches"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"glyphdata","type":"dfn","url":"#glyphpatches-glyphdata"},
"#glyphpatches-glyphdataoffsets": {"export":true,"for_":["GlyphPatches"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"glyphdataoffsets","type":"dfn","url":"#glyphpatches-glyphdataoffsets"},
"#glyphpatches-glyphids": {"export":true,"for_":["GlyphPatches"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"glyphids","type":"dfn","url":"#glyphpatches-glyphids"},
"#glyphpatches-tables": {"export":true,"for_":["GlyphPatches"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"tables","type":"dfn","url":"#glyphpatches-tables"},
"#incremental-font": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"incremental font","type":"dfn","url":"#incremental-font"},
"#mapping-entries": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"mapping entries","type":"dfn","url":"#mapping-entries"},
"#mapping-entries-entries": {"export":true,"for_":["Mapping Entries"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entries","type":"dfn","url":"#mapping-entries-entries"},
"#mapping-entry": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"mapping entry","type":"dfn","url":"#mapping-entry"},
"#mapping-entry-bias": {"export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"bias","type":"dfn","url":"#mapping-entry-bias"},
"#mapping-entry-codepoints": {"export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"codepoints","type":"dfn","url":"#mapping-entry-codepoints"},
"#mapping-entry-copycount": {"export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"copycount","type":"dfn","url":"#mapping-entry-copycount"},
"#mapping-entry-copyindices": {"export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"copyindices","type":"dfn","url":"#mapping-entry-copyindices"},
"#mapping-entry-designspacecount": {"export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"designspacecount","type":"dfn","url":"#mapping-entry-designspacecount"},
"#mapping-entry-designspacesegments": {"export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"designspacesegments","type":"dfn","url":"#mapping-entry-designspacesegments"},
"#mapping-entry-entryiddelta": {"export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entryiddelta","type":"dfn","url":"#mapping-entry-entryiddelta"},
"#mapping-entry-entryidstringlength": {"export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entryidstringlength","type":"dfn","url":"#mapping-entry-entryidstringlength"},
"#mapping-entry-featurecount": {"export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"featurecount","type":"dfn","url":"#mapping-entry-featurecount"},
"#mapping-entry-featuretags": {"export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"featuretags","type":"dfn","url":"#mapping-entry-featuretags"},
"#mapping-entry-formatflags": {"export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"formatflags","type":"dfn","url":"#mapping-entry-formatflags"},
"#mapping-entry-patchencoding": {"export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"patchencoding","type":"dfn","url":"#mapping-entry-patchencoding"},
"#no-invalidation": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"no invalidation","type":"dfn","url":"#no-invalidation"},
"#partial-invalidation": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"partial invalidation","type":"dfn","url":"#partial-invalidation"},
"#patch-application-algorithm": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"patch application algorithm","type":"dfn","url":"#patch-application-algorithm"},
"#patch-format": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"patch format","type":"dfn","url":"#patch-format"},
"#patch-map-entries": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"patch map entries","type":"dfn","url":"#patch-map-entries"},
"#per-table-brotli-patch": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"per table brotli patch","type":"dfn","url":"#per-table-brotli-patch"},
"#per-table-brotli-patch-format": {"export":true,"for_":["Per table brotli patch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"format","type":"dfn","url":"#per-table-brotli-patch-format"},
"#per-table-brotli-patch-id": {"export":true,"for_":["Per table brotli patch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"id","type":"dfn","url":"#per-table-brotli-patch-id"},
"#per-table-brotli-patch-patches": {"export":true,"for_":["Per table brotli patch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"patches","type":"dfn","url":"#per-table-brotli-patch-patches"},
"#sparse-bit-set": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"sparse bit set","type":"dfn","url":"#sparse-bit-set"},
"#tablepatch": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"tablepatch","type":"dfn","url":"#tablepatch"},
"#tablepatch-brotlistream": {"export":true,"for_":["TablePatch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"brotlistream","type":"dfn","url":"#tablepatch-brotlistream"},
"#tablepatch-flags": {"export":true,"for_":["TablePatch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"flags","type":"dfn","url":"#tablepatch-flags"},
"#tablepatch-tag": {"export":true,"for_":["TablePatch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"tag","type":"dfn","url":"#tablepatch-tag"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.text != linkText) {
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.text)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const ref = refsData[url];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>
<script>/* Boilerplate: script-var-click-highlighting */
"use strict";
{
/*
Color-choosing design:

* Colors are ordered by goodness.
* On clicking a var, give it the earliest color
    with the lowest usage in the algorithm.
* On re-clicking, re-use the var's most recent color
    if that's not currently being used elsewhere.
*/

const COLOR_COUNT = 7;

document.addEventListener("click", e=>{
    if(e.target.nodeName == "VAR") {
        highlightSameAlgoVars(e.target);
    }
});

function highlightSameAlgoVars(v) {
    // Find the algorithm container.
    let algoContainer = findAlgoContainer(v);

    // Not highlighting document-global vars,
    // too likely to be unrelated.
    if(algoContainer == null) return;

    const varName = nameFromVar(v);
    if(!v.hasAttribute("data-var-color")) {
        const newColor = chooseHighlightColor(algoContainer, v);
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.setAttribute("data-var-color", newColor);
                el.setAttribute("data-var-last-color", newColor);
            }
        }
    } else {
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.removeAttribute("data-var-color");
            }
        }
    }
}
function findAlgoContainer(el) {
    while(el != document.body) {
        if(el.hasAttribute("data-algorithm")) return el;
        el = el.parentNode;
    }
    return null;
}
function nameFromVar(el) {
    return el.textContent.replace(/(\s|\xa0)+/g, " ").trim();
}
function colorCountsFromContainer(container) {
    const namesFromColor = Array.from({length:COLOR_COUNT}, x=>new Set());
    for(let v of container.querySelectorAll("var[data-var-color]")) {
        let color = +v.getAttribute("data-var-color");
        namesFromColor[color].add(nameFromVar(v));
    }

    return namesFromColor.map(x=>x.size);
}
function leastUsedColor(colors) {
    // Find the earliest color with the lowest count.
    let minCount = Infinity;
    let minColor = null;
    for(var i = 0; i < colors.length; i++) {
        if(colors[i] < minCount) {
            minColor = i;
            minCount = colors[i];
        }
    }
    return minColor;
}
function chooseHighlightColor(container, v) {
    const colorCounts = colorCountsFromContainer(container);
    if(v.hasAttribute("data-var-last-color")) {
        let color = +v.getAttribute("data-var-last-color");
        if(colorCounts[color] == 0) return color;
    }
    return leastUsedColor(colorCounts);
}
}
</script>