<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <title>Incremental Font Transfer</title>
  <meta content="WD" name="w3c-status">
  <meta content="Bikeshed version 63e66730b, updated Tue Oct 25 12:35:05 2022 -0700" name="generator">
  <link href="https://www.w3.org/TR/IFT/" rel="canonical">
  <meta content="c13ee175556e93e33f09de789e6c4cb41336eee2" name="document-revision">
<style>
.conform:hover {background: #31668f}
.conform:target {padding: 2px; border: 2px solid #AAA; background: #31668f }
</style>
<style>/* style-autolinks */

.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}</style>
<style>/* style-counters */

body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}</style>
<style>/* style-dfn-panel */

:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    height: auto;
    width: -webkit-fit-content;
    width: fit-content;
    max-width: 300px;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0; }
.dfn-panel li { list-style: inside; }
.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: .5em;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
}

.dfn-paneled { cursor: pointer; }
</style>
<style>/* style-issues */

a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* style-md-lists */

/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}</style>
<style>/* style-selflinks */

:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* style-var-click-highlighting */

    var { cursor: pointer; }
    var.selected0 { background-color: #F4D200; box-shadow: 0 0 0 2px #F4D200; }
    var.selected1 { background-color: #FF87A2; box-shadow: 0 0 0 2px #FF87A2; }
    var.selected2 { background-color: #96E885; box-shadow: 0 0 0 2px #96E885; }
    var.selected3 { background-color: #3EEED2; box-shadow: 0 0 0 2px #3EEED2; }
    var.selected4 { background-color: #EACFB6; box-shadow: 0 0 0 2px #EACFB6; }
    var.selected5 { background-color: #82DDFF; box-shadow: 0 0 0 2px #82DDFF; }
    var.selected6 { background-color: #FFBCF2; box-shadow: 0 0 0 2px #FFBCF2; }
    </style>
  <link href="https://www.w3.org/StyleSheets/TR/2021/W3C-WD" rel="stylesheet">
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">Incremental Font Transfer</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#WD">W3C Working Draft</a>, <time class="dt-updated" datetime="2022-06-28">28 June 2022</time></p>
   <details open>
    <summary>More details about this document</summary>
    <div data-fill-with="spec-metadata">
     <dl>
      <dt>This version:
      <dd><a class="u-url" href="https://www.w3.org/TR/2022/WD-IFT-20220628/">https://www.w3.org/TR/2022/WD-IFT-20220628/</a>
      <dt>Latest published version:
      <dd><a href="https://www.w3.org/TR/IFT/">https://www.w3.org/TR/IFT/</a>
      <dt>Editor's Draft:
      <dd><a href="https://w3c.github.io/IFT/Overview.html">https://w3c.github.io/IFT/Overview.html</a>
      <dt>History:
      <dd><a class="u-url" href="https://www.w3.org/standards/history/IFT">https://www.w3.org/standards/history/IFT</a>
      <dt>Feedback:
      <dd><span><a href="mailto:public-webfonts-wg@w3.org?subject=%5BIFT%5D%20YOUR%20TOPIC%20HERE">public-webfonts-wg@w3.org</a> with subject line “<kbd>[IFT] <i data-lt>… message topic …</i></kbd>” (<a href="https://lists.w3.org/Archives/Public/public-webfonts-wg/" rel="discussion">archives</a>)</span>
      <dd><a href="https://github.com/w3c/PFE/issues/">GitHub</a>
      <dd><a href="#issues-index">Inline In Spec</a>
      <dt class="editor">Editors:
      <dd class="editor p-author h-card vcard" data-editor-id="1438"><a class="p-name fn u-url url" href="https://svgees.us/">Chris Lilley</a> (<span class="p-org org">W3C</span>)
      <dd class="editor p-author h-card vcard" data-editor-id="77180"><a class="p-name fn u-email email" href="mailto:mmaxfield@apple.com">Myles C. Maxfield</a> (<span class="p-org org">Apple Inc.</span>)
      <dd class="editor p-author h-card vcard" data-editor-id="73905"><a class="p-name fn u-email email" href="mailto:grieger@google.com">Garret Rieger</a> (<span class="p-org org">Google Inc.</span>)
     </dl>
    </div>
   </details>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © 2022 <a href="https://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>®</sup> (<a href="https://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>, <a href="https://www.ercim.eu/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>, <a href="https://www.keio.ac.jp/">Keio</a>, <a href="https://ev.buaa.edu.cn/">Beihang</a>). W3C <a href="https://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>, <a href="https://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and <a href="https://www.w3.org/Consortium/Legal/2015/copyright-software-and-document" rel="license">permissive document license</a> rules apply. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>This specification defines two methods to incrementally transfer fonts from server to client.

          Incremental transfer allows clients to load only the portions of the font they actually need
          which speeds up font loads and reduces data transfer needed to load the fonts. A font can
          be loaded over multiple requests where each request incrementally adds additional data.</p>
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="sotd"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> <em>This section describes the status of this document at the time of
  its publication. A list of
  current W3C publications and the latest revision of this technical report
  can be found in the <a href="https://www.w3.org/TR/">W3C technical reports
  index at https://www.w3.org/TR/.</a></em> </p>
   <p> This document was produced by the <a href="https://www.w3.org/groups/wg/webfonts">Web Fonts Working Group</a> as a Working Draft using the <a href="https://www.w3.org/2021/Process-20211102/#recs-and-notes">Recommendation
      track</a>. This document is intended to become a W3C Recommendation. </p>
   <p> If you wish to make comments regarding this document, please <a href="https://github.com/w3c/PFE/issues/new">file an issue on the specification repository</a>. </p>
   <p> Publication as a Working Draft does not imply endorsement by <abbr title="World Wide Web Consortium">W3C</abbr> and its Members. This is a draft document and may be updated, replaced or
  obsoleted by other documents at any time. It is inappropriate to cite this
  document as other than work in progress. </p>
   <p> This document was produced by groups operating under
  the <a href="https://www.w3.org/Consortium/Patent-Policy-20200915/">W3C Patent Policy</a>.
  W3C maintains a <a href="https://www.w3.org/groups/wg/webfonts/ipr" rel="disclosure">public list of any patent disclosures</a> made in connection with the deliverables of the group;
  that page also includes instructions for disclosing a patent.
  An individual who has actual knowledge of a patent which the individual believes contains <a href="https://www.w3.org/Consortium/Patent-Policy-20200915/#def-essential">Essential Claim(s)</a> must disclose the information in accordance with <a href="https://www.w3.org/Consortium/Patent-Policy-20200915/#sec-Disclosure">section 6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>. </p>
   <p> This document is governed by the <a href="https://www.w3.org/2021/Process-20211102/" id="w3c_process_revision">2 November 2021 W3C Process Document</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li>
     <a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
     <ol class="toc">
      <li><a href="#patch-subset"><span class="secno">1.1</span> <span class="content">Patch Subset</span></a>
      <li><a href="#range-request"><span class="secno">1.2</span> <span class="content">Range Request</span></a>
      <li><a href="#evaluation-report"><span class="secno">1.3</span> <span class="content">Technical Motivation: Evaluation Report</span></a>
      <li>
       <a href="#performance-considerations"><span class="secno">1.4</span> <span class="content">Performance Considerations and the use of Incremental Font Transfer</span></a>
       <ol class="toc">
        <li><a href="#reduce-requests"><span class="secno">1.4.1</span> <span class="content">Reducing the Number of Network Requests</span></a>
        <li><a href="#patchsubset-vs-rangerequest"><span class="secno">1.4.2</span> <span class="content">Deciding between Patch Subset and Range Request</span></a>
       </ol>
     </ol>
    <li><a href="#opt-in"><span class="secno">2</span> <span class="content">Opt-In Mechanism</span></a>
    <li>
     <a href="#method-selection"><span class="secno">3</span> <span class="content">IFT Method Selection</span></a>
     <ol class="toc">
      <li><a href="#method-negotiation"><span class="secno">3.1</span> <span class="content">IFT Method Negotiation</span></a>
      <li><a href="#fallback"><span class="secno">3.2</span> <span class="content">IFT Method Fallback</span></a>
      <li><a href="#offline-usage"><span class="secno">3.3</span> <span class="content">Offline Usage</span></a>
     </ol>
    <li>
     <a href="#patch-incxfer"><span class="secno">4</span> <span class="content">Patch Based Incremental Transfer</span></a>
     <ol class="toc">
      <li><a href="#font-subset-info"><span class="secno">4.1</span> <span class="content">Font Subset</span></a>
      <li>
       <a href="#data-types"><span class="secno">4.2</span> <span class="content">Data Types</span></a>
       <ol class="toc">
        <li><a href="#encoding"><span class="secno">4.2.1</span> <span class="content">Encoding</span></a>
        <li><a href="#primitives"><span class="secno">4.2.2</span> <span class="content">Primitives</span></a>
        <li><a href="#protocol-version"><span class="secno">4.2.3</span> <span class="content"><span>ProtocolVersion</span></span></a>
        <li><a href="#sparsebitset-object"><span class="secno">4.2.4</span> <span class="content"><span>SparseBitSet</span></span></a>
        <li>
         <a href="#integerlist-object"><span class="secno">4.2.5</span> <span class="content"><span>IntegerList</span></span></a>
         <ol class="toc">
          <li><a href="#integerlist-deltas"><span class="secno">4.2.5.1</span> <span class="content">Delta Encoding</span></a>
          <li><a href="#integerlist-zigzag"><span class="secno">4.2.5.2</span> <span class="content">Zig-Zag Encoding</span></a>
          <li><a href="#integerlist-uintbase128"><span class="secno">4.2.5.3</span> <span class="content">UIntBase128 Encoding</span></a>
         </ol>
        <li><a href="#sortedintegerlist-object"><span class="secno">4.2.6</span> <span class="content"><span>SortedIntegerList</span></span></a>
        <li><a href="#rangelist-object"><span class="secno">4.2.7</span> <span class="content"><span>RangeList</span></span></a>
        <li><a href="#featuretagset-object"><span class="secno">4.2.8</span> <span class="content"><span>FeatureTagSet</span></span></a>
        <li><a href="#AxisSpace"><span class="secno">4.2.9</span> <span class="content"><span>AxisSpace</span></span></a>
        <li><a href="#objects"><span class="secno">4.2.10</span> <span class="content">Objects</span></a>
       </ol>
      <li>
       <a href="#schemas"><span class="secno">4.3</span> <span class="content">Object Schemas</span></a>
       <ol class="toc">
        <li><a href="#CompressedSet"><span class="secno">4.3.1</span> <span class="content"><span>CompressedSet</span></span></a>
        <li><a href="#AxisInterval"><span class="secno">4.3.2</span> <span class="content"><span>AxisInterval</span></span></a>
        <li><a href="#PatchRequest"><span class="secno">4.3.3</span> <span class="content"><span>PatchRequest</span></span></a>
        <li><a href="#PatchResponse"><span class="secno">4.3.4</span> <span class="content"><span>PatchResponse</span></span></a>
        <li><a href="#ClientState"><span class="secno">4.3.5</span> <span class="content"><span>ClientState</span></span></a>
       </ol>
      <li>
       <a href="#client"><span class="secno">4.4</span> <span class="content">Client</span></a>
       <ol class="toc">
        <li><a href="#extend-subset"><span class="secno">4.4.1</span> <span class="content">Extending the Font Subset</span></a>
        <li><a href="#handling-patch-response"><span class="secno">4.4.2</span> <span class="content">Handling Server Response</span></a>
        <li><a href="#load-a-font"><span class="secno">4.4.3</span> <span class="content">Load a Font in a User Agent with a HTTP Cache</span></a>
       </ol>
      <li>
       <a href="#handling-patch-request"><span class="secno">4.5</span> <span class="content">Server: Responding to a PatchRequest</span></a>
       <ol class="toc">
        <li><a href="#range-request-support"><span class="secno">4.5.1</span> <span class="content">Range Request Support</span></a>
       </ol>
      <li><a href="#computing-checksums"><span class="secno">4.6</span> <span class="content">Computing Checksums</span></a>
      <li>
       <a href="#codepoint-reordering"><span class="secno">4.7</span> <span class="content">Codepoint Reordering</span></a>
       <ol class="toc">
        <li><a href="#reordering-checksum"><span class="secno">4.7.1</span> <span class="content">Codepoint Reordering Checksum</span></a>
       </ol>
      <li><a href="#patch-formats"><span class="secno">4.8</span> <span class="content">Patch Formats</span></a>
     </ol>
    <li>
     <a href="#range-request-incxfer"><span class="secno">5</span> <span class="content">Range Request Incremental Transfer</span></a>
     <ol class="toc">
      <li><a href="#range-request-intro"><span class="secno">5.1</span> <span class="content">Introduction to Range Request</span></a>
      <li>
       <a href="#font-organization"><span class="secno">5.2</span> <span class="content">Font organization</span></a>
       <ol class="toc">
        <li><a href="#font-organization-background"><span class="secno">5.2.1</span> <span class="content">Background</span></a>
        <li><a href="#font-organization-introduction"><span class="secno">5.2.2</span> <span class="content">Introduction</span></a>
        <li><a href="#font-organization-compression"><span class="secno">5.2.3</span> <span class="content">Compression</span></a>
        <li><a href="#font-organization-table-ordering"><span class="secno">5.2.4</span> <span class="content">Table Ordering</span></a>
        <li><a href="#font-organization-glyph-independence"><span class="secno">5.2.5</span> <span class="content">Glyph Independence</span></a>
        <li><a href="#font-organization-glyph-order"><span class="secno">5.2.6</span> <span class="content">Glyph Order</span></a>
       </ol>
      <li>
       <a href="#browser-behaviors"><span class="secno">5.3</span> <span class="content">Browser Behaviors</span></a>
       <ol class="toc">
        <li><a href="#browser-behaviors-first-request"><span class="secno">5.3.1</span> <span class="content">First Request</span></a>
        <li><a href="#browser-behaviors-subsequent-requests"><span class="secno">5.3.2</span> <span class="content">Subsequent Requests</span></a>
       </ol>
      <li><a href="#server-behaviors"><span class="secno">5.4</span> <span class="content">Server Behaviors</span></a>
     </ol>
    <li>
     <a href="#priv"><span class="secno"></span> <span class="content">Privacy Considerations</span></a>
     <ol class="toc">
      <li><a href="#content-inference-from-character-set"><span class="secno"></span> <span class="content">Content inference from character set</span></a>
      <li><a href="#checksum-and-possible-fingerprinting"><span class="secno"></span> <span class="content">Checksums and possible fingerprinting</span></a>
      <li><a href="#per-origin"><span class="secno"></span> <span class="content">Per-origin restriction avoids fingerprinting</span></a>
     </ol>
    <li><a href="#sec"><span class="secno"></span> <span class="content">Security Considerations</span></a>
    <li><a href="#suggested-glyph-character-ordering"><span class="secno"></span> <span class="content"> Appendix A: Suggested glyph/character ordering</span></a>
    <li><a href="#feature-tag-list"><span class="secno"></span> <span class="content"> Appendix B: Default Feature Tags and Encoding IDs</span></a>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
      <li><a href="#w3c-conformant-algorithms"><span class="secno"></span> <span class="content">Conformant Algorithms</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
   <p><em>This section is not normative.</em></p>
   <p>Incremental Font Transfer (IFT) is a collection of technologies to improve the latency of remote fonts (or "web fonts") on the web. Without this technology, a browser needs to download every last byte of a font before it can render any characters using that font. IFT allows the browser to download only some of the bytes in the file, thereby decreasing the perceived latency between the time when a browser realizes it needs a font and when the necessary text can be rendered with that font.</p>
   <p>The success of WebFonts is unevenly distributed. This specification allows WebFonts to be used where
slow networks, very large fonts, or complex subsetting requirements currently preclude their use. For
example, even using WOFF 2 <a data-link-type="biblio" href="#biblio-woff2">[WOFF2]</a>, fonts for CJK languages are too large to be practical.</p>
   <p>There are two different methods which can be used to incrementally transfer fonts.</p>
   <h3 class="heading settled" data-level="1.1" id="patch-subset"><span class="secno">1.1. </span><span class="content">Patch Subset</span><a class="self-link" href="#patch-subset"></a></h3>
   <p>In the the first method, <a href="#patch-subset">Patch Subset</a> a server generates binary patches which a
client applies to a subset of the font in order to extend the coverage of that subset. The server
is stateless, it does not maintain any session data for clients between requests. Thus when a client
requests the generation of a patch from the server it has to fully describe the current subset of the
font that it has in a way which allows the server to recreate it.</p>
   <p>Generic binary patch algorithms are used which do not need to be aware of the specifics of the font
format. Typically a server will produce a patch by generating two <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset">font subsets</a>: one which matches what
the client currently has and one which matches the extended subset the client desires. A binary patch
is then produced between the two subsets.</p>
   <h3 class="heading settled" data-level="1.2" id="range-request"><span class="secno">1.2. </span><span class="content">Range Request</span><a class="self-link" href="#range-request"></a></h3>
   <p>The second
method, <a href="#range-request-incxfer">Range Request</a>, has no server-side requirements other than the server should be able to respond to byte-based range requests. The browser makes range requests to the server for the specific bytes in the font file that it needs. In order to know which bytes are necessary, the browser makes one initial special request for the beginning of the file to obtain all required font tables, and then calculates glyph coverage and required byte ranges using font character-to-glyph mapping and glyph substitution / layout tables.</p>
   <p>In order for the range request method to be as effective as possible, the font file itself should be internally arranged in a particular way, in order to decrease the number of requests the browser needs to make. Therefore, it is expected that web developers wishing to use the range request method will use font files that have had their contents already arranged optimally.</p>
   <p>This method was modelled after video playback on the web, where seeking in a video causes the browser to send a range request to the server.</p>
   <h3 class="heading settled" data-level="1.3" id="evaluation-report"><span class="secno">1.3. </span><span class="content">Technical Motivation: Evaluation Report</span><a class="self-link" href="#evaluation-report"></a></h3>
   <p>See the Progressive Font Enrichment: Evaluation Report <a data-link-type="biblio" href="#biblio-pfe-report">[PFE-report]</a> for the investigation which led
to this specification.</p>
   <p>The evaluation report found that patch subset was generally more efficient in terms of overall
performance and transferred bytes than range request. However, Range Request is simpler to deploy
for many uses cases while still providing material improvments to loading performance for large fonts.</p>
   <h3 class="heading settled" data-level="1.4" id="performance-considerations"><span class="secno">1.4. </span><span class="content">Performance Considerations and the use of Incremental Font Transfer</span><a class="self-link" href="#performance-considerations"></a></h3>
   <p>Using incremental transfer may not always be beneficial, depending on the characteristics of the font
and the content being rendered. This section provides non-normative guidance to help decide:</p>
   <ol>
    <li data-md>
     <p>When incremental transfer should be utilized.</p>
    <li data-md>
     <p>When used, which of the two methods should be utilized.</p>
   </ol>
   <p>Incrementally loading a font has a fundemental performance tradeoff versus loading the whole font.
Simplistically, under incremental transfer less bytes may be transferred at the potential cost of
increasing the total number of network requests being made, and/or increased request processing
latency. In general incremental font transfer will be beneficial where the reduction in latency from
sending less bytes outweighs additional latency introduced by the incremental transfer method.</p>
   <p>The first factor to consider is the language of the content being rendered. The evaluation report
contains the results of simulating incremental font transfer across three categories of languages
(<a href="https://www.w3.org/TR/PFE-evaluation/#langtype">Progressive Font Enrichment: Evaluation Report § langtype</a>). See it’s conclusions <a href="https://www.w3.org/TR/PFE-evaluation/#conclusions">Progressive Font Enrichment: Evaluation Report § conclusions</a> for a discussion of the
anticipated performance of incremental font transfer across the language categories.</p>
   <p>Next, how much of the font is expected to be needed? If it’s expected that most of the font will be
needed to render the content then incremental font transfer is unlikely to be beneficial. In many cases
however only part of a font is expected to be needed. For example:</p>
   <ul>
    <li data-md>
     <p>If the font contains support for several languages but a user is expected to only render content
in a subset of those languages.</p>
    <li data-md>
     <p>If the content being rendered uses a small subset of the total characters in a font. This is
often the case for Chinese, Japanese, Korean, Emoji, and Icon fonts.</p>
    <li data-md>
     <p>Only a small amount of text is being rendered. For example a font that is only used for a
headline.</p>
   </ul>
   <p>An alternative to incremental transfer is to break a font into distinct subsets (typically by script)
and use the unicode range feature of @font-face to load only the subsets needed. However, this can
break rendering <a href="https://www.w3.org/TR/PFE-evaluation/#fail-subset">Progressive Font Enrichment: Evaluation Report § fail-subset</a> if there are layout rules between characters in
different subsets. Incremental font transfer does not suffer from this issue as it maintains the
original font and all it’s layout rules.</p>
   <h4 class="heading settled" data-level="1.4.1" id="reduce-requests"><span class="secno">1.4.1. </span><span class="content">Reducing the Number of Network Requests</span><a class="self-link" href="#reduce-requests"></a></h4>
   <p>As discussed in the previous section the most basic implementation of incremental font transfer will
tend to increase the total number of requests made vs traditional font loading. Since each request
will require at least one round trip time, performance can be negatively impacted if too many requests
are made. Both range request and patch subset allow for more codepoints then needed to be requested.
Intelligent use of this feature by an implementation can help reduce the total number of requests
being made. The evaluation report explored this by testing the performance of a basic character
frequency based <a href="https://www.w3.org/TR/PFE-evaluation/#codepredict">codepoint prediction</a> scheme and found it improved overall
performance.</p>
   <p>Performant implementations should incorporate a similar mechanism which can select codepoints which are
likely to be needed in the future and preemptively load them. This will improve performance by reducing
the need to make additional requests for missing codepoints. The set of codepoints the client has and
the set they are requesting can be used in conjuction with codepoint occurence frequency and codepoint
usage in languages/scripts  to make predictions on which additional codepoints are likely to be needed.</p>
   <p>Under range request the prediction mechanism will need to be part of the client implementation. In
patch subset either the client and/or server implementation can include a prediction mechanism. A side
benefit to a client side prediction mechanism is providing some obfuscation of the specific codepoints
required by the client. This is further discussed in <a href="#content-inference-from-character-set">Content inference from character set</a>.</p>
   <h4 class="heading settled" data-level="1.4.2" id="patchsubset-vs-rangerequest"><span class="secno">1.4.2. </span><span class="content">Deciding between Patch Subset and Range Request</span><a class="self-link" href="#patchsubset-vs-rangerequest"></a></h4>
   <p>From a purely performance perspective patch subset is more performant than range request. There are
three main factors for this:</p>
   <ol>
    <li data-md>
     <p>Range request requires an extra round trip on the very first load of a font to fetch the non-outline
font data.</p>
    <li data-md>
     <p>Patch subset is able to incrementally transfer all tables in the font, while range request is
limited to only incrementally transferring glyph outline tables. In many fonts the majority of
data is in the glyph outlines, however there are fonts that have significant amounts of data in
the non outline tables.</p>
    <li data-md>
     <p>Patch subset is able to compress incremental font data against previously loaded data from that
font. This leads to better compression overall compared to range request.</p>
   </ol>
   <p>See the evaluation report for a quantative assessment of the difference in performance of patch
subset versus range request <a href="https://www.w3.org/TR/PFE-evaluation/#analysis">Progressive Font Enrichment: Evaluation Report § analysis</a>.</p>
   <p>The downside of using patch subset is that it requires server side processing to produce the patches,
while range request can work on any standard HTTP server that supports range requests:</p>
   <ul>
    <li data-md>
     <p>This means that range request can be deployed easier, and in places such as CDN’s where the content
owner may not have control over the serving stack.</p>
    <li data-md>
     <p>The server side processing required by patch subset will lead to increased processing costs (eg.
CPU, RAM usage) per request vs range request.</p>
   </ul>
   <h2 class="heading settled" data-level="2" id="opt-in"><span class="secno">2. </span><span class="content">Opt-In Mechanism</span><a class="self-link" href="#opt-in"></a></h2>
   <p><em>This section is general to both IFT methods.</em></p>
   <p>Webpage’s can choose to opt-in to either patch subset or range request incremental transfer for a font
via the use of a CSS font tech keyword (<a href="https://www.w3.org/TR/css-fonts-4/#font-tech-definitions"><cite>CSS Fonts 4</cite> § 11.1 Font tech</a>) inside the <a class="css" data-link-type="maybe" href="https://www.w3.org/TR/css-fonts-5/#at-font-face-rule" id="ref-for-at-font-face-rule">@font-face</a> block.</p>
   <p>There are three tech keywords available:</p>
   <ul>
    <li data-md>
     <p><code>incremental-patch</code>: Load the font incrementally using the patch subset method.</p>
    <li data-md>
     <p><code>incremental-range</code>: Load the font incrementally using the range request method.</p>
    <li data-md>
     <p><code>incremental-auto</code>:  Load the font incrementally. The particular method to use is
determined by <a href="#method-negotiation">Method Negotiation</a>.</p>
   </ul>
   <div class="example" id="example-162f300b">
    <a class="self-link" href="#example-162f300b"></a> The use of the <code>incremental-patch</code> keyword in this CSS rule indicates to the browser they
should use the patch subset IFT method to load the font. 
<pre>@font-face {
    font-family: "MyCoolWebFont";
    src: url("MyCoolWebFont.otf") tech(incremental-patch);
}
</pre>
   </div>
   <p class="note" role="note"><span>Note:</span> Each individual <code>@font-face</code> block may or may not opt-in to IFT. This is due to the
variety of ways fonts are used on web pages. Authors have control over which fonts they want to use
this technology with, and which they do not.</p>
   <p class="note" role="note"><span>Note:</span> the use of <code>incremental-auto</code> may incur a CORS preflight request for the initial
request of method negotiation, as the initial request sets a custom header.</p>
   <p class="note" role="note"><span>Note:</span> the IFT tech keywords can be used in conjuction with other font tech specifiers to perform
font feature selection. For example a <code>@font-face</code> could include two urls one with <code>tech(incremental-patch, color-COLRv1)</code> and the other with <code>tech(incremental-patch, color-COLRv0)</code>. The client would initiate an incremental patch
subset transfer to one of the URLs depending on which version of COLR is supported.</p>
   <h2 class="heading settled" data-level="3" id="method-selection"><span class="secno">3. </span><span class="content">IFT Method Selection</span><a class="self-link" href="#method-selection"></a></h2>
   <p><em>This section is general to both IFT methods.</em></p>
   <p>The client should have support for both patch subset and range request IFT. The client selects the
IFT method to utilize for a font load using the following procedure:</p>
   <ul>
    <li data-md>
     <p>If the content has specified which method to use, such as via the <code>incremental-patch</code> or <code>incremental-range</code> font tech keyword (see: <a href="#opt-in">opt-in mechanism</a>),
then that method should be used if the client supports it. If the specified method is not supported
then the client should fallback to to loading the font non-incrementally.</p>
    <li data-md>
     <p>Otherwise if the client does not know which particular IFT method(s) that the server hosting the
font supports, such as when the <code>incremental-auto</code> font tech keyword is used, then <a href="#method-negotiation">method negotiation</a> should be used to determine the method.</p>
   </ul>
   <p>The most recently specified method by the content takes precedence. For example if on a site the
first page specifies to use the patch subset method for a font URL, but the second page specifies
range request for the same font URL then the second page should load the font using range request.
Such cases will require the client to reset any previously stored state for that URL and start fresh
with the new method. In the case that <code>incremental-auto</code> is encountered where previously a
specific method was specified then the client can choose to continue using the previously selected
method.</p>
   <h3 class="heading settled" data-level="3.1" id="method-negotiation"><span class="secno">3.1. </span><span class="content">IFT Method Negotiation</span><a class="self-link" href="#method-negotiation"></a></h3>
   <p>When the particular IFT method(s) that are supported by a server are not known, the client must
determine which method to use. Different clients may support different IFT methods, and different
servers may support different IFT methods, so a negotation occurs as such:</p>
   <ol>
    <li data-md>
     <p>The browser makes the first request to the server using the GET HTTP method (<a href="https://www.rfc-editor.org/rfc/rfc9110#name-get">HTTP Semantics § name-get</a>).
 If the client prefers the <a href="#patch-incxfer">patch-subset method</a>, it sends the relevant <a data-link-type="dfn" href="#patch-request-header" id="ref-for-patch-request-header">patch request header</a>. If the client prefers the range-request method, it does not send the
 header.</p>
    <li data-md>
     <p>If the server receives the patch request header and wishes to honor it, the server must reply with
 a valid <a href="#PatchResponse">patch subset response</a> which includes the <a href="#handling-patch-response">patch-subset magic number</a>. Otherwise, the server must
 reply with the <a href="https://www.rfc-editor.org/rfc/rfc9110#range.requests">HTTP Semantics § range.requests</a> <a href="https://www.rfc-editor.org/rfc/rfc9110.html#name-accept-ranges"><code>Accept-Ranges</code></a> header, if it supports HTTP Range Requests.</p>
    <li data-md>
     <p>If the client receives the patch-subset magic number, it commences using the patch-subset method.
 Otherwise, if the client receives the <code>Accept-Ranges: bytes</code> header, it commences
 using the range-request method. Otherwise, the whole font file is downloaded, and the current
 non-incremental loading behavior is used.</p>
   </ol>
   <h3 class="heading settled" data-level="3.2" id="fallback"><span class="secno">3.2. </span><span class="content">IFT Method Fallback</span><a class="self-link" href="#fallback"></a></h3>
   <p><em>This section is not normative.</em></p>
   <p>This summarizes behaviors that result from the above method selection and negotiation sections.</p>
   <p>If the content specifies the range request method:</p>
   <table class="data">
    <thead>
     <tr>
      <th>
      <th>Client supports range-request method 
      <th>Client does not support range-request method 
    <tbody>
     <tr>
      <th>Server supports range-request method 
      <td>Range-request method is used. 
      <td>Client falls back to non-incremental load of the full font file. 
     <tr>
      <th>Server does not support range-request method. 
      <td>Response is missing accept-ranges header. Client falls back to
                non-incremental load of the full font file. 
      <td>Client falls back to non-incremental load of the full font file. 
   </table>
   <p>If the content specifies the patch subset method:</p>
   <table class="data">
    <thead>
     <tr>
      <th>
      <th>Client supports patch-subset method 
      <th>Client does not support patch-subset method 
    <tbody>
     <tr>
      <th>Server supports patch-subset method 
      <td>Patch-subset method is used. 
      <td>Client falls back to non-incremental load of the full font file. 
     <tr>
      <th>Server does not support patch-subset method 
      <td>Response is missing magic number. Client falls back to non-incremental load of the
            full font file. 
      <td>Client falls back to non-incremental load of the
            full font file. 
   </table>
   <p>If the content does not specify a specific method:</p>
   <table class="data">
    <thead>
     <tr>
      <th>
      <th>Client prefers range-request method 
      <th>Client prefers patch-subset method 
    <tbody>
     <tr>
      <th>Server supports both range-request method and patch-subset method 
      <td>Client makes initial request without the patch request header, and possibly with the <code>Range</code> header. Because all patch-subset servers must support the range-request method, the server replies with <code>Accept-Ranges</code> and initial font data. Client/server commence using range-request method. 
      <td>Client makes initial request with the patch request header. Server replies with the patch-subset magic number, and client/server commence using patch-subset method. 
     <tr>
      <th>Server supports only range-request method 
      <td>Same as above. 
      <td>Client makes initial request with the patch request header. Server replies with <code>Accept-Ranges</code> and initial font data. Client/server commence using range-request method. 
     <tr>
      <th>Server supports neither 
      <td>Client makes initial request without the patch request header, and possibly with the <code>Range</code> header. Server replies without <code>Accept-Ranges</code> header, and sends the full font file to the client from beginning to end. 
      <td>Client makes initial request to server with the patch request header. Server does not reply with the patch-subset magic number, and sends the full font file to the client from beginning to end. 
   </table>
   <h3 class="heading settled" data-level="3.3" id="offline-usage"><span class="secno">3.3. </span><span class="content">Offline Usage</span><a class="self-link" href="#offline-usage"></a></h3>
   <p>Special consideration must be taken when saving a page for offline usage that uses an incrementally
transferred font since the saved page won’t be able to increment the font if content changes (eg.
due to javascript execution). In these cases the page saving mechanism should download the full font
by making a normal GET request without the <a data-link-type="dfn" href="#patch-request-header" id="ref-for-patch-request-header①">patch request header</a> to the font url. Additionally
when URL’s are rewritten to point to the saved full font any of the incremental tech specifiers should
be removed.</p>
   <h2 class="heading settled" data-level="4" id="patch-incxfer"><span class="secno">4. </span><span class="content">Patch Based Incremental Transfer</span><a class="self-link" href="#patch-incxfer"></a></h2>
   <h3 class="heading settled" data-level="4.1" id="font-subset-info"><span class="secno">4.1. </span><span class="content">Font Subset</span><a class="self-link" href="#font-subset-info"></a></h3>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="font-subset">font subset</dfn> is a modified version of a font file that contains only the data needed to
render a subset of:</p>
   <ul>
    <li data-md>
     <p>the codepoints,</p>
    <li data-md>
     <p><a href="https://docs.microsoft.com/en-us/typography/opentype/spec/featuretags">opentype layout
features</a>,</p>
    <li data-md>
     <p>and <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otvaroverview#terminology">design-variation space</a>.</p>
   </ul>
   <p>supported by the original font. <span class="conform client server" id="conform-font-subset"> When a subsetted font is used to render text using any combination of the subset codepoints, <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/featuretags">layout features</a>,
or <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otvaroverview#terminology">design-variation space</a> it must render identically to the original font. This includes rendering with
the use of any optional typographic features that a renderer may choose to use from the original font,
such as hinting instructions. </span></p>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="font-subset-definition">font subset definition</dfn> describes the minimum data (codepoints, layout features,
variation axis space) that a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①">font subset</a> must possess.</p>
   <h3 class="heading settled" data-level="4.2" id="data-types"><span class="secno">4.2. </span><span class="content">Data Types</span><a class="self-link" href="#data-types"></a></h3>
   <p>This section lists all of the data types that are used to form the request and response messages
sent between the client and server.</p>
   <h4 class="heading settled" data-level="4.2.1" id="encoding"><span class="secno">4.2.1. </span><span class="content">Encoding</span><a class="self-link" href="#encoding"></a></h4>
   <p>All data types defined here are encoded into a byte representation for transport using CBOR
(Concise Binary Object Representation) <a data-link-type="biblio" href="#biblio-rfc8949">[RFC8949]</a>. More information on how each data types
should be encoded by CBOR are given in the definition of those data types.</p>
   <h4 class="heading settled" data-level="4.2.2" id="primitives"><span class="secno">4.2.2. </span><span class="content">Primitives</span><a class="self-link" href="#primitives"></a></h4>
   <table>
    <tbody>
     <tr>
      <th>Data Type
      <th>Description
      <th>CBOR Major Type
     <tr>
      <td><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="integer">Integer</dfn>
      <td>An integer value range [-2<sup>63</sup>, 2<sup>63</sup> - 1] inclusive.
      <td>0 or 1
     <tr>
      <td><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="float">Float</dfn>
      <td>IEEE 754 Single-Precision Float.
      <td>7
     <tr>
      <td><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="bytestring">ByteString</dfn>
      <td>Variable number of bytes.
      <td>2
     <tr>
      <td><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="string">String</dfn>
      <td>UTF-8 <a data-link-type="biblio" href="#biblio-rfc3629">[rfc3629]</a> text string.
      <td>3
     <tr>
      <td><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="arrayof">ArrayOf</dfn>&lt;Type>
      <td>Array of a variable number of items of Type.
      <td>4
   </table>
   <h4 class="heading settled" data-level="4.2.3" id="protocol-version"><span class="secno">4.2.3. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="protocolversion">ProtocolVersion</dfn></span><a class="self-link" href="#protocol-version"></a></h4>
   <p>An <a data-link-type="dfn" href="#integer" id="ref-for-integer">Integer</a> describing the version of this communication protocol being used by a <a data-link-type="dfn" href="#patchrequest" id="ref-for-patchrequest">PatchRequest</a> or <a data-link-type="dfn" href="#patchresponse" id="ref-for-patchresponse">PatchResponse</a>. This value guides the semantics and interpretation
of the fields sent.</p>
   <p>This field is for future expansion. There currently is only one valid value, 0.</p>
   <h4 class="heading settled" data-level="4.2.4" id="sparsebitset-object"><span class="secno">4.2.4. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="sparsebitset">SparseBitSet</dfn></span><a class="self-link" href="#sparsebitset-object"></a></h4>
   <p>A data structure which compactly stores a set of distinct unsigned integers. The set is represented as
a tree where each node has a fixed number of children that recursively sub-divides an interval into
equal partitions. A tree of height <i>H</i> with branching factor <i>B</i> can store set membership
for integers in the interval [0 to <i>B</i><sup><i>H</i></sup>-1] inclusive. The tree is encoded into
a <a data-link-type="dfn" href="#bytestring" id="ref-for-bytestring">ByteString</a> for transport.</p>
   <p>To construct the tree <i>T</i> which encodes set <i>S</i> first select the branching factor <i>B</i> (how many children each node has). <i>B</i> can be 4, 8, 16, or 32.</p>
   <p class="note" role="note"><span>Note:</span> the encoder can use any of the possible branching factors, but it is recommended to
use 4 as that has <a href="https://github.com/w3c/PFE-analysis/blob/main/results/set_encoding_branch_factor.md">been shown</a> to give the smallest encodings for most sets typically encountered.</p>
   <p>Next, determine the height, <i>H</i>, of the tree:</p>
   <p><i>H</i> = ceil(log<sub><i>B</i></sub>(max(<i>S</i>) + 1))</p>
   <p>If <i>S</i> is an empty set then <i>H</i> = 1.</p>
   <p>Next create a tree of height H where all non-leaf nodes have <i>B</i> children. Each node in the tree
has a single value composed of <i>B</i> bits. Given a node <i>p</i> which has <i>B</i> children: <i>c<sub>0</sub></i> ... <i>c<sub><i>B</i> - 1</sub></i> and is in a tree, <i>T</i>, of height <i>H</i>, then:</p>
   <ul>
    <li data-md>
     <p>D(<i>n</i>) is depth of node <i>n</i>: the number of edges between
the root node and <i>n</i>.</p>
    <li data-md>
     <p>Start(<i>c<sub>i</sub></i>) is the start (inclusive) of the interval  covered by <i>c<sub>i</sub></i> :<br> Start(<i>c<sub>i</sub></i>) =
 Start(<i>p</i>) + <i>i</i> * <i>B</i><sup><i>H</i> - D(<i>c<sub>i</sub></i>)</sup></p>
    <li data-md>
     <p>End(<i>c<sub>i</sub></i>) is the end (exclusive) of the interval  covered by <i>c<sub>i</sub></i> :<br> End(<i>c<sub>i</sub></i>) =
 Start(<i>p</i>) + (<i>i</i> + 1) * <i>B</i><sup><i>H</i> - D(<i>c<sub>i</sub></i>)</sup></p>
    <li data-md>
     <p>Start(root node) = 0</p>
    <li data-md>
     <p>The value of node <i>p</i> is a string of <i>B</i> bits. If its bits are numbered from 0 (least
significant) to <i>B</i> - 1 (most significant) then bit <i>i</i> will be 1 if the set <i>S</i> contains at least one member in the interval [Start(<i>c<sub>i</sub></i>),
End(<i>c<sub>i</sub></i>)), otherwise bit <i>i</i> will be 0.</p>
    <li data-md>
     <p>If for node <i>p</i>, End(<i>p</i>) - Start(<i>p</i>) = <i>B</i>, then <i>p</i> will have no
children.</p>
    <li data-md>
     <p>An empty set is considered to have no nodes.</p>
   </ul>
   <p>The tree is encoded into a bit string. When appending multiple-bit values to the bit string, bits
are added in order from least significant bit to most significant bit.</p>
   <p>First append 2 bits which encode the branching factor:</p>
   <table>
    <tbody>
     <tr>
      <th>Bits 
      <th>Branching Factor
     <tr>
      <td>00
      <td>2
     <tr>
      <td>01
      <td>4
     <tr>
      <td>10
      <td>8
     <tr>
      <td>11
      <td>32
   </table>
   <p>Then append the value <i>H</i> - 1 as a 5 bit unsigned integer. Next append a single 0 bit, which
is reserved for future use.</p>
   <p>Next the nodes are encoded into the bit string by traversing the nodes of the <i>T</i> in level
order and appending the value for each non-zero node to the bit string. If all of the set values
covered by a node’s interval are present within set <i>S</i>, then that node can instead be encoded
in the bit string as <i>B</i> bits all set to zero. All children of that node must not be encoded.</p>
   <p>Lastly the bit string is converted into a ByteString by converting each consecutive group of 8 bits
into the next byte of the string.
If the number of bits in the bit string is not a multiple of 8, zero bits are appended to the
next multiple of 8.
The bit with the smallest index in the bit string is the least
significant bit in the byte and the bit with the largest index is the most significant bit.</p>
   <div class="example" id="example-ad7a28d1">
    <a class="self-link" href="#example-ad7a28d1"></a> The set {2, 33, 323} in a tree with a branching factor of 8 is encoded as the bit string: 
<pre>BitString:
|- header |- lvl 0 |---- level 1 ----|------- level 2 -----------|
|         |   n0   |   n1       n2   |   n3       n4       n5    |
[ 01010000 10000100 10001000 10000000 00100000 01000000 00010000 ]

Which then becomes the ByteString:
[
  0b00001010,
  0b00100001,
  0b00010001,
  0b00000001,
  0b00000100,
  0b00000010,
  0b00001000
]
</pre>
    <p>First determine the height of the tree:</p>
    <p><i>H</i> = ceil(log<sub>8</sub>(323 + 1)) = 3</p>
    <p>Then append</p>
    <ul>
     <li data-md>
      <p>branching factor = 8 = 10</p>
     <li data-md>
      <p><i>H</i> - 1 = 2 = 00010</p>
     <li data-md>
      <p>reserved bit = 0</p>
    </ul>
    <p>Level 0:</p>
    <ul>
     <li data-md>
      <p>root node, n<sub>0</sub> append 00100001. Bit 0 is set because there are set members in the interval
 [0, 64), and bit 5 is set due to members in the interval [320, 384).</p>
    </ul>
    <p>Level 1:</p>
    <ul>
     <li data-md>
      <p>There will be two non-zero children corresponding to bit 0 and bit 5 in n<sub>0</sub>:</p>
     <li data-md>
      <p>n<sub>1</sub> append 00010001. It is child 0 of n<sub>0</sub> and subdivides the interval
 [0, 64). Bit 0 is set since there are set members in [0, 8) and bit 4 for [32, 40).</p>
     <li data-md>
      <p>n<sub>2</sub> append 00000001. It is child 5 of n<sub>0</sub> it subdivides the interval
 [320, 384). Bit 0 is set since there are set members in [320 - 328).</p>
    </ul>
    <p>Level 2:</p>
    <ul>
     <li data-md>
      <p>n<sub>3</sub> append 00000100. Child 0 of n<sub>1</sub>, bit 2 is set for the interval [2, 3) or 2.</p>
     <li data-md>
      <p>n<sub>4</sub> append 00000010. Child 4 of n<sub>1</sub>, bit 1 is set for the interval [33, 34) or 33.</p>
     <li data-md>
      <p>n<sub>5</sub> append 00001000. Child 0 of n<sub>2</sub>, bit 3 is set for the interval [323, 324)
 or 323.</p>
    </ul>
   </div>
   <div class="example" id="example-bc5ac7b1">
    <a class="self-link" href="#example-bc5ac7b1"></a> The set {} in a tree with a branching factor of 4 is encoded as the bit string: 
<pre>BitString:
|- header- |
|          |
[ 00000000 ]

Which then becomes the ByteString:
[
  0b00000000,
]
</pre>
    <p>First determine the height of the tree. Because we are encoding an empty
  set height is:</p>
    <p><i>H</i> = 1</p>
    <p>Then append</p>
    <ul>
     <li data-md>
      <p>branching factor = 2 = 00</p>
     <li data-md>
      <p><i>H</i> - 1 = 0 = 00000</p>
     <li data-md>
      <p>reserved bit = 0</p>
    </ul>
    <p>Empty sets have no nodes, so no bytes beyond the header need to be appended.</p>
   </div>
   <div class="example" id="example-bcd5e3df">
    <a class="self-link" href="#example-bcd5e3df"></a> The set {0, 1, 2, ..., 17} can be encoded with a branching factor of 4 as: 
<pre>BitString:
|- header | l0 |- lvl 1 -| l2  |
|         | n0 | n1 | n2 | n3  |
[ 10010000 1100 0000 1000 1100 ]

ByteString:
[
  0b00001001,
  0b00000011,
  0b00110001
]
</pre>
    <p>First determine the height of the tree:</p>
    <p><i>H</i> = ceil(log<sub>4</sub>(17 + 1)) = 3</p>
    <p>Then append</p>
    <ul>
     <li data-md>
      <p>branching factor = 4 = 01</p>
     <li data-md>
      <p><i>H</i> - 1 = 2 = 00010</p>
     <li data-md>
      <p>reserved bit = 0</p>
    </ul>
    <p>Level 0:</p>
    <ul>
     <li data-md>
      <p>n<sub>0</sub> append 0011. Bit 0 set for [0, 16), bit 1 set for [16, 32)</p>
    </ul>
    <p>Level 1:</p>
    <ul>
     <li data-md>
      <p>n<sub>1</sub> append 0000. All bits zero to indicate interval [0, 16) is fully filled.</p>
     <li data-md>
      <p>n<sub>2</sub> append 0001. Bit 0 set for [16, 20)</p>
    </ul>
    <p>Level 2:</p>
    <ul>
     <li data-md>
      <p>n<sub>3</sub> append 0011. Bit 0 set for value 16, bit 1 set for value 17.</p>
    </ul>
   </div>
   <h4 class="heading settled" data-level="4.2.5" id="integerlist-object"><span class="secno">4.2.5. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="integerlist">IntegerList</dfn></span><a class="self-link" href="#integerlist-object"></a></h4>
   <p>A data structure which compactly represents a list of non-negative integers
from 0 to 2<sup>31</sup>-1. The list is encoded into a <a data-link-type="dfn" href="#bytestring" id="ref-for-bytestring①">ByteString</a> for transport.</p>
   <p>There are three steps of encoding/compression: first delta, second zig-zag, and finally UIntBase128.
The final <a data-link-type="dfn" href="#bytestring" id="ref-for-bytestring②">ByteString</a> result is simply the concatenation of the individual UIntBase128
encoded bytes.</p>
   <p><a data-link-type="dfn" href="#integerlist" id="ref-for-integerlist">IntegerList</a> encoding must reject an input list which contains values not in the range
0 to 2<sup>31</sup>-1. Likewise if decoding an IntegerList results in values which are not
in the range 0 to 2<sup>31</sup>-1 the list is invalid and must be rejected.</p>
   <h5 class="heading settled" data-level="4.2.5.1" id="integerlist-deltas"><span class="secno">4.2.5.1. </span><span class="content">Delta Encoding</span><a class="self-link" href="#integerlist-deltas"></a></h5>
   <p>Delta encoding converts a list of integers to a list of deltas between them.</p>
   <p>A list L of n integers L<sub>i<sub>0..n-1</sub></sub> is converted into a list
of N integers D<sub>i<sub>0..n-1</sub></sub> as follows:</p>
   <ul>
    <li data-md>
     <p>D<sub>0</sub> = L<sub>0</sub></p>
    <li data-md>
     <p>D<sub>i = 1..n-1</sub> = L<sub>i</sub> - L<sub>i-1<sub></sub></sub></p>
   </ul>
   <p>This has the effect of reducing the magnitude of the values, which reduces the number
of bytes required in the UIntBase128 encoding, below.</p>
   <div class="example" id="example-a8b975f3">
    <a class="self-link" href="#example-a8b975f3"></a> 
<pre>// Note: unsorted
int_list = [23, 43, 12, 3, 67, 68, 69, 0]
delta_list = [23, 20, -31, -9, 64, 1, 1, -69]
</pre>
   </div>
   <h5 class="heading settled" data-level="4.2.5.2" id="integerlist-zigzag"><span class="secno">4.2.5.2. </span><span class="content">Zig-Zag Encoding</span><a class="self-link" href="#integerlist-zigzag"></a></h5>
   <p>Zig-Zag encoding reversibly converts signed integers to unsigned integers,
using the same number of bits. The entire range of values is supported.
This step is required, as the <a href="#integerlist-uintbase128">§ 4.2.5.3 UIntBase128 Encoding</a> step works on
unsigned integers only. The encoding maps positive integer values to even positive integers and
negative integer values to odd positive integers. Psuedo code:</p>
<pre>encode(n):
  if n >= 0:
    return n * 2
  else:
    return (n * -2) - 1

decode(n) {
  if n &amp; 1:
    return -((n + 1) / 2)
  else:
    return n / 2
</pre>
   <div class="example" id="example-16a15e38">
    <a class="self-link" href="#example-16a15e38"></a> 
    <table>
     <tbody>
      <tr>
       <th>Value
       <th>Zig-Zag Encoding
      <tr>
       <td>0
       <td>0
      <tr>
       <td>1
       <td>2
      <tr>
       <td>2
       <td>4
      <tr>
       <td>3
       <td>6
      <tr>
       <td>4
       <td>8
      <tr>
       <td>-1
       <td>1
      <tr>
       <td>-2
       <td>3
      <tr>
       <td>-3
       <td>5
      <tr>
       <td>-4
       <td>7
    </table>
   </div>
   <div class="example" id="example-d75ff9a8">
    <a class="self-link" href="#example-d75ff9a8"></a> 
<pre>delta_list = [23, 20, -31, -9, 64, 1, 1, -69]
zig_zag_encoded_list = [46, 40, 61, 17, 128, 2, 2, 137]
</pre>
   </div>
   <h5 class="heading settled" data-level="4.2.5.3" id="integerlist-uintbase128"><span class="secno">4.2.5.3. </span><span class="content">UIntBase128 Encoding</span><a class="self-link" href="#integerlist-uintbase128"></a></h5>
   <p>UIntBase128 is a variable length encoding of unsigned integers,
suitable for values up to 2<sup>32</sup>-1. A UIntBase128 encoded number
is a sequence of bytes for which the most significant bit is set for all but
the last byte, and clear for the last byte. The number itself is base 128
encoded in the lower 7 bits of each byte. Thus, a decoding procedure for
a UIntBase128 is: start with value = 0. Consume a byte, setting value =
old value times 128 + (byte bitwise-and 127). Repeat last step until
the most significant bit of byte is false.</p>
   <p>UIntBase128 encoding format allows a possibility of sub-optimal encoding, where e.g.
the same numerical value can be represented with variable number of bytes (utilizing
leading zeros). For example, the value 63 could be encoded as either one byte 0x3F
or two (or more) bytes: [0x80, 0x3f]. <span class="conform server client" id="conform-uintbase128-illegal">An encoder must not allow this
to happen and must produce shortest possible encoding. A decoder must reject the response/request
if it encounters a UIntBase128-encoded value with leading zeros (a value that starts with the byte
0x80), if UIntBase128-encoded sequence is longer than 5 bytes, or if a UIntBase128-encoded value
exceeds 2<sup>32</sup>-1.</span> Pseudo-code:</p>
<pre>bool ReadUIntBase128( data, *result ) {
  UInt32 accum = 0;

  for (i = 0; i &lt; 5; i++) {
    UInt8 data_byte = data.getNextUInt8();

    // No leading 0’s
    if (i == 0 &amp;&amp; data_byte == 0x80) return false;

    // If any of top 7 bits are set then &lt;&lt; 7 would overflow
    if (accum &amp; 0xFE000000) return false;

    accum = (accum &lt;&lt; 7) | (data_byte &amp; 0x7F);

    // Spin until most significant bit of data byte is false
    if ((data_byte &amp; 0x80) == 0) {
      *result = accum;
      return true;
    }
  }
  // UIntBase128 sequence exceeds 5 bytes
  return false;
}
</pre>
   <div class="example" id="example-ca5da7f7">
    <a class="self-link" href="#example-ca5da7f7"></a> 
<pre>Value       Output Bytes
0           00000000
1           00000001
2           00000010
3           00000011
127         01111111
128         10000001 00000000
255         10000001 01111111
16256       11111111 00000000
2080768     11111111 10000000 00000000
266338304   11111111 10000000 10000000 00000000
4294967295  10001111 11111111 11111111 11111111 01111111
</pre>
   </div>
   <div class="example" id="example-0f812e73">
    <a class="self-link" href="#example-0f812e73"></a> 
<pre>zig_zag_encoded_list = [46, 40, 61, 17, 128, 2, 2, 137]
bytes = [2E 28 3D 11 81 00 02 02 81 09]
         └┘ └┘ └┘ └┘ └───┘ └┘ └┘ └───┘
</pre>
   </div>
   <h4 class="heading settled" data-level="4.2.6" id="sortedintegerlist-object"><span class="secno">4.2.6. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="sortedintegerlist">SortedIntegerList</dfn></span><a class="self-link" href="#sortedintegerlist-object"></a></h4>
   <p>A data structure which compactly represents a sorted list of ascending non-negative integers
(0 to 2<sup>32</sup>-1). The list is encoded into a <a data-link-type="dfn" href="#bytestring" id="ref-for-bytestring③">ByteString</a> for transport.</p>
   <p>This is a variation on <a data-link-type="dfn" href="#integerlist" id="ref-for-integerlist①">IntegerList</a> with better compression. Sorted lists only use two steps of
encoding/compression: first deltas and then UIntBase128. The <a href="#integerlist-zigzag">§ 4.2.5.2 Zig-Zag Encoding</a> step is skipped.
This allows twice the range in UIntBase128, so that single bytes may be used more often.</p>
   <p><a data-link-type="dfn" href="#sortedintegerlist" id="ref-for-sortedintegerlist">SortedIntegerList</a> encoding must reject an input list which contains values not in the range
0 to 2<sup>32</sup>-1. <span class="conform server client" id="conform-sorted-integer-list-rejects-illegal"> Likewise if decoding an <a data-link-type="dfn" href="#integerlist" id="ref-for-integerlist②">IntegerList</a> results in values which are not
in the range 0 to 2<sup>32</sup>-1 the list is invalid and must be rejected. </span></p>
   <h4 class="heading settled" data-level="4.2.7" id="rangelist-object"><span class="secno">4.2.7. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="rangelist">RangeList</dfn></span><a class="self-link" href="#rangelist-object"></a></h4>
   <p>A RangeList encodes a set of non-negative integers (0 to 2<sup>32</sup>-1). The set is encoded as a
list of disjoint intervals. Each interval is represented by two integers, a
start (inclusive) and end (inclusive).</p>
   <p>A RangeList is a list of n pairs
[min<sub>i<sub>0..n-1</sub></sub>, max<sub>i<sub>0..n-1</sub></sub>].
The list must be non-decreasing, i.e. min<sub>i=1..n-1</sub> >= max<sub>i-1<sub>.</sub></sub></p>
   <p>To encode this list, we convert it to a list L of 2n integers, where
L<sub>2i</sub> = min<sub>i</sub> and L<sub>2i+1</sub> = max<sub>i</sub> for
i = 0..n-1.</p>
   <p>L is a sorted list of integers, so a <a data-link-type="dfn" href="#sortedintegerlist" id="ref-for-sortedintegerlist①">SortedIntegerList</a> is used to encode it as a <a data-link-type="dfn" href="#bytestring" id="ref-for-bytestring④">ByteString</a>.</p>
   <div class="example" id="example-228f592b">
    <a class="self-link" href="#example-228f592b"></a> 
<pre>range_list = [3, 10], [13, 268]
int_list = [3, 10, 13, 268]
delta_list = [3, 7, 3, 255]
bytes = [03 07 03 81 7F]
</pre>
   </div>
   <h4 class="heading settled" data-level="4.2.8" id="featuretagset-object"><span class="secno">4.2.8. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="featuretagset">FeatureTagSet</dfn></span><a class="self-link" href="#featuretagset-object"></a></h4>
   <p>A FeatureTagSet encodes a set of zero or more <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/featuretags">opentype layout feature tags</a>.
Each feature tag is mapped to an integer value and then the set of mapped integers are encoded in a <a data-link-type="dfn" href="#sortedintegerlist" id="ref-for-sortedintegerlist②">SortedIntegerList</a>. Feature tags are mapped to integers as follows:</p>
   <ul>
    <li data-md>
     <p>If the tag is found in <a href="#feature-tag-list">Appendix B: Default Feature Tags and Encoding IDs</a>:</p>
     <ul>
      <li data-md>
       <p>If the "Encoded As" column corresponding to the tag is "default" then the tag is skipped and
not encoded.</p>
      <li data-md>
       <p>Else, the tag is mapped to the integer value in the "Encoded As" column.</p>
     </ul>
    <li data-md>
     <p>Otherwise: the tag is converted to an integer by treating the tag’s 4 byte string as a 4 byte
little endian integer.</p>
   </ul>
   <p>The final encoding is produced by sorting the mapped integers (exlcuding tags which are skipped)
into ascending order and then encoding the sorted list as a <a data-link-type="dfn" href="#sortedintegerlist" id="ref-for-sortedintegerlist③">SortedIntegerList</a>.</p>
   <p>When decoding a FeatureTagSet the integer values are mapped back to the original tags by reversing
the above mapping rules. <span class="conform server client" id="conform-feature-tag-set-defaults">Additionally all
default features in <a href="#feature-tag-list">Appendix B: Default Feature Tags and Encoding IDs</a> must be added to the decoded set.</span></p>
   <h4 class="heading settled" data-level="4.2.9" id="AxisSpace"><span class="secno">4.2.9. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="axisspace">AxisSpace</dfn></span><a class="self-link" href="#AxisSpace"></a></h4>
   <p>Stores a set of intervals on one or more open type variation axes <a data-link-type="biblio" href="#biblio-opentype-variations">[opentype-variations]</a>.
Encoded as a CBOR map (major type 5). The key in each pair is an <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/fvar#variationaxisrecord"> axis tag</a>. It is encoded as a <a data-link-type="dfn" href="#bytestring" id="ref-for-bytestring⑤">ByteString</a> containing exactly 4 ASCII characters. The value in each
pair is an <a data-link-type="dfn" href="#arrayof" id="ref-for-arrayof">ArrayOf</a>&lt;<a data-link-type="dfn" href="#axisinterval" id="ref-for-axisinterval">AxisInterval</a>>. <span class="conform client server" id="conform-axis-space-disjoint">The list of intervals for a
each axis tag must be disjoint.</span></p>
   <h4 class="heading settled" data-level="4.2.10" id="objects"><span class="secno">4.2.10. </span><span class="content">Objects</span><a class="self-link" href="#objects"></a></h4>
   <p>Objects are data structures comprised of key and value pairs. <span class="conform server client" id="conform-object">Objects are encoded via CBOR as maps (major
type 5)</span>. Each key and value pair is encoded as a single map entry. Keys are always unsigned
integers and are encoded using major type 0. Values are encoded using the encoding specified by the
type of the value.</p>
   <p>All fields in an object are optional and do not need to have an associated value. Conversely when
decoding and object fields may be present which are not specified in the schema. <span class="conform server client" id="conform-object-unrecognized-field"> The decoder must ignore without error any key and value pairs where the key is not recognized. </span></p>
   <p>There are several types of object used, each type is defined by a schema in <a href="#schemas">§ 4.3 Object Schemas</a>. The schema
for a type specifies for each field:</p>
   <ul>
    <li data-md>
     <p>A human readable name for the field. For reference only, not used in the encoding.</p>
    <li data-md>
     <p>A unsigned integer id for the field. This is used as the key in the encoding.</p>
    <li data-md>
     <p>The type of the value stored in this field. Can be any of the types defined in <a href="#data-types">§ 4.2 Data Types</a> including object types.</p>
   </ul>
   <h3 class="heading settled" data-level="4.3" id="schemas"><span class="secno">4.3. </span><span class="content">Object Schemas</span><a class="self-link" href="#schemas"></a></h3>
   <h4 class="heading settled" data-level="4.3.1" id="CompressedSet"><span class="secno">4.3.1. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="compressedset">CompressedSet</dfn></span><a class="self-link" href="#CompressedSet"></a></h4>
   <p>Encodes a set of unsigned integers. The set is not ordered and does not
allow duplicates. Members of the set are encoded into either a <a data-link-type="dfn" href="#sparsebitset" id="ref-for-sparsebitset">SparseBitSet</a> or a <a data-link-type="dfn" href="#rangelist" id="ref-for-rangelist">RangeList</a>. To obtain the final set the members of <a data-link-type="dfn" href="#compressedset-sparse_bit_set" id="ref-for-compressedset-sparse_bit_set">sparse_bit_set</a> and the list of ranges in <a data-link-type="dfn" href="#compressedset-range_deltas" id="ref-for-compressedset-range_deltas">range_deltas</a> are unioned together.</p>
   <table>
    <tbody>
     <tr>
      <th>ID 
      <th>Field Name
      <th>Type
     <tr>
      <td>0
      <td><dfn class="dfn-paneled" data-dfn-for="CompressedSet" data-dfn-type="dfn" data-noexport id="compressedset-sparse_bit_set">sparse_bit_set</dfn>
      <td><a data-link-type="dfn" href="#sparsebitset" id="ref-for-sparsebitset①">SparseBitSet</a> (<a data-link-type="dfn" href="#bytestring" id="ref-for-bytestring⑥">ByteString</a>)
     <tr>
      <td>1
      <td><dfn class="dfn-paneled" data-dfn-for="CompressedSet" data-dfn-type="dfn" data-noexport id="compressedset-range_deltas">range_deltas</dfn>
      <td><a data-link-type="dfn" href="#rangelist" id="ref-for-rangelist①">RangeList</a> (<a data-link-type="dfn" href="#bytestring" id="ref-for-bytestring⑦">ByteString</a>)
   </table>
   <h4 class="heading settled" data-level="4.3.2" id="AxisInterval"><span class="secno">4.3.2. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="axisinterval">AxisInterval</dfn></span><a class="self-link" href="#AxisInterval"></a></h4>
   <table>
    <tbody>
     <tr>
      <th>ID
      <th>Field Name
      <th>Value Type
     <tr>
      <td>0
      <td><dfn class="dfn-paneled" data-dfn-for="AxisInterval" data-dfn-type="dfn" data-noexport id="axisinterval-start">start</dfn>
      <td><a data-link-type="dfn" href="#float" id="ref-for-float">Float</a>
     <tr>
      <td>1
      <td><dfn class="dfn-paneled" data-dfn-for="AxisInterval" data-dfn-type="dfn" data-noexport id="axisinterval-end">end</dfn>
      <td><a data-link-type="dfn" href="#float" id="ref-for-float①">Float</a>
   </table>
   <p><a data-link-type="dfn" href="#axisinterval" id="ref-for-axisinterval①">AxisInterval</a> defines an interval (from <a data-link-type="dfn" href="#axisinterval-start" id="ref-for-axisinterval-start">start</a> to <a data-link-type="dfn" href="#axisinterval-end" id="ref-for-axisinterval-end">end</a> inclusive)
on some variable axis in a font.</p>
   <p>For an <a data-link-type="dfn" href="#axisinterval" id="ref-for-axisinterval②">AxisInterval</a> object to be well formed:</p>
   <ul>
    <li data-md>
     <p><span class="conform client server" id="conform-axis-interval-start"> <a data-link-type="dfn" href="#axisinterval-start" id="ref-for-axisinterval-start①">start</a> must be set. </span></p>
    <li data-md>
     <p><span class="conform client server" id="conform-axis-interval-end"> <a data-link-type="dfn" href="#axisinterval-end" id="ref-for-axisinterval-end①">end</a> is optional, if set it must be greater than <a data-link-type="dfn" href="#axisinterval-start" id="ref-for-axisinterval-start②">start</a>.</span> If <a data-link-type="dfn" href="#axisinterval-end" id="ref-for-axisinterval-end②">end</a> is not set then this interval is a single point, <a data-link-type="dfn" href="#axisinterval-start" id="ref-for-axisinterval-start③">start</a>.</p>
   </ul>
   <h4 class="heading settled" data-level="4.3.3" id="PatchRequest"><span class="secno">4.3.3. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="patchrequest">PatchRequest</dfn></span><a class="self-link" href="#PatchRequest"></a></h4>
   <table>
    <tbody>
     <tr>
      <th>ID
      <th>Field Name
      <th>Value Type
     <tr>
      <td>0
      <td><dfn class="dfn-paneled" data-dfn-for="PatchRequest" data-dfn-type="dfn" data-noexport id="patchrequest-protocol_version">protocol_version</dfn>
      <td><a data-link-type="dfn" href="#protocolversion" id="ref-for-protocolversion">ProtocolVersion</a> (<a data-link-type="dfn" href="#integer" id="ref-for-integer①">Integer</a>)
     <tr>
      <td>1
      <td><dfn class="dfn-paneled" data-dfn-for="PatchRequest" data-dfn-type="dfn" data-noexport id="patchrequest-accept_patch_format">accept_patch_format</dfn>
      <td><a data-link-type="dfn" href="#arrayof" id="ref-for-arrayof①">ArrayOf</a>&lt;<a data-link-type="dfn" href="#integer" id="ref-for-integer②">Integer</a>>
     <tr>
      <td>2
      <td><dfn class="dfn-paneled" data-dfn-for="PatchRequest" data-dfn-type="dfn" data-noexport id="patchrequest-codepoints_have">codepoints_have</dfn>
      <td><a data-link-type="dfn" href="#compressedset" id="ref-for-compressedset">CompressedSet</a>
     <tr>
      <td>3
      <td><dfn class="dfn-paneled" data-dfn-for="PatchRequest" data-dfn-type="dfn" data-noexport id="patchrequest-codepoints_needed">codepoints_needed</dfn>
      <td><a data-link-type="dfn" href="#compressedset" id="ref-for-compressedset①">CompressedSet</a>
     <tr>
      <td>4
      <td><dfn class="dfn-paneled" data-dfn-for="PatchRequest" data-dfn-type="dfn" data-noexport id="patchrequest-indices_have">indices_have</dfn>
      <td><a data-link-type="dfn" href="#compressedset" id="ref-for-compressedset②">CompressedSet</a>
     <tr>
      <td>5
      <td><dfn class="dfn-paneled" data-dfn-for="PatchRequest" data-dfn-type="dfn" data-noexport id="patchrequest-indices_needed">indices_needed</dfn>
      <td><a data-link-type="dfn" href="#compressedset" id="ref-for-compressedset③">CompressedSet</a>
     <tr>
      <td>6
      <td><dfn class="dfn-paneled" data-dfn-for="PatchRequest" data-dfn-type="dfn" data-noexport id="patchrequest-features_have">features_have</dfn>
      <td><a data-link-type="dfn" href="#featuretagset" id="ref-for-featuretagset">FeatureTagSet</a>
     <tr>
      <td>7
      <td><dfn class="dfn-paneled" data-dfn-for="PatchRequest" data-dfn-type="dfn" data-noexport id="patchrequest-features_needed">features_needed</dfn>
      <td><a data-link-type="dfn" href="#featuretagset" id="ref-for-featuretagset①">FeatureTagSet</a>
     <tr>
      <td>8
      <td><dfn class="dfn-paneled" data-dfn-for="PatchRequest" data-dfn-type="dfn" data-noexport id="patchrequest-axis_space_have">axis_space_have</dfn>
      <td><a data-link-type="dfn" href="#axisspace" id="ref-for-axisspace">AxisSpace</a>
     <tr>
      <td>9
      <td><dfn class="dfn-paneled" data-dfn-for="PatchRequest" data-dfn-type="dfn" data-noexport id="patchrequest-axis_space_needed">axis_space_needed</dfn>
      <td><a data-link-type="dfn" href="#axisspace" id="ref-for-axisspace①">AxisSpace</a>
     <tr>
      <td>10
      <td><dfn class="dfn-paneled" data-dfn-for="PatchRequest" data-dfn-type="dfn" data-noexport id="patchrequest-ordering_checksum">ordering_checksum</dfn>
      <td><a data-link-type="dfn" href="#integer" id="ref-for-integer③">Integer</a>
     <tr>
      <td>11
      <td><dfn class="dfn-paneled" data-dfn-for="PatchRequest" data-dfn-type="dfn" data-noexport id="patchrequest-original_font_checksum">original_font_checksum</dfn>
      <td><a data-link-type="dfn" href="#integer" id="ref-for-integer④">Integer</a>
     <tr>
      <td>12
      <td><dfn class="dfn-paneled" data-dfn-for="PatchRequest" data-dfn-type="dfn" data-noexport id="patchrequest-base_checksum">base_checksum</dfn>
      <td><a data-link-type="dfn" href="#integer" id="ref-for-integer⑤">Integer</a>
     <tr>
      <td>13
      <td><dfn class="dfn-paneled" data-dfn-for="PatchRequest" data-dfn-type="dfn" data-noexport id="patchrequest-fragment_id">fragment_id</dfn> 
      <td><a data-link-type="dfn" href="#string" id="ref-for-string">String</a>
     <tr>
      <td>14
      <td><dfn class="dfn-paneled" data-dfn-for="PatchRequest" data-dfn-type="dfn" data-noexport id="patchrequest-codepoint_ordering">codepoint_ordering</dfn>
      <td><a data-link-type="dfn" href="#integerlist" id="ref-for-integerlist③">IntegerList</a>
   </table>
   <p>For a <a data-link-type="dfn" href="#patchrequest" id="ref-for-patchrequest①">PatchRequest</a> object to be well formed:</p>
   <ul>
    <li data-md>
     <p><span class="conform client server" id="conform-request-protocol-version"> <a data-link-type="dfn" href="#patchrequest-protocol_version" id="ref-for-patchrequest-protocol_version">protocol_version</a> must be set to 0.</span></p>
    <li data-md>
     <p><a data-link-type="dfn" href="#patchrequest-accept_patch_format" id="ref-for-patchrequest-accept_patch_format">accept_patch_format</a> can include any of the values listed in <a href="#patch-formats">§ 4.8 Patch Formats</a>.</p>
    <li data-md>
     <p><span class="conform client server" id="conform-request-ordering-checksum"> If either of <a data-link-type="dfn" href="#patchrequest-indices_have" id="ref-for-patchrequest-indices_have">indices_have</a> or <a data-link-type="dfn" href="#patchrequest-indices_needed" id="ref-for-patchrequest-indices_needed">indices_needed</a> is set to a non-empty
set then <a data-link-type="dfn" href="#patchrequest-ordering_checksum" id="ref-for-patchrequest-ordering_checksum">ordering_checksum</a> must be set.</span></p>
    <li data-md>
     <p><span class="conform client server" id="conform-request-base-checksum"> If <a data-link-type="dfn" href="#patchrequest-codepoints_have" id="ref-for-patchrequest-codepoints_have">codepoints_have</a> or <a data-link-type="dfn" href="#patchrequest-indices_have" id="ref-for-patchrequest-indices_have①">indices_have</a> is set to a non-empty set then <a data-link-type="dfn" href="#patchrequest-original_font_checksum" id="ref-for-patchrequest-original_font_checksum">original_font_checksum</a> and <a data-link-type="dfn" href="#patchrequest-base_checksum" id="ref-for-patchrequest-base_checksum">base_checksum</a> must be set.</span></p>
   </ul>
   <h4 class="heading settled" data-level="4.3.4" id="PatchResponse"><span class="secno">4.3.4. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="patchresponse">PatchResponse</dfn></span><a class="self-link" href="#PatchResponse"></a></h4>
   <table>
    <tbody>
     <tr>
      <th>ID
      <th>Field Name
      <th>Value Type
     <tr>
      <td>0
      <td><dfn class="dfn-paneled" data-dfn-for="PatchResponse" data-dfn-type="dfn" data-noexport id="patchresponse-protocol_version">protocol_version</dfn>
      <td><a data-link-type="dfn" href="#protocolversion" id="ref-for-protocolversion①">ProtocolVersion</a> (<a data-link-type="dfn" href="#integer" id="ref-for-integer⑥">Integer</a>)
     <tr>
      <td>1
      <td><dfn class="dfn-paneled" data-dfn-for="PatchResponse" data-dfn-type="dfn" data-noexport id="patchresponse-patch_format">patch_format</dfn>
      <td><a data-link-type="dfn" href="#integer" id="ref-for-integer⑦">Integer</a>
     <tr>
      <td>2
      <td><dfn class="dfn-paneled" data-dfn-for="PatchResponse" data-dfn-type="dfn" data-noexport id="patchresponse-patch">patch</dfn>
      <td><a data-link-type="dfn" href="#bytestring" id="ref-for-bytestring⑧">ByteString</a>
     <tr>
      <td>3
      <td><dfn class="dfn-paneled" data-dfn-for="PatchResponse" data-dfn-type="dfn" data-noexport id="patchresponse-replacement">replacement</dfn>
      <td><a data-link-type="dfn" href="#bytestring" id="ref-for-bytestring⑨">ByteString</a>
     <tr>
      <td>4
      <td><dfn class="dfn-paneled" data-dfn-for="PatchResponse" data-dfn-type="dfn" data-noexport id="patchresponse-unrecognized_ordering">unrecognized_ordering</dfn>
      <td><a data-link-type="dfn" href="#integer" id="ref-for-integer⑧">Integer</a>
   </table>
   <p>For a PatchResponse object to be well formed:</p>
   <ul>
    <li data-md>
     <p><span class="conform server" id="conform-response-protocol-version"> <a data-link-type="dfn" href="#patchresponse-protocol_version" id="ref-for-patchresponse-protocol_version">protocol_version</a> must be set to 0.</span></p>
    <li data-md>
     <p><span class="conform server" id="conform-response-patch-or-replacement"> Only one of <a data-link-type="dfn" href="#patchresponse-patch" id="ref-for-patchresponse-patch">patch</a>, <a data-link-type="dfn" href="#patchresponse-replacement" id="ref-for-patchresponse-replacement">replacement</a>, or <a data-link-type="dfn" href="#patchresponse-unrecognized_ordering" id="ref-for-patchresponse-unrecognized_ordering">unrecognized_ordering</a> must be set.</span></p>
    <li data-md>
     <p><span class="conform server" id="conform-response-valid-format"> If <a data-link-type="dfn" href="#patchresponse-patch_format" id="ref-for-patchresponse-patch_format">patch_format</a> is set then it must be one of the values listed in <a href="#patch-formats">§ 4.8 Patch Formats</a>.</span></p>
   </ul>
   <h4 class="heading settled" data-level="4.3.5" id="ClientState"><span class="secno">4.3.5. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="clientstate">ClientState</dfn></span><a class="self-link" href="#ClientState"></a></h4>
   <table>
    <tbody>
     <tr>
      <th>ID
      <th>Field Name
      <th>Value Type
     <tr>
      <td>0
      <td><dfn class="dfn-paneled" data-dfn-for="ClientState" data-dfn-type="dfn" data-noexport id="clientstate-original_font_checksum">original_font_checksum</dfn>
      <td><a data-link-type="dfn" href="#integer" id="ref-for-integer⑨">Integer</a>
     <tr>
      <td>1
      <td><dfn class="dfn-paneled" data-dfn-for="ClientState" data-dfn-type="dfn" data-noexport id="clientstate-codepoint_ordering">codepoint_ordering</dfn>
      <td><a data-link-type="dfn" href="#integerlist" id="ref-for-integerlist④">IntegerList</a>
     <tr>
      <td>2
      <td><dfn class="dfn-paneled" data-dfn-for="ClientState" data-dfn-type="dfn" data-noexport id="clientstate-subset_axis_space">subset_axis_space</dfn>
      <td><a data-link-type="dfn" href="#axisspace" id="ref-for-axisspace②">AxisSpace</a>
     <tr>
      <td>3
      <td><dfn class="dfn-paneled" data-dfn-for="ClientState" data-dfn-type="dfn" data-noexport id="clientstate-original_axis_space">original_axis_space</dfn>
      <td><a data-link-type="dfn" href="#axisspace" id="ref-for-axisspace③">AxisSpace</a>
     <tr>
      <td>4
      <td><dfn class="dfn-paneled" data-dfn-for="ClientState" data-dfn-type="dfn" data-noexport id="clientstate-original_features">original_features</dfn>
      <td><a data-link-type="dfn" href="#featuretagset" id="ref-for-featuretagset②">FeatureTagSet</a>
   </table>
   <h3 class="heading settled" data-level="4.4" id="client"><span class="secno">4.4. </span><span class="content">Client</span><a class="self-link" href="#client"></a></h3>
   <h4 class="heading settled algorithm" data-algorithm="Extending the Font Subset" data-level="4.4.1" id="extend-subset"><span class="secno">4.4.1. </span><span class="content">Extending the Font Subset</span><a class="self-link" href="#extend-subset"></a></h4>
   <p>This algorithm is used by the client to extends its <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②">font subset</a> to cover additional codepoints,
features, and/or design-variation space.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-extend-the-font-subset">Extend the font subset</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>font URL</var>: a URL where the font to be extended is located.</p>
    <li data-md>
     <p><var>fragment identifier</var> (optional): if the font at the font url is a collection of fonts,
the fragment identifier (<a href="https://www.rfc-editor.org/rfc/rfc8081#section-4.2">The "font" Top-Level Media Type § section-4.2</a>) identifies a single font within the collection.</p>
    <li data-md>
     <p><var>font subset</var> (optional): previously loaded <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset③">font subset</a> for the given
font url, or null.</p>
    <li data-md>
     <p><var>desired subset definition</var>: a <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition">description</a> of the desired
minimum <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset④">font subset</a>. The subset definition must be a superset of the <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset⑤">font subset</a> in <var>client state</var>.</p>
    <li data-md>
     <p><var>fetch algorithm</var>: algorithm for fetching HTTP resources, such as <a data-link-type="biblio" href="#biblio-fetch">[fetch]</a>. The remainder
of this section is desribed in terms of <a href="https://fetch.spec.whatwg.org/#fetching"><cite>Fetch Standard</cite> § 4 Fetching</a>, but it is allowed to substitute
whatever HTTP fetching algorithm the user agent supports.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p>Extended Font Subset: <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset⑥">font subset</a> that has been updated to cover at least the requested subset
definition.</p>
    <li data-md>
     <p>Cache fields: HTTP cache fields <a href="https://www.rfc-editor.org/rfc/rfc9111#name-field-definitions">HTTP Caching § name-field-definitions</a> describing how client state
can be cached, or null.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Compare the <var>desired subset definition</var> to the <var>font subset</var>. If the <var>font subset</var> already satisifies the <var>desired subset definition</var>. Then return <var>font subset</var>, and null for the cache fields.</p>
    <li data-md>
     <p>If <var>font subset</var> is set then load the <var>client state</var> from the <var>font subset</var>. Client state is stored in the <var>font subset</var> as a <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a> identified by the 4-byte tag "IFTP". The contents of the table are a single <a data-link-type="dfn" href="#clientstate" id="ref-for-clientstate">ClientState</a> object
encoded via CBOR.</p>
    <li data-md>
     <p>Otherwise make an HTTP request using the <var>fetch algorithm</var>:</p>
     <ul>
      <li data-md>
       <p>The request <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-method" id="ref-for-concept-request-method">method</a> must be either "GET" or "POST".</p>
      <li data-md>
       <p>The request <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-destination" id="ref-for-concept-request-destination">destination</a> must be "font".</p>
      <li data-md>
       <p>The request CORS <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-mode" id="ref-for-concept-request-mode">mode</a> must be "cors".</p>
      <li data-md>
       <p>The request <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-cache-mode" id="ref-for-concept-request-cache-mode">cache mode</a> should be "no-store".</p>
      <li data-md>
       <p>The request URL <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-scheme" id="ref-for-concept-url-scheme">scheme</a> must be "https".</p>
      <li data-md>
       <p>The request URL <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-path" id="ref-for-concept-url-path">path</a> is set to the input <var>font URL</var>.</p>
      <li data-md>
       <p>If <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-method" id="ref-for-concept-request-method①">method</a> is "POST" then, request <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-body" id="ref-for-concept-request-body">body</a> must be a single <a data-link-type="dfn" href="#patchrequest" id="ref-for-patchrequest②">PatchRequest</a> object encoded via CBOR.</p>
      <li data-md>
       <p>Otherwise if <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-method" id="ref-for-concept-request-method②">method</a> is "GET" then, a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header" id="ref-for-concept-header">header</a> with name <code>Font-Patch-Request</code> (the <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="patch-request-header">patch request header</dfn>)
 and whose value is a single <a data-link-type="dfn" href="#patchrequest" id="ref-for-patchrequest③">PatchRequest</a> object encoded via CBOR and then
  base64url encoding <a data-link-type="biblio" href="#biblio-rfc4648">[rfc4648]</a> must be added to the request’s header list.</p>
     </ul>
     <p>Any request and/or url parameters which are not specified here should be set based on
 the user agent’s normal handling for font requests. For example if this font load is
 from a CSS font face, then <a href="https://www.w3.org/TR/css-fonts-4/#font-fetching-requirements"><cite>CSS Fonts 4</cite> § 4.8.2 Font fetching requirements</a> should be followed.</p>
     <p>The fields of the <a data-link-type="dfn" href="#patchrequest" id="ref-for-patchrequest④">PatchRequest</a> object should be set
 as follows:</p>
     <ul>
      <li data-md>
       <p><a data-link-type="dfn" href="#patchrequest-protocol_version" id="ref-for-patchrequest-protocol_version①">protocol_version</a>: set to 0.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#patchrequest-accept_patch_format" id="ref-for-patchrequest-accept_patch_format①">accept_patch_format</a>: set to the list of <a href="#patch-formats">§ 4.8 Patch Formats</a> that this client is
 capable of decoding. Must contain at least one format.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#patchrequest-codepoints_have" id="ref-for-patchrequest-codepoints_have①">codepoints_have</a>: set to exactly the set of codepoints that the current <var>font subset</var> contains data for. If the current <var>font subset</var> is not set then this field is left unset. If <var>client state</var> is available and has a <a data-link-type="dfn" href="#clientstate-codepoint_ordering" id="ref-for-clientstate-codepoint_ordering">codepoint_ordering</a> then
 this field should not be set.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#patchrequest-codepoints_needed" id="ref-for-patchrequest-codepoints_needed">codepoints_needed</a>: set to the set of codepoints that the client wants to
 add to its <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset⑦">font subset</a>. That is the codepoint set from <var>desired subset
 definition</var> minus the codepoints already in the <var>font subset</var>. If <var>client state</var> is available and has a <a data-link-type="dfn" href="#clientstate-codepoint_ordering" id="ref-for-clientstate-codepoint_ordering①">codepoint_ordering</a> then
 this field should not be set.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#patchrequest-indices_have" id="ref-for-patchrequest-indices_have②">indices_have</a>: encodes the set of additional codepoints that the current <var>font subset</var> contains data for. The codepoint values are transformed
 to indices by applying the <a href="#codepoint-reordering">§ 4.7 Codepoint Reordering</a> specified by <a data-link-type="dfn" href="#clientstate-codepoint_ordering" id="ref-for-clientstate-codepoint_ordering②">codepoint_ordering</a> to each codepoint value. If
 the <var>client state</var> is not available or it does not have a <a data-link-type="dfn" href="#clientstate-codepoint_ordering" id="ref-for-clientstate-codepoint_ordering③">codepoint_ordering</a> then this field should not be set.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#patchrequest-indices_needed" id="ref-for-patchrequest-indices_needed①">indices_needed</a>: encodes the set of codepoints that the client wants to add to
 its <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset⑧">font subset</a>. That is the codepoint set from <var>desired subset
 definition</var> minus the codepoints already in <var>font subset</var>.
 The codepoint values are transformed to indices by applying the <a href="#codepoint-reordering">§ 4.7 Codepoint Reordering</a> specified by <a data-link-type="dfn" href="#clientstate-codepoint_ordering" id="ref-for-clientstate-codepoint_ordering④">codepoint_ordering</a> to each codepoint value. If
 the <var>client state</var> is not available or it does not have a <a data-link-type="dfn" href="#clientstate-codepoint_ordering" id="ref-for-clientstate-codepoint_ordering⑤">codepoint_ordering</a> then this field should not be set.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#patchrequest-features_have" id="ref-for-patchrequest-features_have">features_have</a>: set to the list of <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/featuretags"> opentype layout feature tags</a> that the current <var>font subset</var> has data
 for. If the current <var>font subset</var> is not set then this
 field is left unset. Additionally, if the current <var>font subset</var> has all
 data for features present in the <a data-link-type="dfn" href="#original-font" id="ref-for-original-font">original font</a> then this field can be unset.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#patchrequest-features_needed" id="ref-for-patchrequest-features_needed">features_needed</a>: set to the list of feature tags that the client wants to add
 to the current <var>font subset</var>. That is the feature set from <var>desired subset
 definition</var> minus the set of features already in <var>font subset</var>.
 If the client wishes to add all remaining layout features from the <a data-link-type="dfn" href="#original-font" id="ref-for-original-font①">original font</a> to it’s
 subset then this field should be unset.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#patchrequest-axis_space_have" id="ref-for-patchrequest-axis_space_have">axis_space_have</a>: set to the current value of <a data-link-type="dfn" href="#clientstate-subset_axis_space" id="ref-for-clientstate-subset_axis_space">subset_axis_space</a> saved in the <var>client state</var> for this font. If <var>client state</var> is not available then this field is unset.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#patchrequest-axis_space_needed" id="ref-for-patchrequest-axis_space_needed">axis_space_needed</a>: set to the intervals of each variable axis in the <a data-link-type="dfn" href="#original-font" id="ref-for-original-font②">original font</a> that the client wants to add to its <var>font subset</var> as defined in the <var>desired subset definition</var>. If the client wants an
 entire axis from the <a data-link-type="dfn" href="#original-font" id="ref-for-original-font③">original font</a> then that axis should not be listed.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#patchrequest-ordering_checksum" id="ref-for-patchrequest-ordering_checksum①">ordering_checksum</a>: If either of <a data-link-type="dfn" href="#patchrequest-indices_have" id="ref-for-patchrequest-indices_have③">indices_have</a> or <a data-link-type="dfn" href="#patchrequest-indices_needed" id="ref-for-patchrequest-indices_needed②">indices_needed</a> is set then this must be set to the checksum of the <a data-link-type="dfn" href="#clientstate-codepoint_ordering" id="ref-for-clientstate-codepoint_ordering⑥">codepoint_ordering</a> saved in the <var>client state</var>. The checksum
 is computed via <a href="#reordering-checksum">§ 4.7.1 Codepoint Reordering Checksum</a>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#patchrequest-original_font_checksum" id="ref-for-patchrequest-original_font_checksum①">original_font_checksum</a>:
 Set to saved value for <a data-link-type="dfn" href="#clientstate-original_font_checksum" id="ref-for-clientstate-original_font_checksum">original_font_checksum</a> in the <var>client state</var> for this font. If there is no <var>client state</var> leave this field unset.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#patchrequest-base_checksum" id="ref-for-patchrequest-base_checksum①">base_checksum</a>:
 Set to the checksum of the <var>font subset</var>. See: <a href="#computing-checksums">§ 4.6 Computing Checksums</a>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#patchrequest-fragment_id" id="ref-for-patchrequest-fragment_id">fragment_id</a>:
 If a <var>fragment identifier</var> was provided as an input then this field must be set to
 the provided <var>fragment identifier</var>, otherwise it must be left unset.</p>
     </ul>
     <p class="note" role="note"><span>Note:</span> It is allowed for the client to request more codepoints then it strictly needs. For
 example, on slower connections it may be more performant to request extra codepoints if
 that is likely to prevent a future request from needing to be sent.</p>
    <li data-md>
     <p>Invoke <a data-link-type="abstract-op" href="#abstract-opdef-handle-server-response" id="ref-for-abstract-opdef-handle-server-response">Handle server response</a> with the response from the server and the <var>font subset</var> then return the result.</p>
   </ol>
   <p class="note" role="note"><span>Note:</span> POST is preferred for the HTTP method since it will not cause a CORS preflight request
and the request object is more compactly encoded. GET should only be used during <a href="#method-negotiation">method negotiation</a>.</p>
   <h4 class="heading settled algorithm" data-algorithm="Handling Server Response" data-level="4.4.2" id="handling-patch-response"><span class="secno">4.4.2. </span><span class="content">Handling Server Response</span><a class="self-link" href="#handling-patch-response"></a></h4>
   <p>If a server is able to succsessfully process a <a data-link-type="dfn" href="#patchrequest" id="ref-for-patchrequest⑤">PatchRequest</a> it will respond with HTTP <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-status" id="ref-for-concept-response-status">status</a> code 200 and the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-body" id="ref-for-concept-response-body">body</a> of the response will
be a 4 byte magic number (0x49, 0x46, 0x54, 0x20) followed by a single <a data-link-type="dfn" href="#patchresponse" id="ref-for-patchresponse①">PatchResponse</a> object encoded
via CBOR. The client uses the following algorithm to interpret and process the fields of the
object.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-handle-server-response">Handle server response</dfn></p>
   <p>Inputs:</p>
   <ul>
    <li data-md>
     <p><var>server response</var>: HTTP <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response" id="ref-for-concept-response">response</a> to a patch request.</p>
    <li data-md>
     <p><var>font subset</var> (optional): existing <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset⑨">font subset</a> which is  being extended. May be null.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p>Extended Font Subset: <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⓪">font subset</a> that has been updated to cover at least the requested subset
definition.</p>
    <li data-md>
     <p>Cache fields: HTTP cache fields <a href="https://www.rfc-editor.org/rfc/rfc9111#name-field-definitions">HTTP Caching § name-field-definitions</a> describing how client state
can be cached, or null.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>If the <var>server response</var> has <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-status" id="ref-for-concept-response-status①">status</a> other than 200:</p>
     <ul>
      <li data-md>
       <p>If it is a redirect <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-status" id="ref-for-concept-status">status</a>: follow normal redirect handling, such as <a href="https://fetch.spec.whatwg.org/#http-redirect-fetch"><cite>Fetch Standard</cite> § 4.4 HTTP-redirect fetch</a> and then go back to step 1.</p>
      <li data-md>
       <p>All other statuses, the <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①①">font subset</a> extension has failed. Invoke <a data-link-type="abstract-op" href="#abstract-opdef-handle-failed-font-load" id="ref-for-abstract-opdef-handle-failed-font-load">Handle failed font load</a> and return the result.</p>
     </ul>
    <li data-md>
     <p>Check the first four bytes of the <var>server response</var> <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-body" id="ref-for-concept-response-body①">body</a>. If they are
 not equal to [0x49, 0x46, 0x54, 0x20] then this response is malformed.
 Invoke <a data-link-type="abstract-op" href="#abstract-opdef-handle-failed-font-load" id="ref-for-abstract-opdef-handle-failed-font-load①">Handle failed font load</a> and return the result.</p>
    <li data-md>
     <p>Interpret the remaining bytes of the <var>server response</var> <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-body" id="ref-for-concept-response-body②">body</a> as a CBOR
 encoded <a data-link-type="dfn" href="#patchresponse" id="ref-for-patchresponse②">PatchResponse</a>. If the bytes are not decodable with CBOR, or the <a data-link-type="dfn" href="#patchresponse" id="ref-for-patchresponse③">PatchResponse</a> is not well formed, then this is an error. Invoke <a data-link-type="abstract-op" href="#abstract-opdef-handle-failed-font-load" id="ref-for-abstract-opdef-handle-failed-font-load②">Handle failed font load</a> and return the result.</p>
    <li data-md>
     <p>If field <a data-link-type="dfn" href="#patchresponse-replacement" id="ref-for-patchresponse-replacement①">replacement</a> is set then: the byte array in this field is a binary patch
 in the format specified by <a data-link-type="dfn" href="#patchresponse-patch_format" id="ref-for-patchresponse-patch_format①">patch_format</a>. Apply the binary patch to a base which
 is an empty byte array. This produces the extended font subset. Return the extended font subset
 and any cache headers that were set on the <var>server response</var>.</p>
    <li data-md>
     <p>If field <a data-link-type="dfn" href="#patchresponse-patch" id="ref-for-patchresponse-patch①">patch</a> is set then:  the byte array in this field is a binary patch
 in the format specifiedy <a data-link-type="dfn" href="#patchresponse-patch_format" id="ref-for-patchresponse-patch_format②">patch_format</a>. Apply the binary patch to the input <var>font subset</var>. This produces the extended font subset. Return the extended font subset
 and any cache headers that were set on the <var>server response</var>.</p>
    <li data-md>
     <p>If field <a data-link-type="dfn" href="#patchresponse-unrecognized_ordering" id="ref-for-patchresponse-unrecognized_ordering①">unrecognized_ordering</a> is set to a non-zero value then the client should
 resend the request that triggered this response but also set the <a data-link-type="dfn" href="#patchrequest-codepoint_ordering" id="ref-for-patchrequest-codepoint_ordering">codepoint_ordering</a> field on the request to the <a data-link-type="dfn" href="#clientstate-codepoint_ordering" id="ref-for-clientstate-codepoint_ordering⑦">codepoint_ordering</a> in the client state table within <var>font subset</var>.</p>
    <li data-md>
     <p>Otherwise if none of <a data-link-type="dfn" href="#patchresponse-replacement" id="ref-for-patchresponse-replacement②">replacement</a>, <a data-link-type="dfn" href="#patchresponse-patch" id="ref-for-patchresponse-patch②">patch</a>, or <a data-link-type="dfn" href="#patchresponse-unrecognized_ordering" id="ref-for-patchresponse-unrecognized_ordering②">unrecognized_ordering</a> this is an error, invoke <a data-link-type="abstract-op" href="#abstract-opdef-handle-failed-font-load" id="ref-for-abstract-opdef-handle-failed-font-load③">Handle failed font load</a> and
 return the result.</p>
   </ol>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-handle-failed-font-load">Handle failed font load</dfn></p>
   <p>If the font load or extension has failed the client should choose one of the following options:</p>
   <ol>
    <li data-md>
     <p>If the client has a saved <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①②">font subset</a>, it may choose to use that and then use the user
  agent’s existing font fallback mechanism for codepoints not covered by the subset.</p>
    <li data-md>
     <p>The client may re-issue the request as a regular non incremental font fetch to the same <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-path" id="ref-for-concept-url-path①">path</a>. It must not include the patch subset request parameter or header. This will load
  the entire <a data-link-type="dfn" href="#original-font" id="ref-for-original-font④">original font</a>.</p>
    <li data-md>
     <p>Discard the saved <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①③">font subset</a>, and use the user agent’s existing font fallback mechanism.</p>
   </ol>
   <h4 class="heading settled algorithm" data-algorithm="Load a Font in a User Agent with a HTTP Cache" data-level="4.4.3" id="load-a-font"><span class="secno">4.4.3. </span><span class="content">Load a Font in a User Agent with a HTTP Cache</span><a class="self-link" href="#load-a-font"></a></h4>
   <p>The previous section <a href="#extend-subset">§ 4.4.1 Extending the Font Subset</a> provides no guidance on how a user agent should handle
saving the font subset and client state between invocations of the subset extension algorithm. This
section provides an algorithm that user agents which implement <a data-link-type="biblio" href="#biblio-fetch">[fetch]</a> should use to save the font
subset to the user agent’s HTTP cache (<a data-link-type="biblio" href="#biblio-rfc9111">[RFC9111]</a>).</p>
   <p><dfn data-dfn-type="abstract-op" data-export id="abstract-opdef-load-a-font-with-a-http-cache">Load a font with a HTTP Cache<a class="self-link" href="#abstract-opdef-load-a-font-with-a-http-cache"></a></dfn></p>
   <p>The inputs to this algorithm:</p>
   <ul>
    <li data-md>
     <p><var>font URL</var>: a URL where the font to be extended is located.</p>
    <li data-md>
     <p><var>fragment identifier</var> (optional): if the font at the font url is a collection of fonts,
the fragment identifier (<a href="https://www.rfc-editor.org/rfc/rfc8081#section-4.2">The "font" Top-Level Media Type § section-4.2</a>) identifies a single font within the collection.</p>
    <li data-md>
     <p><var>desired subset definition</var>: a <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition①">description</a> of the desired
minimum <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①④">font subset</a>.</p>
    <li data-md>
     <p><var>fetch algorithm</var>: algorithm for fetching HTTP resources, such as <a data-link-type="biblio" href="#biblio-fetch">[fetch]</a>. The remainder
of this section is desribed in terms of <a href="https://fetch.spec.whatwg.org/#fetching"><cite>Fetch Standard</cite> § 4 Fetching</a>, but it is allowed to substitute
whatever HTTP fetching algorithm the user agent supports.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p>A <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⑤">font subset</a> which covers at minimum the input subset definition.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Make a HTTP fetch:</p>
     <ul>
      <li data-md>
       <p>The request <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-method" id="ref-for-concept-request-method③">method</a> is "GET".</p>
      <li data-md>
       <p>The request <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-destination" id="ref-for-concept-request-destination①">destination</a> must be "font".</p>
      <li data-md>
       <p>The request CORS <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-mode" id="ref-for-concept-request-mode①">mode</a> must be "cors".</p>
      <li data-md>
       <p>The request URL <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-scheme" id="ref-for-concept-url-scheme①">scheme</a> must be "https".</p>
      <li data-md>
       <p>The request URL <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-path" id="ref-for-concept-url-path②">path</a> is set to the input font URL.</p>
      <li data-md>
       <p>The request <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-cache-mode" id="ref-for-concept-request-cache-mode①">cache mode</a> is "only-if-cached".</p>
     </ul>
    <li data-md>
     <p>If the request is successful and the response is "fresh" (<a href="https://www.rfc-editor.org/rfc/rfc9111#name-freshness">HTTP Caching § name-freshness</a>)
 then invoke <a data-link-type="abstract-op" href="#abstract-opdef-extend-the-font-subset" id="ref-for-abstract-opdef-extend-the-font-subset">Extend the font subset</a> with:</p>
     <ul>
      <li data-md>
       <p>Font url set to the input <var>font URL</var>.</p>
      <li data-md>
       <p>Fragment identifier set to the input <var>fragment identifier</var></p>
      <li data-md>
       <p>Font subset set to the response.</p>
      <li data-md>
       <p>Desired subset definition set to the input <var>desired subset definition</var>.</p>
      <li data-md>
       <p>Fetch algorithm set to the input <var>fetch algorithm</var>.</p>
     </ul>
     <p>Once that returns go to step 4.</p>
    <li data-md>
     <p>Otherwise, invoke <a data-link-type="abstract-op" href="#abstract-opdef-extend-the-font-subset" id="ref-for-abstract-opdef-extend-the-font-subset①">Extend the font subset</a> with:</p>
     <ul>
      <li data-md>
       <p>Font url set to the input <var>font URL</var>.</p>
      <li data-md>
       <p>Fragment identifier set to the input <var>fragment identifier</var></p>
      <li data-md>
       <p>Font subset set to null.</p>
      <li data-md>
       <p>Desired subset definition set to the input <var>desired subset definition</var>.</p>
      <li data-md>
       <p>Fetch algorithm set to the input <var>fetch algorithm</var>.</p>
     </ul>
     <p>Once that returns go to step 4.</p>
    <li data-md>
     <p>If the returned cache fields are non-null update the cache entry for the input
 font url with the returned client state and returned cache fields.</p>
    <li data-md>
     <p>Return the returned <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⑥">font subset</a>.</p>
   </ol>
   <h3 class="heading settled" data-level="4.5" id="handling-patch-request"><span class="secno">4.5. </span><span class="content">Server: Responding to a PatchRequest</span><a class="self-link" href="#handling-patch-request"></a></h3>
   <p><span class="conform server" id="conform-successful-response">If the server receives a well formed <a data-link-type="dfn" href="#patchrequest" id="ref-for-patchrequest⑥">PatchRequest</a> over HTTPS for a font the server has and that was
populated according to the requirements in <a href="#extend-subset">§ 4.4.1 Extending the Font Subset</a> then it must respond with HTTP <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-status" id="ref-for-concept-response-status②">status</a> code 200.</span> <span class="conform server" id="conform-magic-number">The first 4 bytes of the response <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-body" id="ref-for-concept-response-body③">body</a> must be set to 0x49, 0x46, 0x54, 0x20 ("IFT " encoded as ASCII) followed by a
single <a data-link-type="dfn" href="#patchresponse" id="ref-for-patchresponse④">PatchResponse</a> object encoded via CBOR.</span></p>
   <p>The <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-path" id="ref-for-concept-url-path③">path</a> in the request <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-url" id="ref-for-concept-request-url">url</a> identifies the specific font that a patch is desired
for. If the request has the <a data-link-type="dfn" href="#patchrequest-fragment_id" id="ref-for-patchrequest-fragment_id①">fragment_id</a> field set and the file identified by <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-path" id="ref-for-concept-url-path④">path</a> is a collection of fonts, then <a data-link-type="dfn" href="#patchrequest-fragment_id" id="ref-for-patchrequest-fragment_id②">fragment_id</a> identifies the font within
that collection that a patch is desired for. The identified font is referred to as the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="original-font">original font</dfn> in the rest of this section.</p>
   <p>From the request object the server can produce two codepoint sets:</p>
   <ol>
    <li data-md>
     <p>Codepoints the client has: formed by the union of the codepoint sets specified by <a data-link-type="dfn" href="#patchrequest-codepoints_have" id="ref-for-patchrequest-codepoints_have②">codepoints_have</a> and <a data-link-type="dfn" href="#patchrequest-indices_have" id="ref-for-patchrequest-indices_have④">indices_have</a>. <span class="conform server" id="conform-remap-codepoints-have">The indices in <a data-link-type="dfn" href="#patchrequest-indices_have" id="ref-for-patchrequest-indices_have⑤">indices_have</a> must be mapped to codepoints by the application of the
 codepoint reordering with a checksum matching <a data-link-type="dfn" href="#patchrequest-ordering_checksum" id="ref-for-patchrequest-ordering_checksum②">ordering_checksum</a>.</span></p>
    <li data-md>
     <p>Codepoints the client needs: formed by the union of the codepoint sets specified by <a data-link-type="dfn" href="#patchrequest-codepoints_needed" id="ref-for-patchrequest-codepoints_needed①">codepoints_needed</a> and <a data-link-type="dfn" href="#patchrequest-indices_needed" id="ref-for-patchrequest-indices_needed③">indices_needed</a>. <span class="conform server" id="conform-remap-codepoints-needed">The indices in <a data-link-type="dfn" href="#patchrequest-indices_needed" id="ref-for-patchrequest-indices_needed④">indices_needed</a> must be mapped to codepoints by the application of the
 codepoint reordering with a checksum matching <a data-link-type="dfn" href="#patchrequest-ordering_checksum" id="ref-for-patchrequest-ordering_checksum③">ordering_checksum</a>.</span></p>
   </ol>
   <p>Likewise, the server can produce two sets of <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/featuretags">opentype layout feature tags</a>:</p>
   <ol>
    <li data-md>
     <p>Feature tags the client’s subset has: specified by <a data-link-type="dfn" href="#patchrequest-features_have" id="ref-for-patchrequest-features_have①">features_have</a>. If the field is
 unset this indicates the client’s subset contains all features in the <a data-link-type="dfn" href="#original-font" id="ref-for-original-font⑤">original font</a>.</p>
    <li data-md>
     <p>Feature tags the client needs: specified by <a data-link-type="dfn" href="#patchrequest-features_needed" id="ref-for-patchrequest-features_needed①">features_needed</a>. If the field is unset
 this indicates the client wants all features in the <a data-link-type="dfn" href="#original-font" id="ref-for-original-font⑥">original font</a>.</p>
   </ol>
   <p>Lastly, the server can produce two variable axis spaces:</p>
   <ol>
    <li data-md>
     <p>Axis space the client has: specified by <a data-link-type="dfn" href="#patchrequest-axis_space_have" id="ref-for-patchrequest-axis_space_have①">axis_space_have</a>. If any axes in the font
 are not specified in <a data-link-type="dfn" href="#patchrequest-axis_space_have" id="ref-for-patchrequest-axis_space_have②">axis_space_have</a> then for those axes add their entire
 interval from the <a data-link-type="dfn" href="#original-font" id="ref-for-original-font⑦">original font</a>.</p>
    <li data-md>
     <p>Axis space the client needs: specified by <a data-link-type="dfn" href="#patchrequest-axis_space_needed" id="ref-for-patchrequest-axis_space_needed①">axis_space_needed</a>. If any axes in the
 font are not specified in <a data-link-type="dfn" href="#patchrequest-axis_space_needed" id="ref-for-patchrequest-axis_space_needed②">axis_space_needed</a> then for those axes add their entire
 interval from the <a data-link-type="dfn" href="#original-font" id="ref-for-original-font⑧">original font</a>.</p>
   </ol>
   <p><span class="conform server" id="conform-bad-reordering"> If the server does not recognize the codepoint ordering used by the client, it must respond
with a response that will cause the client to update it’s codepoint ordering to one the server
will recognize via the process described in <a href="#handling-patch-response">§ 4.4.2 Handling Server Response</a> and not include any patch.
That is the <a data-link-type="dfn" href="#patchresponse-patch" id="ref-for-patchresponse-patch③">patch</a> and <a data-link-type="dfn" href="#patchresponse-replacement" id="ref-for-patchresponse-replacement③">replacement</a> fields must not be set.
The <a data-link-type="dfn" href="#patchresponse-unrecognized_ordering" id="ref-for-patchresponse-unrecognized_ordering③">unrecognized_ordering</a> field must be set to a non-zero value.</span></p>
   <p><span class="conform server" id="conform-response-valid-patch"> Otherwise when the response is applied by the client following the process in <a href="#handling-patch-response">§ 4.4.2 Handling Server Response</a> to a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⑦">font subset</a> with checksum <a data-link-type="dfn" href="#patchrequest-base_checksum" id="ref-for-patchrequest-base_checksum②">base_checksum</a> it must
result in an extended <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⑧">font subset</a>: </span></p>
   <ul>
    <li data-md>
     <p><span class="conform server" id="conform-response-subset">That contains data for at least the union
of the set of codepoints needed and the sets of codepoints the client already has.</span></p>
    <li data-md>
     <p><span class="conform server" id="conform-response-subset-features">That contains data for at least
the union of the set of features needed and the sets of features the client already has.</span></p>
    <li data-md>
     <p><span class="conform server" id="conform-response-subset-axis-space">That contains a variation axis
space that covers at least the union of the axis space the client has and the axis space the
client needs.</span></p>
    <li data-md>
     <p><span class="conform server" id="conform-response-client-state">That has a <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a> which is mapped to the tag "IFTP" whose content is a single <a data-link-type="dfn" href="#clientstate" id="ref-for-clientstate①">ClientState</a> object encoded via
CBOR:</span></p>
     <ul>
      <li data-md>
       <p><span class="conform server" id="conform-response-client-state-original-checksum">The <a data-link-type="dfn" href="#clientstate-original_font_checksum" id="ref-for-clientstate-original_font_checksum①">original_font_checksum</a> field must be set to the checksum of the <a data-link-type="dfn" href="#original-font" id="ref-for-original-font⑨">original font</a> computed by the procedure in <a href="#computing-checksums">§ 4.6 Computing Checksums</a>.</span></p>
      <li data-md>
       <p><span class="conform server" id="conform-response-client-state-codepoint-ordering"> The <a data-link-type="dfn" href="#clientstate-codepoint_ordering" id="ref-for-clientstate-codepoint_ordering⑧">codepoint_ordering</a> field must be set following <a href="#codepoint-reordering">§ 4.7 Codepoint Reordering</a>.</span></p>
      <li data-md>
       <p><span class="conform server" id="conform-response-client-state-subset-axis-space-field"> If the <a data-link-type="dfn" href="#original-font" id="ref-for-original-font①⓪">original font</a> has variation axes, the <a data-link-type="dfn" href="#clientstate-subset_axis_space" id="ref-for-clientstate-subset_axis_space①">subset_axis_space</a> field must be set to the axis space covered by the <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⑨">font subset</a>.</span></p>
      <li data-md>
       <p><span class="conform server" id="conform-response-client-state-original-axis-space"> If the <a data-link-type="dfn" href="#original-font" id="ref-for-original-font①①">original font</a> has variation axes, the <a data-link-type="dfn" href="#clientstate-original_axis_space" id="ref-for-clientstate-original_axis_space">original_axis_space</a> field must be set to the axis space covered by
 the <a data-link-type="dfn" href="#original-font" id="ref-for-original-font①②">original font</a>.</span></p>
      <li data-md>
       <p><span class="conform server" id="conform-response-client-state-original-features"> The <a data-link-type="dfn" href="#clientstate-original_features" id="ref-for-clientstate-original_features">original_features</a> field must be set to the list of <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/featuretags">opentype layout
feature tags</a> that the <a data-link-type="dfn" href="#original-font" id="ref-for-original-font①③">original font</a> has data for.</span></p>
     </ul>
   </ul>
   <p>Additionally:</p>
   <ul>
    <li data-md>
     <p><span class="conform server" id="conform-response-patch-format">The format of the patch in the
either the <a data-link-type="dfn" href="#patchresponse-patch" id="ref-for-patchresponse-patch④">patch</a> or <a data-link-type="dfn" href="#patchresponse-replacement" id="ref-for-patchresponse-replacement④">replacement</a> fields must be one of those
listed in <a data-link-type="dfn" href="#patchrequest-accept_patch_format" id="ref-for-patchrequest-accept_patch_format②">accept_patch_format</a></span>.</p>
    <li data-md>
     <p><span class="conform server" id="conform-response-ignore-unrecognized-formats"> If <a data-link-type="dfn" href="#patchrequest-accept_patch_format" id="ref-for-patchrequest-accept_patch_format③">accept_patch_format</a> contains any unrecognized patch formats the server must
ignore the unrecognized ones.</span></p>
   </ul>
   <p class="note" role="note"><span>Note:</span> the server can respond with either a patch or a replacement but should try to produce a patch
where possible. Replacement’s should only be used in situations where the server is unable to recreate
the client’s state in order to generate a patch against it.</p>
   <p class="note" role="note"><span>Note:</span> if a patch subset service is composed of more than one server task and some subset of those
tasks are using a subsetter version which produces different binary results than the rest, there is
a risk that consecutive extend requests may result in unnecessary replacement responses. For example if
consecutive requests alternate between server backends with different subsetters, then each response
will be a replacement as the server tasks will be unable to recreate the previously generated
subset. This scenario might occur during software updates to the server tasks. To combat this
it’s recommended that sticky load balancing is used which aims to send consecutive requests from the
same client to the same server task.</p>
   <p>Possible error responses:</p>
   <ul>
    <li data-md>
     <p><span class="conform server" id="conform-reject-malformed-request"> If the request is malformed the server must instead respond with http <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-status" id="ref-for-concept-response-status③">status</a> code 400
 to indicate an error.</span></p>
    <li data-md>
     <p>If the requested font is not recognized by the server it should respond with http <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-status" id="ref-for-concept-response-status④">status</a> code 404 to indicate a not found error.</p>
   </ul>
   <h4 class="heading settled" data-level="4.5.1" id="range-request-support"><span class="secno">4.5.1. </span><span class="content">Range Request Support</span><a class="self-link" href="#range-request-support"></a></h4>
   <p>A patch subset support server must also support incremental transfer via <a href="#range-request-incxfer">§ 5 Range Request Incremental Transfer</a>.
To support range request incremental tranfser the patch subset server must support HTTP range requests
(<a href="https://www.rfc-editor.org/rfc/rfc9110#range.requests">HTTP Semantics § range.requests</a>) against the font files it provides via patch subset.</p>
   <h3 class="heading settled" data-level="4.6" id="computing-checksums"><span class="secno">4.6. </span><span class="content">Computing Checksums</span><a class="self-link" href="#computing-checksums"></a></h3>
   <p>64 bit checksums of byte strings are computed using the <a data-link-type="biblio" href="#biblio-fast-hash">[fast-hash]</a> algorithm. A python like pseudo
code version of the algorithm is presented below:</p>
<pre># Constant values come fast hash: https://github.com/ztanml/fast-hash
SEED = 0x11743e80f437ffe6
M = 0x880355f21e6d1965

mix(value):
  value = value ^ (value >> 23)
  value = value * 0x2127599bf4325c37
  value = value ^ (value >> 47)
  return value

fast_hash(byte[] data):
  # When casting byte arrays into unsigned 64 bit integers the bytes are in little
  # endian order. That is the smallest index is the least significant byte.
  uint64 hash = SEED ^ (length(data) * M)
  for (i = 0; i &lt;= length(data) - 8; i += 8)
    hash = (hash ^ mix((uint64) data[i:i+8])) * M

  remaining = length(data) % 8
  if not remaining:
    return mix(hash)

  uint64 last_value = (uint64) concat(data[length(data) - remaining:],
                                      [0] * (8 - remaining))
  return mix((hash ^ mix(last_value)) * M)
</pre>
   <p>To ensure checksums are consistent across all platforms, all integers during the computation are
in little endian order.</p>
   <p class="note" role="note"><span>Note:</span> a C implementation of fast hash can be found here: <a data-link-type="biblio" href="#biblio-fast-hash">[fast-hash]</a></p>
   <div class="example" id="example-e69b2b2f">
    <a class="self-link" href="#example-e69b2b2f"></a> 
    <table>
     <tbody>
      <tr>
       <th>Bytes
       <th>Checksum value
      <tr>
       <td>0f 7b 5a e5
       <td>0xe5e0d1dc89eaa189
      <tr>
       <td>1d f4 02 5e d3 b8 43 21 3b ae de
       <td>0xb31e9c70768205fb
    </table>
   </div>
   <h3 class="heading settled" data-level="4.7" id="codepoint-reordering"><span class="secno">4.7. </span><span class="content">Codepoint Reordering</span><a class="self-link" href="#codepoint-reordering"></a></h3>
   <p>A codepoint reordering for a font defines a function which maps unicode codepoint values from the
font to a continuous space of [0, number of codepoints in the font). This transformation is intended
to reduce the cost of representing codepoint sets.</p>
   <p><span class="conform server " id="conform-remap-all">A codepoint ordering is encoded into a <a data-link-type="dfn" href="#integerlist" id="ref-for-integerlist⑤">IntegerList</a>. The list must contain all unicode codepoints that are supported by the
font.</span> The index of a particular unicode codepoint in the list is the new value for that
codepoint.</p>
   <p>A server is free to choose any codepoint ordering, but should try to pick one that will minimize the
size of encoded codepoint sets for that font.</p>
   <h4 class="heading settled" data-level="4.7.1" id="reordering-checksum"><span class="secno">4.7.1. </span><span class="content">Codepoint Reordering Checksum</span><a class="self-link" href="#reordering-checksum"></a></h4>
   <p>A checksum of a codepoint reordering can be computed as follows:</p>
<pre>SEED = 0x11743e80f437ffe6
M = 0x880355f21e6d1965

mix(value):
  value = value ^ (value >> 23)
  value = value * 0x2127599bf4325c37
  value = value ^ (value >> 47)
  return value

fast_hash_ordering(uint64[] ordering):
  uint64 hash = SEED ^ (length(ordering) * 8 * M)
  for i in ordering:
    hash = (hash ^ mix(ordering[i])) * M

  return mix(hash)
</pre>
   <p>To ensure checksums are consistent across all platforms, all integers during the computation are
in little endian order.</p>
   <div class="example" id="example-6c33d2ed">
    <a class="self-link" href="#example-6c33d2ed"></a> 
    <table>
     <tbody>
      <tr>
       <th>Codepoint Ordering
       <th>Checksum value
      <tr>
       <td>[106, 97, 105, 120, 100]
       <td>0x6986dc19f4e621e
    </table>
   </div>
   <h3 class="heading settled" data-level="4.8" id="patch-formats"><span class="secno">4.8. </span><span class="content">Patch Formats</span><a class="self-link" href="#patch-formats"></a></h3>
   <p>The following patch formats may be used by the server to create binary diffs between a source file
and a target file:</p>
   <table>
    <tbody>
     <tr>
      <th>Format
      <th>Value
      <th>Notes
     <tr>
      <td>VCDIFF
      <td>0
      <td> Uses VCDIFF format <a data-link-type="biblio" href="#biblio-rfc3284">[RFC3284]</a> to produce the patch. <span class="conform server client" id="conform-vcdiff"> All client and server implementations must support this format. </span> 
     <tr>
      <td>Brotli Shared Dictionary
      <td>1
      <td> The target file is encoded with <a data-link-type="biblio" href="#biblio-rfc7932">brotli compression</a> using the
      source file as a <a data-link-type="biblio" href="#biblio-shared-brotli">shared LZ77 dictionary</a>. If the source file is empty then
      the target file is just compressed using <a data-link-type="biblio" href="#biblio-rfc7932">brotli compression</a> with no shared
      dictionary. 
   </table>
   <h2 class="heading settled" data-level="5" id="range-request-incxfer"><span class="secno">5. </span><span class="content">Range Request Incremental Transfer</span><a class="self-link" href="#range-request-incxfer"></a></h2>
   <h3 class="heading settled" data-level="5.1" id="range-request-intro"><span class="secno">5.1. </span><span class="content">Introduction to Range Request</span><a class="self-link" href="#range-request-intro"></a></h3>
   <p><em>This section is not normative.</em></p>
   <p>The Range Request method is a very simple method of incremental transfer, and has no server-side requirements (other than the server should be able to respond to byte-based range requests). The browser simply makes range requests to the server for the specific bytes in the font file that it needs. In order to know which bytes are necessary, the browser makes one initial special request for the beginning of the file.</p>
   <p>In order for the range request method to be as effective as possible, the font file itself should be internally arranged in a particular way, in order to decrease the number of requests the browser needs to make. Therefore, it is expected that web developers wishing to use the range request method will use font files that have had their contents already arranged optimally.</p>
   <p>This method was modelled after video playback on the web, where seeking in a video causes the browser to send a range request to the server.</p>
   <h3 class="heading settled" data-level="5.2" id="font-organization"><span class="secno">5.2. </span><span class="content">Font organization</span><a class="self-link" href="#font-organization"></a></h3>
   <h4 class="heading settled" data-level="5.2.1" id="font-organization-background"><span class="secno">5.2.1. </span><span class="content">Background</span><a class="self-link" href="#font-organization-background"></a></h4>
   <p><em>This section is not normative.</em></p>
   <p>A particular organization of font files is beneficial for improving the performance of the range-request IFT method. The range-request IFT method only works with <a data-link-type="biblio" href="#biblio-truetype">[TRUETYPE]</a>, <a data-link-type="biblio" href="#biblio-opentype">[OPENTYPE]</a>, <a data-link-type="biblio" href="#biblio-woff">[WOFF]</a>, or <a data-link-type="biblio" href="#biblio-woff2">[WOFF2]</a> files. All of these file formats use an <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#organization-of-an-opentype-font"><code>sfnt</code> wrapper</a> which provides a directory of tables inside the font file. A <code>sfnt</code>-based font file is mainly composed of a collection of independent tables.</p>
   <p class="issue" id="issue-73fb8795"><a class="self-link" href="#issue-73fb8795"></a> <a href="https://github.com/w3c/IFT/issues/59">Using WOFF2 files with range-request mechanism doesn’t seem to be a viable option</a></p>
   <h4 class="heading settled" data-level="5.2.2" id="font-organization-introduction"><span class="secno">5.2.2. </span><span class="content">Introduction</span><a class="self-link" href="#font-organization-introduction"></a></h4>
   <p>The term <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="range-request-optimized-font">range-request optimized font</dfn> is used to describe a font file organized for use with the range-request IFT method. Optimizing a font for the range-request IFT method does not change the file format of the font.</p>
   <p class="note" role="note"><span>Note:</span> Because optimizing a font does not change its file format, no new additional tooling is necessary to interact with these optimized fonts. They are still valid fonts, but with a particular internal organization.</p>
   <div class="example" id="example-85584618"><a class="self-link" href="#example-85584618"></a> The result of optimizing an OpenType font for the range-request IFT method is still a valid OpenType font. The resulting file may be larger (by byte count) than it was before optimizing it, but fewer of those bytes should be necessary for a client to download in order to render a target text. </div>
   <p class="note" role="note"><span>Note:</span> There are no <code>MUST</code>-level requirements on the organization of a <a data-link-type="dfn" href="#range-request-optimized-font" id="ref-for-range-request-optimized-font">range-request optimized font</a>. Any arbitrary font file may be considered to be a <a data-link-type="dfn" href="#range-request-optimized-font" id="ref-for-range-request-optimized-font①">range-request optimized font</a>. However, additional optimizations should increase the performance of loading in a browser via the range-request IFT method. Font creators are encouraged to enact as many of the optimizations listed in this section as are reasonable for the fonts they create.</p>
   <h4 class="heading settled" data-level="5.2.3" id="font-organization-compression"><span class="secno">5.2.3. </span><span class="content">Compression</span><a class="self-link" href="#font-organization-compression"></a></h4>
   <p>Servers supporting the range-request IFT method should support compression via the <code>Content-Encoding</code> header (<a href="https://www.rfc-editor.org/rfc/rfc9110#name-content-encoding">HTTP Semantics § name-content-encoding</a>), rather than having the font file itself be statically compressed.</p>
   <p>A <a data-link-type="dfn" href="#range-request-optimized-font" id="ref-for-range-request-optimized-font②">range-request optimized font</a> file (the file itself) should not use any kind of compression other than <a data-link-type="biblio" href="#biblio-rfc7932">[RFC7932]</a> (commonly referred to as "Brotli") compression.</p>
   <p>If Brotli compression is used in a <a data-link-type="dfn" href="#range-request-optimized-font" id="ref-for-range-request-optimized-font③">range-request optimized font</a>, it should use only one <a href="https://datatracker.ietf.org/doc/html/rfc7932#section-9.2">meta-block</a>.</p>
   <p>If Brotli compression is used in a <a data-link-type="dfn" href="#range-request-optimized-font" id="ref-for-range-request-optimized-font④">range-request optimized font</a>, its one meta-block should have the <a href="https://datatracker.ietf.org/doc/html/rfc7932#section-9.2"><code>ISUNCOMPRESSED</code></a> bit set to 1.</p>
   <p class="issue" id="issue-6786fd81"><a class="self-link" href="#issue-6786fd81"></a> <a href="https://github.com/w3c/IFT/issues/60">Static file compression compatibility with range-request method</a></p>
   <h4 class="heading settled" data-level="5.2.4" id="font-organization-table-ordering"><span class="secno">5.2.4. </span><span class="content">Table Ordering</span><a class="self-link" href="#font-organization-table-ordering"></a></h4>
   <p>The term <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="outline-table">outline table</dfn> is used to describe these three tables,
which carry different types of glyph outlines:</p>
   <ul>
    <li data-md>
     <p>The <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/cff"><code>CFF</code></a> table</p>
    <li data-md>
     <p>The <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/cff2"><code>CFF2</code></a> table</p>
    <li data-md>
     <p>The <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/glyf"><code>glyf</code></a> table</p>
   </ul>
   <p>A <a data-link-type="dfn" href="#range-request-optimized-font" id="ref-for-range-request-optimized-font⑤">range-request optimized font</a> should have only one outline table.</p>
   <p>No two tables in a <a data-link-type="dfn" href="#range-request-optimized-font" id="ref-for-range-request-optimized-font⑥">range-request optimized font</a> should share a tag name.</p>
   <p>The <a data-link-type="dfn" href="#outline-table" id="ref-for-outline-table">outline table</a> data in a <a data-link-type="dfn" href="#range-request-optimized-font" id="ref-for-range-request-optimized-font⑦">range-request optimized font</a> should lie at the end of the file.</p>
   <p>If a <code>CFF</code> table exists, the <a href="https://adobe-type-tools.github.io/font-tech-notes/pdfs/5176.CFF.pdf">CharString</a> data should lie at the end of the <code>CFF</code> table.</p>
   <p>If a <code>CFF2</code> table exists, the <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/cff2#charStrings">CharString</a> data should lie at the end of the <code>CFF2</code> table.</p>
   <p class="issue" id="issue-010f4980"><a class="self-link" href="#issue-010f4980"></a> <a href="https://github.com/w3c/IFT/issues/28">Font Collections support</a></p>
   <h4 class="heading settled" data-level="5.2.5" id="font-organization-glyph-independence"><span class="secno">5.2.5. </span><span class="content">Glyph Independence</span><a class="self-link" href="#font-organization-glyph-independence"></a></h4>
   <p class="note" role="note"><span>Note:</span> The goal of this section is to make every glyph independent from each other.</p>
   <p>A <a data-link-type="dfn" href="#range-request-optimized-font" id="ref-for-range-request-optimized-font⑧">range-request optimized font</a> should not use <a href="https://developer.apple.com/fonts/TrueType-Reference-Manual/RM06/Chap6glyf.html">Compound glyphs</a>.</p>
   <p class="issue" id="issue-5533a524"><a class="self-link" href="#issue-5533a524"></a> <a href="https://github.com/w3c/IFT/issues/58">Supporting fonts with composite glyphs via range-request</a></p>
   <p class="note" role="note"><span>Note:</span> Compound glyphs can be flattened by inlining their component glyphs to become additional contours.</p>
   <p>A <a data-link-type="dfn" href="#range-request-optimized-font" id="ref-for-range-request-optimized-font⑨">range-request optimized font</a> should not use <a href="https://adobe-type-tools.github.io/font-tech-notes/pdfs/5176.CFF.pdf">Subroutines</a>.</p>
   <p class="note" role="note"><span>Note:</span> CFF glyph CharStrings can be flattened by inlining subroutines to become additional CharString bytes.</p>
   <h4 class="heading settled" data-level="5.2.6" id="font-organization-glyph-order"><span class="secno">5.2.6. </span><span class="content">Glyph Order</span><a class="self-link" href="#font-organization-glyph-order"></a></h4>
   <p>Glyphs inside a <a data-link-type="dfn" href="#range-request-optimized-font" id="ref-for-range-request-optimized-font①⓪">range-request optimized font</a> should be sorted in the file to keep glyphs often used in the same documents close together in the file.</p>
   <p class="note" role="note"><span>Note:</span> Putting the most frequently used glyphs together in the font increases the likelihood that the browser can download a contiguous sequence of necessary glyphs in a single range-request, thereby minimizing overhead.</p>
   <p class="note" role="note"><span>Note:</span> Reordering glyphs in a font is the same conceptual operation as renaming glyphs to have different glyph IDs. Therefore, this operation cannot be completed if glyph IDs must be preserved. Because glyph IDs are internal to text processing procedures and are not persisted, this requirement is not expected to be particularly burdensome.</p>
   <p>One suggested method of sorting the glyphs in the file is by <a data-link-type="dfn" href="#usage-document-frequency" id="ref-for-usage-document-frequency">usage document frequency</a> inside a relevant <a data-link-type="dfn" href="#corpus" id="ref-for-corpus">corpus</a>.</p>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="corpus">corpus</dfn> is defined to be a collection of documents, where a documents includes a collection of glyphs necessary to render some textual content.</p>
   <p class="note" role="note"><span>Note:</span> For a particular website, a corpus might be defined to be individual page loads of pages on that website.</p>
   <p>The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="usage-document-frequency">usage document frequency</dfn> of a particular glyph inside a <a data-link-type="dfn" href="#corpus" id="ref-for-corpus①">corpus</a> is defined by the number of documents in the <a data-link-type="dfn" href="#corpus" id="ref-for-corpus②">corpus</a> which use that glyph, divided by the number of documents in the <a data-link-type="dfn" href="#corpus" id="ref-for-corpus③">corpus</a>.</p>
   <p class="note" role="note"><span>Note:</span> This is distinct, but similar, to the number of times the glyph is used throughout the entire corpus.</p>
   <p>The <a data-link-type="dfn" href="#usage-document-frequency" id="ref-for-usage-document-frequency①">usage document frequency</a> of the glyphs in a <a data-link-type="dfn" href="#range-request-optimized-font" id="ref-for-range-request-optimized-font①①">range-request optimized font</a> should be decreasing throughout the font; that is, the most frequently used glyphs should have the lowest glyph IDs.</p>
   <p class="note" role="note"><span>Note:</span> Glyph ID 0 cannot be renamed in OpenType, TrueType, WOFF, and WOFF 2 fonts. All other glyphs can be renamed.</p>
   <p class="note" role="note"><span>Note:</span> Because the goal is simply to minimize overhead by placing similarly-used glyphs together, it may actually be possible to do better than ordering by simple frequency for a particular corpus. For example, some corpuses may have cliques of glyphs which have different frequencies but which nevertheless always seem to be used together.</p>
   <p>A suggested ordering is included in <a href="#suggested-glyph-character-ordering">Appendix A</a> below.</p>
   <h3 class="heading settled" data-level="5.3" id="browser-behaviors"><span class="secno">5.3. </span><span class="content">Browser Behaviors</span><a class="self-link" href="#browser-behaviors"></a></h3>
   <h4 class="heading settled" data-level="5.3.1" id="browser-behaviors-first-request"><span class="secno">5.3.1. </span><span class="content">First Request</span><a class="self-link" href="#browser-behaviors-first-request"></a></h4>
   <p>When a browser encounters the CSS opt-in mechanism, it is instructed to use IFT to load the fonts. First, it follows the steps in the <a href="#method-selection">IFT method selection</a> section above. If those steps result in using the range-request method, the rest of this section applies.</p>
   <p>The IFT method selection involves a single round-trip to the server, and if the range-request method is being used, the server’s response starts sending the font file to the browser. The browser should start parsing the partial font data as it is being loaded from the server. The browser should not wait until the entire file has been received before parsing its contents.</p>
   <p>There is a certain amount of data from the beginning of the font file which the browser should unconditionally download. The boundary at the end of this data is called the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="range-request-threshold">range-request threshold</dfn>.</p>
   <p class="note" role="note"><span>Note:</span> The first request does not have to be a range request. If the browser expects the <a data-link-type="dfn" href="#range-request-threshold" id="ref-for-range-request-threshold">range-request threshold</a> to lie within the first <code>n</code> bytes of the font, the first request may be a range request for the first <code>n</code> bytes of the font. However, a browser may instead make a non-range request, parse the data as it is being streamed from the server, and discover that it has reached the <a data-link-type="dfn" href="#range-request-threshold" id="ref-for-range-request-threshold①">range-request threshold</a> while data is still being streamed.</p>
   <p>Once all the data before the <a data-link-type="dfn" href="#range-request-threshold" id="ref-for-range-request-threshold②">range-request threshold</a> has been loaded by the browser, the browser may either close this connection to the server, or it may choose to leave the connection open and let the font data continue loading in the background.</p>
   <p>A browser may choose to add a <code>Range</code> header (<a href="https://www.rfc-editor.org/rfc/rfc9110#name-range">HTTP Semantics § name-range</a>) to the initial request during the IFT method selection if it has reason to believe the range it requests will be large enough and it prefers to not close this connection to the server.</p>
   <p class="note" role="note"><span>Note:</span> Different browsers may choose different <a data-link-type="dfn" href="#range-request-threshold" id="ref-for-range-request-threshold③">range-request thresholds</a>. Some browsers may treat this threshold as occuring at the end of the <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">sfnt tableDirectory</a>. Other browsers may treat this threshold as occurring just before any outline data, provided the outline data appears at the end of the font. Other browsers may place this threshold at the very beginning of the file, thereby treating the whole file as able to be downloaded with range-requests.</p>
   <h4 class="heading settled" data-level="5.3.2" id="browser-behaviors-subsequent-requests"><span class="secno">5.3.2. </span><span class="content">Subsequent Requests</span><a class="self-link" href="#browser-behaviors-subsequent-requests"></a></h4>
   <p>After all the data before the <a data-link-type="dfn" href="#range-request-threshold" id="ref-for-range-request-threshold④">range-request threshold</a> has been loaded by the browser, the browser will determine which additional byte ranges in the file are necessary to load. It will then issue HTTP Range Requests (<a href="https://www.rfc-editor.org/rfc/rfc9110#range.requests">HTTP Semantics § range.requests</a>) for at least those ranges.</p>
   <p class="note" role="note"><span>Note:</span> Browsers are encouraged to coalesce range requests for nearby areas of the file, to minimize the amount of range-request overhead required. Browsers are encouraged to inform these coalescing decisions from network configuration parameters and bandwidth / latency observations.</p>
   <p class="note" role="note"><span>Note:</span> If the font file has followed all of the organization guidelines above, all information required for laying out content and performing shaping will lie before any of the outline data in the file, and every glyph’s outline will be independent from every other glyph. Therefore, the browser can treat the <a data-link-type="dfn" href="#range-request-threshold" id="ref-for-range-request-threshold⑤">range-request threshold</a> as being just before outline data begins, and once it has loaded up to that threshold, it can lay out page content. After laying out the page, downloading all the necessary outlines can be done with a collection of independent and parallel range requests. This works particularly well for Chinese, Japanese, and Korean fonts, where 90% or more of the font data is outline data.</p>
   <p class="note" role="note"><span>Note:</span> Another valid alternative is to treat the entire font as residing on an asynchronous virtual filesystem, and have the browser track which ranges of the font it ended up reading during its normal operation. The browser could then request those regions in range requests.</p>
   <h3 class="heading settled" data-level="5.4" id="server-behaviors"><span class="secno">5.4. </span><span class="content">Server Behaviors</span><a class="self-link" href="#server-behaviors"></a></h3>
   <p>Servers supporting the range-request IFT method must support range requests (<a href="https://www.rfc-editor.org/rfc/rfc9110#range.requests">HTTP Semantics § range.requests</a>).</p>
   <p>Servers supporting the range-request IFT method should support compression via the <code>Content-Encoding</code> (<a href="https://www.rfc-editor.org/rfc/rfc9110#name-content-encoding">HTTP Semantics § name-content-encoding</a>) header or the <code>Transfer-Encoding</code> header (<a href="https://www.rfc-editor.org/rfc/rfc9112#section-6.1">HTTP/1.1 § section-6.1</a>), rather than having the font file
itself be statically compressed.</p>
   <h2 class="no-num heading settled" id="priv"><span class="content">Privacy Considerations</span><a class="self-link" href="#priv"></a></h2>
   <h3 class="heading settled" id="content-inference-from-character-set"><span class="content">Content inference from character set</span><a class="self-link" href="#content-inference-from-character-set"></a></h3>
   <p>IFT exposes, to the server hosting a Web font, the set of characters that the browser can already render in a given Web font, and also the set of characters that it cannot render, but wants to (for example, to render a new Web page). For details, see <a href="#extend-subset">§ 4.4.1 Extending the Font Subset</a>.</p>
   <p>The purpose of doing so is to allow the server to compute a binary patch to the existing font, adding more characters. Thus, fonts are transferred incrementally, as needed, which <a href="https://www.w3.org/TR/PFE-evaluation/#analysis-cjk">greatly reduces</a>> the bytes transferred and the overall network cost..</p>
   <p>For some languages, which use a very large character set (Chinese and Japanese are examples) the vast reduction in total bytes transferred means that Web fonts become usable, including on mobile networks, for the first time.</p>
   <p>However, for those languages, it is <em>possible</em> that individual requests might be analyzed by a rogue font server to obtain intelligence about the type of content which is being read. It is unclear how feasible this attack is, or the computational complexity required to exploit it, unless the characters being requested are very unusual.</p>
   <p>One mitigation, which was originally introduced for reasons of networking efficiency so is likely to be implemented in practice, is to request additional, un-needed characters to dilute the ability to infer what content the user is viewing. Requesting characters which are <a href="https://www.w3.org/TR/PFE-evaluation/#codepredict">statistically likely to occur</a> may <a href="https://docs.google.com/document/d/1u-05ztF9MqftHbMKB_KiqeUhZKiXNFE4TRSUWFAPXsk/edit">avoid a subsequent request</a>.</p>
   <p>(IFT mandates HTTPS, so no in-the-middle attack is possible; the trust is between the client, and the server hosting the fonts).</p>
   <h3 class="heading settled" id="checksum-and-possible-fingerprinting"><span class="content">Checksums and possible fingerprinting</span><a class="self-link" href="#checksum-and-possible-fingerprinting"></a></h3>
   <p>In the patch subset method 64 bit checksums are generated and transferred between client and server. These are used for error detection, are not persistent across browsing sessions, change frequently in the course of a single browsing session, and thus should not pose a tracking risk.</p>
   <p>Also, browsers typically cache resources keyed by the origin domain; thus the checksums and the set of characters the client requires would only be available to that domain and the patch subset server.</p>
   <h3 class="heading settled" id="per-origin"><span class="content">Per-origin restriction avoids fingerprinting</span><a class="self-link" href="#per-origin"></a></h3>
   <p>As required by <a data-link-type="biblio" href="#biblio-css-fonts-4">[css-fonts-4]</a>,
  Web Fonts <a href="https://drafts.csswg.org/css-fonts-4/#web-fonts">must not be accessible
  in any other Document from the one which either is associated with the @font-face rule
  or owns the FontFaceSet.
  Other applications on the device must not be able to access Web Fonts.</a> This avoids information leaking across origins.</p>
   <p>Similarly, font palette values <a href="https://drafts.csswg.org/css-fonts-4/#font-palette-values">must only be available to the documents that reference it</a>.
  Using an author-defined color palette outside of the documents that reference it
  would constitute a security leak since the contents of one page
  would be able to affect other pages,
  something an attacker could use as an attack vector.</p>
   <h2 class="no-num heading settled" id="sec"><span class="content">Security Considerations</span><a class="self-link" href="#sec"></a></h2>
   <p>No Security issues have been raised against this document</p>
   <h2 class="heading settled" id="suggested-glyph-character-ordering"><span class="content"> Appendix A: Suggested glyph/character ordering</span><a class="self-link" href="#suggested-glyph-character-ordering"></a></h2>
   <p class="note" role="note"><span>Note:</span> This section describes ordering of characters, not glyph IDs, because the meaning of glyph IDs are not consistent across different fonts. To optimize a particular font according to the ordering listed here, the characters will have to be mapped to glyph IDs inside the font. This approach of mapping characters to glyphs for ordering purposes works particularly well for ideographic languages with large character sets.</p>
   <p class="issue" id="issue-763d5c98"><a class="self-link" href="#issue-763d5c98"></a> <a href="https://github.com/w3c/IFT/issues/61">Populate suggested character ordering for range-request method</a></p>
   <h2 class="heading settled" id="feature-tag-list"><span class="content"> Appendix B: Default Feature Tags and Encoding IDs</span><a class="self-link" href="#feature-tag-list"></a></h2>
   <table>
    <tbody>
     <tr>
      <th>Tag
      <th>Encoded As
     <tr>
      <td>aalt
      <td>1
     <tr>
      <td>abvf
      <td>default
     <tr>
      <td>abvm
      <td>default
     <tr>
      <td>abvs
      <td>default
     <tr>
      <td>afrc
      <td>2
     <tr>
      <td>akhn
      <td>default
     <tr>
      <td>blwf
      <td>default
     <tr>
      <td>blwm
      <td>default
     <tr>
      <td>blws
      <td>default
     <tr>
      <td>calt
      <td>default
     <tr>
      <td>case
      <td>3
     <tr>
      <td>ccmp
      <td>default
     <tr>
      <td>cfar
      <td>default
     <tr>
      <td>chws
      <td>default
     <tr>
      <td>cjct
      <td>default
     <tr>
      <td>clig
      <td>default
     <tr>
      <td>cpct
      <td>4
     <tr>
      <td>cpsp
      <td>5
     <tr>
      <td>cswh
      <td>default
     <tr>
      <td>curs
      <td>default
     <tr>
      <td>cv01-cv99
      <td>6-104
     <tr>
      <td>c2pc
      <td>105
     <tr>
      <td>c2sc
      <td>106
     <tr>
      <td>dist
      <td>default
     <tr>
      <td>dlig
      <td>107
     <tr>
      <td>dnom
      <td>default
     <tr>
      <td>dtls
      <td>default
     <tr>
      <td>expt
      <td>108
     <tr>
      <td>falt
      <td>109
     <tr>
      <td>fin2
      <td>default
     <tr>
      <td>fin3
      <td>default
     <tr>
      <td>fina
      <td>default
     <tr>
      <td>flac
      <td>default
     <tr>
      <td>frac
      <td>default
     <tr>
      <td>fwid
      <td>110
     <tr>
      <td>half
      <td>default
     <tr>
      <td>haln
      <td>default
     <tr>
      <td>halt
      <td>111
     <tr>
      <td>hist
      <td>112
     <tr>
      <td>hkna
      <td>113
     <tr>
      <td>hlig
      <td>114
     <tr>
      <td>hngl
      <td>115
     <tr>
      <td>hojo
      <td>116
     <tr>
      <td>hwid
      <td>117
     <tr>
      <td>init
      <td>default
     <tr>
      <td>isol
      <td>default
     <tr>
      <td>ital
      <td>118
     <tr>
      <td>jalt
      <td>default
     <tr>
      <td>jp78
      <td>119
     <tr>
      <td>jp83
      <td>120
     <tr>
      <td>jp90
      <td>121
     <tr>
      <td>jp04
      <td>122
     <tr>
      <td>kern
      <td>default
     <tr>
      <td>lfbd
      <td>123
     <tr>
      <td>liga
      <td>default
     <tr>
      <td>ljmo
      <td>default
     <tr>
      <td>lnum
      <td>124
     <tr>
      <td>locl
      <td>default
     <tr>
      <td>ltra
      <td>default
     <tr>
      <td>ltrm
      <td>default
     <tr>
      <td>mark
      <td>default
     <tr>
      <td>med2
      <td>default
     <tr>
      <td>medi
      <td>default
     <tr>
      <td>mgrk
      <td>125
     <tr>
      <td>mkmk
      <td>default
     <tr>
      <td>mset
      <td>default
     <tr>
      <td>nalt
      <td>126
     <tr>
      <td>nlck
      <td>127
     <tr>
      <td>nukt
      <td>default
     <tr>
      <td>numr
      <td>default
     <tr>
      <td>onum
      <td>128
     <tr>
      <td>opbd
      <td>129
     <tr>
      <td>ordn
      <td>130
     <tr>
      <td>ornm
      <td>131
     <tr>
      <td>palt
      <td>132
     <tr>
      <td>pcap
      <td>133
     <tr>
      <td>pkna
      <td>134
     <tr>
      <td>pnum
      <td>135
     <tr>
      <td>pref
      <td>default
     <tr>
      <td>pres
      <td>default
     <tr>
      <td>pstf
      <td>default
     <tr>
      <td>psts
      <td>default
     <tr>
      <td>pwid
      <td>136
     <tr>
      <td>qwid
      <td>137
     <tr>
      <td>rand
      <td>default
     <tr>
      <td>rclt
      <td>default
     <tr>
      <td>rkrf
      <td>default
     <tr>
      <td>rlig
      <td>default
     <tr>
      <td>rphf
      <td>default
     <tr>
      <td>rtbd
      <td>138
     <tr>
      <td>rtla
      <td>default
     <tr>
      <td>rtlm
      <td>default
     <tr>
      <td>ruby
      <td>139
     <tr>
      <td>rvrn
      <td>default
     <tr>
      <td>salt
      <td>140
     <tr>
      <td>sinf
      <td>141
     <tr>
      <td>size
      <td>142
     <tr>
      <td>smcp
      <td>143
     <tr>
      <td>smpl
      <td>144
     <tr>
      <td>ss01-ss20
      <td>145-164
     <tr>
      <td>ssty
      <td>default
     <tr>
      <td>stch
      <td>default
     <tr>
      <td>subs
      <td>165
     <tr>
      <td>sups
      <td>166
     <tr>
      <td>swsh
      <td>167
     <tr>
      <td>titl
      <td>168
     <tr>
      <td>tjmo
      <td>default
     <tr>
      <td>tnam
      <td>169
     <tr>
      <td>tnum
      <td>170
     <tr>
      <td>trad
      <td>171
     <tr>
      <td>twid
      <td>172
     <tr>
      <td>unic
      <td>173
     <tr>
      <td>valt
      <td>default
     <tr>
      <td>vatu
      <td>default
     <tr>
      <td>vchw
      <td>default
     <tr>
      <td>vert
      <td>default
     <tr>
      <td>vhal
      <td>174
     <tr>
      <td>vjmo
      <td>default
     <tr>
      <td>vkna
      <td>175
     <tr>
      <td>vkrn
      <td>default
     <tr>
      <td>vpal
      <td>default
     <tr>
      <td>vrt2
      <td>default
     <tr>
      <td>vrtr
      <td>default
     <tr>
      <td>zero
      <td>176
   </table>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
   <h3 class="no-ref no-num heading settled" id="w3c-conformant-algorithms"><span class="content">Conformant Algorithms</span><a class="self-link" href="#w3c-conformant-algorithms"></a></h3>
   <p>Requirements phrased in the imperative as part of algorithms
    (such as "strip any leading space characters"
    or "return false and abort these steps")
    are to be interpreted with the meaning of the key word
    ("must", "should", "may", etc)
    used in introducing the algorithm. </p>
   <p>Conformance requirements phrased as algorithms or specific steps
    can be implemented in any manner,
    so long as the end result is equivalent.
    In particular, the algorithms defined in this specification
    are intended to be easy to understand
    and are not intended to be performant.
    Implementers are encouraged to optimize. </p>
  </div>
<script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#patchrequest-accept_patch_format">accept_patch_format</a><span>, in § 4.3.3</span>
   <li><a href="#arrayof">ArrayOf</a><span>, in § 4.2.2</span>
   <li><a href="#axisinterval">AxisInterval</a><span>, in § 4.3.2</span>
   <li><a href="#axisspace">AxisSpace</a><span>, in § 4.2.9</span>
   <li><a href="#patchrequest-axis_space_have">axis_space_have</a><span>, in § 4.3.3</span>
   <li><a href="#patchrequest-axis_space_needed">axis_space_needed</a><span>, in § 4.3.3</span>
   <li><a href="#patchrequest-base_checksum">base_checksum</a><span>, in § 4.3.3</span>
   <li><a href="#bytestring">ByteString</a><span>, in § 4.2.2</span>
   <li><a href="#clientstate">ClientState</a><span>, in § 4.3.5</span>
   <li>
    codepoint_ordering
    <ul>
     <li><a href="#clientstate-codepoint_ordering">dfn for ClientState</a><span>, in § 4.3.5</span>
     <li><a href="#patchrequest-codepoint_ordering">dfn for PatchRequest</a><span>, in § 4.3.3</span>
    </ul>
   <li><a href="#patchrequest-codepoints_have">codepoints_have</a><span>, in § 4.3.3</span>
   <li><a href="#patchrequest-codepoints_needed">codepoints_needed</a><span>, in § 4.3.3</span>
   <li><a href="#compressedset">CompressedSet</a><span>, in § 4.3.1</span>
   <li><a href="#corpus">corpus</a><span>, in § 5.2.6</span>
   <li><a href="#axisinterval-end">end</a><span>, in § 4.3.2</span>
   <li><a href="#abstract-opdef-extend-the-font-subset">Extend the font subset</a><span>, in § 4.4.1</span>
   <li><a href="#patchrequest-features_have">features_have</a><span>, in § 4.3.3</span>
   <li><a href="#patchrequest-features_needed">features_needed</a><span>, in § 4.3.3</span>
   <li><a href="#featuretagset">FeatureTagSet</a><span>, in § 4.2.8</span>
   <li><a href="#float">Float</a><span>, in § 4.2.2</span>
   <li><a href="#font-subset">font subset</a><span>, in § 4.1</span>
   <li><a href="#font-subset-definition">font subset definition</a><span>, in § 4.1</span>
   <li><a href="#patchrequest-fragment_id">fragment_id</a><span>, in § 4.3.3</span>
   <li><a href="#abstract-opdef-handle-failed-font-load">Handle failed font load</a><span>, in § 4.4.2</span>
   <li><a href="#abstract-opdef-handle-server-response">Handle server response</a><span>, in § 4.4.2</span>
   <li><a href="#patchrequest-indices_have">indices_have</a><span>, in § 4.3.3</span>
   <li><a href="#patchrequest-indices_needed">indices_needed</a><span>, in § 4.3.3</span>
   <li><a href="#integer">Integer</a><span>, in § 4.2.2</span>
   <li><a href="#integerlist">IntegerList</a><span>, in § 4.2.5</span>
   <li><a href="#abstract-opdef-load-a-font-with-a-http-cache">Load a font with a HTTP Cache</a><span>, in § 4.4.3</span>
   <li><a href="#patchrequest-ordering_checksum">ordering_checksum</a><span>, in § 4.3.3</span>
   <li><a href="#clientstate-original_axis_space">original_axis_space</a><span>, in § 4.3.5</span>
   <li><a href="#clientstate-original_features">original_features</a><span>, in § 4.3.5</span>
   <li><a href="#original-font">original font</a><span>, in § 4.5</span>
   <li>
    original_font_checksum
    <ul>
     <li><a href="#clientstate-original_font_checksum">dfn for ClientState</a><span>, in § 4.3.5</span>
     <li><a href="#patchrequest-original_font_checksum">dfn for PatchRequest</a><span>, in § 4.3.3</span>
    </ul>
   <li><a href="#outline-table">outline table</a><span>, in § 5.2.4</span>
   <li><a href="#patchresponse-patch">patch</a><span>, in § 4.3.4</span>
   <li><a href="#patchresponse-patch_format">patch_format</a><span>, in § 4.3.4</span>
   <li><a href="#patchrequest">PatchRequest</a><span>, in § 4.3.3</span>
   <li><a href="#patch-request-header">patch request header</a><span>, in § 4.4.1</span>
   <li><a href="#patchresponse">PatchResponse</a><span>, in § 4.3.4</span>
   <li>
    protocol_version
    <ul>
     <li><a href="#patchrequest-protocol_version">dfn for PatchRequest</a><span>, in § 4.3.3</span>
     <li><a href="#patchresponse-protocol_version">dfn for PatchResponse</a><span>, in § 4.3.4</span>
    </ul>
   <li><a href="#protocolversion">ProtocolVersion</a><span>, in § 4.2.3</span>
   <li><a href="#compressedset-range_deltas">range_deltas</a><span>, in § 4.3.1</span>
   <li><a href="#rangelist">RangeList</a><span>, in § 4.2.7</span>
   <li><a href="#range-request-optimized-font">range-request optimized font</a><span>, in § 5.2.2</span>
   <li><a href="#range-request-threshold">range-request threshold</a><span>, in § 5.3.1</span>
   <li><a href="#patchresponse-replacement">replacement</a><span>, in § 4.3.4</span>
   <li><a href="#sortedintegerlist">SortedIntegerList</a><span>, in § 4.2.6</span>
   <li><a href="#compressedset-sparse_bit_set">sparse_bit_set</a><span>, in § 4.3.1</span>
   <li><a href="#sparsebitset">SparseBitSet</a><span>, in § 4.2.4</span>
   <li><a href="#axisinterval-start">start</a><span>, in § 4.3.2</span>
   <li><a href="#string">String</a><span>, in § 4.2.2</span>
   <li><a href="#clientstate-subset_axis_space">subset_axis_space</a><span>, in § 4.3.5</span>
   <li><a href="#patchresponse-unrecognized_ordering">unrecognized_ordering</a><span>, in § 4.3.4</span>
   <li><a href="#usage-document-frequency">usage document frequency</a><span>, in § 5.2.6</span>
  </ul>
  <aside class="dfn-panel" data-for="term-for-at-font-face-rule">
   <a href="https://www.w3.org/TR/css-fonts-5/#at-font-face-rule">https://www.w3.org/TR/css-fonts-5/#at-font-face-rule</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-at-font-face-rule">2. Opt-In Mechanism</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-request-body">
   <a href="https://fetch.spec.whatwg.org/#concept-request-body">https://fetch.spec.whatwg.org/#concept-request-body</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-request-body">4.4.1. Extending the Font Subset</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-response-body">
   <a href="https://fetch.spec.whatwg.org/#concept-response-body">https://fetch.spec.whatwg.org/#concept-response-body</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-response-body">4.4.2. Handling Server Response</a> <a href="#ref-for-concept-response-body①">(2)</a> <a href="#ref-for-concept-response-body②">(3)</a>
    <li><a href="#ref-for-concept-response-body③">4.5. Server: Responding to a PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-request-cache-mode">
   <a href="https://fetch.spec.whatwg.org/#concept-request-cache-mode">https://fetch.spec.whatwg.org/#concept-request-cache-mode</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-request-cache-mode">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-concept-request-cache-mode①">4.4.3. Load a Font in a User Agent with a HTTP Cache</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-request-destination">
   <a href="https://fetch.spec.whatwg.org/#concept-request-destination">https://fetch.spec.whatwg.org/#concept-request-destination</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-request-destination">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-concept-request-destination①">4.4.3. Load a Font in a User Agent with a HTTP Cache</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-header">
   <a href="https://fetch.spec.whatwg.org/#concept-header">https://fetch.spec.whatwg.org/#concept-header</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-header">4.4.1. Extending the Font Subset</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-request-method">
   <a href="https://fetch.spec.whatwg.org/#concept-request-method">https://fetch.spec.whatwg.org/#concept-request-method</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-request-method">4.4.1. Extending the Font Subset</a> <a href="#ref-for-concept-request-method①">(2)</a> <a href="#ref-for-concept-request-method②">(3)</a>
    <li><a href="#ref-for-concept-request-method③">4.4.3. Load a Font in a User Agent with a HTTP Cache</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-request-mode">
   <a href="https://fetch.spec.whatwg.org/#concept-request-mode">https://fetch.spec.whatwg.org/#concept-request-mode</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-request-mode">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-concept-request-mode①">4.4.3. Load a Font in a User Agent with a HTTP Cache</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-response">
   <a href="https://fetch.spec.whatwg.org/#concept-response">https://fetch.spec.whatwg.org/#concept-response</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-response">4.4.2. Handling Server Response</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-status">
   <a href="https://fetch.spec.whatwg.org/#concept-status">https://fetch.spec.whatwg.org/#concept-status</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-status">4.4.2. Handling Server Response</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-response-status">
   <a href="https://fetch.spec.whatwg.org/#concept-response-status">https://fetch.spec.whatwg.org/#concept-response-status</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-response-status">4.4.2. Handling Server Response</a> <a href="#ref-for-concept-response-status①">(2)</a>
    <li><a href="#ref-for-concept-response-status②">4.5. Server: Responding to a PatchRequest</a> <a href="#ref-for-concept-response-status③">(2)</a> <a href="#ref-for-concept-response-status④">(3)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-request-url">
   <a href="https://fetch.spec.whatwg.org/#concept-request-url">https://fetch.spec.whatwg.org/#concept-request-url</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-request-url">4.5. Server: Responding to a PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-url-path">
   <a href="https://url.spec.whatwg.org/#concept-url-path">https://url.spec.whatwg.org/#concept-url-path</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-url-path">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-concept-url-path①">4.4.2. Handling Server Response</a>
    <li><a href="#ref-for-concept-url-path②">4.4.3. Load a Font in a User Agent with a HTTP Cache</a>
    <li><a href="#ref-for-concept-url-path③">4.5. Server: Responding to a PatchRequest</a> <a href="#ref-for-concept-url-path④">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-url-scheme">
   <a href="https://url.spec.whatwg.org/#concept-url-scheme">https://url.spec.whatwg.org/#concept-url-scheme</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-url-scheme">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-concept-url-scheme①">4.4.3. Load a Font in a User Agent with a HTTP Cache</a>
   </ul>
  </aside>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[CSS-FONTS-5]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-at-font-face-rule">@font-face</span>
    </ul>
   <li>
    <a data-link-type="biblio">[FETCH]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-concept-request-body">body <small>(for request)</small></span>
     <li><span class="dfn-paneled" id="term-for-concept-response-body">body <small>(for response)</small></span>
     <li><span class="dfn-paneled" id="term-for-concept-request-cache-mode">cache mode</span>
     <li><span class="dfn-paneled" id="term-for-concept-request-destination">destination</span>
     <li><span class="dfn-paneled" id="term-for-concept-header">header</span>
     <li><span class="dfn-paneled" id="term-for-concept-request-method">method</span>
     <li><span class="dfn-paneled" id="term-for-concept-request-mode">mode</span>
     <li><span class="dfn-paneled" id="term-for-concept-response">response</span>
     <li><span class="dfn-paneled" id="term-for-concept-status">status</span>
     <li><span class="dfn-paneled" id="term-for-concept-response-status">status <small>(for response)</small></span>
     <li><span class="dfn-paneled" id="term-for-concept-request-url">url</span>
    </ul>
   <li>
    <a data-link-type="biblio">[URL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-concept-url-path">path</span>
     <li><span class="dfn-paneled" id="term-for-concept-url-scheme">scheme</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-css-fonts-4">[CSS-FONTS-4]
   <dd>John Daggett; Myles Maxfield; Chris Lilley. <a href="https://www.w3.org/TR/css-fonts-4/"><cite>CSS Fonts Module Level 4</cite></a>. 21 December 2021. WD. URL: <a href="https://www.w3.org/TR/css-fonts-4/">https://www.w3.org/TR/css-fonts-4/</a>
   <dt id="biblio-css-fonts-5">[CSS-FONTS-5]
   <dd>Myles Maxfield; Chris Lilley. <a href="https://www.w3.org/TR/css-fonts-5/"><cite>CSS Fonts Module Level 5</cite></a>. 21 December 2021. WD. URL: <a href="https://www.w3.org/TR/css-fonts-5/">https://www.w3.org/TR/css-fonts-5/</a>
   <dt id="biblio-fast-hash">[FAST-HASH]
   <dd>ztanml. <a href="https://github.com/ztanml/fast-hash"><cite>fast-hash</cite></a>. 22 October 2018. Note. URL: <a href="https://github.com/ztanml/fast-hash">https://github.com/ztanml/fast-hash</a>
   <dt id="biblio-fetch">[FETCH]
   <dd><a href="https://fetch.spec.whatwg.org/"><cite>Fetch Standard</cite></a>. 13 December 2021. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-opentype">[OPENTYPE]
   <dd><a href="http://www.microsoft.com/typography/otspec/default.htm"><cite>OpenType specification</cite></a>. URL: <a href="http://www.microsoft.com/typography/otspec/default.htm">http://www.microsoft.com/typography/otspec/default.htm</a>
   <dt id="biblio-pfe-report">[PFE-report]
   <dd>Chris Lilley. <a href="https://www.w3.org/TR/PFE-evaluation/"><cite>Progressive Font Enrichment: Evaluation Report</cite></a>. 15 October 2020. Note. URL: <a href="https://www.w3.org/TR/PFE-evaluation/">https://www.w3.org/TR/PFE-evaluation/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-rfc3284">[RFC3284]
   <dd>D. Korn; et al. <a href="https://www.rfc-editor.org/rfc/rfc3284"><cite>The VCDIFF Generic Differencing and Compression Data Format</cite></a>. June 2002. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc3284">https://www.rfc-editor.org/rfc/rfc3284</a>
   <dt id="biblio-rfc7932">[RFC7932]
   <dd>J. Alakuijala; Z. Szabadka. <a href="https://www.rfc-editor.org/rfc/rfc7932"><cite>Brotli Compressed Data Format</cite></a>. July 2016. Informational. URL: <a href="https://www.rfc-editor.org/rfc/rfc7932">https://www.rfc-editor.org/rfc/rfc7932</a>
   <dt id="biblio-rfc8081">[RFC8081]
   <dd>C. Lilley. <a href="https://www.rfc-editor.org/rfc/rfc8081"><cite>The "font" Top-Level Media Type</cite></a>. February 2017. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc8081">https://www.rfc-editor.org/rfc/rfc8081</a>
   <dt id="biblio-rfc8949">[RFC8949]
   <dd>C. Bormann; P. Hoffman. <a href="https://www.rfc-editor.org/rfc/rfc8949"><cite>Concise Binary Object Representation (CBOR)</cite></a>. December 2020. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc8949">https://www.rfc-editor.org/rfc/rfc8949</a>
   <dt id="biblio-rfc9110">[RFC9110]
   <dd>R. Fielding, Ed.; M. Nottingham, Ed.; J. Reschke, Ed.. <a href="https://www.rfc-editor.org/rfc/rfc9110"><cite>HTTP Semantics</cite></a>. June 2022. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc9110">https://www.rfc-editor.org/rfc/rfc9110</a>
   <dt id="biblio-rfc9111">[RFC9111]
   <dd>R. Fielding, Ed.; M. Nottingham, Ed.; J. Reschke, Ed.. <a href="https://www.rfc-editor.org/rfc/rfc9111"><cite>HTTP Caching</cite></a>. June 2022. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc9111">https://www.rfc-editor.org/rfc/rfc9111</a>
   <dt id="biblio-rfc9112">[RFC9112]
   <dd>R. Fielding, Ed.; M. Nottingham, Ed.; J. Reschke, Ed.. <a href="https://www.rfc-editor.org/rfc/rfc9112"><cite>HTTP/1.1</cite></a>. June 2022. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc9112">https://www.rfc-editor.org/rfc/rfc9112</a>
   <dt id="biblio-shared-brotli">[Shared-Brotli]
   <dd>J. Alakuijala; et al. <a href="https://datatracker.ietf.org/doc/html/draft-vandevenne-shared-brotli-format-09#section-3.2"><cite>Shared Brotli Compressed Data Format</cite></a>. 27 Jul 2021. Internet Draft. URL: <a href="https://datatracker.ietf.org/doc/html/draft-vandevenne-shared-brotli-format-09#section-3.2">https://datatracker.ietf.org/doc/html/draft-vandevenne-shared-brotli-format-09#section-3.2</a>
   <dt id="biblio-truetype">[TRUETYPE]
   <dd><a href="https://developer.apple.com/fonts/TrueType-Reference-Manual/"><cite>TrueType™ Reference Manual</cite></a>. URL: <a href="https://developer.apple.com/fonts/TrueType-Reference-Manual/">https://developer.apple.com/fonts/TrueType-Reference-Manual/</a>
   <dt id="biblio-url">[URL]
   <dd>Anne van Kesteren. <a href="https://url.spec.whatwg.org/"><cite>URL Standard</cite></a>. Living Standard. URL: <a href="https://url.spec.whatwg.org/">https://url.spec.whatwg.org/</a>
   <dt id="biblio-woff">[WOFF]
   <dd>Jonathan Kew; Tal Leming; Erik van Blokland. <a href="https://www.w3.org/TR/WOFF/"><cite>WOFF File Format 1.0</cite></a>. 13 December 2012. REC. URL: <a href="https://www.w3.org/TR/WOFF/">https://www.w3.org/TR/WOFF/</a>
   <dt id="biblio-woff2">[WOFF2]
   <dd>Vladimir Levantovsky; Raph Levien. <a href="https://www.w3.org/TR/WOFF2/"><cite>WOFF File Format 2.0</cite></a>. 10 March 2022. REC. URL: <a href="https://www.w3.org/TR/WOFF2/">https://www.w3.org/TR/WOFF2/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-opentype-variations">[OPENTYPE-VARIATIONS]
   <dd><a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otvaroverview"><cite>OpenType Font Variations Overview</cite></a>. 23 October 2020. Note. URL: <a href="https://docs.microsoft.com/en-us/typography/opentype/spec/otvaroverview">https://docs.microsoft.com/en-us/typography/opentype/spec/otvaroverview</a>
   <dt id="biblio-rfc3629">[RFC3629]
   <dd>F. Yergeau. <a href="https://www.rfc-editor.org/rfc/rfc3629"><cite>UTF-8, a transformation format of ISO 10646</cite></a>. November 2003. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc3629">https://www.rfc-editor.org/rfc/rfc3629</a>
   <dt id="biblio-rfc4648">[RFC4648]
   <dd>S. Josefsson. <a href="https://www.rfc-editor.org/rfc/rfc4648"><cite>The Base16, Base32, and Base64 Data Encodings</cite></a>. October 2006. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc4648">https://www.rfc-editor.org/rfc/rfc4648</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> <a href="https://github.com/w3c/IFT/issues/59">Using WOFF2 files with range-request mechanism doesn’t seem to be a viable option</a> <a class="issue-return" href="#issue-73fb8795" title="Jump to section">↵</a></div>
   <div class="issue"> <a href="https://github.com/w3c/IFT/issues/60">Static file compression compatibility with range-request method</a> <a class="issue-return" href="#issue-6786fd81" title="Jump to section">↵</a></div>
   <div class="issue"> <a href="https://github.com/w3c/IFT/issues/28">Font Collections support</a> <a class="issue-return" href="#issue-010f4980" title="Jump to section">↵</a></div>
   <div class="issue"> <a href="https://github.com/w3c/IFT/issues/58">Supporting fonts with composite glyphs via range-request</a> <a class="issue-return" href="#issue-5533a524" title="Jump to section">↵</a></div>
   <div class="issue"> <a href="https://github.com/w3c/IFT/issues/61">Populate suggested character ordering for range-request method</a> <a class="issue-return" href="#issue-763d5c98" title="Jump to section">↵</a></div>
  </div>
  <aside class="dfn-panel" data-for="font-subset">
   <b><a href="#font-subset">#font-subset</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-font-subset">1.1. Patch Subset</a>
    <li><a href="#ref-for-font-subset①">4.1. Font Subset</a>
    <li><a href="#ref-for-font-subset②">4.4.1. Extending the Font Subset</a> <a href="#ref-for-font-subset③">(2)</a> <a href="#ref-for-font-subset④">(3)</a> <a href="#ref-for-font-subset⑤">(4)</a> <a href="#ref-for-font-subset⑥">(5)</a> <a href="#ref-for-font-subset⑦">(6)</a> <a href="#ref-for-font-subset⑧">(7)</a>
    <li><a href="#ref-for-font-subset⑨">4.4.2. Handling Server Response</a> <a href="#ref-for-font-subset①⓪">(2)</a> <a href="#ref-for-font-subset①①">(3)</a> <a href="#ref-for-font-subset①②">(4)</a> <a href="#ref-for-font-subset①③">(5)</a>
    <li><a href="#ref-for-font-subset①④">4.4.3. Load a Font in a User Agent with a HTTP Cache</a> <a href="#ref-for-font-subset①⑤">(2)</a> <a href="#ref-for-font-subset①⑥">(3)</a>
    <li><a href="#ref-for-font-subset①⑦">4.5. Server: Responding to a PatchRequest</a> <a href="#ref-for-font-subset①⑧">(2)</a> <a href="#ref-for-font-subset①⑨">(3)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="font-subset-definition">
   <b><a href="#font-subset-definition">#font-subset-definition</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-font-subset-definition">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-font-subset-definition①">4.4.3. Load a Font in a User Agent with a HTTP Cache</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="integer">
   <b><a href="#integer">#integer</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-integer">4.2.3. ProtocolVersion</a>
    <li><a href="#ref-for-integer①">4.3.3. PatchRequest</a> <a href="#ref-for-integer②">(2)</a> <a href="#ref-for-integer③">(3)</a> <a href="#ref-for-integer④">(4)</a> <a href="#ref-for-integer⑤">(5)</a>
    <li><a href="#ref-for-integer⑥">4.3.4. PatchResponse</a> <a href="#ref-for-integer⑦">(2)</a> <a href="#ref-for-integer⑧">(3)</a>
    <li><a href="#ref-for-integer⑨">4.3.5. ClientState</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="float">
   <b><a href="#float">#float</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-float">4.3.2. AxisInterval</a> <a href="#ref-for-float①">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="bytestring">
   <b><a href="#bytestring">#bytestring</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-bytestring">4.2.4. SparseBitSet</a>
    <li><a href="#ref-for-bytestring①">4.2.5. IntegerList</a> <a href="#ref-for-bytestring②">(2)</a>
    <li><a href="#ref-for-bytestring③">4.2.6. SortedIntegerList</a>
    <li><a href="#ref-for-bytestring④">4.2.7. RangeList</a>
    <li><a href="#ref-for-bytestring⑤">4.2.9. AxisSpace</a>
    <li><a href="#ref-for-bytestring⑥">4.3.1. CompressedSet</a> <a href="#ref-for-bytestring⑦">(2)</a>
    <li><a href="#ref-for-bytestring⑧">4.3.4. PatchResponse</a> <a href="#ref-for-bytestring⑨">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="string">
   <b><a href="#string">#string</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-string">4.3.3. PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="arrayof">
   <b><a href="#arrayof">#arrayof</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-arrayof">4.2.9. AxisSpace</a>
    <li><a href="#ref-for-arrayof①">4.3.3. PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="protocolversion">
   <b><a href="#protocolversion">#protocolversion</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-protocolversion">4.3.3. PatchRequest</a>
    <li><a href="#ref-for-protocolversion①">4.3.4. PatchResponse</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="sparsebitset">
   <b><a href="#sparsebitset">#sparsebitset</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-sparsebitset">4.3.1. CompressedSet</a> <a href="#ref-for-sparsebitset①">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="integerlist">
   <b><a href="#integerlist">#integerlist</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-integerlist">4.2.5. IntegerList</a>
    <li><a href="#ref-for-integerlist①">4.2.6. SortedIntegerList</a> <a href="#ref-for-integerlist②">(2)</a>
    <li><a href="#ref-for-integerlist③">4.3.3. PatchRequest</a>
    <li><a href="#ref-for-integerlist④">4.3.5. ClientState</a>
    <li><a href="#ref-for-integerlist⑤">4.7. Codepoint Reordering</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="sortedintegerlist">
   <b><a href="#sortedintegerlist">#sortedintegerlist</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-sortedintegerlist">4.2.6. SortedIntegerList</a>
    <li><a href="#ref-for-sortedintegerlist①">4.2.7. RangeList</a>
    <li><a href="#ref-for-sortedintegerlist②">4.2.8. FeatureTagSet</a> <a href="#ref-for-sortedintegerlist③">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="rangelist">
   <b><a href="#rangelist">#rangelist</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-rangelist">4.3.1. CompressedSet</a> <a href="#ref-for-rangelist①">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="featuretagset">
   <b><a href="#featuretagset">#featuretagset</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-featuretagset">4.3.3. PatchRequest</a> <a href="#ref-for-featuretagset①">(2)</a>
    <li><a href="#ref-for-featuretagset②">4.3.5. ClientState</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="axisspace">
   <b><a href="#axisspace">#axisspace</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-axisspace">4.3.3. PatchRequest</a> <a href="#ref-for-axisspace①">(2)</a>
    <li><a href="#ref-for-axisspace②">4.3.5. ClientState</a> <a href="#ref-for-axisspace③">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="compressedset">
   <b><a href="#compressedset">#compressedset</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-compressedset">4.3.3. PatchRequest</a> <a href="#ref-for-compressedset①">(2)</a> <a href="#ref-for-compressedset②">(3)</a> <a href="#ref-for-compressedset③">(4)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="compressedset-sparse_bit_set">
   <b><a href="#compressedset-sparse_bit_set">#compressedset-sparse_bit_set</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-compressedset-sparse_bit_set">4.3.1. CompressedSet</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="compressedset-range_deltas">
   <b><a href="#compressedset-range_deltas">#compressedset-range_deltas</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-compressedset-range_deltas">4.3.1. CompressedSet</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="axisinterval">
   <b><a href="#axisinterval">#axisinterval</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-axisinterval">4.2.9. AxisSpace</a>
    <li><a href="#ref-for-axisinterval①">4.3.2. AxisInterval</a> <a href="#ref-for-axisinterval②">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="axisinterval-start">
   <b><a href="#axisinterval-start">#axisinterval-start</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-axisinterval-start">4.3.2. AxisInterval</a> <a href="#ref-for-axisinterval-start①">(2)</a> <a href="#ref-for-axisinterval-start②">(3)</a> <a href="#ref-for-axisinterval-start③">(4)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="axisinterval-end">
   <b><a href="#axisinterval-end">#axisinterval-end</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-axisinterval-end">4.3.2. AxisInterval</a> <a href="#ref-for-axisinterval-end①">(2)</a> <a href="#ref-for-axisinterval-end②">(3)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchrequest">
   <b><a href="#patchrequest">#patchrequest</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchrequest">4.2.3. ProtocolVersion</a>
    <li><a href="#ref-for-patchrequest①">4.3.3. PatchRequest</a>
    <li><a href="#ref-for-patchrequest②">4.4.1. Extending the Font Subset</a> <a href="#ref-for-patchrequest③">(2)</a> <a href="#ref-for-patchrequest④">(3)</a>
    <li><a href="#ref-for-patchrequest⑤">4.4.2. Handling Server Response</a>
    <li><a href="#ref-for-patchrequest⑥">4.5. Server: Responding to a PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchrequest-protocol_version">
   <b><a href="#patchrequest-protocol_version">#patchrequest-protocol_version</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchrequest-protocol_version">4.3.3. PatchRequest</a>
    <li><a href="#ref-for-patchrequest-protocol_version①">4.4.1. Extending the Font Subset</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchrequest-accept_patch_format">
   <b><a href="#patchrequest-accept_patch_format">#patchrequest-accept_patch_format</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchrequest-accept_patch_format">4.3.3. PatchRequest</a>
    <li><a href="#ref-for-patchrequest-accept_patch_format①">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-patchrequest-accept_patch_format②">4.5. Server: Responding to a PatchRequest</a> <a href="#ref-for-patchrequest-accept_patch_format③">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchrequest-codepoints_have">
   <b><a href="#patchrequest-codepoints_have">#patchrequest-codepoints_have</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchrequest-codepoints_have">4.3.3. PatchRequest</a>
    <li><a href="#ref-for-patchrequest-codepoints_have①">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-patchrequest-codepoints_have②">4.5. Server: Responding to a PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchrequest-codepoints_needed">
   <b><a href="#patchrequest-codepoints_needed">#patchrequest-codepoints_needed</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchrequest-codepoints_needed">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-patchrequest-codepoints_needed①">4.5. Server: Responding to a PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchrequest-indices_have">
   <b><a href="#patchrequest-indices_have">#patchrequest-indices_have</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchrequest-indices_have">4.3.3. PatchRequest</a> <a href="#ref-for-patchrequest-indices_have①">(2)</a>
    <li><a href="#ref-for-patchrequest-indices_have②">4.4.1. Extending the Font Subset</a> <a href="#ref-for-patchrequest-indices_have③">(2)</a>
    <li><a href="#ref-for-patchrequest-indices_have④">4.5. Server: Responding to a PatchRequest</a> <a href="#ref-for-patchrequest-indices_have⑤">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchrequest-indices_needed">
   <b><a href="#patchrequest-indices_needed">#patchrequest-indices_needed</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchrequest-indices_needed">4.3.3. PatchRequest</a>
    <li><a href="#ref-for-patchrequest-indices_needed①">4.4.1. Extending the Font Subset</a> <a href="#ref-for-patchrequest-indices_needed②">(2)</a>
    <li><a href="#ref-for-patchrequest-indices_needed③">4.5. Server: Responding to a PatchRequest</a> <a href="#ref-for-patchrequest-indices_needed④">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchrequest-features_have">
   <b><a href="#patchrequest-features_have">#patchrequest-features_have</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchrequest-features_have">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-patchrequest-features_have①">4.5. Server: Responding to a PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchrequest-features_needed">
   <b><a href="#patchrequest-features_needed">#patchrequest-features_needed</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchrequest-features_needed">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-patchrequest-features_needed①">4.5. Server: Responding to a PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchrequest-axis_space_have">
   <b><a href="#patchrequest-axis_space_have">#patchrequest-axis_space_have</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchrequest-axis_space_have">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-patchrequest-axis_space_have①">4.5. Server: Responding to a PatchRequest</a> <a href="#ref-for-patchrequest-axis_space_have②">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchrequest-axis_space_needed">
   <b><a href="#patchrequest-axis_space_needed">#patchrequest-axis_space_needed</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchrequest-axis_space_needed">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-patchrequest-axis_space_needed①">4.5. Server: Responding to a PatchRequest</a> <a href="#ref-for-patchrequest-axis_space_needed②">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchrequest-ordering_checksum">
   <b><a href="#patchrequest-ordering_checksum">#patchrequest-ordering_checksum</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchrequest-ordering_checksum">4.3.3. PatchRequest</a>
    <li><a href="#ref-for-patchrequest-ordering_checksum①">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-patchrequest-ordering_checksum②">4.5. Server: Responding to a PatchRequest</a> <a href="#ref-for-patchrequest-ordering_checksum③">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchrequest-original_font_checksum">
   <b><a href="#patchrequest-original_font_checksum">#patchrequest-original_font_checksum</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchrequest-original_font_checksum">4.3.3. PatchRequest</a>
    <li><a href="#ref-for-patchrequest-original_font_checksum①">4.4.1. Extending the Font Subset</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchrequest-base_checksum">
   <b><a href="#patchrequest-base_checksum">#patchrequest-base_checksum</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchrequest-base_checksum">4.3.3. PatchRequest</a>
    <li><a href="#ref-for-patchrequest-base_checksum①">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-patchrequest-base_checksum②">4.5. Server: Responding to a PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchrequest-fragment_id">
   <b><a href="#patchrequest-fragment_id">#patchrequest-fragment_id</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchrequest-fragment_id">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-patchrequest-fragment_id①">4.5. Server: Responding to a PatchRequest</a> <a href="#ref-for-patchrequest-fragment_id②">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchrequest-codepoint_ordering">
   <b><a href="#patchrequest-codepoint_ordering">#patchrequest-codepoint_ordering</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchrequest-codepoint_ordering">4.4.2. Handling Server Response</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchresponse">
   <b><a href="#patchresponse">#patchresponse</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchresponse">4.2.3. ProtocolVersion</a>
    <li><a href="#ref-for-patchresponse①">4.4.2. Handling Server Response</a> <a href="#ref-for-patchresponse②">(2)</a> <a href="#ref-for-patchresponse③">(3)</a>
    <li><a href="#ref-for-patchresponse④">4.5. Server: Responding to a PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchresponse-protocol_version">
   <b><a href="#patchresponse-protocol_version">#patchresponse-protocol_version</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchresponse-protocol_version">4.3.4. PatchResponse</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchresponse-patch_format">
   <b><a href="#patchresponse-patch_format">#patchresponse-patch_format</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchresponse-patch_format">4.3.4. PatchResponse</a>
    <li><a href="#ref-for-patchresponse-patch_format①">4.4.2. Handling Server Response</a> <a href="#ref-for-patchresponse-patch_format②">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchresponse-patch">
   <b><a href="#patchresponse-patch">#patchresponse-patch</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchresponse-patch">4.3.4. PatchResponse</a>
    <li><a href="#ref-for-patchresponse-patch①">4.4.2. Handling Server Response</a> <a href="#ref-for-patchresponse-patch②">(2)</a>
    <li><a href="#ref-for-patchresponse-patch③">4.5. Server: Responding to a PatchRequest</a> <a href="#ref-for-patchresponse-patch④">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchresponse-replacement">
   <b><a href="#patchresponse-replacement">#patchresponse-replacement</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchresponse-replacement">4.3.4. PatchResponse</a>
    <li><a href="#ref-for-patchresponse-replacement①">4.4.2. Handling Server Response</a> <a href="#ref-for-patchresponse-replacement②">(2)</a>
    <li><a href="#ref-for-patchresponse-replacement③">4.5. Server: Responding to a PatchRequest</a> <a href="#ref-for-patchresponse-replacement④">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patchresponse-unrecognized_ordering">
   <b><a href="#patchresponse-unrecognized_ordering">#patchresponse-unrecognized_ordering</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patchresponse-unrecognized_ordering">4.3.4. PatchResponse</a>
    <li><a href="#ref-for-patchresponse-unrecognized_ordering①">4.4.2. Handling Server Response</a> <a href="#ref-for-patchresponse-unrecognized_ordering②">(2)</a>
    <li><a href="#ref-for-patchresponse-unrecognized_ordering③">4.5. Server: Responding to a PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="clientstate">
   <b><a href="#clientstate">#clientstate</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-clientstate">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-clientstate①">4.5. Server: Responding to a PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="clientstate-original_font_checksum">
   <b><a href="#clientstate-original_font_checksum">#clientstate-original_font_checksum</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-clientstate-original_font_checksum">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-clientstate-original_font_checksum①">4.5. Server: Responding to a PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="clientstate-codepoint_ordering">
   <b><a href="#clientstate-codepoint_ordering">#clientstate-codepoint_ordering</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-clientstate-codepoint_ordering">4.4.1. Extending the Font Subset</a> <a href="#ref-for-clientstate-codepoint_ordering①">(2)</a> <a href="#ref-for-clientstate-codepoint_ordering②">(3)</a> <a href="#ref-for-clientstate-codepoint_ordering③">(4)</a> <a href="#ref-for-clientstate-codepoint_ordering④">(5)</a> <a href="#ref-for-clientstate-codepoint_ordering⑤">(6)</a> <a href="#ref-for-clientstate-codepoint_ordering⑥">(7)</a>
    <li><a href="#ref-for-clientstate-codepoint_ordering⑦">4.4.2. Handling Server Response</a>
    <li><a href="#ref-for-clientstate-codepoint_ordering⑧">4.5. Server: Responding to a PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="clientstate-subset_axis_space">
   <b><a href="#clientstate-subset_axis_space">#clientstate-subset_axis_space</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-clientstate-subset_axis_space">4.4.1. Extending the Font Subset</a>
    <li><a href="#ref-for-clientstate-subset_axis_space①">4.5. Server: Responding to a PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="clientstate-original_axis_space">
   <b><a href="#clientstate-original_axis_space">#clientstate-original_axis_space</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-clientstate-original_axis_space">4.5. Server: Responding to a PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="clientstate-original_features">
   <b><a href="#clientstate-original_features">#clientstate-original_features</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-clientstate-original_features">4.5. Server: Responding to a PatchRequest</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="abstract-opdef-extend-the-font-subset">
   <b><a href="#abstract-opdef-extend-the-font-subset">#abstract-opdef-extend-the-font-subset</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-abstract-opdef-extend-the-font-subset">4.4.3. Load a Font in a User Agent with a HTTP Cache</a> <a href="#ref-for-abstract-opdef-extend-the-font-subset①">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="patch-request-header">
   <b><a href="#patch-request-header">#patch-request-header</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-patch-request-header">3.1. IFT Method Negotiation</a>
    <li><a href="#ref-for-patch-request-header①">3.3. Offline Usage</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="abstract-opdef-handle-server-response">
   <b><a href="#abstract-opdef-handle-server-response">#abstract-opdef-handle-server-response</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-abstract-opdef-handle-server-response">4.4.1. Extending the Font Subset</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="abstract-opdef-handle-failed-font-load">
   <b><a href="#abstract-opdef-handle-failed-font-load">#abstract-opdef-handle-failed-font-load</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-abstract-opdef-handle-failed-font-load">4.4.2. Handling Server Response</a> <a href="#ref-for-abstract-opdef-handle-failed-font-load①">(2)</a> <a href="#ref-for-abstract-opdef-handle-failed-font-load②">(3)</a> <a href="#ref-for-abstract-opdef-handle-failed-font-load③">(4)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="original-font">
   <b><a href="#original-font">#original-font</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-original-font">4.4.1. Extending the Font Subset</a> <a href="#ref-for-original-font①">(2)</a> <a href="#ref-for-original-font②">(3)</a> <a href="#ref-for-original-font③">(4)</a>
    <li><a href="#ref-for-original-font④">4.4.2. Handling Server Response</a>
    <li><a href="#ref-for-original-font⑤">4.5. Server: Responding to a PatchRequest</a> <a href="#ref-for-original-font⑥">(2)</a> <a href="#ref-for-original-font⑦">(3)</a> <a href="#ref-for-original-font⑧">(4)</a> <a href="#ref-for-original-font⑨">(5)</a> <a href="#ref-for-original-font①⓪">(6)</a> <a href="#ref-for-original-font①①">(7)</a> <a href="#ref-for-original-font①②">(8)</a> <a href="#ref-for-original-font①③">(9)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="range-request-optimized-font">
   <b><a href="#range-request-optimized-font">#range-request-optimized-font</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-range-request-optimized-font">5.2.2. Introduction</a> <a href="#ref-for-range-request-optimized-font①">(2)</a>
    <li><a href="#ref-for-range-request-optimized-font②">5.2.3. Compression</a> <a href="#ref-for-range-request-optimized-font③">(2)</a> <a href="#ref-for-range-request-optimized-font④">(3)</a>
    <li><a href="#ref-for-range-request-optimized-font⑤">5.2.4. Table Ordering</a> <a href="#ref-for-range-request-optimized-font⑥">(2)</a> <a href="#ref-for-range-request-optimized-font⑦">(3)</a>
    <li><a href="#ref-for-range-request-optimized-font⑧">5.2.5. Glyph Independence</a> <a href="#ref-for-range-request-optimized-font⑨">(2)</a>
    <li><a href="#ref-for-range-request-optimized-font①⓪">5.2.6. Glyph Order</a> <a href="#ref-for-range-request-optimized-font①①">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="outline-table">
   <b><a href="#outline-table">#outline-table</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-outline-table">5.2.4. Table Ordering</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="corpus">
   <b><a href="#corpus">#corpus</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-corpus">5.2.6. Glyph Order</a> <a href="#ref-for-corpus①">(2)</a> <a href="#ref-for-corpus②">(3)</a> <a href="#ref-for-corpus③">(4)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="usage-document-frequency">
   <b><a href="#usage-document-frequency">#usage-document-frequency</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-usage-document-frequency">5.2.6. Glyph Order</a> <a href="#ref-for-usage-document-frequency①">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="range-request-threshold">
   <b><a href="#range-request-threshold">#range-request-threshold</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-range-request-threshold">5.3.1. First Request</a> <a href="#ref-for-range-request-threshold①">(2)</a> <a href="#ref-for-range-request-threshold②">(3)</a> <a href="#ref-for-range-request-threshold③">(4)</a>
    <li><a href="#ref-for-range-request-threshold④">5.3.2. Subsequent Requests</a> <a href="#ref-for-range-request-threshold⑤">(2)</a>
   </ul>
  </aside>
<script>/* script-dfn-panel */

document.body.addEventListener("click", function(e) {
    var queryAll = function(sel) { return [].slice.call(document.querySelectorAll(sel)); }
    // Find the dfn element or panel, if any, that was clicked on.
    var el = e.target;
    var target;
    var hitALink = false;
    while(el.parentElement) {
        if(el.tagName == "A") {
            // Clicking on a link in a <dfn> shouldn't summon the panel
            hitALink = true;
        }
        if(el.classList.contains("dfn-paneled")) {
            target = "dfn";
            break;
        }
        if(el.classList.contains("dfn-panel")) {
            target = "dfn-panel";
            break;
        }
        el = el.parentElement;
    }
    if(target != "dfn-panel") {
        // Turn off any currently "on" or "activated" panels.
        queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(function(el){
            el.classList.remove("on");
            el.classList.remove("activated");
        });
    }
    if(target == "dfn" && !hitALink) {
        // open the panel
        var dfnPanel = document.querySelector(".dfn-panel[data-for='" + el.id + "']");
        if(dfnPanel) {
            dfnPanel.classList.add("on");
            var rect = el.getBoundingClientRect();
            dfnPanel.style.left = window.scrollX + rect.right + 5 + "px";
            dfnPanel.style.top = window.scrollY + rect.top + "px";
            var panelRect = dfnPanel.getBoundingClientRect();
            var panelWidth = panelRect.right - panelRect.left;
            if(panelRect.right > document.body.scrollWidth && (rect.left - (panelWidth + 5)) > 0) {
                // Reposition, because the panel is overflowing
                dfnPanel.style.left = window.scrollX + rect.left - (panelWidth + 5) + "px";
            }
        } else {
            console.log("Couldn't find .dfn-panel[data-for='" + el.id + "']");
        }
    } else if(target == "dfn-panel") {
        // Switch it to "activated" state, which pins it.
        el.classList.add("activated");
        el.style.left = null;
        el.style.top = null;
    }

});
</script>
<script>/* script-var-click-highlighting */

    document.addEventListener("click", e=>{
        if(e.target.nodeName == "VAR") {
            highlightSameAlgoVars(e.target);
        }
    });
    {
        const indexCounts = new Map();
        const indexNames = new Map();
        function highlightSameAlgoVars(v) {
            // Find the algorithm container.
            let algoContainer = null;
            let searchEl = v;
            while(algoContainer == null && searchEl != document.body) {
                searchEl = searchEl.parentNode;
                if(searchEl.hasAttribute("data-algorithm")) {
                    algoContainer = searchEl;
                }
            }

            // Not highlighting document-global vars,
            // too likely to be unrelated.
            if(algoContainer == null) return;

            const algoName = algoContainer.getAttribute("data-algorithm");
            const varName = getVarName(v);
            const addClass = !v.classList.contains("selected");
            let highlightClass = null;
            if(addClass) {
                const index = chooseHighlightIndex(algoName, varName);
                indexCounts.get(algoName)[index] += 1;
                indexNames.set(algoName+"///"+varName, index);
                highlightClass = nameFromIndex(index);
            } else {
                const index = previousHighlightIndex(algoName, varName);
                indexCounts.get(algoName)[index] -= 1;
                highlightClass = nameFromIndex(index);
            }

            // Find all same-name vars, and toggle their class appropriately.
            for(const el of algoContainer.querySelectorAll("var")) {
                if(getVarName(el) == varName) {
                    el.classList.toggle("selected", addClass);
                    el.classList.toggle(highlightClass, addClass);
                }
            }
        }
        function getVarName(el) {
            return el.textContent.replace(/(\s|\xa0)+/, " ").trim();
        }
        function chooseHighlightIndex(algoName, varName) {
            let indexes = null;
            if(indexCounts.has(algoName)) {
                indexes = indexCounts.get(algoName);
            } else {
                // 7 classes right now
                indexes = [0,0,0,0,0,0,0];
                indexCounts.set(algoName, indexes);
            }

            // If the element was recently unclicked,
            // *and* that color is still unclaimed,
            // give it back the same color.
            const lastIndex = previousHighlightIndex(algoName, varName);
            if(indexes[lastIndex] === 0) return lastIndex;

            // Find the earliest index with the lowest count.
            const minCount = Math.min.apply(null, indexes);
            let index = null;
            for(var i = 0; i < indexes.length; i++) {
                if(indexes[i] == minCount) {
                    return i;
                }
            }
        }
        function previousHighlightIndex(algoName, varName) {
            return indexNames.get(algoName+"///"+varName);
        }
        function nameFromIndex(index) {
            return "selected" + index;
        }
    }
    </script>