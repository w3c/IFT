<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <title>Incremental Font Transfer</title>
  <meta content="WD" name="w3c-status">
  <meta content="Bikeshed version 4b8aed3f7, updated Thu Mar 6 12:35:01 2025 -0800" name="generator">
  <link href="https://www.w3.org/TR/IFT/" rel="canonical">
  <meta content="d980726397bb6bbea8bde06bedf3a8d2f64a1a5b" name="revision">
  <meta content="dark light" name="color-scheme">
<style>
.conform:hover {background: #31668f; color: white}
.conform:target {padding: 2px; border: 2px solid #AAA; background: #31668f; color: white }

table {
  width: 100%;
}

table, tr {
  border: 1px solid #aaa;
  border-collapse: collapse;
}

th, td {
  padding: 0.5rem;
}
</style>
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-syntax-highlighting */
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }

.highlight:not(.idl) { background: rgba(0, 0, 0, .03); }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */

@media (prefers-color-scheme: dark) {
    .highlight:not(.idl) { background: rgba(255, 255, 255, .05); }

    c-[a] { color: #d33682 } /* Keyword.Declaration */
    c-[b] { color: #d33682 } /* Keyword.Type */
    c-[c] { color: #2aa198 } /* Comment */
    c-[d] { color: #2aa198 } /* Comment.Multiline */
    c-[e] { color: #268bd2 } /* Name.Attribute */
    c-[f] { color: #b58900 } /* Name.Tag */
    c-[g] { color: #cb4b16 } /* Name.Variable */
    c-[k] { color: #d33682 } /* Keyword */
    c-[l] { color: #657b83 } /* Literal */
    c-[m] { color: #657b83 } /* Literal.Number */
    c-[n] { color: #268bd2 } /* Name */
    c-[o] { color: #657b83 } /* Operator */
    c-[p] { color: #657b83 } /* Punctuation */
    c-[s] { color: #6c71c4 } /* Literal.String */
    c-[t] { color: #6c71c4 } /* Literal.String.Single */
    c-[u] { color: #6c71c4 } /* Literal.String.Double */
    c-[ch] { color: #2aa198 } /* Comment.Hashbang */
    c-[cp] { color: #2aa198 } /* Comment.Preproc */
    c-[cpf] { color: #2aa198 } /* Comment.PreprocFile */
    c-[c1] { color: #2aa198 } /* Comment.Single */
    c-[cs] { color: #2aa198 } /* Comment.Special */
    c-[kc] { color: #d33682 } /* Keyword.Constant */
    c-[kn] { color: #d33682 } /* Keyword.Namespace */
    c-[kp] { color: #d33682 } /* Keyword.Pseudo */
    c-[kr] { color: #d33682 } /* Keyword.Reserved */
    c-[ld] { color: #657b83 } /* Literal.Date */
    c-[nc] { color: #268bd2 } /* Name.Class */
    c-[no] { color: #268bd2 } /* Name.Constant */
    c-[nd] { color: #268bd2 } /* Name.Decorator */
    c-[ni] { color: #268bd2 } /* Name.Entity */
    c-[ne] { color: #268bd2 } /* Name.Exception */
    c-[nf] { color: #268bd2 } /* Name.Function */
    c-[nl] { color: #268bd2 } /* Name.Label */
    c-[nn] { color: #268bd2 } /* Name.Namespace */
    c-[py] { color: #268bd2 } /* Name.Property */
    c-[ow] { color: #657b83 } /* Operator.Word */
    c-[mb] { color: #657b83 } /* Literal.Number.Bin */
    c-[mf] { color: #657b83 } /* Literal.Number.Float */
    c-[mh] { color: #657b83 } /* Literal.Number.Hex */
    c-[mi] { color: #657b83 } /* Literal.Number.Integer */
    c-[mo] { color: #657b83 } /* Literal.Number.Oct */
    c-[sa] { color: #6c71c4 } /* Literal.String.Affix */
    c-[sb] { color: #6c71c4 } /* Literal.String.Backtick */
    c-[sc] { color: #6c71c4 } /* Literal.String.Char */
    c-[dl] { color: #6c71c4 } /* Literal.String.Delimiter */
    c-[sd] { color: #6c71c4 } /* Literal.String.Doc */
    c-[se] { color: #6c71c4 } /* Literal.String.Escape */
    c-[sh] { color: #6c71c4 } /* Literal.String.Heredoc */
    c-[si] { color: #6c71c4 } /* Literal.String.Interpol */
    c-[sx] { color: #6c71c4 } /* Literal.String.Other */
    c-[sr] { color: #6c71c4 } /* Literal.String.Regex */
    c-[ss] { color: #6c71c4 } /* Literal.String.Symbol */
    c-[fm] { color: #268bd2 } /* Name.Function.Magic */
    c-[vc] { color: #cb4b16 } /* Name.Variable.Class */
    c-[vg] { color: #cb4b16 } /* Name.Variable.Global */
    c-[vi] { color: #cb4b16 } /* Name.Variable.Instance */
    c-[vm] { color: #cb4b16 } /* Name.Variable.Magic */
    c-[il] { color: #657b83 } /* Literal.Number.Integer.Long */
}
</style>
<style>/* Boilerplate: style-var-click-highlighting */
/*
Colors were chosen in Lab using https://nixsensor.com/free-color-converter/
D50 2deg illuminant, L in [0,100], a and b in [-128, 128]
0 = lab(85,0,85)
1 = lab(85,80,30)
2 = lab(85,-40,40)
3 = lab(85,-50,0)
4 = lab(85,5,15)
5 = lab(85,-10,-50)
6 = lab(85,35,-15)

For darkmode:
0 = oklab(50%   0%  108%)
1 = oklab(50% -51%   51%)
2 = oklab(50% -64%  -20%)
3 = oklab(50%   6%   19%)
4 = oklab(50% -12%  -64%)
5 = oklab(50%  44%  -19%)  
6 = oklab(50% 102%   38%)
*/

[data-algorithm] var { cursor: pointer; }
var[data-var-color] { background-color: var(--var-bg); box-shadow: 0 0 0 2px var(--var-bg); }

var[data-var-color] { --var-bg: #F4D200; }
var[data-var-color="1"] { --var-bg: #FF87A2; }
var[data-var-color="2"] { --var-bg: #96E885; }
var[data-var-color="3"] { --var-bg: #3EEED2; }
var[data-var-color="4"] { --var-bg: #EACFB6; }
var[data-var-color="5"] { --var-bg: #82DDFF; }
var[data-var-color="6"] { --var-vg: #FFBCF2; }

@media (prefers-color-scheme: dark) {
	var[data-var-color] { --var-bg: #bc1a00; }
	var[data-var-color="1"] { --var-bg: #007f00; }
	var[data-var-color="2"] { --var-bg: #008698; }
	var[data-var-color="3"] { --var-bg: #7f5b2b; }
	var[data-var-color="4"] { --var-bg: #004df3; }
	var[data-var-color="5"] { --var-bg: #a1248a; }
	var[data-var-color="6"] { --var-vg: #ff0000; }
}
</style>
  <link href="https://www.w3.org/StyleSheets/TR/2021/W3C-WD" rel="stylesheet">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">Incremental Font Transfer</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types/#WD">W3C Working Draft</a>, <time class="dt-updated" datetime="2025-02-20">20 February 2025</time></p>
   <details open>
    <summary>More details about this document</summary>
    <div data-fill-with="spec-metadata">
     <dl>
      <dt>This version:
      <dd><a class="u-url" href="https://www.w3.org/TR/2025/WD-IFT-20250220/">https://www.w3.org/TR/2025/WD-IFT-20250220/</a>
      <dt>Latest published version:
      <dd><a href="https://www.w3.org/TR/IFT/">https://www.w3.org/TR/IFT/</a>
      <dt>Editor's Draft:
      <dd><a href="https://w3c.github.io/IFT/Overview.html">https://w3c.github.io/IFT/Overview.html</a>
      <dt>History:
      <dd><a class="u-url" href="https://www.w3.org/standards/history/IFT/">https://www.w3.org/standards/history/IFT/</a>
      <dt>Feedback:
      <dd><span><a href="mailto:public-webfonts-wg@w3.org?subject=%5BIFT%5D%20YOUR%20TOPIC%20HERE">public-webfonts-wg@w3.org</a> with subject line “<kbd>[IFT] <i data-lt>… message topic …</i></kbd>” (<a href="https://lists.w3.org/Archives/Public/public-webfonts-wg/" rel="discussion">archives</a>)</span>
      <dd><a href="https://github.com/w3c/PFE/issues/">GitHub</a>
      <dt class="editor">Editors:
      <dd class="editor p-author h-card vcard" data-editor-id="1438"><a class="p-name fn u-url url" href="https://svgees.us/">Chris Lilley</a> (<span class="p-org org">W3C</span>)
      <dd class="editor p-author h-card vcard" data-editor-id="73905"><a class="p-name fn u-email email" href="mailto:grieger@google.com">Garret Rieger</a> (<span class="p-org org">Google Inc.</span>)
      <dd class="editor p-author h-card vcard" data-editor-id="137857"><a class="p-name fn u-email email" href="mailto:siterum@adobe.com">Skef Iterum</a> (<span class="p-org org">Adobe Inc.</span>)
     </dl>
    </div>
   </details>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 2025 <a href="https://www.w3.org/">World Wide Web Consortium</a>. <abbr title="World Wide Web Consortium">W3C</abbr><sup>®</sup> <a href="https://www.w3.org/policies/#Legal_Disclaimer">liability</a>, <a href="https://www.w3.org/policies/#W3C_Trademarks">trademark</a> and <a href="https://www.w3.org/copyright/software-license/" rel="license" title="W3C Software and Document License">permissive document license</a> rules apply. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>This specification defines a method to incrementally transfer a font
from server to client. The client loads only the portion(s) of the font that
they actually need, significantly reducing data transfer. Multiple incremental
additions to the same font are possible, such as a user agent updating a font
as a user browses multiple pages. Incremental transfer improves on
unicode-range by avoiding damage to layout (kerning, ligatures, etc) rules,
meaning it can efficiently support fine grained increments to latin and
to complex scripts like Indic or Arabic.</p>
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="sotd"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> <em>This section describes the status of this document at the time of
  its publication. A list of
  current W3C publications and the latest revision of this technical report
  can be found in the <a href="https://www.w3.org/TR/">W3C technical reports
  index at https://www.w3.org/TR/.</a></em> </p>
   <p> This document was produced by the <a href="https://www.w3.org/groups/wg/webfonts">Web Fonts Working Group</a> as a Working Draft using the <a href="https://www.w3.org/policies/process/20231103/#recs-and-notes">Recommendation
      track</a>. This document is intended to become a W3C Recommendation. </p>
   <p> If you wish to make comments regarding this document, please <a href="https://github.com/w3c/PFE/issues/new">file an issue on the specification repository</a>. </p>
   <p> Publication as a Working Draft does not imply endorsement by <abbr title="World Wide Web Consortium">W3C</abbr> and its Members. This is a draft document and may be updated, replaced or
  obsoleted by other documents at any time. It is inappropriate to cite this
  document as other than work in progress. </p>
   <p> This document was produced by a group operating under
  the <a href="https://www.w3.org/policies/patent-policy/20200915/">W3C Patent Policy</a>.
  W3C maintains a <a href="https://www.w3.org/groups/wg/webfonts/ipr" rel="disclosure">public list of any patent disclosures</a> made in connection with the deliverables of the group;
  that page also includes instructions for disclosing a patent.
  An individual who has actual knowledge of a patent which the individual believes contains <a href="https://www.w3.org/policies/patent-policy/20200915/#def-essential">Essential Claim(s)</a> must disclose the information in accordance with <a href="https://www.w3.org/policies/patent-policy/20200915/#sec-Disclosure">section 6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>. </p>
   <p> This document is governed by the <a href="https://www.w3.org/policies/process/20231103/" id="w3c_process_revision">03 November 2023 W3C Process Document</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li>
     <a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
     <ol class="toc">
      <li><a href="#evaluation-report"><span class="secno">1.1</span> <span class="content">Technical Motivation: Evaluation Report</span></a>
      <li><a href="#overview"><span class="secno">1.2</span> <span class="content">Overview</span></a>
      <li><a href="#making-incremental-fonts"><span class="secno">1.3</span> <span class="content">Creating an Incremental Font</span></a>
      <li>
       <a href="#performance-considerations"><span class="secno">1.4</span> <span class="content">Performance Considerations and the use of Incremental Font Transfer</span></a>
       <ol class="toc">
        <li><a href="#reduce-requests"><span class="secno">1.4.1</span> <span class="content">Reducing the Number of Network Requests</span></a>
       </ol>
     </ol>
    <li>
     <a href="#opt-in"><span class="secno">2</span> <span class="content">Opt-In Mechanism</span></a>
     <ol class="toc">
      <li><a href="#offline-usage"><span class="secno">2.1</span> <span class="content">Offline Usage</span></a>
     </ol>
    <li>
     <a href="#definitions"><span class="secno">3</span> <span class="content">Definitions</span></a>
     <ol class="toc">
      <li><a href="#font-subset-dfn"><span class="secno">3.1</span> <span class="content">Font Subset</span></a>
      <li><a href="#font-patch-definitions"><span class="secno">3.2</span> <span class="content">Font Patch</span></a>
      <li><a href="#patch-map-dfn"><span class="secno">3.3</span> <span class="content">Patch Map</span></a>
      <li><a href="#data-types"><span class="secno">3.4</span> <span class="content">Explanation of Data Types</span></a>
     </ol>
    <li>
     <a href="#extending-font-subset"><span class="secno">4</span> <span class="content">Extending a Font Subset</span></a>
     <ol class="toc">
      <li><a href="#font-patch-invalidations"><span class="secno">4.1</span> <span class="content">Patch Invalidations</span></a>
      <li><a href="#default-layout-features"><span class="secno">4.2</span> <span class="content">Default Layout Features</span></a>
      <li><a href="#extend-font-subset"><span class="secno">4.3</span> <span class="content">Incremental Font Extension Algorithm</span></a>
      <li><a href="#invalidating-patch-selection"><span class="secno">4.4</span> <span class="content">Selecting Invalidating Patches</span></a>
      <li><a href="#target-subset-definitions"><span class="secno">4.5</span> <span class="content">Target Subset Definition</span></a>
      <li><a href="#ift-font-coverage"><span class="secno">4.6</span> <span class="content">Determining what Content a Font can Render</span></a>
      <li><a href="#fully-expanding-a-font"><span class="secno">4.7</span> <span class="content">Fully Expanding a Font</span></a>
      <li><a href="#caching-incremental-fonts"><span class="secno">4.8</span> <span class="content">Caching Extended Incremental Fonts</span></a>
     </ol>
    <li>
     <a href="#font-format-extensions"><span class="secno">5</span> <span class="content">Extensions to the Font Format</span></a>
     <ol class="toc">
      <li><a href="#ift-and-compression"><span class="secno">5.1</span> <span class="content">Incremental Font Transfer and Font Compression Formats</span></a>
      <li><a href="#cff"><span class="secno">5.2</span> <span class="content">CFF and CFF2 Incremental Fonts</span></a>
      <li>
       <a href="#patch-map-table"><span class="secno">5.3</span> <span class="content">Patch Map Table</span></a>
       <ol class="toc">
        <li>
         <a href="#patch-map-format-1"><span class="secno">5.3.1</span> <span class="content">Patch Map Table: Format 1</span></a>
         <ol class="toc">
          <li><a href="#interpreting-patch-map-format-1"><span class="secno">5.3.1.1</span> <span class="content">Interpreting Format 1</span></a>
          <li><a href="#remove-entries-format-1"><span class="secno">5.3.1.2</span> <span class="content">Remove Entries from Format 1</span></a>
         </ol>
        <li>
         <a href="#patch-map-format-2"><span class="secno">5.3.2</span> <span class="content">Patch Map Table: Format 2</span></a>
         <ol class="toc">
          <li><a href="#interpreting-patch-map-format-2"><span class="secno">5.3.2.1</span> <span class="content">Interpreting Format 2</span></a>
          <li><a href="#remove-entries-format-2"><span class="secno">5.3.2.2</span> <span class="content">Remove Entries from Format 2</span></a>
          <li><a href="#sparse-bit-set-decoding"><span class="secno">5.3.2.3</span> <span class="content">Sparse Bit Set</span></a>
         </ol>
        <li><a href="#url-templates"><span class="secno">5.3.3</span> <span class="content">URL Templates</span></a>
       </ol>
     </ol>
    <li>
     <a href="#font-patch-formats"><span class="secno">6</span> <span class="content">Font Patch Formats</span></a>
     <ol class="toc">
      <li><a href="#font-patch-formats-summary"><span class="secno">6.1</span> <span class="content">Formats Summary</span></a>
      <li>
       <a href="#table-keyed"><span class="secno">6.2</span> <span class="content">Table Keyed</span></a>
       <ol class="toc">
        <li><a href="#apply-table-keyed"><span class="secno">6.2.1</span> <span class="content">Applying Table Keyed Patches</span></a>
       </ol>
      <li>
       <a href="#glyph-keyed"><span class="secno">6.3</span> <span class="content">Glyph Keyed</span></a>
       <ol class="toc">
        <li><a href="#apply-glyph-keyed"><span class="secno">6.3.1</span> <span class="content">Applying Glyph Keyed Patches</span></a>
       </ol>
     </ol>
    <li>
     <a href="#encoding"><span class="secno">7</span> <span class="content">Encoding</span></a>
     <ol class="toc">
      <li><a href="#encoding-considerations"><span class="secno">7.1</span> <span class="content">Encoding Considerations</span></a>
     </ol>
    <li>
     <a href="#priv"><span class="secno">8</span> <span class="content">Privacy Considerations</span></a>
     <ol class="toc">
      <li><a href="#content-inference-from-character-set"><span class="secno">8.1</span> <span class="content">Content inference from character set</span></a>
      <li><a href="#per-origin"><span class="secno">8.2</span> <span class="content">Per-origin restriction avoids fingerprinting</span></a>
     </ol>
    <li><a href="#sec"><span class="secno">9</span> <span class="content">Security Considerations</span></a>
    <li><a href="#changes"><span class="secno">10</span> <span class="content">Changes</span></a>
    <li><a href="#feature-tag-list"><span class="secno"></span> <span class="content"> Appendix A: Default Feature Tags</span></a>
    <li>
     <a href="#extension-example"><span class="secno"></span> <span class="content"> Appendix B: Extension Algorithm Example Execution</span></a>
     <ol class="toc">
      <li><a href="#appendix-b-example-1"><span class="secno"></span> <span class="content">Example 1: Table and Glyph Keyed Patches</span></a>
      <li><a href="#appendix-b-example-2"><span class="secno"></span> <span class="content">Example 2: Glyph Keyed Patches with Child Entries</span></a>
     </ol>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
      <li><a href="#w3c-conformant-algorithms"><span class="secno"></span> <span class="content">Conformant Algorithms</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
   <p><em>This section is not normative.</em></p>
   <p>Incremental Font Transfer (IFT) is a technology to improve the latency of remote fonts (or "web fonts") on
the web. Without this technology, a browser needs to download every last byte of a font before it can render
any characters using that font. IFT allows the browser to download only some of the bytes in the file, thereby
decreasing the perceived latency between the time when a browser realizes it needs a font and when the
necessary text can be rendered with that font. Unlike traditional font subsetting approaches Incremental Font Transfer
retains the encoding of layout rules between segments (<a href="https://www.w3.org/TR/PFE-evaluation/#fail-subset">Progressive Font Enrichment: Evaluation Report § fail-subset</a>).</p>
   <p>The success of WebFonts is unevenly distributed. This specification allows WebFonts to be used where
slow networks, very large fonts, or complex subsetting requirements currently preclude their use. For
example, even using WOFF 2 <a data-link-type="biblio" href="#biblio-woff2" title="WOFF File Format 2.0">[WOFF2]</a>, fonts for CJK languages can be too large to be practical.</p>
   <h3 class="heading settled" data-level="1.1" id="evaluation-report"><span class="secno">1.1. </span><span class="content">Technical Motivation: Evaluation Report</span><a class="self-link" href="#evaluation-report"></a></h3>
   <p>See the Progressive Font Enrichment: Evaluation Report <a data-link-type="biblio" href="#biblio-pfe-report" title="Progressive Font Enrichment: Evaluation Report">[PFE-report]</a> for the investigation which led
to this specification.</p>
   <h3 class="heading settled" data-level="1.2" id="overview"><span class="secno">1.2. </span><span class="content">Overview</span><a class="self-link" href="#overview"></a></h3>
   <p>An <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="incremental-font">incremental font</dfn> is a regular <a data-link-type="biblio" href="#biblio-open-type" title="OpenType Specification">OpenType</a> font that is reformatted to include incremental functionality,
partly in virtue of two additional <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">tables</a>. Using these new tables the font can be augmented
(eg. to cover more code points) by loading and applying patches to it.</p>
   <p>The IFT technology has four main pieces:</p>
   <ul>
    <li data-md>
     <p><a href="#extending-font-subset">§ 4 Extending a Font Subset</a>: provides the algorithm that is used by a client to select and apply patches.</p>
    <li data-md>
     <p><a href="#font-format-extensions">§ 5 Extensions to the Font Format</a>: defines the new tables which contain a list of patches that are available to be applied to a font.</p>
    <li data-md>
     <p><a href="#font-patch-formats">§ 6 Font Patch Formats</a>: defines three different types of patches that can be used. Two are "generic" binary patches, one is
 specific to the font’s format for storing glyph data.</p>
    <li data-md>
     <p><a href="#encoding">§ 7 Encoding</a>: creates the font and associated patches that form an incremental font.</p>
   </ul>
   <p>At a high level an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font">incremental font</a> is used like this:</p>
   <ol>
    <li data-md>
     <p>The client downloads an initial font file, which contains some initial subset of data from the full version of the font along with <a href="#font-format-extensions">embedded data</a> describing the set of <a href="#font-patch-formats">patches</a> which can be used to extend 
the font.</p>
    <li data-md>
     <p>Based on the content to be rendered, the client <a href="#extending-font-subset">selects, downloads, and applies</a> patches to extend
the font to cover additional characters, layout features, and/or variation space. This step is repeated each time there is new
content.</p>
   </ol>
   <h3 class="heading settled" data-level="1.3" id="making-incremental-fonts"><span class="secno">1.3. </span><span class="content">Creating an Incremental Font</span><a class="self-link" href="#making-incremental-fonts"></a></h3>
   <p>It is expected that the most common way to produce an incremental font will be to convert an existing font to use the incremental
encoding defined in this specification. At a high level converting an existing font to be incremental will look like this:</p>
   <ol>
    <li data-md>
     <p>Choose the content of the initial <a href="#font-subset-dfn">subset</a>, this will be included in the initial font file the client loads
and usually consists of any data from the original font that is expected to always be needed.</p>
    <li data-md>
     <p>Choose the patch type or types. Different patch types have different qualities, so different use cases can call for different
patch types, or in some cases a mix of two types.</p>
    <li data-md>
     <p>Choose a segmentation of the font. Individual segments will be added to the base subset by the client using patches. Choosing an
appropriate segmentation is one of the most important parts of producing an efficient encoding.</p>
    <li data-md>
     <p>Based on these choices, generate a set of patches, where each patch adds the data for a particular segment relative to either
the initial font file or a previous patch.</p>
    <li data-md>
     <p>Generate the initial font file including the initial subset and a <a href="#font-format-extensions">patch mapping</a>. This mapping
lists all of the available patch files, the url they reside at, and information on what data the patch will add to the font.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> this is a highly simplified description of creating an incremental font, a more in-depth discussion of generating an encoding and
requirements on the encoding can be found in the <a href="#encoding">§ 7 Encoding</a> section.</p>
   <h3 class="heading settled" data-level="1.4" id="performance-considerations"><span class="secno">1.4. </span><span class="content">Performance Considerations and the use of Incremental Font Transfer</span><a class="self-link" href="#performance-considerations"></a></h3>
   <p>Using incremental transfer may not always be beneficial, depending on the characteristics of the font,
the network, and the content being rendered. This section provides non-normative guidance to help decide
when incremental transfer should be utilized.</p>
   <p>It is common for an incremental font to trigger the loading of multiple patches in parallel. So to maximize performance, when
serving an incremental font it is recommended that an HTTP server which is capable of multiplexing (such as <a data-link-type="biblio" href="#biblio-rfc9113" title="HTTP/2">[rfc9113]</a> or <a data-link-type="biblio" href="#biblio-rfc9114" title="HTTP/3">[rfc9114]</a>)
is used.</p>
   <p>Incrementally loading a font has a fundamental performance trade off versus loading the whole font.
Simplistically, under incremental transfer less bytes may be transferred at the potential cost of
increasing the total number of network requests being made, and/or increased request processing
latency. In general incremental font transfer will be beneficial where the reduction in latency from
sending less bytes outweighs additional latency introduced by the incremental transfer method.</p>
   <p>The first factor to consider is the language of the content being rendered. The evaluation report
contains the results of simulating incremental font transfer across three categories of languages
(<a href="https://www.w3.org/TR/PFE-evaluation/#langtype">Progressive Font Enrichment: Evaluation Report § langtype</a>). See it’s conclusions <a href="https://www.w3.org/TR/PFE-evaluation/#conclusions">Progressive Font Enrichment: Evaluation Report § conclusions</a> for a discussion of the
anticipated performance of incremental font transfer across the language categories.</p>
   <p>Next, how much of the font is expected to be needed? If it’s expected that most of the font will be
needed to render the content, then incremental font transfer is unlikely to be beneficial. In many cases
however only part of a font is expected to be needed. For example:</p>
   <ul>
    <li data-md>
     <p>If the font contains support for several languages but a user is expected to only render content
in a subset of those languages.</p>
    <li data-md>
     <p>If the content being rendered uses a small subset of the total characters in a font. This is
often the case for Chinese, Japanese, Korean, Emoji, and Icon fonts.</p>
    <li data-md>
     <p>Only a small amount of text is being rendered. For example a font that is only used for a
headline.</p>
   </ul>
   <p>An alternative to incremental transfer is to break a font into distinct subsets (typically by script)
and use the unicode range feature of @font-face to load only the subsets needed. However, this can alter
the rendering of some content <a href="https://www.w3.org/TR/PFE-evaluation/#fail-subset">Progressive Font Enrichment: Evaluation Report § fail-subset</a> if there are layout rules between characters in
different subsets. Incremental font transfer does not suffer from this issue as it can encompass the
original font and all of it’s layout rules.</p>
   <h4 class="heading settled" data-level="1.4.1" id="reduce-requests"><span class="secno">1.4.1. </span><span class="content">Reducing the Number of Network Requests</span><a class="self-link" href="#reduce-requests"></a></h4>
   <p>As discussed in the previous section the most basic implementation of incremental font transfer will
tend to increase the total number of requests made vs traditional font loading. Since each augmentation
will typically require at least one round trip time, performance can be negatively impacted if too many requests
are made. Depending on which patch types are available and how much information is provided in the <a href="#font-format-extensions">patch mapping</a>, a client might preemptively request patches for code points that are not
currently needed, but expected to be needed in the future. Intelligent use of this feature by an
implementation can help reduce the total number of requests being made. The evaluation report explored
this by testing the performance of a basic character frequency based <a href="https://www.w3.org/TR/PFE-evaluation/#codepredict">code point prediction</a> scheme and found it improved overall performance.</p>
   <h2 class="heading settled" data-level="2" id="opt-in"><span class="secno">2. </span><span class="content">Opt-In Mechanism</span><a class="self-link" href="#opt-in"></a></h2>
   <p>Web pages can choose to opt-in to incremental transfer for a font via the use of a CSS font tech
keyword (<a href="https://www.w3.org/TR/css-fonts-4/#font-tech-definitions"><cite>CSS Fonts 4</cite> § 11.1 Font tech</a>) inside the ''@font-face'' block. The keyword <code>incremental</code> is used to indicate the referenced font contains IFT data and should
only be loaded by a user agent which supports incremental font transfer.</p>
   <div class="example" id="example-e768eb0f">
    <a class="self-link" href="#example-e768eb0f"></a> 
<pre>@font-face {
    font-family: "MyCoolWebFont";
    src: url("MyCoolWebFont-Incremental.otf") tech(incremental);
}
</pre>
   </div>
   <div class="example" id="example-8a58c904">
    <a class="self-link" href="#example-8a58c904"></a> 
<pre>@font-face {
    font-family: "MyCoolWebFont";
    src: url("MyCoolWebFont-Incremental.otf") tech(incremental);
    unicode-range: U+0000-00FF;
}
</pre>
   </div>
   <p>As shown in the second example, <a href="https://www.w3.org/TR/css-fonts-4/#unicode-range-desc">unicode-range</a> can be used in conjuction with an IFT font. The
unicode ranges should be set to match the coverage of the fully extended font. This will allow clients to avoid trying to load the IFT font
if the font does not support any code points which are needed.</p>
   <p>An alternative approach is to use the <a data-link-type="biblio" href="#biblio-css-conditional-5" title="CSS Conditional Rules Module Level 5">CSS supports mechanism</a> which can make selections based on font tech:</p>
   <div class="example" id="example-439e65c2">
    <a class="self-link" href="#example-439e65c2"></a> 
<pre>@when font-tech(incremental) {
  @font-face {
    font-family: "MyCoolWebFont";
    src: url("MyCoolWebFont-Incremental.otf");
  }
}
@else {
  @font-face {
    font-family: "MyCoolWebFont";
    src: url("MyCoolWebFont.otf");
  }
}
</pre>
   </div>
   <p class="note" role="note"><span class="marker">Note:</span> Each individual <code>@font-face</code> block may or may not opt-in to IFT. This is due to the
variety of ways fonts are used on web pages. Authors have control over which fonts they want to use
this technology with, and which they do not.</p>
   <p class="note" role="note"><span class="marker">Note:</span> the IFT tech keyword can be used in conjunction with other font tech specifiers to perform
font feature selection. For example a <code>@font-face</code> could include two URLs one with <code>tech(incremental, color-COLRv1)</code> and the other with <code>tech(incremental, color-COLRv0)</code>.</p>
   <h3 class="heading settled" data-level="2.1" id="offline-usage"><span class="secno">2.1. </span><span class="content">Offline Usage</span><a class="self-link" href="#offline-usage"></a></h3>
   <p>In some cases a user agent may wish to save a web page for offline use. Saved pages may be viewed while there is no network connection
and thus it won’t be possible to request any additional patches referenced by an incremental font. Since it won’t be possible extend
incremental fonts if content changes (eg. due to JavaScript execution), the page saving mechanism should fully expand the incremental font
by invoking <a data-link-type="abstract-op" href="#abstract-opdef-fully-expand-a-font-subset" id="ref-for-abstract-opdef-fully-expand-a-font-subset">Fully Expand a Font Subset</a> and replace references to the incremental font with the fully expanded one.</p>
   <h2 class="heading settled" data-level="3" id="definitions"><span class="secno">3. </span><span class="content">Definitions</span><a class="self-link" href="#definitions"></a></h2>
   <h3 class="heading settled" data-level="3.1" id="font-subset-dfn"><span class="secno">3.1. </span><span class="content">Font Subset</span><a class="self-link" href="#font-subset-dfn"></a></h3>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="font-subset">font subset</dfn> is a modified version of a font file <a data-link-type="biblio" href="#biblio-iso14496-22" title="Information technology — Coding of audio-visual objects — Part 22: Open Font Format">[iso14496-22]</a> that contains only the data
needed to render a subset of:</p>
   <ul>
    <li data-md>
     <p>the code points,</p>
    <li data-md>
     <p><a href="https://learn.microsoft.com/en-us/typography/opentype/spec/featuretags#">layout features</a>,</p>
    <li data-md>
     <p>and <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otvaroverview#terminology">design-variation space</a>.</p>
   </ul>
   <p>supported by the original font. When a subsetted font is used to render text using any combination of the subset
code points, <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/featuretags#">layout features</a>, or <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otvaroverview#terminology">design-variation space</a> it should render identically to the original font. This includes rendering with the use of any optional typographic
features that a renderer may choose to use from the original font, such as hinting instructions. Design variation spaces
are specified using the user-axis scales (<a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otvaroverview#coordinate-scales-and-normalization">OpenType Specification § otvaroverview#coordinate-scales-and-normalization</a>).</p>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="font-subset-definition">font subset definition</dfn> describes the minimum data (code points, layout features,
variation axis space) that a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset">font subset</a> should support.</p>
   <p class="note" role="note"><span class="marker">Note:</span> For convenience the remainder of this document links to the <a data-link-type="biblio" href="#biblio-open-type" title="OpenType Specification">[open-type]</a> specification which is a copy of <a data-link-type="biblio" href="#biblio-iso14496-22" title="Information technology — Coding of audio-visual objects — Part 22: Open Font Format">[iso14496-22]</a>.</p>
   <h3 class="heading settled" data-level="3.2" id="font-patch-definitions"><span class="secno">3.2. </span><span class="content">Font Patch</span><a class="self-link" href="#font-patch-definitions"></a></h3>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="font-patch">font patch</dfn> is a file which encodes changes to be made to an IFT-encoded font. Patches are used to extend
an existing <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①">font subset</a> and provide expanded coverage.</p>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="patch-format">patch format</dfn> is a specified encoding of changes to be applied relative to a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②">font subset</a>. A set of
changes encoded according to the format is a <a data-link-type="dfn" href="#font-patch" id="ref-for-font-patch">font patch</a>. Each <a data-link-type="dfn" href="#patch-format" id="ref-for-patch-format">patch format</a> has an associated <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="patch-application-algorithm">patch application algorithm</dfn> which takes a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset③">font subset</a> and a <a data-link-type="dfn" href="#font-patch" id="ref-for-font-patch①">font patch</a> encoded in the <a data-link-type="dfn" href="#patch-format" id="ref-for-patch-format①">patch format</a> as input and outputs an extended <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset④">font subset</a>.</p>
   <h3 class="heading settled" data-level="3.3" id="patch-map-dfn"><span class="secno">3.3. </span><span class="content">Patch Map</span><a class="self-link" href="#patch-map-dfn"></a></h3>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="patch-map">patch map</dfn> is an <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">open type table</a> which encodes a collection of
mappings from <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition">font subset definitions</a> to URLs which host <a href="#font-patch-formats">patches</a> that
extend the <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font①">incremental font</a>. A <a data-link-type="dfn" href="#patch-map" id="ref-for-patch-map">patch map</a> table encodes a list of <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="patch-map-entries">patch map entries</dfn>, where each
entry has a key and value.  The key of an entry defines the coverage of the entry, which is information on what subset
definitions will match it. The value specifies information about the patches which should be applied when the entry is
matched. <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries">Patch Map Entry</a> summary:</p>
   <table>
    <tbody>
     <tr>
      <th>Key
      <th>Value
     <tr>
      <td>
       <ul>
        <li data-md>
         <p><a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition①">font subset definition</a>: defines the base coverage.</p>
        <li data-md>
         <p>References to zero or more child <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries①">Patch Map Entry</a>’s:<br> these child entries are used to extend the coverage.</p>
        <li data-md>
         <p>Child entry match mode, which can be either conjunctive or disjunctive.</p>
       </ul>
      <td>
       <ul>
        <li data-md>
         <p>One or more Patch <a data-link-type="biblio" href="#biblio-whatwg-url" title="URL Standard">URL</a> strings</p>
        <li data-md>
         <p><a href="#font-patch-formats">Patch Format</a></p>
        <li data-md>
         <p><a href="#font-patch-invalidations">compatibility ID</a></p>
       </ul>
   </table>
   <p>More details of the format of patch maps can be found in <a href="#font-format-extensions">§ 5 Extensions to the Font Format</a>.</p>
   <h3 class="heading settled" data-level="3.4" id="data-types"><span class="secno">3.4. </span><span class="content">Explanation of Data Types</span><a class="self-link" href="#data-types"></a></h3>
   <p>Encoded data structures in the remainder of this specification are described in terms of the data types defined
in <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#data-types">OpenType Specification § otff#data-types</a>. As with the rest of OpenType, all fields use "big-endian" byte ordering.</p>
   <h2 class="heading settled" data-level="4" id="extending-font-subset"><span class="secno">4. </span><span class="content">Extending a Font Subset</span><a class="self-link" href="#extending-font-subset"></a></h2>
   <p>This section defines the algorithm that a client uses to extend an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font②">incremental</a> <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset⑤">font subset</a> to cover additional
code points, layout features and/or design space. It is an iterative algorithm which, repeatedly:</p>
   <ul>
    <li data-md>
     <p>parses the font subset’s patch mappings into a list of available patches.</p>
    <li data-md>
     <p>checks if any available patches match the content to be rendered.</p>
    <li data-md>
     <p>selects one available patch, loads it, and then applies it.</p>
   </ul>
   <p>This process repeats until no more relevant patches remain. Since a patch application may alter the patch mappings
embedded in the font file, on each iteration the patch map in the current version of the font subset is reparsed to see what  patches
remain. Thus the font subset is on each iteration is the source of truth for what patches are available, and fully encapsulates the current
state of the augmentation process.</p>
   <h3 class="heading settled" data-level="4.1" id="font-patch-invalidations"><span class="secno">4.1. </span><span class="content">Patch Invalidations</span><a class="self-link" href="#font-patch-invalidations"></a></h3>
   <p>The patch mappings embedded in a font subset encode an invalidation mode for each patch. The invalidation mode for a patch
marks which other patches will no longer be valid after the application of that patch. This invalidation mode is used by the
extension algorithm to determine which patches are compatible and influences the order of selection. Patch validity during patch
application is enforced by the compatibility ID from the <a href="#patch-map-table">§ 5.3 Patch Map Table</a>. Every patch has a compatibility ID encoded within it
which needs to match the compatibility ID from the <a href="#patch-map-table">§ 5.3 Patch Map Table</a> which lists that patch.</p>
   <p>There are three invalidation modes:</p>
   <ul>
    <li data-md>
     <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="full-invalidation">Full Invalidation</dfn>: when this patch is applied all other patches currently listed in the <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset⑥">font subset</a> are invalidated.
The compatibility ID in both the 'IFT ' and 'IFTX' <a href="#patch-map-table">§ 5.3 Patch Map Table</a> will be changed.</p>
    <li data-md>
     <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="partial-invalidation">Partial Invalidation</dfn>: when this patch is applied all other patches in the same <a href="#patch-map-table">§ 5.3 Patch Map Table</a> will be invalidated.
The compatibility ID of only the <a href="#patch-map-table">§ 5.3 Patch Map Table</a> which contains this patch will be changed.</p>
    <li data-md>
     <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="no-invalidation">No Invalidation</dfn>: no other patches will be invalidated by the application of this patch. The compatibility ID of the
'IFT ' and 'IFTX' <a href="#patch-map-table">§ 5.3 Patch Map Table</a> will not change.</p>
   </ul>
   <p>The invalidation mode of a specific patch is encoded in its format number, which can be found in <a href="#font-patch-formats-summary">§ 6.1 Formats Summary</a>.</p>
   <h3 class="heading settled" data-level="4.2" id="default-layout-features"><span class="secno">4.2. </span><span class="content">Default Layout Features</span><a class="self-link" href="#default-layout-features"></a></h3>
   <p>Most text shapers have a set of <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/featuretags#">layout features</a> which are always enabled and thus always required in an
incrementally loaded font. <a href="#feature-tag-list">Appendix A: Default Feature Tags</a> collects a list of features that at the time of writing are known to be required
by default in common shaper implementations. When forming a <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition②">font subset definition</a> as input to the extension algorithm the client
should typically include all features found in <a href="#feature-tag-list">Appendix A: Default Feature Tags</a> in the subset definition. However, in some cases the client might
know that the specific shaper which will be used may not make use of some features in <a href="#feature-tag-list">Appendix A: Default Feature Tags</a> and may
opt to exclude those unused features from the subset definition.</p>
   <h3 class="heading settled algorithm" data-algorithm="Incremental Font Extension Algorithm" data-level="4.3" id="extend-font-subset"><span class="secno">4.3. </span><span class="content">Incremental Font Extension Algorithm</span><a class="self-link" href="#extend-font-subset"></a></h3>
   <p>The following algorithm is used by a client to extend an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font③">incremental</a> <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset⑦">font subset</a> to cover additional
code points, layout features and/or design space. This algorithm incrementally selects and applies patches to the font one at a time, loading
them as needed. As an important optimization to minimize network round trips it permits loads to be started for all patches that will eventually
be needed. These come in two forms:</p>
   <ul>
    <li data-md>
     <p>First, <a data-link-type="dfn" href="#patch-map" id="ref-for-patch-map①">patch mapping entries</a> may list more than one URL string, where each URL string after the first should also be loaded
because they will be needed in future iterations.</p>
    <li data-md>
     <p>Second, <a href="#font-patch-invalidations">§ 4.1 Patch Invalidations</a> is used to determine which patches loads can be started for. Any patches which match the target subset
definition and will not be invalidated by the next patch to be applied according to <a href="#font-patch-invalidations">§ 4.1 Patch Invalidations</a> can be expected to be
needed in future iterations.</p>
   </ul>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-extend-an-incremental-font-subset">Extend an Incremental Font Subset</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>font subset</var>: an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font④">incremental</a> <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset⑧">font subset</a>.</p>
    <li data-md>
     <p><var>initial font URL</var>: a <a href="https://url.spec.whatwg.org/#concept-url">URL</a> which identifies the location of the initial incremental
font that <var>font subset</var> was derived from.</p>
    <li data-md>
     <p><var>target subset definition</var>: the <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition③">font subset definition</a> that the client wants to extend <var>font subset</var> to cover.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>extended font subset</var>: an extended version of <var>font subset</var>. May or may not be an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font⑤">incremental font</a>.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Set <var>extended font subset</var> to <var>font subset</var>.</p>
    <li data-md>
     <p>Load the 'IFT ' and 'IFTX' (if present) mapping <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">tables</a> from <var>extended font subset</var>. Both
tables are formatted as a <a href="#patch-map-table">§ 5.3 Patch Map Table</a>. Check that they are valid according to the requirements in <a href="#patch-map-table">§ 5.3 Patch Map Table</a>. If
either table is not valid, invoke <a data-link-type="abstract-op" href="#abstract-opdef-handle-errors" id="ref-for-abstract-opdef-handle-errors">Handle errors</a>. If <var>extended font subset</var> does not have an 'IFT ' table, then it is
not an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font⑥">incremental font</a> and cannot be extended, return <var>extended font subset</var>.</p>
    <li data-md>
     <p>If the compatibility ID in 'IFT ' is equal to the compatibility ID in 'IFTX' this is an error, invoke <a data-link-type="abstract-op" href="#abstract-opdef-handle-errors" id="ref-for-abstract-opdef-handle-errors①">Handle errors</a>.</p>
    <li data-md>
     <p>For each of <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">tables</a> 'IFT ' and 'IFTX' (if present): convert the table into a list of entries by
invoking <a data-link-type="abstract-op" href="#abstract-opdef-interpret-format-1-patch-map" id="ref-for-abstract-opdef-interpret-format-1-patch-map">Interpret Format 1 Patch Map</a> or <a data-link-type="abstract-op" href="#abstract-opdef-interpret-format-2-patch-map" id="ref-for-abstract-opdef-interpret-format-2-patch-map">Interpret Format 2 Patch Map</a>. Concatenate the returned entry lists into a single list, <var>entry list</var>.</p>
    <li data-md>
     <p>For each <var>entry</var> in <var>entry list</var> invoke <a data-link-type="abstract-op" href="#abstract-opdef-check-entry-intersection" id="ref-for-abstract-opdef-check-entry-intersection">Check entry intersection</a> with <var>entry</var> and <var>target subset definition</var> as inputs, if it returns false remove <var>entry</var> from <var>entry list</var>. Additionally remove
any entries in <var>entry list</var> which have a patch URL string which was loaded and applied previously during the execution of this algorithm.</p>
    <li data-md>
     <p>If <var>entry list</var> is empty, then the extension operation is finished, return <var>extended font subset</var>.</p>
    <li data-md>
     <p>Group the entries from <var>entry list</var> into 3 lists based on the invalidation mode of the <a href="#font-patch-formats-summary">patch format</a> of each entry: <var>full invalidation entry list</var>, <var>partial invalidation entry list</var>, and <var>no invalidation entry list</var>.</p>
    <li data-md>
     <p>Pick one <var>entry</var> with the following procedure:</p>
     <ul>
      <li data-md>
       <p>If <var>full invalidation entry list</var> is not empty, then select exactly one of the contained entries. Follow the criteria in <a href="#invalidating-patch-selection">§ 4.4 Selecting Invalidating Patches</a> to select the single entry.</p>
      <li data-md>
       <p>Otherwise if <var>partial invalidation entry list</var> is not empty then, select exactly one of the contained entries.
Follow the criteria in <a href="#invalidating-patch-selection">§ 4.4 Selecting Invalidating Patches</a> to select the single entry.</p>
      <li data-md>
       <p>Otherwise select the entry in <var>no invalidation entry list</var> which is listed first in the <a data-link-type="dfn" href="#patch-map" id="ref-for-patch-map②">patch map</a>. For <a href="#patch-map-format-1">§ 5.3.1 Patch Map Table: Format 1</a> this is the entry with the lowest entry index. For <a href="#patch-map-format-2">§ 5.3.2 Patch Map Table: Format 2</a> this is the entry that appears first in the <a data-link-type="dfn" href="#mapping-entries-entries" id="ref-for-mapping-entries-entries">entries</a> array. If entries from both the IFT and
IFTX tables are candidates then all entries in IFT are considered to come before those in IFTX.</p>
     </ul>
    <li data-md>
     <p>Start a load of <var>patch file</var> (if not already previously started) by invoking <a data-link-type="abstract-op" href="#abstract-opdef-load-patch-file" id="ref-for-abstract-opdef-load-patch-file">Load patch file</a> with the <var>initial font URL</var> as the initial font URL and the first patch URL string in <var>entry</var> as the patch URL string. If there are any other URL strings in <var>entry</var>, then initiate loads for those using the same procedure. These may be used during future iterations of this algorithm.
Additionally the client may optionally start loads using the same procedure for any entries in <var>entry list</var> which will not be <a href="#font-patch-invalidations">invalidated</a> by <var>entry</var>. The total number of patches that a client can load and apply during a single execution
of this algorithm is limited to:</p>
     <ul>
      <li data-md>
       <p>At most 100 patches which are <a data-link-type="dfn" href="#partial-invalidation" id="ref-for-partial-invalidation">Partial Invalidation</a> or <a data-link-type="dfn" href="#full-invalidation" id="ref-for-full-invalidation">Full Invalidation</a>.</p>
      <li data-md>
       <p>At most 2000 patches of any type.</p>
     </ul>
     <p>Can be loaded and applied during a single invocation of this algorithm. If either count has been exceeded this is an error invoke <a data-link-type="abstract-op" href="#abstract-opdef-handle-errors" id="ref-for-abstract-opdef-handle-errors②">Handle errors</a>.</p>
    <li data-md>
     <p>Once the load for <var>patch file</var> is finished, apply it using the appropriate application algorithm (matching the patches format in <var>entry</var>) from <a href="#font-patch-formats">§ 6 Font Patch Formats</a> to apply the <var>patch file</var> using the patch URL string and the compatibility id from <var>entry</var> to <var>extended font subset</var>. If the load for <var>patch file</var> resulted in an error, handle it according
 to <a data-link-type="abstract-op" href="#abstract-opdef-handle-errors" id="ref-for-abstract-opdef-handle-errors③">Handle errors</a>.</p>
    <li data-md>
     <p>Go to step 2.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> in step 9 the client may optionally start loads in parallel for patches which are not invalidated by the currently
selected entry. Such patches will nearly always be needed in later iterations (since they won’t be invalidated), and loading
them in parallel significantly improves performance by eliminating round trips. When initiating loads this way, the order of
request initiation needs to follow the ordering specified in step 8.</p>
   <p class="note" role="note"><span class="marker">Note:</span> if the only remaining intersecting entries are no-invalidation entries, then the intersection check in step 5 does
not need to be repeated on subsequent iterations (this is because no-invalidation a patch does not change the list of
available patches upon application, other than to remove its own entry.)  Additionally, as an optimization clients may
want to perform patch application of the remaining intersecting non-invalidating entries as a single batch
operation. Due to the nature of glyph keyed patches it’s straightforward to construct the end result of applying
multiple patches sequentially in a single pass. Doing it this way avoids repeatedly re-synthesizing new
glyf/loca/CFF/CFF2 tables for each individual patch and can significantly reduce the total amount of computation needed.</p>
   <div class="example" id="example-2ebb408c"><a class="self-link" href="#example-2ebb408c"></a> An example of the execution of the extension algorithm can be found in <a href="#extension-example">Appendix B: Extension Algorithm Example Execution</a>. </div>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-check-entry-intersection">Check entry intersection</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>mapping entry</var>: a <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries②">patch map entry</a>.</p>
    <li data-md>
     <p><var>subset definition</var>: a <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition④">font subset definition</a>.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>intersects</var>: true if <var>subset definition</var> intersects <var>mapping entry</var>, otherwise false.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>For each set in <var>subset definition</var> (code points, feature tags,
 design space) check if the set intersects the corresponding set from <var>mapping entry</var>’s subset definition. A set
 intersects when:</p>
     <table>
      <tbody>
       <tr>
        <th>
        <th>subset definition set is empty
        <th>subset definition set is not empty
       <tr>
        <th>mapping entry set is empty
        <td>true
        <td>true
       <tr>
        <th>mapping entry set is not empty
        <td>false
        <td>true if the two sets intersect
     </table>
     <p>When checking design space sets for intersection, they intersect if there is at least one pair of intersecting segments
 (tags are equal and the ranges intersect).</p>
    <li data-md>
     <p>If one or more sets checked in step 1 did not intersect, then return false for <var>intersects</var>.</p>
    <li data-md>
     <p>If there are no child entries in <var>mapping entry</var>, then return true for <var>intersects</var>.</p>
    <li data-md>
     <p>Invoke <a data-link-type="abstract-op" href="#abstract-opdef-check-entry-intersection" id="ref-for-abstract-opdef-check-entry-intersection①">Check entry intersection</a> for each child entry referenced in <var>mapping entry</var> with <var>subset definition</var> as an input. If child entry match mode is conjunctive, then return true for <var>intersects</var> only if all invocations return true.
Otherwise return true only if at least one invocation returns true.</p>
   </ol>
   <div class="example" id="example-8269bfc5">
    <a class="self-link" href="#example-8269bfc5"></a> 
    <p>The table below represents a patch mapping and shows the expected result of an intersection check against various entries. In these examples
when a set (ie. code points, feature tags, design space, child entries) is not specified it is assumed to be the empty set.</p>
    <table>
     <tbody>
      <tr>
       <th>index
       <th>mapping entry
       <th>subset definition
       <th>intersects?
      <tr>
       <td>0
       <td>
<pre>subset definition {
  code points: {1, 2, 3},
},
match mode: disjunctive,
</pre>
       <td>
<pre>code points: {2},
</pre>
       <td>true
      <tr>
       <td>1
       <td>
<pre>subset definition {
  code points: {4, 5, 6},
},
match mode: disjunctive,
</pre>
       <td>
<pre>code points: {2},
</pre>
       <td>false
      <tr>
       <td>2
       <td>
<pre>subset definition {
  code points: {1, 2, 3},
},
match mode: disjunctive,
</pre>
       <td>
<pre>code points: {2},
feature tags: {smcp},
</pre>
       <td>true
      <tr>
       <td>3
       <td>
<pre>subset definition: {
  code points: {1, 2, 3},
},
match mode: disjunctive,
</pre>
       <td>
<pre>feature tags: {smcp},
</pre>
       <td>false
      <tr>
       <td>4
       <td>
<pre>subset definition: {
  code points: {1, 2, 3},
},
child entry indices: {1},
match mode: disjunctive,
</pre>
       <td>
<pre>code points: {5},
</pre>
       <td>false
      <tr>
       <td>5
       <td>
<pre>subset definition: {
},
child entry indices: {0, 1},
match mode: conjunctive,
</pre>
       <td>
<pre>code points: {2},
</pre>
       <td>false
      <tr>
       <td>6
       <td>
<pre>subset definition: {
},
child entry indices: {0, 1},
match mode: conjunctive,
</pre>
       <td>
<pre>code points: {2, 6},
</pre>
       <td>true
    </table>
   </div>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-load-patch-file">Load patch file</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>patch URL string</var>: A <a data-link-type="biblio" href="#biblio-whatwg-url" title="URL Standard">URL</a> string (<a data-link-type="biblio" href="#biblio-utf-8" title="UTF-8, a transformation format of ISO 10646">[UTF-8]</a> encoded) identifying the patch file to load. It  may be a <a href="https://url.spec.whatwg.org/#relative-url-string">relative</a> URL.</p>
    <li data-md>
     <p><var>initial font URL</var>: a <a href="https://url.spec.whatwg.org/#concept-url">URL</a> which identifies the location of the initial incremental
font that <var>font subset</var> was derived from.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>patch file</var>: the content (bytes) identified by <var>patch URL string</var>.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Parse <var>patch URL string</var> into a <a href="https://url.spec.whatwg.org/#concept-url">URL Record</a> using <a href="https://url.spec.whatwg.org/#url-parsing">URL Standard § url-parsing</a>. <var>initial font URL</var> is the <a href="https://url.spec.whatwg.org/#concept-base-url">base URL</a> and encoding is UTF-8. Store the result
 in <var>target URL</var>. If URL parsing failed, then return an error.</p>
    <li data-md>
     <p>Retrieve the contents of <var>target URL</var> using the fetching capabilities of the implementing user agent. For web browsers, <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a> should be used. When using <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a> the request is configured as follows:</p>
     <ul>
      <li data-md>
       <p>Set <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-method" id="ref-for-concept-request-method">method</a> to GET.</p>
      <li data-md>
       <p>Set <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-url" id="ref-for-concept-request-url">url</a> to <var>target URL</var>.</p>
      <li data-md>
       <p>Set <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client">client</a> to the client from the request object used to fetch <var>initial font URL</var>.</p>
      <li data-md>
       <p>Set <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#request-initiator-type" id="ref-for-request-initiator-type">initiator type</a> to "font".</p>
      <li data-md>
       <p>Set <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-destination" id="ref-for-concept-request-destination">destination</a> to "font".</p>
      <li data-md>
       <p>Set <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-referrer" id="ref-for-concept-request-referrer">referrer</a> to <var>initial font URL</var>.</p>
      <li data-md>
       <p>Set <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-mode" id="ref-for-concept-request-mode">mode</a> to "cors".</p>
     </ul>
     <p><a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-fetch" id="ref-for-concept-fetch">Fetch</a> the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request">request</a> where <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#process-response-end-of-body" id="ref-for-process-response-end-of-body">processResponseConsumeBody</a> is step 3 of this algorithm.</p>
     <p>For non <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a> implementations, make a request for <var>target URL</var> using the fetching capabilities that are available.
Copy the <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a> based settings specified above where equivalent concepts exist. Proceed to step 3 with the results of that
fetch.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#process-response-end-of-body" id="ref-for-process-response-end-of-body①">processResponseConsumeBody</a> is passed the response and null, failure, or a byte sequence. If a byte sequence is received,
then return the bytes as <var>patch file</var>. If null is received, then return an empty byte array as <var>patch file</var>.
Otherwise return an error.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> the fetch settings aim to match those used for CSS font loading <a href="https://www.w3.org/TR/css-fonts-4/#font-fetching-requirements"><cite>CSS Fonts 4</cite> § 4.8.2 Font fetching requirements</a>, but with a couple of differences:
first referrer is set to the initial font’s URL, second URL resolution uses the initial font as the base instead of the stylesheet.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-handle-errors">Handle errors</dfn></p>
   <p>If the extending the font subset process has failed with an error then, some of the data within the font may not be fully loaded and as
a result rendering content which relies on the missing data may result in incorrect renderings. The client may choose to continue using
the font, but should only use it for the rendering of code points, features, and design space that are fully loaded according to <a href="#ift-font-coverage">§ 4.6 Determining what Content a Font can Render</a>. Rendering of all other content should fallback to a different font following normal client fallback logic.</p>
   <p>If the error occurred during <a data-link-type="abstract-op" href="#abstract-opdef-load-patch-file" id="ref-for-abstract-opdef-load-patch-file①">Load patch file</a>, then the client may continue trying to extend the font subset. In step 8 of <a data-link-type="abstract-op" href="#abstract-opdef-extend-an-incremental-font-subset" id="ref-for-abstract-opdef-extend-an-incremental-font-subset">Extend an Incremental Font Subset</a> within each invalidation grouping any patches which failed to load are excluded from selection.
If an invalidation group is non empty and being selected from, but only contains failed patches then extension has failed and cannot
continue.</p>
   <p>In the case of all other errors the client must not attempt to further extend the font subset.</p>
   <h3 class="heading settled" data-level="4.4" id="invalidating-patch-selection"><span class="secno">4.4. </span><span class="content">Selecting Invalidating Patches</span><a class="self-link" href="#invalidating-patch-selection"></a></h3>
   <p>During execution of the <a data-link-type="abstract-op" href="#abstract-opdef-extend-an-incremental-font-subset" id="ref-for-abstract-opdef-extend-an-incremental-font-subset①">Extend an Incremental Font Subset</a> algorithm in some cases it’s necessary to select a single invalidating (full or partial)
patch entry from a list of candidate entries. The selection criteria used has a direct impact on the total number of round trips that will be needed to
perform the extension. Round trips are costly so for maximum performance patches should be selected in a way that minimizes the total number of needed
round trips.</p>
   <p>The following selection criteria minimizes round trips and must be used by the client when selecting a single partial or full invalidation patch in step 8
of <a data-link-type="abstract-op" href="#abstract-opdef-extend-an-incremental-font-subset" id="ref-for-abstract-opdef-extend-an-incremental-font-subset②">Extend an Incremental Font Subset</a>:</p>
   <ol>
    <li data-md>
     <p>If one or more candidate entries have previously had their associated patch file loaded by step 9 of <a data-link-type="abstract-op" href="#abstract-opdef-extend-an-incremental-font-subset" id="ref-for-abstract-opdef-extend-an-incremental-font-subset③">Extend an Incremental Font Subset</a>,
then in the following steps only consider candidate entries whose patch file is already loaded or is currently being loaded. Otherwise consider all
candidate entries.</p>
    <li data-md>
     <p>For each candidate entry: compute a total subset definition by unioning that entry’s subset definition and the subset definition of all child entries
 reachable via the graph of referenced child entries.</p>
    <li data-md>
     <p>For each candidate entry: compute the set intersection between the total subset definition and the target subset definition.</p>
    <li data-md>
     <p>Find an entry whose intersection from step 2 is not a strict subset of any other intersection.</p>
    <li data-md>
     <p>Locate any additional entries that are in the same <a data-link-type="dfn" href="#patch-map" id="ref-for-patch-map③">patch map</a> and have the same intersection as the entry found in step 3. From the this set of
 entries (including the step 3 pick) the final selection is the entry which is listed first in the <a data-link-type="dfn" href="#patch-map" id="ref-for-patch-map④">patch map</a>. For <a href="#patch-map-format-1">§ 5.3.1 Patch Map Table: Format 1</a> this is the
 entry with the lowest entry index. For <a href="#patch-map-format-2">§ 5.3.2 Patch Map Table: Format 2</a> this is the entry that appears first in the <a data-link-type="dfn" href="#mapping-entries-entries" id="ref-for-mapping-entries-entries①">entries</a> array.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> a fast and efficient way to find an entry which satisfies the criteria for step 3 is to sort the entries (descending) by the size of the code point
set intersection, then the size of feature tag set intersection, and finally the size of the design space intersection. The first entry in this sorting is
guaranteed to not be a strict subset of any other entries, since any strict super sets would have to be at least one item larger. This approach also has
the added benefit that it selects the patch which will add the most data which the client is currently requesting.</p>
   <h3 class="heading settled" data-level="4.5" id="target-subset-definitions"><span class="secno">4.5. </span><span class="content">Target Subset Definition</span><a class="self-link" href="#target-subset-definitions"></a></h3>
   <p>The <a data-link-type="abstract-op" href="#abstract-opdef-extend-an-incremental-font-subset" id="ref-for-abstract-opdef-extend-an-incremental-font-subset④">Extend an Incremental Font Subset</a> algorithm takes as an input a target subset definition based on some content that the client
wants to render. The client may choose to form one single subset definition for the content as a whole and run the extension algorithm
once. Alternatively, the client may instead break the content up into smaller spans, form a subset definition for each span, and run
the extension algorithm on each of the smaller subset definitions. Either approach will ultimately produce a font which equivalently
renders the overall content as long as:</p>
   <ul>
    <li data-md>
     <p>Each span of text which generates a subset definition is built from only one or more complete shaping units.</p>
    <li data-md>
     <p>Where a shaping unit is a span of text which the client will process together as a single unit during <a href="https://harfbuzz.github.io/what-is-harfbuzz.html#what-is-text-shaping">text shaping</a>.</p>
   </ul>
   <h3 class="heading settled" data-level="4.6" id="ift-font-coverage"><span class="secno">4.6. </span><span class="content">Determining what Content a Font can Render</span><a class="self-link" href="#ift-font-coverage"></a></h3>
   <p>Given some incremental font (whether the initial font or one that has been partially extended) a client may wish to know what content
that font can render in it’s current state. This is of particular importance where the client is looking to determine which portions
of the text to use fallback fonts for.</p>
   <p>During fallback processing a client would typically check the font’s <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/cmap#">cmap</a> table to determine which code points are
supported; However, in an IFT font due to the way <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patches work the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/cmap#">cmap</a> table may contain mappings
for code points which do not yet have the corresponding glyph data loaded. As a result the client should not rely solely on the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/cmap#">cmap</a> table to determine code point presence. Instead the following procedure can be used by a client to check what
parts of some content an incremental font can render:</p>
   <ul>
    <li data-md>
     <p>Split the content up into the shaping units (see <a href="#target-subset-definitions">§ 4.5 Target Subset Definition</a>) on which the content will be processed during text
shaping.</p>
    <li data-md>
     <p>For each shaping unit there are two checks:</p>
     <ul>
      <li data-md>
       <p>First, if for any code point in the shaping unit there is not a <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/cmap#">cmap</a> entry for it, or the entry maps to glyph
0 then the incremental font does not fully support rendering the shaping unit.</p>
      <li data-md>
       <p>Second, compute the corresponding <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition⑤">font subset definition</a> and execute the <a data-link-type="abstract-op" href="#abstract-opdef-extend-an-incremental-font-subset" id="ref-for-abstract-opdef-extend-an-incremental-font-subset⑤">Extend an Incremental Font Subset</a> algorithm,
stopping at step 6. If the entry list is not empty then the incremental font does not fully support rendering the shaping unit.</p>
     </ul>
    <li data-md>
     <p>Any shaping units that passed both checks can be rendered in their entirety with the font.</p>
   </ul>
   <p>The client may also wish to know what the font can render at a more granular level than a shaping unit. The following pseudo code
demonstrates a possible method for splitting a shaping unit which failed the above check up into spans which can be rendered using the
incremental font:</p>
<pre class="highlight"><c- c1># Returns a list of spans, [start, end] inclusive, within shaping_unit that are</c->
<c- c1># supported by and can be safely rendered with ift_font.</c->
<c- c1>#</c->
<c- c1># shaping_unit is an array where each item has a code point, associated list of</c->
<c- c1># layout features, and the design space point that code point is being rendered with.</c->
<c- k>def</c-> <c- nf>supported_spans</c-><c- p>(</c-><c- n>shaping_unit</c-><c- p>,</c-> <c- n>ift_font</c-><c- p>):</c->
  <c- n>current_start</c-> <c- o>=</c-> <c- n>current_end</c-> <c- o>=</c-> <c- n>current_subset_def</c-> <c- o>=</c-> <c- kc>None</c->
  <c- n>supported_spans</c-> <c- o>=</c-> <c- p>[]</c->

  <c- n>i</c-> <c- o>=</c-> <c- mi>0</c->
  <c- k>while</c-> <c- n>i</c-> <c- o>&lt;</c-> <c- n>shaping_unit</c-><c- o>.</c-><c- n>length</c-><c- p>():</c->
    <c- k>if</c-> <c- n>current_subset_def</c-> <c- ow>is</c-> <c- kc>None</c-><c- p>:</c->
      <c- n>current_subset_def</c-> <c- o>=</c-> <c- n>SubsetDefinition</c-><c- p>()</c->
      <c- n>current_start</c-> <c- o>=</c-> <c- n>i</c->

    <c- n>current_end</c-> <c- o>=</c-> <c- n>i</c->
    <c- n>current_subset_def</c-><c- o>.</c-><c- n>add</c-><c- p>(</c-><c- n>shaping_unit</c-><c- o>.</c-><c- n>codepoint_at</c-><c- p>(</c-><c- n>i</c-><c- p>),</c->
                           <c- n>shaping_unit</c-><c- o>.</c-><c- n>features_at</c-><c- p>(</c-><c- n>i</c-><c- p>),</c->
                           <c- n>shaping_unit</c-><c- o>.</c-><c- n>design_space_point_at</c-><c- p>(</c-><c- n>i</c-><c- p>))</c->

    <c- k>if</c-> <c- n>supports_subset_def</c-><c- p>(</c-><c- n>ift_font</c-><c- p>,</c-> <c- n>current_subset_def</c-><c- p>):</c->
      <c- n>i</c-> <c- o>+=</c-> <c- mi>1</c->
      <c- k>continue</c->

    <c- k>if</c-> <c- n>current_end</c-> <c- o>></c-> <c- n>current_start</c-><c- p>:</c->
      <c- n>supported_spans</c-><c- o>.</c-><c- n>append</c-><c- p>(</c-><c- n>Span</c-><c- p>(</c-><c- n>current_start</c-><c- p>,</c-> <c- n>current_end</c-> <c- o>-</c-> <c- mi>1</c-><c- p>))</c->
      <c- c1># i isn’t incremented so the current code point can be checked on it’s own</c->
      <c- c1># in the next iteration.</c->
    <c- k>else</c-><c- p>:</c->
      <c- n>i</c-> <c- o>+=</c-> <c- mi>1</c->

    <c- n>current_start</c-> <c- o>=</c-> <c- n>current_end</c-> <c- o>=</c-> <c- n>current_subset_def</c-> <c- o>=</c-> <c- kc>None</c->

  <c- k>return</c-> <c- n>supported_spans</c->


<c- c1># Returns true if ift_font has support for rendering content covered by subset_def.</c->
<c- k>def</c-> <c- nf>supports_subset_def</c-><c- p>(</c-><c- n>ift_font</c-><c- p>,</c-> <c- n>subset_def</c-><c- p>):</c->
  <c- c1># Return true only if both of the following two checks are true:</c->
  <c- c1># - Each code point in subset_def is mapped to a glyph id other than '0' by ift_font’s cmap table.</c->
  <c- c1># - After executing the "Extend an Incremental Font Subset" algorithm on ift_font with subset_def and stopping at step 6 the</c->
  <c- c1>#   entry list is empty.</c->
</pre>
   <p>Any text from the shaping unit which is not covered by one of the returned spans is not supported by the incremental font and should
be rendered with a fallback font. Each span should be shaped in isolation (ie. each span becomes a new shaping unit).
Because this method splits a shaping unit up, not all features of the original font, such as multi code point substitutions, may be
present. If the client is correctly following the <a data-link-type="abstract-op" href="#abstract-opdef-extend-an-incremental-font-subset" id="ref-for-abstract-opdef-extend-an-incremental-font-subset⑥">Extend an Incremental Font Subset</a> algorithm with a subset definition formed
according to <a href="#target-subset-definitions">§ 4.5 Target Subset Definition</a> then the missing data will be loaded and this case will only occur temporarily while the
relevant patch is loading. Once the missing patch arrives and has been applied the rendering of the affected
code points may change as a result of the substitution.</p>
   <p class="note" role="note"><span class="marker">Note:</span> The "supported_spans(...)" check above should not be used to drive incremental font extension. Target subset definitions for full
executions of <a data-link-type="abstract-op" href="#abstract-opdef-extend-an-incremental-font-subset" id="ref-for-abstract-opdef-extend-an-incremental-font-subset⑦">Extend an Incremental Font Subset</a> should follow the guidelines in <a href="#target-subset-definitions">§ 4.5 Target Subset Definition</a>.</p>
   <h3 class="heading settled algorithm" data-algorithm="Fully Expanding a Font" data-level="4.7" id="fully-expanding-a-font"><span class="secno">4.7. </span><span class="content">Fully Expanding a Font</span><a class="self-link" href="#fully-expanding-a-font"></a></h3>
   <p>This sections defines an algorithm that can be used to transform an incremental font into a fully expanded non-incremental font. This
process loads all available data provided by the incremental font and produces a single static font file that contains no further
patches to be applied.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-fully-expand-a-font-subset">Fully Expand a Font Subset</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>font subset</var>: an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font⑦">incremental</a> <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset⑨">font subset</a>.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>expanded font</var>: an <a data-link-type="biblio" href="#biblio-open-type" title="OpenType Specification">[open-type]</a> font that is not incremental.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Invoke <a data-link-type="abstract-op" href="#abstract-opdef-extend-an-incremental-font-subset" id="ref-for-abstract-opdef-extend-an-incremental-font-subset⑧">Extend an Incremental Font Subset</a> with <var>font subset</var>. The input target subset definition is a special one which
is considered to intersect all entries in the <a data-link-type="abstract-op" href="#abstract-opdef-check-entry-intersection" id="ref-for-abstract-opdef-check-entry-intersection②">Check entry intersection</a> step. Return the resulting font subset as
the <var>expanded font</var>.</p>
   </ol>
   <h3 class="heading settled" data-level="4.8" id="caching-incremental-fonts"><span class="secno">4.8. </span><span class="content">Caching Extended Incremental Fonts</span><a class="self-link" href="#caching-incremental-fonts"></a></h3>
   <p>Incremental fonts that have been extended contain all of the state needed to perform any future extension operations according
to the procedures in this section. So if an incremental font needs to be stored or cached for future use by a client it is sufficient to
store only the font binary produced by the most recent application of the extension algorithm. It is not necessary to retain the initial
font or any versions produced by prior extensions.</p>
   <h2 class="heading settled" data-level="5" id="font-format-extensions"><span class="secno">5. </span><span class="content">Extensions to the Font Format</span><a class="self-link" href="#font-format-extensions"></a></h2>
   <p>An <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font⑧">incremental font</a> follows the existing <a data-link-type="biblio" href="#biblio-open-type" title="OpenType Specification">OpenType</a> format, but includes two new <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">tables</a> identified by the 4-byte tags 'IFT ' and 'IFTX'. These new tables are both <a data-link-type="dfn" href="#patch-map" id="ref-for-patch-map⑤">patch maps</a>. All incremental fonts must contain the 'IFT ' table. The 'IFTX' table is optional. When both tables are
present, the mapping of the font as a whole is the union of the mappings of the two tables. The two new tables are used only in this
specification and are not being added to the <a data-link-type="biblio" href="#biblio-open-type" title="OpenType Specification">Open-Type</a> specification.</p>
   <p class="note" role="note"><span class="marker">Note:</span> allowing the mapping to be split between two distinct tables allows an incremental font to more easily make use of multiple
patch types. For example all patches of one type can be specified in the 'IFT ' table, and all patches of a second type in the
'IFTX' table. Those patches can make updates only to one of the mapping tables and avoid making conflicting updates.</p>
   <h3 class="heading settled" data-level="5.1" id="ift-and-compression"><span class="secno">5.1. </span><span class="content">Incremental Font Transfer and Font Compression Formats</span><a class="self-link" href="#ift-and-compression"></a></h3>
   <p>It is common when using fonts on the web to compress them with a compression format such as <a data-link-type="biblio" href="#biblio-woff" title="WOFF File Format 1.0">[WOFF]</a> or <a data-link-type="biblio" href="#biblio-woff2" title="WOFF File Format 2.0">[WOFF2]</a>. Formats such as
these can be used to compress the initial font file used in an incremental font transfer encoding as long as:</p>
   <ol>
    <li data-md>
     <p>The bytes of each <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a> are unmodified by the process of encoding then decoding the font via the
compression format.</p>
    <li data-md>
     <p>Since the incremental font transfer extension algorithm (<a href="#extending-font-subset">§ 4 Extending a Font Subset</a>) operates specifically on the uncompressed font
file, the compressed font needs to be decoded before attempting to extend it.</p>
   </ol>
   <p>For <a data-link-type="biblio" href="#biblio-woff2" title="WOFF File Format 2.0">[WOFF2]</a> special care must be taken. If an incremental font will be encoded by WOFF2 for transfer:</p>
   <ol>
    <li data-md>
     <p>If the WOFF2 encoding will include a transformed glyf and loca table (<a href="https://www.w3.org/TR/WOFF2/#glyf_table_format"><cite>WOFF 2.0</cite> § 5.1 Transformed glyf table format</a>) then, the incremental
 font should not contain <a href="#table-keyed">§ 6.2 Table Keyed</a> patches which modify either the glyf or loca table. The WOFF2 format does not
 guarantee the specific bytes that result from decoding a transformed glyf and loca table. <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patches may be used
 in conjunction with a transformed glyf and loca table.</p>
    <li data-md>
     <p>The 'IFT ' and 'IFTX' tables can be processed and brotli encoded by a WOFF2 encoder following the standard process defined in <a href="https://www.w3.org/TR/WOFF2/#table_format"><cite>WOFF 2.0</cite> § 5 Compressed data format</a>.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> Given that WOFF2 compression outperforms WOFF even with glyf/loca transformations disabled it is generally recommended
that IFT fonts are compressed using WOFF2, with glyf/loca transformations disabled when the encoding updates those tables using
table-keyed patches.</p>
   <h3 class="heading settled" data-level="5.2" id="cff"><span class="secno">5.2. </span><span class="content">CFF and CFF2 Incremental Fonts</span><a class="self-link" href="#cff"></a></h3>
   <p>For incremental fonts that contain glyph outlines stored in a <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/cff#">CFF</a> or <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/cff2#">CFF2</a> table there are some
additional restrictions:</p>
   <ul>
    <li data-md>
     <p>CFF and CFF2 tables in an incremental font must have the CharStrings INDEX data structure be last element of the
table (followed only by 0 padding to a four-byte word boundary).</p>
    <li data-md>
     <p>CFF and CFF2 tables in an incremental font must not have any other data elements that overlap the CharStrings INDEX data
structure.</p>
    <li data-md>
     <p>The 'IFT ' <a data-link-type="dfn" href="#patch-map" id="ref-for-patch-map⑥">patch map</a> table must contain an offset
(<a data-link-type="dfn" href="#format-1-patch-map-cffcharstringsoffset" id="ref-for-format-1-patch-map-cffcharstringsoffset">cffCharStringsOffset</a>, <a data-link-type="dfn" href="#format-1-patch-map-cff2charstringsoffset" id="ref-for-format-1-patch-map-cff2charstringsoffset">cff2CharStringsOffset</a> <a data-link-type="dfn" href="#format-2-patch-map-cffcharstringsoffset" id="ref-for-format-2-patch-map-cffcharstringsoffset">cffCharStringsOffset</a>, or <a data-link-type="dfn" href="#format-2-patch-map-cff2charstringsoffset" id="ref-for-format-2-patch-map-cff2charstringsoffset">cff2CharStringsOffset</a>)
to the start of the CharStrings INDEX data for the CFF and/or CFF2 table.</p>
   </ul>
   <p>These three requirements allow for the glyph keyed patch application implementation on CFF and CFF2 tables to be significantly
simplified. They allow glyph data to be inserted into CFF/CFF2 tables without changing the offsets to any other data elements
encoded in the CFF/CFF2 table. The stored CFF/CFF2 offsets allow the client to locate the CharStrings INDEX without needing to
parse any other parts of the CFF/CFF2 table.</p>
   <p class="note" role="note"><span class="marker">Note:</span> that in some cases a CFF or CFF2 table may be added or changed by a table keyed patch. In these cases the patch
will need to also add or update the charstrings offset to reflect the new or changed contents.</p>
   <p>CFF or CFF2 subroutinization is compatible with the incremental font transfer. However, naive subroutinization will tend
to reduce patch size while increasing the size of the initial file. Also, WOFF2 has often been shown to compress a
non-subroutinized font more effectively than its subroutinized equivalent (at the cost of a significantly larger
uncompressed file).  Therefore, it is recommended that subroutinzation either be avoided, used moderately, or customized
to the specific needs of IFT.</p>
   <h3 class="heading settled" data-level="5.3" id="patch-map-table"><span class="secno">5.3. </span><span class="content">Patch Map Table</span><a class="self-link" href="#patch-map-table"></a></h3>
   <p>A <a data-link-type="dfn" href="#patch-map" id="ref-for-patch-map⑦">patch map</a> is encoded in one of two formats:</p>
   <ul>
    <li data-md>
     <p>Format 1: a limited, but more compact encoding. It encodes a one-to-one mapping from glyph id to patch URL strings. It does
not support <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition⑥">font subset definitions</a> with design space or entries with overlapping subset definitions.</p>
    <li data-md>
     <p>Format 2: can encode arbitrary mappings including ones with design space or overlapping subset definitions. However, it
is typically less compact than format 1.</p>
   </ul>
   <p>Each format defines an algorithm for interpreting bytes encoded with that format to produce the list of entries it represents. The <a data-link-type="abstract-op" href="#abstract-opdef-extend-an-incremental-font-subset" id="ref-for-abstract-opdef-extend-an-incremental-font-subset⑨">Extend an Incremental Font Subset</a> algorithm invokes the interpretation algorithms and operates on the resulting entry list. The
encoded bytes are the source of truth at all times for the patch map. Patch application during subset extension will alter the encoded
bytes of the patch map and as a result the entry list derived from the encoded bytes will change. The extension algorithm reinterprets
the encoded bytes at the start of every iteration to pick up any changes made in the previous iteration.</p>
   <h4 class="heading settled" data-level="5.3.1" id="patch-map-format-1"><span class="secno">5.3.1. </span><span class="content">Patch Map Table: Format 1</span><a class="self-link" href="#patch-map-format-1"></a></h4>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="format-1-patch-map">Format 1 Patch Map</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-format">format</dfn>
      <td>Set to 1, identifies this as format 1.
     <tr>
      <td>uint24
      <td>reserved
      <td>Not used, set to 0.
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-flags">flags</dfn>
      <td>Flags to signal the presence of optional fields.
        If bit 0 (least significant bit) is set, then <a data-link-type="dfn" href="#format-1-patch-map-cffcharstringsoffset" id="ref-for-format-1-patch-map-cffcharstringsoffset①">cffCharStringsOffset</a> will be present.
        If bit 1 (least significant bit) is set, then <a data-link-type="dfn" href="#format-1-patch-map-cff2charstringsoffset" id="ref-for-format-1-patch-map-cff2charstringsoffset①">cff2CharStringsOffset</a> will be present. 
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-compatibilityid">compatibilityId</dfn>[4]
      <td> Unique ID used to identify patches that are compatible with this font (see <a href="#font-patch-invalidations">§ 4.1 Patch Invalidations</a>). The encoder chooses this
      value. The encoder should set it to a random value which has not previously been used while encoding the IFT font. 
     <tr>
      <td>uint16
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-maxentryindex">maxEntryIndex</dfn>
      <td>The largest entry index encoded in this table.
     <tr>
      <td>uint16
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-maxglyphmapentryindex">maxGlyphMapEntryIndex</dfn>
      <td>The largest <a data-link-type="dfn" href="#glyph-map" id="ref-for-glyph-map">Glyph Map</a> entry index encoded in this table. Must be less than or equal to maxEntryIndex.
     <tr>
      <td>uint24
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-glyphcount">glyphCount</dfn>
      <td>
       Number of glyphs that mappings are provided for.
        Must match the number of glyphs in the the font file. 
       <p class="note" role="note"><span class="marker">Note:</span> the number of glyphs in the font is encoded in the font file. At the time of writing, this value is listed in the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/maxp#">maxp</a> table; however, future font format extensions may use alternate tables to encode the value for number of
        glyphs.</p>
     <tr>
      <td>Offset32
      <td>glyphMapOffset
      <td>Offset to a <a data-link-type="dfn" href="#glyph-map" id="ref-for-glyph-map①">Glyph Map</a> sub table. Offset is from the start of this table.
     <tr>
      <td>Offset32
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-featuremapoffset">featureMapOffset</dfn>
      <td>Offset to a <a data-link-type="dfn" href="#feature-map" id="ref-for-feature-map">Feature Map</a> sub table. Offset is from the start of this table. May be null (0).
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-appliedentriesbitmap">appliedEntriesBitMap</dfn>[(maxEntryIndex + 8)/8]
      <td> A bit map which tracks which entries have been applied. If bit <code>i</code> is set that indicates the patch for entry <code>i</code> has been applied to this font. Bit 0 is the least significant bit of appliedEntriesBitMap[0], while bit 7 is
      the most significant bit. Bit 8 is the least significant bit of appliedEntriesBitMap[1] and so on. 
     <tr>
      <td>uint16
      <td>urlTemplateLength
      <td> Length of the urlTemplate byte array. 
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-urltemplate">urlTemplate</dfn>[urlTemplateLength]
      <td> A byte array containing a <a href="#url-templates">URL Template</a> which is used to produce URL strings associated with each entry. 
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-patchformat">patchFormat</dfn>
      <td> Specifies the format of the patches linked to by urlTemplate.
      Must be set to one of the format numbers from  the <a href="#font-patch-formats-summary">§ 6.1 Formats Summary</a> table. 
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-cffcharstringsoffset">cffCharStringsOffset</dfn>
      <td> Only present if bit 0 (least significant) of <a data-link-type="dfn" href="#format-1-patch-map-flags" id="ref-for-format-1-patch-map-flags">flags</a> is set.
      Gives the offset from the start of the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/CFF#">CFF</a> table to the CharStrings INDEX data structure of the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/CFF#">CFF</a> table. 
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="Format 1 Patch Map" data-dfn-type="dfn" data-noexport id="format-1-patch-map-cff2charstringsoffset">cff2CharStringsOffset</dfn>
      <td> Only present if bit 1 of <a data-link-type="dfn" href="#format-1-patch-map-flags" id="ref-for-format-1-patch-map-flags①">flags</a> is set.
      Gives the offset from the start of the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/CFF#">CFF2</a> table to the CharStrings INDEX data structure of the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/CFF2#">CFF2</a> table. 
   </table>
   <p class="note" role="note"><span class="marker">Note:</span> <a data-link-type="dfn" href="#format-1-patch-map-glyphcount" id="ref-for-format-1-patch-map-glyphcount">glyphCount</a> is designed to be compatible with the
      proposed <a href="https://github.com/harfbuzz/boring-expansion-spec/tree/main">future font format extension</a> to allow for more
      than 65,535 glyphs.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="glyph-map">Glyph Map</dfn> encoding:</p>
   <p>A glyph map table associates each glyph index in the font with an entry index.</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint16
      <td><dfn class="dfn-paneled" data-dfn-for="Glyph Map" data-dfn-type="dfn" data-noexport id="glyph-map-firstmappedglyph">firstMappedGlyph</dfn>
      <td>All glyph indices less than firstMappedGlyph are implicitly mapped to entry index 0.
     <tr>
      <td>uint8/uint16
      <td><dfn class="dfn-paneled" data-dfn-for="Glyph Map" data-dfn-type="dfn" data-noexport id="glyph-map-entryindex">entryIndex</dfn>[<a data-link-type="dfn" href="#format-1-patch-map-glyphcount" id="ref-for-format-1-patch-map-glyphcount①">glyphCount</a> - firstMappedGlyph]
      <td> The entry index for glyph <code>i</code> is stored in entryIndex[<code>i</code> - <a data-link-type="dfn" href="#glyph-map-firstmappedglyph" id="ref-for-glyph-map-firstmappedglyph">firstMappedGlyph</a>]. Array members
      are uint8 if <a data-link-type="dfn" href="#format-1-patch-map-maxentryindex" id="ref-for-format-1-patch-map-maxentryindex">maxEntryIndex</a> is less than 256, otherwise they are uint16. 
   </table>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="feature-map">Feature Map</dfn> encoding:</p>
   <p>A feature map table associates combinations of <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/featuretags#">feature tags</a> and glyphs with an entry index.</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint16
      <td>featureCount
      <td>Number of featureRecords.
     <tr>
      <td><a data-link-type="dfn" href="#featurerecord" id="ref-for-featurerecord">FeatureRecord</a>
      <td><dfn class="dfn-paneled" data-dfn-for="Feature Map" data-dfn-type="dfn" data-noexport id="feature-map-featurerecords">featureRecords</dfn>[featureCount]
      <td> Provides mappings for a specific <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/featuretags#">feature tag</a>. <a data-link-type="dfn" href="#feature-map-featurerecords" id="ref-for-feature-map-featurerecords">featureRecords</a> are sorted by <a data-link-type="dfn" href="#featurerecord-featuretag" id="ref-for-featurerecord-featuretag">featureTag</a> in ascending order with any feature tag occurring at most once. For sorting tag values are interpreted
      as a 4 byte big endian unsigned integer and sorted by the integer value. 
     <tr>
      <td><a data-link-type="dfn" href="#entrymaprecord" id="ref-for-entrymaprecord">EntryMapRecord</a>
      <td><dfn class="dfn-paneled" data-dfn-for="Feature Map" data-dfn-type="dfn" data-noexport id="feature-map-entrymaprecords">entryMapRecords</dfn>[variable]
      <td> Provides the key (entry index) for each feature mapping. The entryMapRecords array contains as many entries as the sum of
      the <a data-link-type="dfn" href="#featurerecord-entrymapcount" id="ref-for-featurerecord-entrymapcount">entryMapCount</a> fields in the <a data-link-type="dfn" href="#feature-map-featurerecords" id="ref-for-feature-map-featurerecords①">featureRecords</a> array, with entryMapRecords[0] corresponding
      to the first entry of featureRecords[0], entryMapRecords[featureRecord[0].entryMapCount] corresponding to the first entry of
      featureRecords[1], entryMapRecords[featureRecords[0].entryMapCount + featureRecord[1].entryMapCount]] corresponding to the
      first entry of featureRecords[2], and so on. 
   </table>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="featurerecord">FeatureRecord</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>Tag
      <td><dfn class="dfn-paneled" data-dfn-for="FeatureRecord" data-dfn-type="dfn" data-noexport id="featurerecord-featuretag">featureTag</dfn>
      <td>The <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/featuretags#">feature tag</a> this mapping is for.
     <tr>
      <td>uint8/uint16
      <td><dfn class="dfn-paneled" data-dfn-for="FeatureRecord" data-dfn-type="dfn" data-noexport id="featurerecord-firstnewentryindex">firstNewEntryIndex</dfn>
      <td> uint8 if <a data-link-type="dfn" href="#format-1-patch-map-maxentryindex" id="ref-for-format-1-patch-map-maxentryindex①">maxEntryIndex</a> is less than 256, otherwise uint16.
      The first entry index this record maps too. 
     <tr>
      <td>uint8/uint16
      <td><dfn class="dfn-paneled" data-dfn-for="FeatureRecord" data-dfn-type="dfn" data-noexport id="featurerecord-entrymapcount">entryMapCount</dfn>
      <td> uint8 if <a data-link-type="dfn" href="#format-1-patch-map-maxentryindex" id="ref-for-format-1-patch-map-maxentryindex②">maxEntryIndex</a> is less than 256, otherwise uint16.
      The number of <a data-link-type="dfn" href="#entrymaprecord" id="ref-for-entrymaprecord①">EntryMapRecord</a>s associated with this feature. 
   </table>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="entrymaprecord">EntryMapRecord</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint8/uint16
      <td><dfn class="dfn-paneled" data-dfn-for="EntryMapRecord" data-dfn-type="dfn" data-noexport id="entrymaprecord-firstentryindex">firstEntryIndex</dfn>
      <td> uint8 if <a data-link-type="dfn" href="#format-1-patch-map-maxentryindex" id="ref-for-format-1-patch-map-maxentryindex③">maxEntryIndex</a> is less than 256, otherwise uint16. firstEntryIndex and lastEntryIndex specify
      the set of <a data-link-type="dfn" href="#glyph-map" id="ref-for-glyph-map②">Glyph Map</a> entries which form the subset definitions for the entries created by this mapping. 
     <tr>
      <td>uint8/uint16
      <td><dfn class="dfn-paneled" data-dfn-for="EntryMapRecord" data-dfn-type="dfn" data-noexport id="entrymaprecord-lastentryindex">lastEntryIndex</dfn>
      <td> uint8 if <a data-link-type="dfn" href="#format-1-patch-map-maxentryindex" id="ref-for-format-1-patch-map-maxentryindex④">maxEntryIndex</a> is less than 256, otherwise uint16. 
   </table>
   <p>An entry map record matches any entry indices that are greater than or equal to firstEntryIndex and less than or equal to  lastEntryIndex.</p>
   <h5 class="heading settled algorithm" data-algorithm="Interpreting Format 1" data-level="5.3.1.1" id="interpreting-patch-map-format-1"><span class="secno">5.3.1.1. </span><span class="content">Interpreting Format 1</span><a class="self-link" href="#interpreting-patch-map-format-1"></a></h5>
   <p>This algorithm is used to convert a format 1 patch map into a list of <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries③">patch map entries</a>.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-interpret-format-1-patch-map">Interpret Format 1 Patch Map</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>patch map</var>: a <a data-link-type="dfn" href="#format-1-patch-map" id="ref-for-format-1-patch-map">Format 1 Patch Map</a> encoded patch map.</p>
    <li data-md>
     <p><var>font subset</var>: the <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⓪">font subset</a> which contains <var>patch map</var>.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>entry list</var>: a list of <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries④">patch map entries</a>.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Check that the <var>patch map</var> data is: complete and not truncated, has <a data-link-type="dfn" href="#format-1-patch-map-format" id="ref-for-format-1-patch-map-format">format</a> equal to 1, and is valid
 according to the requirements in <a href="#patch-map-format-1">§ 5.3.1 Patch Map Table: Format 1</a> (requirements are marked with a "must"). If it is not return an error.</p>
    <li data-md>
     <p>For each unique <var>entry index</var> in <a data-link-type="dfn" href="#glyph-map-entryindex" id="ref-for-glyph-map-entryindex">entryIndex</a>:</p>
     <ul>
      <li data-md>
       <p>If <var>entry index</var> is 0 then, this is a special entry used to mark glyphs which are already in the initial font. Skip this
index and do not build an entry for it.</p>
      <li data-md>
       <p>If the <var>entry index</var> is larger than <a data-link-type="dfn" href="#format-1-patch-map-maxglyphmapentryindex" id="ref-for-format-1-patch-map-maxglyphmapentryindex">maxGlyphMapEntryIndex</a> this entry is invalid, skip this <var>entry index</var>.</p>
      <li data-md>
       <p>If the bit for <var>entry index</var> in <a data-link-type="dfn" href="#format-1-patch-map-appliedentriesbitmap" id="ref-for-format-1-patch-map-appliedentriesbitmap">appliedEntriesBitMap</a> is set to 1, skip this <var>entry index</var>.</p>
      <li data-md>
       <p>Collect the set of glyph indices that map to the <var>entry index</var>.</p>
      <li data-md>
       <p>Convert the set of glyph indices to a set of Unicode code points using the code point to glyph mapping in the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/cmap#">cmap</a> table of <var>font subset</var>. Ignore any glyph indices that are not mapped by <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/cmap#">cmap</a>.
Multiple code points may map to the same glyph id. All code points associated with a glyph should be included.</p>
      <li data-md>
       <p>Convert <var>entry index</var> into a URL string by invoking <a data-link-type="abstract-op" href="#abstract-opdef-expand-url-template" id="ref-for-abstract-opdef-expand-url-template">Expand URL Template</a> with <a data-link-type="dfn" href="#format-1-patch-map-urltemplate" id="ref-for-format-1-patch-map-urltemplate">urlTemplate</a> and <var>entry index</var> as inputs. If the template expansion results in an error (see: <a href="https://www.rfc-editor.org/rfc/rfc6570#section-3">URI Template § section-3</a>) then, return
an error.</p>
      <li data-md>
       <p>If the Unicode code point set is empty then, skip this <var>entry index</var>.</p>
      <li data-md>
       <p>Add an <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries⑤">entry</a> to <var>entry list</var> with a subset definition which contains only the Unicode code point
set and maps to the generated URL string, the patch format specified by <a data-link-type="dfn" href="#format-1-patch-map-patchformat" id="ref-for-format-1-patch-map-patchformat">patchFormat</a>, and <a data-link-type="dfn" href="#format-1-patch-map-compatibilityid" id="ref-for-format-1-patch-map-compatibilityid">compatibilityId</a>.</p>
     </ul>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#format-1-patch-map-featuremapoffset" id="ref-for-format-1-patch-map-featuremapoffset">featureMapOffset</a> is not null then, for each <a data-link-type="dfn" href="#featurerecord" id="ref-for-featurerecord①">FeatureRecord</a> and associated <a data-link-type="dfn" href="#entrymaprecord" id="ref-for-entrymaprecord②">EntryMapRecord</a> in <a data-link-type="dfn" href="#feature-map-featurerecords" id="ref-for-feature-map-featurerecords②">featureRecords</a> and <a data-link-type="dfn" href="#feature-map-entrymaprecords" id="ref-for-feature-map-entrymaprecords">entryMapRecords</a>:</p>
     <ul>
      <li data-md>
       <p>Any <a data-link-type="dfn" href="#featurerecord" id="ref-for-featurerecord②">FeatureRecord’s</a> whose <a data-link-type="dfn" href="#featurerecord-featuretag" id="ref-for-featurerecord-featuretag①">featureTag</a> is less than or equal to a <a data-link-type="dfn" href="#featurerecord-featuretag" id="ref-for-featurerecord-featuretag②">featureTag</a> of any <a data-link-type="dfn" href="#featurerecord" id="ref-for-featurerecord③">FeatureRecord</a> which occurred earlier in the list are invalid. All associated <a data-link-type="dfn" href="#entrymaprecord" id="ref-for-entrymaprecord③">EntryMapRecord’s</a> are
skipped. For ordering, tag values are interpreted as a 4 byte big endian unsigned integer and ordered by the integer value.</p>
      <li data-md>
       <p>Compute <var>mapped entry index</var>, the first <a data-link-type="dfn" href="#entrymaprecord" id="ref-for-entrymaprecord④">EntryMapRecord</a> associated with a <a data-link-type="dfn" href="#featurerecord" id="ref-for-featurerecord④">FeatureRecord</a> is <a data-link-type="dfn" href="#featurerecord-firstnewentryindex" id="ref-for-featurerecord-firstnewentryindex">FeatureRecord::firstNewEntryIndex</a>, the second <a data-link-type="dfn" href="#featurerecord-firstnewentryindex" id="ref-for-featurerecord-firstnewentryindex①">FeatureRecord::firstNewEntryIndex</a> + 1, and so on. The last will be <a data-link-type="dfn" href="#featurerecord-firstnewentryindex" id="ref-for-featurerecord-firstnewentryindex②">FeatureRecord::firstNewEntryIndex</a> + <a data-link-type="dfn" href="#featurerecord-entrymapcount" id="ref-for-featurerecord-entrymapcount①">entryMapCount</a> - 1.</p>
      <li data-md>
       <p>If the computed <var>mapped entry index</var> is less than or equal to <a data-link-type="dfn" href="#format-1-patch-map-maxglyphmapentryindex" id="ref-for-format-1-patch-map-maxglyphmapentryindex①">maxGlyphMapEntryIndex</a> or larger than <a data-link-type="dfn" href="#format-1-patch-map-maxentryindex" id="ref-for-format-1-patch-map-maxentryindex⑤">maxEntryIndex</a> this <a data-link-type="dfn" href="#entrymaprecord" id="ref-for-entrymaprecord⑤">EntryMapRecord</a> is invalid, skip it.</p>
      <li data-md>
       <p>If <a data-link-type="dfn" href="#entrymaprecord-firstentryindex" id="ref-for-entrymaprecord-firstentryindex">EntryMapRecord::firstEntryIndex</a> is greater than <a data-link-type="dfn" href="#entrymaprecord-lastentryindex" id="ref-for-entrymaprecord-lastentryindex">EntryMapRecord::lastEntryIndex</a> this <a data-link-type="dfn" href="#entrymaprecord" id="ref-for-entrymaprecord⑥">EntryMapRecord</a> is invalid, skip it.</p>
      <li data-md>
       <p>Convert <var>mapped entry index</var> into a URL string by invoking <a data-link-type="abstract-op" href="#abstract-opdef-expand-url-template" id="ref-for-abstract-opdef-expand-url-template①">Expand URL Template</a> with <a data-link-type="dfn" href="#format-1-patch-map-urltemplate" id="ref-for-format-1-patch-map-urltemplate①">urlTemplate</a> and <var>mapped entry index</var> as inputs. If the template expansion results in an error (see: <a href="https://www.rfc-editor.org/rfc/rfc6570#section-3">URI Template § section-3</a>) then,
return an error.</p>
      <li data-md>
       <p>If the bit for <var>mapped entry index</var> in <a data-link-type="dfn" href="#format-1-patch-map-appliedentriesbitmap" id="ref-for-format-1-patch-map-appliedentriesbitmap①">appliedEntriesBitMap</a> is set to 1, skip this entry.</p>
      <li data-md>
       <p>Construct a set of Unicode code points. For each <var>entry index</var> between <a data-link-type="dfn" href="#entrymaprecord-firstentryindex" id="ref-for-entrymaprecord-firstentryindex①">EntryMapRecord::firstEntryIndex</a> (inclusive) and <a data-link-type="dfn" href="#entrymaprecord-lastentryindex" id="ref-for-entrymaprecord-lastentryindex①">EntryMapRecord::lastEntryIndex</a> (inclusive):</p>
       <ul>
        <li data-md>
         <p>If <var>entry index</var> is greater than <a data-link-type="dfn" href="#format-1-patch-map-maxglyphmapentryindex" id="ref-for-format-1-patch-map-maxglyphmapentryindex②">maxGlyphMapEntryIndex</a> then, this <a data-link-type="dfn" href="#entrymaprecord" id="ref-for-entrymaprecord⑦">EntryMapRecord</a> is invalid
skip it.</p>
        <li data-md>
         <p>Add the set of Unicode code points associated with <var>entry index</var> that was computed in step 2 to the set. If the <var>entry index</var> was skipped because it was 0 or <a data-link-type="dfn" href="#format-1-patch-map-appliedentriesbitmap" id="ref-for-format-1-patch-map-appliedentriesbitmap②">appliedEntriesBitMap</a> compute the set of
associated code points as if it wasn’t skipped.</p>
       </ul>
      <li data-md>
       <p>If the constructed set of Unicode code points is empty then, this <a data-link-type="dfn" href="#entrymaprecord" id="ref-for-entrymaprecord⑧">EntryMapRecord</a> is invalid skip it.</p>
      <li data-md>
       <p>Add an <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries⑥">entry</a> to <var>entry list</var> which  maps to the generated URL string, the patch format
specified by <a data-link-type="dfn" href="#format-1-patch-map-patchformat" id="ref-for-format-1-patch-map-patchformat①">patchFormat</a>, and <a data-link-type="dfn" href="#format-1-patch-map-compatibilityid" id="ref-for-format-1-patch-map-compatibilityid①">compatibilityId</a>; or if there is an existing <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries⑦">entry</a> in <var>entry list</var> which has the same patch URL string as the generated URL string then
instead modify the existing entry. Add the constructed set of Unicode code points and <a data-link-type="dfn" href="#featurerecord-featuretag" id="ref-for-featurerecord-featuretag③">featureTag</a> to the new or
existing entry’s subset definition.</p>
     </ul>
    <li data-md>
     <p>Return <var>entry list</var>.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> while an encoding is not required to include entries for all entry indices in [0, <a data-link-type="dfn" href="#format-1-patch-map-maxentryindex" id="ref-for-format-1-patch-map-maxentryindex⑥">maxEntryIndex</a>], it is
recommended that it do so for maximum compactness.</p>
   <h5 class="heading settled algorithm" data-algorithm="Remove Entries from Format 1" data-level="5.3.1.2" id="remove-entries-format-1"><span class="secno">5.3.1.2. </span><span class="content">Remove Entries from Format 1</span><a class="self-link" href="#remove-entries-format-1"></a></h5>
   <p>This algorithm is used to remove entries from a format 1 patch map. This removal modifies the bytes of the patch map but does not
change the number of bytes.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-remove-entries-from-format-1-patch-map">Remove Entries from Format 1 Patch Map</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>patch map</var>: a <a data-link-type="dfn" href="#format-1-patch-map" id="ref-for-format-1-patch-map①">Format 1 Patch Map</a> encoded patch map. May be modified by this procedure.</p>
    <li data-md>
     <p><var>patch URL string</var>: URL string for a patch which identifies the entries to be removed.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Check that the <var>patch map</var> has <a data-link-type="dfn" href="#format-1-patch-map-format" id="ref-for-format-1-patch-map-format①">format</a> equal to 1 and is valid according to the requirements in <a href="#patch-map-format-1">§ 5.3.1 Patch Map Table: Format 1</a>. If it is not return an error.</p>
    <li data-md>
     <p>For each unique <var>entry index</var> in <a data-link-type="dfn" href="#glyph-map-entryindex" id="ref-for-glyph-map-entryindex①">entryIndex</a> of <var>patch map</var>:</p>
     <ul>
      <li data-md>
       <p>If the bit for <var>entry index</var> in <a data-link-type="dfn" href="#format-1-patch-map-appliedentriesbitmap" id="ref-for-format-1-patch-map-appliedentriesbitmap③">appliedEntriesBitMap</a> is set to 1, skip this <var>entry index</var>.</p>
      <li data-md>
       <p>Convert <var>entry index</var> into a URL string by invoking <a data-link-type="abstract-op" href="#abstract-opdef-expand-url-template" id="ref-for-abstract-opdef-expand-url-template②">Expand URL Template</a> with <a data-link-type="dfn" href="#format-1-patch-map-urltemplate" id="ref-for-format-1-patch-map-urltemplate②">urlTemplate</a> and <var>entry index</var> as inputs. If the template expansion results in an error (see: <a href="https://www.rfc-editor.org/rfc/rfc6570#section-3">URI Template § section-3</a>) then, return
an error.</p>
      <li data-md>
       <p>If the generated URL string is equal to <var>patch URL string</var> then set the bit for <var>entry index</var> in <a data-link-type="dfn" href="#format-1-patch-map-appliedentriesbitmap" id="ref-for-format-1-patch-map-appliedentriesbitmap④">appliedEntriesBitMap</a> to 1.</p>
     </ul>
   </ol>
   <h4 class="heading settled" data-level="5.3.2" id="patch-map-format-2"><span class="secno">5.3.2. </span><span class="content">Patch Map Table: Format 2</span><a class="self-link" href="#patch-map-format-2"></a></h4>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="format-2-patch-map">Format 2 Patch Map</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Format 2 Patch Map" data-dfn-type="dfn" data-noexport id="format-2-patch-map-format">format</dfn>
      <td>Set to 2, identifies this as format 2.
     <tr>
      <td>uint24
      <td>reserved
      <td>Not used, set to 0.
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Format 2 Patch Map" data-dfn-type="dfn" data-noexport id="format-2-patch-map-flags">flags</dfn>
      <td>Flags to signal the presence of optional fields.
        If bit 0 (least significant bit) is set, then <a data-link-type="dfn" href="#format-2-patch-map-cffcharstringsoffset" id="ref-for-format-2-patch-map-cffcharstringsoffset①">cffCharStringsOffset</a> will be present.
        If bit 1 (least significant bit) is set, then <a data-link-type="dfn" href="#format-2-patch-map-cff2charstringsoffset" id="ref-for-format-2-patch-map-cff2charstringsoffset①">cff2CharStringsOffset</a> will be present. 
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="Format 2 Patch Map" data-dfn-type="dfn" data-noexport id="format-2-patch-map-compatibilityid">compatibilityId</dfn>[4]
      <td> Unique ID used to identify patches that are compatible with this font (see <a href="#font-patch-invalidations">§ 4.1 Patch Invalidations</a>). The encoder chooses this
      value. The encoder should set it to a random value which has not previously been used while encoding the IFT font. 
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Format 2 Patch Map" data-dfn-type="dfn" data-noexport id="format-2-patch-map-defaultpatchformat">defaultPatchFormat</dfn>
      <td> Specifies the format of the patches linked to by urlTemplate (unless overridden by an entry).
      Must be set to one of the format numbers from the <a href="#font-patch-formats-summary">§ 6.1 Formats Summary</a> table. 
     <tr>
      <td>uint24
      <td><dfn class="dfn-paneled" data-dfn-for="Format 2 Patch Map" data-dfn-type="dfn" data-noexport id="format-2-patch-map-entrycount">entryCount</dfn>
      <td>Number of entries encoded in this table.
     <tr>
      <td>Offset32
      <td><dfn class="dfn-paneled" data-dfn-for="Format 2 Patch Map" data-dfn-type="dfn" data-noexport id="format-2-patch-map-entries">entries</dfn>
      <td>Offset to a <a data-link-type="dfn" href="#mapping-entries" id="ref-for-mapping-entries">Mapping Entries</a> sub table. Offset is from the start of this table.
     <tr>
      <td>Offset32
      <td><dfn class="dfn-paneled" data-dfn-for="Format 2 Patch Map" data-dfn-type="dfn" data-noexport id="format-2-patch-map-entryidstringdata">entryIdStringData</dfn>
      <td> Offset to a block of data containing the concatentation of all of the entry ID strings.
      May be null (0). Offset is from the start of this table. 
     <tr>
      <td>uint16
      <td>urlTemplateLength
      <td> Length of the urlTemplate byte array. 
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Format 2 Patch Map" data-dfn-type="dfn" data-noexport id="format-2-patch-map-urltemplate">urlTemplate</dfn>[urlTemplateLength]
      <td> A byte array containing a <a href="#url-templates">URL Template</a> which is used to produce URL strings associated with each entry. 
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="Format 2 Patch Map" data-dfn-type="dfn" data-noexport id="format-2-patch-map-cffcharstringsoffset">cffCharStringsOffset</dfn>
      <td> Only present if bit 0 (least significant) of <a data-link-type="dfn" href="#format-2-patch-map-flags" id="ref-for-format-2-patch-map-flags">flags</a> is set.
      Gives the offset from the start of the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/CFF#">CFF</a> table to the CharStrings INDEX data structure of the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/CFF#">CFF</a> table. 
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="Format 2 Patch Map" data-dfn-type="dfn" data-noexport id="format-2-patch-map-cff2charstringsoffset">cff2CharStringsOffset</dfn>
      <td> Only present if bit 1 of <a data-link-type="dfn" href="#format-2-patch-map-flags" id="ref-for-format-2-patch-map-flags①">flags</a> is set.
      Gives the offset from the start of the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/CFF#">CFF2</a> table to the CharStrings INDEX data structure of the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/CFF2#">CFF2</a> table. 
   </table>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="mapping-entries">Mapping Entries</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entries" data-dfn-type="dfn" data-noexport id="mapping-entries-entries">entries</dfn>[variable]
      <td>Byte array containing the encoded bytes of <a data-link-type="dfn" href="#format-2-patch-map-entrycount" id="ref-for-format-2-patch-map-entrycount">entryCount</a> <a data-link-type="dfn" href="#mapping-entry" id="ref-for-mapping-entry">Mapping Entry</a>’s. Each entry has a variable
        length, which is determined following <a data-link-type="abstract-op" href="#abstract-opdef-interpret-format-2-patch-map-entry" id="ref-for-abstract-opdef-interpret-format-2-patch-map-entry">Interpret Format 2 Patch Map Entry</a>.
   </table>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="mapping-entry">Mapping Entry</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-formatflags">formatFlags</dfn>
      <td> A bit field. Bit 0 (least significant bit) through bit 5 indicate the presence of optional fields. If bit 6 is set this entry is
      ignored. Bit 7 is reserved for future use and set to 0. 
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-featurecount">featureCount</dfn>
      <td> Number of feature tags in the featureTags list. Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags">formatFlags</a> bit 0 is set. 
     <tr>
      <td>Tag
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-featuretags">featureTags</dfn>[featureCount]
      <td> List of <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/featuretags#">feature tags</a> in the entry’s <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition⑦">font subset definition</a>. Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①">formatFlags</a> bit 0 is set. 
     <tr>
      <td>uint16
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-designspacecount">designSpaceCount</dfn>
      <td> Number of elements in the design space list. Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags②">formatFlags</a> bit 0 is set. 
     <tr>
      <td><a data-link-type="dfn" href="#design-space-segment" id="ref-for-design-space-segment">Design Space Segment</a>
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-designspacesegments">designSpaceSegments</dfn>[designSpaceCount]
      <td> List of design space segments in the entry’s <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition⑧">font subset definition</a>. Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags③">formatFlags</a> bit 0 is set. 
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-childentrymatchmodeandcount">childEntryMatchModeAndCount</dfn>
      <td> This and the following field are used to add conditions to the intersection check for this entry that depend on whether prior entries intersect.
      The most significant bit is used to indicate the matching mode. If the bit is set the condition is conjunctive otherwise it is disjunctive. The
      remaining 7 bits are interpreted as a unsigned integer and represent the number of entry indices in the childEntryIndices list. This field is only
      present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags④">formatFlags</a> bit 1 is set. 
     <tr>
      <td>uint24
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-childentryindices">childEntryIndices</dfn>[0b01111111 &amp; childEntryMatchModeAndCount]
      <td> Each value is the index of an entry in <a data-link-type="dfn" href="#mapping-entries-entries" id="ref-for-mapping-entries-entries②">entries</a> array whose intersection will be checked to determine this entries intersection.
      Only entries that occurred prior to this <a data-link-type="dfn" href="#mapping-entry" id="ref-for-mapping-entry①">Mapping Entry</a> in <a data-link-type="dfn" href="#mapping-entries-entries" id="ref-for-mapping-entries-entries③">entries</a> can be referenced. Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags⑤">formatFlags</a> bit 1 is set. 
     <tr>
      <td>int24
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-entryiddelta">entryIdDelta</dfn>[variable]
      <td> List of signed deltas which calculate the IDs of the URL strings for this entry. If present, has at least one delta. If the least
      significant bit of a delta is set, then one more delta follows. This repeats until a delta with the least significant bit
      cleared is encountered. The entry id for each delta is the last calculated entry id + 1 + floor(entryIdDelta / 2). Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags⑥">formatFlags</a> bit 2 is set and <a data-link-type="dfn" href="#format-2-patch-map-entryidstringdata" id="ref-for-format-2-patch-map-entryidstringdata">entryIdStringData</a> is null (0).
      If not present and <a data-link-type="dfn" href="#format-2-patch-map-entryidstringdata" id="ref-for-format-2-patch-map-entryidstringdata①">entryIdStringData</a> is null (0), then there is one id for this entry and the
      delta is assumed to be 0. 
     <tr>
      <td>uint24
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-entryidstringlength">entryIdStringLength</dfn>[variable]
      <td> The number of bytes that each id string for this entry occupies in the <a data-link-type="dfn" href="#format-2-patch-map-entryidstringdata" id="ref-for-format-2-patch-map-entryidstringdata②">entryIdStringData</a> data block.  If the most significant bit of a length value is set, then another length value follows. This repeats
      until a length value with the most significant bit cleared is encountered. The actual length value is stored in
      the least significant 23 bits of each value. Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags⑦">formatFlags</a> bit 2 is set and <a data-link-type="dfn" href="#format-2-patch-map-entryidstringdata" id="ref-for-format-2-patch-map-entryidstringdata③">entryIdStringData</a> is not null (0). If present has at least one length value. If not present
      and <a data-link-type="dfn" href="#format-2-patch-map-entryidstringdata" id="ref-for-format-2-patch-map-entryidstringdata④">entryIdStringData</a> is not null (0), then the there is one id string which is set to the last
      id string from the previous entry or an empty string for the first entry. 
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-patchformat">patchFormat</dfn>
      <td> Specifies the format of the patch linked to by this entry. Uses the ID numbers from the <a href="#font-patch-formats-summary">§ 6.1 Formats Summary</a> table.
      Overrides <a data-link-type="dfn" href="#format-2-patch-map-defaultpatchformat" id="ref-for-format-2-patch-map-defaultpatchformat">defaultPatchFormat</a>.
      Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags⑧">formatFlags</a> bit 3 is set. 
     <tr>
      <td>uint16/uint24
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-bias">bias</dfn>
      <td> Bias value which is added to all code point values in the code points set.
      If format bit 4 is 0 and bit 5 is 1, then this is present and a uint16.
      If format bit 4 is 1 and bit 5 is 1, then this is present and a uint24.
      Otherwise it is not present. 
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Mapping Entry" data-dfn-type="dfn" data-noexport id="mapping-entry-codepoints">codePoints</dfn>[variable]
      <td> Set of code points for this mapping. Encoded as a <a data-link-type="dfn" href="#sparse-bit-set" id="ref-for-sparse-bit-set">Sparse Bit Set</a>.
      Only present if <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags⑨">formatFlags</a> bit 4 and/or 5 is set. The length is
      determined by following the decoding procedures in <a href="#sparse-bit-set-decoding">§ 5.3.2.3 Sparse Bit Set</a>. 
   </table>
   <p>If an encoder is producing patches that will be stored on a file system and then served it’s recommended that only numeric entry IDs be
used (via <a data-link-type="dfn" href="#mapping-entry-entryiddelta" id="ref-for-mapping-entry-entryiddelta">entryIdDelta</a>) as these will generally produce the smallest encoding of the format 2 patch map. String IDs
are useful in cases where patches are not being stored in advance and the ID strings can be then used to encode information about the patch
being requested.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="design-space-segment">Design Space Segment</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>Tag
      <td><dfn class="dfn-paneled" data-dfn-for="Design Space Segment" data-dfn-type="dfn" data-noexport id="design-space-segment-tag">tag</dfn>
      <td> Axis tag value. 
     <tr>
      <td>Fixed
      <td><dfn class="dfn-paneled" data-dfn-for="Design Space Segment" data-dfn-type="dfn" data-noexport id="design-space-segment-start">start</dfn>
      <td> Start (inclusive) of the segment. This value uses the user axis scale: <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otvaroverview#coordinate-scales-and-normalization">OpenType Specification § otvaroverview#coordinate-scales-and-normalization</a>. 
     <tr>
      <td>Fixed
      <td><dfn class="dfn-paneled" data-dfn-for="Design Space Segment" data-dfn-type="dfn" data-noexport id="design-space-segment-end">end</dfn>
      <td> End (inclusive) of the segment. Must be greater than or equal to start. This value uses the user axis scale: <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otvaroverview#coordinate-scales-and-normalization">OpenType Specification § otvaroverview#coordinate-scales-and-normalization</a>. 
   </table>
   <h5 class="heading settled algorithm" data-algorithm="Interpreting Format 2" data-level="5.3.2.1" id="interpreting-patch-map-format-2"><span class="secno">5.3.2.1. </span><span class="content">Interpreting Format 2</span><a class="self-link" href="#interpreting-patch-map-format-2"></a></h5>
   <p>This algorithm is used to convert a format 2 <a data-link-type="dfn" href="#patch-map" id="ref-for-patch-map⑧">patch map</a> into a list of <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries⑧">patch map entries</a>.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-interpret-format-2-patch-map">Interpret Format 2 Patch Map</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>patch map</var>: a <a data-link-type="dfn" href="#format-2-patch-map" id="ref-for-format-2-patch-map">Format 2 Patch Map</a> encoded <a data-link-type="dfn" href="#patch-map" id="ref-for-patch-map⑨">patch map</a>.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>entry list</var>: a list of <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries⑨">patch map entries</a>.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Check that the <var>patch map</var> has <a data-link-type="dfn" href="#format-2-patch-map-format" id="ref-for-format-2-patch-map-format">format</a> equal to 2 and is valid according to the requirements in <a href="#patch-map-format-2">§ 5.3.2 Patch Map Table: Format 2</a> (requirements are marked with a "must"). If it is not return an error.</p>
    <li data-md>
     <p>If the <a data-link-type="dfn" href="#format-2-patch-map-entryidstringdata" id="ref-for-format-2-patch-map-entryidstringdata⑤">entryIdStringData</a> offset is 0 then initialize <var>last entry id</var> to 0. Otherwise initialize
 it to an empty byte string. Set <var>current byte</var> to 0, and <var>current id string byte</var> to 0.</p>
    <li data-md>
     <p>Initialize <var>entry list</var> and <var>prior entry list</var> to empty lists.</p>
    <li data-md>
     <p>Invoke <a data-link-type="abstract-op" href="#abstract-opdef-interpret-format-2-patch-map-entry" id="ref-for-abstract-opdef-interpret-format-2-patch-map-entry①">Interpret Format 2 Patch Map Entry</a>, <a data-link-type="dfn" href="#format-2-patch-map-entrycount" id="ref-for-format-2-patch-map-entrycount①">entryCount</a> times. For each invocation:</p>
     <ul>
      <li data-md>
       <p>pass in <var>prior entry list</var>, the bytes from <var>patch map</var> starting from <a data-link-type="dfn" href="#format-2-patch-map-entries" id="ref-for-format-2-patch-map-entries">entries</a>[<var>current byte</var>] to
 the end of <var>patch map</var>,
 the bytes from <var>patch map</var> starting from <a data-link-type="dfn" href="#format-2-patch-map-entryidstringdata" id="ref-for-format-2-patch-map-entryidstringdata⑥">entryIdStringData</a>[<var>current id string byte</var>]
 to the end of <var>patch map</var> if <a data-link-type="dfn" href="#format-2-patch-map-entryidstringdata" id="ref-for-format-2-patch-map-entryidstringdata⑦">entryIdStringData</a> is non zero, <var>last entry id</var>, <a data-link-type="dfn" href="#format-2-patch-map-defaultpatchformat" id="ref-for-format-2-patch-map-defaultpatchformat①">defaultPatchFormat</a>, and <a data-link-type="dfn" href="#format-2-patch-map-urltemplate" id="ref-for-format-2-patch-map-urltemplate">urlTemplate</a>.</p>
      <li data-md>
       <p>Set <var>last entry id</var> to the returned entry id.</p>
      <li data-md>
       <p>Add the returned consumed byte count to <var>current byte</var>.</p>
      <li data-md>
       <p>Add the returned consumed id string byte count to <var>current id string byte</var>.</p>
      <li data-md>
       <p>Add the returned entry to <var>prior entry list</var>.</p>
      <li data-md>
       <p>If the returned value of ignored is false, then set the compatibility ID of the returned entry to <a data-link-type="dfn" href="#format-2-patch-map-compatibilityid" id="ref-for-format-2-patch-map-compatibilityid">compatibilityId</a> and add the  entry to <var>entry list</var>.</p>
     </ul>
    <li data-md>
     <p>Return <var>entry list</var>.</p>
   </ol>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-interpret-format-2-patch-map-entry">Interpret Format 2 Patch Map Entry</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>prior entry list</var>: a list of entries prior to this one.</p>
    <li data-md>
     <p><var>entry bytes</var>: a byte array that contains an encoded <a data-link-type="dfn" href="#mapping-entry" id="ref-for-mapping-entry②">Mapping Entry</a>.</p>
    <li data-md>
     <p><var>id string bytes</var> (optional): a byte array the contains entry ID strings.</p>
    <li data-md>
     <p><var>last entry id</var>: the last generated entry id.</p>
    <li data-md>
     <p><var>default patch format</var>: the default patch format if one isn’t specified.</p>
    <li data-md>
     <p><var>url template</var>: the URL template used to locate patches.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>entry id</var>: the last generated numeric or string id of this entry.</p>
    <li data-md>
     <p><var>entry</var>: a single <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries①⓪">entry</a>.</p>
    <li data-md>
     <p><var>consumed bytes</var>: the number of bytes used to encode the entry.</p>
    <li data-md>
     <p><var>consumed id string bytes</var>: the number of bytes used to encode the entry id string.</p>
    <li data-md>
     <p><var>ignored</var>: if true, then this entry should be ignored.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>For the all steps whenever data is loaded from <var>entry bytes</var> increment <var>consumed bytes</var> with the
 number of bytes read.</p>
    <li data-md>
     <p>Set <var>entry id</var> = <var>last entry id</var>, <var>consumed id string bytes</var> = 0.</p>
    <li data-md>
     <p>Set the patch format of <var>entry</var> to <var>default patch format</var>.</p>
    <li data-md>
     <p>Add a single <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition⑨">font subset definition</a> to <var>entry</var> with all sets initialized to be empty.</p>
    <li data-md>
     <p>Read <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①⓪">formatFlags</a> from <var>entry bytes</var>.</p>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①①">formatFlags</a> bit 0 is set, then the feature tag and design space lists are present:</p>
     <ul>
      <li data-md>
       <p>Read the feature tag list specified by <a data-link-type="dfn" href="#mapping-entry-featurecount" id="ref-for-mapping-entry-featurecount">featureCount</a> and <a data-link-type="dfn" href="#mapping-entry-featuretags" id="ref-for-mapping-entry-featuretags">featureTags</a> from <var>entry bytes</var> and add the loaded tags to the first <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition①⓪">font subset definition</a> in <var>entry</var>.</p>
      <li data-md>
       <p>Read the design space segment list specified by <a data-link-type="dfn" href="#mapping-entry-designspacecount" id="ref-for-mapping-entry-designspacecount">designSpaceCount</a> and <a data-link-type="dfn" href="#mapping-entry-designspacesegments" id="ref-for-mapping-entry-designspacesegments">designSpaceSegments</a> from <var>entry bytes</var> and add the design space segments to the first <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition①①">font subset definition</a> in <var>entry</var>. Each
segment defines an interval from <a data-link-type="dfn" href="#design-space-segment-start" id="ref-for-design-space-segment-start">start</a> to <a data-link-type="dfn" href="#design-space-segment-end" id="ref-for-design-space-segment-end">end</a> inclusive for the axis identified
by <a data-link-type="dfn" href="#design-space-segment-tag" id="ref-for-design-space-segment-tag">tag</a>. If any segment has a <a data-link-type="dfn" href="#design-space-segment-start" id="ref-for-design-space-segment-start①">start</a> which is greater than <a data-link-type="dfn" href="#design-space-segment-end" id="ref-for-design-space-segment-end①">end</a> then, this encoding is invalid return an error.</p>
     </ul>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①②">formatFlags</a> bit 1 is set, then the copy indices list is present:</p>
     <ul>
      <li data-md>
       <p>If the most significant bit of <a data-link-type="dfn" href="#mapping-entry-childentrymatchmodeandcount" id="ref-for-mapping-entry-childentrymatchmodeandcount">childEntryMatchModeAndCount</a> is set then set <var>entry</var>’s match mode to conjunctive,
 otherwise to disjunctive.</p>
      <li data-md>
       <p>Read the child entry indices list specified by <a data-link-type="dfn" href="#mapping-entry-childentrymatchmodeandcount" id="ref-for-mapping-entry-childentrymatchmodeandcount①">childEntryMatchModeAndCount</a> and <a data-link-type="dfn" href="#mapping-entry-childentryindices" id="ref-for-mapping-entry-childentryindices">childEntryIndices</a> from <var>entry bytes</var>.</p>
      <li data-md>
       <p>The child entry indices refer to previously loaded entries. 0 is the first <a data-link-type="dfn" href="#mapping-entry" id="ref-for-mapping-entry③">Mapping Entry</a> in <var>prior entry list</var>, 1 the second
 and so on. For each value in <a data-link-type="dfn" href="#mapping-entry-childentryindices" id="ref-for-mapping-entry-childentryindices①">childEntryIndices</a> locate the entry in <var>prior entry list</var> with a matching index.
 Add a reference to that entry into <var>entry</var>. If a <a data-link-type="dfn" href="#mapping-entry-childentryindices" id="ref-for-mapping-entry-childentryindices②">childEntryIndices</a> is greater than or equal to the length
 of <var>prior entry list</var> then, this encoding is invalid return an error.</p>
     </ul>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①③">formatFlags</a> bit 2 is set, then id deltas or id string lengths are present:</p>
     <ul>
      <li data-md>
       <p>If <var>id string bytes</var> is not present, then:</p>
       <ul>
        <li data-md>
         <p>Read the next <a data-link-type="dfn" href="#mapping-entry-entryiddelta" id="ref-for-mapping-entry-entryiddelta①">entryIdDelta</a> value.</p>
        <li data-md>
         <p>Set <var>entry id</var> to <code><var>entry id</var> + 1 + floor(delta value / 2)</code>.
 If <var>entry id</var> is negative or greater than 4,294,967,295 then, this encoding is invalid return an error.</p>
        <li data-md>
         <p>Convert <var>entry id</var> into a URL string by invoking <a data-link-type="abstract-op" href="#abstract-opdef-expand-url-template" id="ref-for-abstract-opdef-expand-url-template③">Expand URL Template</a> with <var>url template</var> and <var>entry id</var> as inputs. If the template expansion results in an error (see: <a href="https://www.rfc-editor.org/rfc/rfc6570#section-3">URI Template § section-3</a>)
 then, return an error.</p>
        <li data-md>
         <p>Add the generated patch URL string to <var>entry</var>.</p>
        <li data-md>
         <p>If the least significant bit of the read delta value is set, then repeat step 8.</p>
       </ul>
      <li data-md>
       <p>Otherwise if <var>id string bytes</var> is present, then:</p>
       <ul>
        <li data-md>
         <p>Read the next <a data-link-type="dfn" href="#mapping-entry-entryidstringlength" id="ref-for-mapping-entry-entryidstringlength">entryIdStringLength</a> value.</p>
        <li data-md>
         <p>Interpret the least significant 23 bits as an unsigned integer and read that many bytes from <var>id string bytes</var>.
 Set <var>entry id</var> to the result. Increment <var>consumed id string bytes</var> by the number of bytes read.</p>
        <li data-md>
         <p>Convert <var>entry id</var> into a URL string by invoking <a data-link-type="abstract-op" href="#abstract-opdef-expand-url-template" id="ref-for-abstract-opdef-expand-url-template④">Expand URL Template</a> with <var>url template</var> and <var>entry id</var> as inputs. If the template expansion results in an error (see: <a href="https://www.rfc-editor.org/rfc/rfc6570#section-3">URI Template § section-3</a>)
 then, return an error.</p>
        <li data-md>
         <p>Add the generated patch URL string to <var>entry</var>.</p>
        <li data-md>
         <p>If the most significant bit of the read length value is set, then repeat step 8.</p>
       </ul>
     </ul>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①④">formatFlags</a> bit 2 is not set:</p>
     <ul>
      <li data-md>
       <p>If <var>id string bytes</var> is not present, then:</p>
       <ul>
        <li data-md>
         <p>Set <var>entry id</var> to <var>entry id</var> + 1.</p>
        <li data-md>
         <p>Convert <var>entry id</var> into a URL string by invoking <a data-link-type="abstract-op" href="#abstract-opdef-expand-url-template" id="ref-for-abstract-opdef-expand-url-template⑤">Expand URL Template</a> with <var>url template</var> and <var>entry id</var> as inputs. If the template expansion results in an error (see: <a href="https://www.rfc-editor.org/rfc/rfc6570#section-3">URI Template § section-3</a>)
 then, return an error.</p>
        <li data-md>
         <p>Add the generated patch URL string to <var>entry</var>.</p>
       </ul>
      <li data-md>
       <p>Otherwise if <var>id string bytes</var> is present, then:</p>
       <ul>
        <li data-md>
         <p>Convert <var>entry id</var> into a URL string by invoking <a data-link-type="abstract-op" href="#abstract-opdef-expand-url-template" id="ref-for-abstract-opdef-expand-url-template⑥">Expand URL Template</a> with <var>url template</var> and <var>entry id</var> as inputs. If the template expansion results in an error (see: <a href="https://www.rfc-editor.org/rfc/rfc6570#section-3">URI Template § section-3</a>)
 then, return an error.</p>
        <li data-md>
         <p>Add the generated patch URL string to <var>entry</var>.</p>
       </ul>
     </ul>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①⑤">formatFlags</a> bit 3 is set, then a patch format is present. Read the format specified by <a data-link-type="dfn" href="#mapping-entry-patchformat" id="ref-for-mapping-entry-patchformat">patchFormat</a> from <var>entry bytes</var> and set the patch format of <var>entry</var> to the read value.
 If <a data-link-type="dfn" href="#mapping-entry-patchformat" id="ref-for-mapping-entry-patchformat①">patchFormat</a> is not one of the values in <a href="#font-patch-formats-summary">§ 6.1 Formats Summary</a> then, this encoding is invalid
 return an error.</p>
    <li data-md>
     <p>If one or both of <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①⑥">formatFlags</a> bit 4 and bit 5 are set, then a code point list is present:</p>
     <ul>
      <li data-md>
       <p>If <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①⑦">formatFlags</a> bit 4 is 0 and bit 5 is 1, then read the 2 byte (uint16) <a data-link-type="dfn" href="#mapping-entry-bias" id="ref-for-mapping-entry-bias">bias</a> value
from <var>entry bytes</var>.</p>
      <li data-md>
       <p>If <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①⑧">formatFlags</a> bit 4 is 1 and bit 5 is 1, then read the 3 byte (uint24) <a data-link-type="dfn" href="#mapping-entry-bias" id="ref-for-mapping-entry-bias①">bias</a> value
from <var>entry bytes</var>.</p>
      <li data-md>
       <p>Otherwise the bias is 0.</p>
      <li data-md>
       <p>Read the sparse bit set <a data-link-type="dfn" href="#mapping-entry-codepoints" id="ref-for-mapping-entry-codepoints">codePoints</a> from <var>entry bytes</var> with bias following <a href="#sparse-bit-set-decoding">§ 5.3.2.3 Sparse Bit Set</a>.
Add the resulting code point set to the first <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition①②">font subset definition</a> in <var>entry</var>. If the sparse bit set decoding
failed then, this encoding is invalid return an error.</p>
     </ul>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags①⑨">formatFlags</a> bit 6 is set, then set <var>ignored</var> to true. Otherwise <var>ignored</var> is false.</p>
    <li data-md>
     <p>Return <var>entry id</var>, <var>entry</var>, <var>consumed bytes</var>, <var>consumed id string bytes</var>, and <var>ignored</var>.</p>
   </ol>
   <h5 class="heading settled algorithm" data-algorithm="Remove Entries from Format 2" data-level="5.3.2.2" id="remove-entries-format-2"><span class="secno">5.3.2.2. </span><span class="content">Remove Entries from Format 2</span><a class="self-link" href="#remove-entries-format-2"></a></h5>
   <p>This algorithm is used to remove entries from a format 2 patch map. This removal modifies the bytes of the patch map but does not
change the number of bytes.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-remove-entries-from-format-2-patch-map">Remove Entries from Format 2 Patch Map</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>patch map</var>: a <a data-link-type="dfn" href="#format-2-patch-map" id="ref-for-format-2-patch-map①">Format 2 Patch Map</a> encoded patch map. May be modified by this procedure.</p>
    <li data-md>
     <p><var>patch URL string</var>: URL string for a patch which identifies the entries to be removed.</p>
   </ul>
   <p>This algorithm is a modified version of <a data-link-type="abstract-op" href="#abstract-opdef-interpret-format-2-patch-map" id="ref-for-abstract-opdef-interpret-format-2-patch-map①">Interpret Format 2 Patch Map</a>, invoke <a data-link-type="abstract-op" href="#abstract-opdef-interpret-format-2-patch-map" id="ref-for-abstract-opdef-interpret-format-2-patch-map②">Interpret Format 2 Patch Map</a> with <var>patch map</var> as an input but with the following changes:</p>
   <ul>
    <li data-md>
     <p>During step 8 and 9 of <a data-link-type="abstract-op" href="#abstract-opdef-interpret-format-2-patch-map-entry" id="ref-for-abstract-opdef-interpret-format-2-patch-map-entry②">Interpret Format 2 Patch Map Entry</a>: compare the URL string generated for only the first delta/length value to <var>patch URL string</var> if they are equal then, set bit 6 of <a data-link-type="dfn" href="#mapping-entry-formatflags" id="ref-for-mapping-entry-formatflags②⓪">formatFlags</a> to 1. Stop the interpretation process
at this point.</p>
    <li data-md>
     <p>The return value of <a data-link-type="abstract-op" href="#abstract-opdef-interpret-format-2-patch-map" id="ref-for-abstract-opdef-interpret-format-2-patch-map③">Interpret Format 2 Patch Map</a> is not used.</p>
   </ul>
   <h5 class="heading settled algorithm" data-algorithm="Sparse Bit Set" data-level="5.3.2.3" id="sparse-bit-set-decoding"><span class="secno">5.3.2.3. </span><span class="content">Sparse Bit Set</span><a class="self-link" href="#sparse-bit-set-decoding"></a></h5>
   <p>A sparse bit set is a data structure which compactly stores a set of distinct unsigned integers. The set is represented as a tree where
each node has a fixed number of children that recursively sub-divides an interval into equal partitions. A tree of height <i>H</i> with
branching factor <i>B</i> can store set membership for integers in the interval [0 to <i>B</i><sup><i>H</i></sup>-1] inclusive. The tree
is encoded into an array of bytes for transport.</p>
   <p>In the context of a <a data-link-type="dfn" href="#format-2-patch-map" id="ref-for-format-2-patch-map②">Format 2 Patch Map</a> a sparse bit set is used to store a set of <a data-link-type="biblio" href="#biblio-unicode" title="The Unicode Standard">Unicode</a> code points. As such integer
values stored in a sparse bit set are restricted to being <a data-link-type="biblio" href="#biblio-unicode" title="The Unicode Standard">Unicode</a> code point values in the range 0 to 0x10FFFF.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="sparse-bit-set">Sparse Bit Set</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint8
      <td>header
      <td>Bits 0 (least significant) and 1 encode the trees branch factor <i>B</i> via <a data-link-type="dfn" href="#branch-factor-encoding" id="ref-for-branch-factor-encoding">Branch Factor Encoding</a>. Bits 2 through 6 are a
        5-bit unsigned integer which encodes the value of <i>H</i>. Bit 7 is set to 0 and reserved for future use. 
     <tr>
      <td>uint8
      <td>treeData[variable]
      <td>Binary encoding of the tree.
   </table>
   <p>The exact length of <var>treeData</var> is initially unknown, it’s length is determined by executing the decoding algorithm. When using
branch factors of 2 or 4 the last node may only partially consume the bits in a byte. In that case all remaining bits are unused and
ignored.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="branch-factor-encoding">Branch Factor Encoding</dfn>:</p>
   <table>
    <tbody>
     <tr>
      <th>Bit 1
      <th>Bit 0
      <th>Branch Factor (B)
      <th>Maximum Height (H)
     <tr>
      <td>0
      <td>0
      <td>2
      <td>31
     <tr>
      <td>0
      <td>1
      <td>4
      <td>16
     <tr>
      <td>1
      <td>0
      <td>8
      <td>11
     <tr>
      <td>1
      <td>1
      <td>32
      <td>7
   </table>
   <p>Sparse bit sets that have an encoded height (H) which is larger than the maximum height for the encoded branch factor (B) in the above table
are invalid.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-decoding-sparse-bit-set-treedata">Decoding sparse bit set treeData</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>treeData</var>: array of bytes to be decoded.</p>
    <li data-md>
     <p><var>bias</var>: unsigned integer value added to each decoded set member.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>S</var>: a set of unsigned integers.</p>
   </ul>
   <p>The algorithm, using a FIFO (first in first out) queue <var>Q</var>:</p>
   <ol>
    <li data-md>
     <p>Remove the first byte from <var>treeData</var>. This is the header byte. Determine <var>H</var> the tree height and <var>B</var> the
 branch factor following <a data-link-type="dfn" href="#sparse-bit-set" id="ref-for-sparse-bit-set①">Sparse Bit Set</a>.</p>
    <li data-md>
     <p>If <var>H</var> is greater than the "Maximum Height" in the <a data-link-type="dfn" href="#branch-factor-encoding" id="ref-for-branch-factor-encoding①">Branch Factor Encoding</a> table in the row for <var>B</var> then,
 the encoding is invalid, return an error.</p>
    <li data-md>
     <p>If <var>H</var> is equal to 0, then this is an empty set and no further bytes of <var>treeData</var> are consumed. Return an empty set.</p>
    <li data-md>
     <p>Insert the tuple (0, 1) into <var>Q</var>.</p>
    <li data-md>
     <p>Initialize <var>S</var> to an empty set.</p>
    <li data-md>
     <p><var>treeData</var> is interpreted as a string of bits where the least significant bit of <var>treeData</var>[0] is the first bit in
 the string, the most significant bit of <var>treeData</var>[0] is the 8th bit, and so on.</p>
    <li data-md>
     <p>If in the following steps a value is added to <var>S</var> which is larger than the maximum unicode code point value (0x10FFFF) then,
 ignore the value and do not add it to <var>S</var>.</p>
    <li data-md>
     <p>If <var>Q</var> is empty return <var>S</var>.</p>
    <li data-md>
     <p>Extract the next tuple <var>t</var> from <var>Q</var>. The first value of
 in <var>t</var> is <var>start</var> and the second value is <var>depth</var>.</p>
    <li data-md>
     <p>Remove the next <var>B</var> bits from the <var>treeData</var> bit string. The first removed bit is <i>v<sub>1</sub></i>,
 the second is <i>v<sub>2</sub></i>, and so on until the last removed bit which is <i>v<sub>B</sub></i>. If prior to removal there
 were less than <var>B</var> bits left in <var>treeData</var>, then <var>treeData</var> is malformed, return an error.</p>
    <li data-md>
     <p>If all bits <i>v<sub>1</sub></i> through <i>v<sub>B</sub></i> are 0, then insert all integers in the interval
[<var>start</var> + <var>bias</var>, <var>start</var> + <var>bias</var> + <var>B</var><sup><var>H</var> - <var>depth</var> + 1</sup>)
into <var>S</var>. Go to step 5.</p>
    <li data-md>
     <p>For each <i>v<sub>i</sub></i> which is equal to 1 in <i>v<sub>1</sub></i> through <i>v<sub>B</sub></i>:
 If <var>depth</var> is equal to <var>H</var> add
 integer <var>start</var> + <var>bias</var> + <i>i</i> - 1 to <var>S</var>. Otherwise, insert the tuple
 (<var>start</var> + (i - 1) * <var>B</var><sup><var>H</var> - <var>depth</var></sup>, <var>depth</var> + 1)
 into <var>Q</var>.</p>
    <li data-md>
     <p>Go to step 8.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> when encoding sparse bit sets the encoder can use any of the possible branching factors, but it is recommended to
use 4 as that has <a href="https://github.com/w3c/PFE-analysis/blob/main/results/set_encoding_branch_factor.md">been shown</a> to give the smallest encodings for most unicode code point sets typically encountered.</p>
   <div class="example" id="example-eb491b43">
    <a class="self-link" href="#example-eb491b43"></a> The set {2, 33, 323} in a tree with a branching factor of 8 can be encoded as the bit string: 
<pre>bit string:
|-- header --|- lvl 0 |---- level 1 ----|------- level 2 -----------|
| B=8 H=3    |   n0   |   n1       n2   |   n3       n4       n5    |
[ 01  11000 0 10000100 10001000 10000000 00100000 01000000 00010000 ]

Which then becomes the byte string:
[
  0b00001110,
  0b00100001,
  0b00010001,
  0b00000001,
  0b00000100,
  0b00000010,
  0b00001000
]
</pre>
   </div>
   <div class="example" id="example-e803ad63">
    <a class="self-link" href="#example-e803ad63"></a> The empty set in a tree with a branching factor of 2 is encoded as the bit string: 
<pre>bit string:
|-- header -- |
| B=2 H=0     |
[ 00  00000 0 ]

Which then becomes the byte string:
[
  0b00000000,
]
</pre>
   </div>
   <div class="example" id="example-cc307778">
    <a class="self-link" href="#example-cc307778"></a> The set {0, 1, 2, ..., 17} can be encoded with a branching factor of 4 as: 
<pre>bit string:
|-- header --| l0 |- lvl 1 -| l2  |
| B=4 H=3    | n0 | n1 | n2 | n3  |
[ 10  11000 0 1100 0000 1000 1100 ]

byte string:
[
  0b00001101,
  0b00000011,
  0b00110001
]
</pre>
   </div>
   <h4 class="heading settled" data-level="5.3.3" id="url-templates"><span class="secno">5.3.3. </span><span class="content">URL Templates</span><a class="self-link" href="#url-templates"></a></h4>
   <p>URL templates are used to compress the URL strings associated with each patch map entry. Each patch mapping table
provides a URL template and then the URL string for each entry is produced by expanding the common template using
each entry’s ID as an input. The output of template expansion is a <a data-link-type="biblio" href="#biblio-utf-8" title="UTF-8, a transformation format of ISO 10646">[UTF-8]</a> encoded string.</p>
   <p>URL templates are encoded as a series of one byte op codes that either insert literal values, or insert values
based on the input entry ID.</p>
   <p>The algorithm for decoding and expanding a URL template follows.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-expand-url-template">Expand URL Template</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>url template bytes</var>: an array of bytes the contains the URL template.</p>
    <li data-md>
     <p><var>entry ID</var>: the ID of an entry. May be either an unsigned integer or an array of bytes.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>URL string</var>: an array of bytes representing the URL string. Encoded as <a data-link-type="biblio" href="#biblio-utf-8" title="UTF-8, a transformation format of ISO 10646">[UTF-8]</a>.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Initialize <var>URL string</var> to an empty byte array. <var>url template bytes</var> is used as a queue in the remaining steps.
Read operations remove bytes from the front of the queue (starting with the byte at index 0).</p>
    <li data-md>
     <p>Read the next byte of <var>url template bytes</var> into <var>op code</var>. If there are no remaining bytes, then
expansion is finished, return <var>URL string</var>.</p>
    <li data-md>
     <p>If the most significant bit of <var>op code</var> is not set, then:</p>
     <ul>
      <li data-md>
       <p>Interpret the 7 least significant bits of <var>op code</var> as an unsigned integer, <var>number of literals</var>.</p>
      <li data-md>
       <p>If <var>number of literals</var> is 0, then return an error.</p>
      <li data-md>
       <p>Read the next <var>number of literals</var> bytes from <var>url template bytes</var> into <var>literal bytes</var>.
 If there are not enough remaining bytes in <var>url template bytes</var>, then return an error.</p>
      <li data-md>
       <p>Check that <var>literal bytes</var> is a valid UTF-8 encoded string according to <a href="https://www.rfc-editor.org/rfc/rfc3629#section-4">UTF-8, a transformation format of ISO 10646 § section-4</a>.
 If it is not, then return an error.</p>
      <li data-md>
       <p>Append <var>literal bytes</var> to the end of <var>URL string</var>.</p>
      <li data-md>
       <p>Go to step 2.</p>
     </ul>
    <li data-md>
     <p>If the most significant bit of <var>op code</var> is set, then:</p>
     <ul>
      <li data-md>
       <p>Look up <var>op code</var> in the proceeding <b>Op Code Reference Table</b>. Perform the operation specified
 in the "Insertion Operation" column. If <var>op code</var> is not found in the table, then return an error.</p>
      <li data-md>
       <p>Go to step 2.</p>
     </ul>
   </ol>
   <p><b>Op Code Reference Table</b></p>
   <table>
    <tbody>
     <tr>
      <th>Name
      <th>Op Code Value
      <th>Insertion Operation
     <tr>
      <td>Insert id32
      <td>128 (0b10000000)
      <td> Append the value of the <var>id32</var> variable from the proceeding <b>Expansion Variables</b> table to <var>URL string</var>. 
     <tr>
      <td>Insert d1
      <td>129 (0b10000001)
      <td> Append the value of the <var>d1</var> variable from the proceeding <b>Expansion Variables</b> table to <var>URL string</var>. 
     <tr>
      <td>Insert d2
      <td>130 (0b10000010)
      <td> Append the value of the <var>d2</var> variable from the proceeding <b>Expansion Variables</b> table to <var>URL string</var>. 
     <tr>
      <td>Insert d3
      <td>131 (0b10000011)
      <td> Append the value of the <var>d3</var> variable from the proceeding <b>Expansion Variables</b> table to <var>URL string</var>. 
     <tr>
      <td>Insert d4
      <td>132 (0b10000100)
      <td> Append the value of the <var>d4</var> variable from the proceeding <b>Expansion Variables</b> table to <var>URL string</var>. 
     <tr>
      <td>Insert id64
      <td>133 (0b10000101)
      <td> Append the value of the <var>id64</var> variable from the proceeding <b>Expansion Variables</b> table to <var>URL string</var>. 
   </table>
   <p><b>Expansion Variables</b></p>
   <table>
    <tbody>
     <tr>
      <th>Variable
      <th>Value
     <tr>
      <td><var>id32</var>
      <td> The input <var>entry ID</var> encoded as a <a href="https://www.rfc-editor.org/rfc/rfc4648#section-7">base32hex</a> string (using the digits 0-9, A-V) with padding
      omitted.  When <var>entry ID</var> is an unsigned integer it must first be converted to a big endian 32 bit unsigned integer,
      but then all leading bytes that are equal to 0 are removed before encoding.  (For example, when the
      integer is less than 256 only one byte is encoded.) If <var>entry ID</var> is 0 then one zero byte is encoded. When <var>entry ID</var> is a string the raw bytes are encoded as base32hex. 
     <tr>
      <td><var>d1</var>
      <td> The last character of the string in the <var>id32</var> variable.
      If <var>id32</var> variable is empty then, the value is the character _ (U+005F). 
     <tr>
      <td><var>d2</var>
      <td> The second to last character of the string in the <var>id32</var> variable.
      If the <var>id32</var> variable has less than 2 characters then, the value is the character _ (U+005F). 
     <tr>
      <td><var>d3</var>
      <td> The third to last character of the string in the <var>id32</var> variable.
      If the <var>id32</var> variable has less than 3 characters then, the value is the character _ (U+005F). 
     <tr>
      <td><var>d4</var>
      <td> The fourth to last character of the string in the <var>id32</var> variable.
      If the <var>id32</var> variable has less than 4 characters then, the value is the character _ (U+005F). 
     <tr>
      <td><var>id64</var>
      <td> The input <var>entry ID</var> encoded as a <a href="https://www.rfc-editor.org/rfc/rfc4648#section-5">base64url</a> string (using the digits A-Z, a-z, 0-9, -
      (minus) and _ (underline)) with padding included. Because the padding character is '=', it must
      be URL-encoded as '%3D'.  When <var>entry ID</var> is an unsigned integer it must first be converted to a big
      endian 32 bit unsigned integer, but then all leading bytes that are equal to 0 are removed before encoding. 
      (For example, when the integer is less than 256 only one byte is encoded.) If the <var>entry ID</var> is 0 then one
      zero byte is encoded. When the <var>entry ID</var> is a string its raw bytes are encoded as <a href="https://www.rfc-editor.org/rfc/rfc4648#section-5">base64url</a>. 
   </table>
   <div class="example" id="example-13e51108">
    <a class="self-link" href="#example-13e51108"></a> 
    <p>Some example inputs and the corresponding expansions. Values in "Template Bytes" column are provided as C style byte arrays.</p>
    <table>
     <tbody>
      <tr>
       <th>Template Bytes
       <th>Input ID
       <th>ID Type
       <th>Expansion
      <tr>
       <td>[10, '/', '/', 'f', 'o', 'o', '.', 'b', 'a', 'r', '/', 128]
       <td>123
       <td>Integer
       <td>//foo.bar/FC
      <tr>
       <td>[8, 'f', 'o', 'o', '?', 'b', 'a', 'r', '=', 128]
       <td>123
       <td>Integer
       <td>foo?bar=FC
      <tr>
       <td>[10, '/', '/', 'f', 'o', 'o', '.', 'b', 'a', 'r', '/', 128]
       <td>0
       <td>Integer
       <td>//foo.bar/00
      <tr>
       <td>[4, 'f', 'o', 'o', '/', 129, 1, '/', 130, 1, '/', 128]
       <td>478
       <td>Integer
       <td>foo/0/F/07F0
      <tr>
       <td>[4, 'f', 'o', 'o', '/', 129, 1, '/', 130, 1, '/', 131, 1, '/', 128]
       <td>123
       <td>Integer
       <td>foo/C/F/_/FC
      <tr>
       <td>[4, 'f', 'o', 'o', '/', 129, 1, '/', 130, 1, '/', 131, 1, '/', 128]
       <td>['b', 'a', 'z']
       <td>String
       <td>foo/K/N/G/C9GNK
      <tr>
       <td>[4, 'f', 'o', 'o', '/', 129, 1, '/', 130, 1, '/', 131, 1, '/', 128]
       <td>['z']
       <td>String
       <td>foo/8/F/_/F8
      <tr>
       <td>[10, '/', '/', 'f', 'o', 'o', '.', 'b', 'a', 'r', '/', 133]
       <td>14,000,000
       <td>Integer
       <td>//foo.bar/1Z-A
      <tr>
       <td>[10, '/', '/', 'f', 'o', 'o', '.', 'b', 'a', 'r', '/', 133]
       <td>0
       <td>Integer
       <td>//foo.bar/AA%3D%3D
      <tr>
       <td>[10, '/', '/', 'f', 'o', 'o', '.', 'b', 'a', 'r', '/', 133]
       <td>17,000,000
       <td>Integer
       <td>//foo.bar/AQNmQA%3D%3D
      <tr>
       <td>[10, '/', '/', 'f', 'o', 'o', '.', 'b', 'a', 'r', '/', 133]
       <td>[0xc3, 0xa0, 0x62, 0x63]
       <td>String
       <td>//foo.bar/w6BiYw%3D%3D
    </table>
    <p>In the following examples expansion is expected to fail and return an error:</p>
    <table>
     <tbody>
      <tr>
       <th>Template Bytes
       <th>Input ID
       <th>ID Type
       <th>Failure Reason
      <tr>
       <td>[4, 'f', 'o', 'o', '/', 150]
       <td>123
       <td>Integer
       <td>Op code 150 is not valid
      <tr>
       <td>[4, 'f', 'o', 'o', '/', 0, 128]
       <td>123
       <td>Integer
       <td>Op code 0 is not valid
      <tr>
       <td>[10, 'f', 'o', 'o', '/', 128]
       <td>123
       <td>Integer
       <td>Not enough bytes in template for literal copy op code 10.
      <tr>
       <td>[4, 'f', 'o', 'o', 0x85, 128]
       <td>123
       <td>Integer
       <td>Literal bytes are not valid UTF-8.
    </table>
   </div>
   <h2 class="heading settled" data-level="6" id="font-patch-formats"><span class="secno">6. </span><span class="content">Font Patch Formats</span><a class="self-link" href="#font-patch-formats"></a></h2>
   <p>In incremental font transfer <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①①">font subsets</a> are extended by applying patches.
This specification defines two patch formats, each appropriate to its own set of augmentation scenarios. A single
encoding can make use of more than one patch format.</p>
   <h3 class="heading settled" data-level="6.1" id="font-patch-formats-summary"><span class="secno">6.1. </span><span class="content">Formats Summary</span><a class="self-link" href="#font-patch-formats-summary"></a></h3>
   <p>The following patch formats are defined by this specification:</p>
   <ul>
    <li data-md>
     <p><a href="#table-keyed">§ 6.2 Table Keyed</a>: a collection of brotli encoded binary diffs that use tables from a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①②">font subset</a> as bases.</p>
    <li data-md>
     <p><a href="#glyph-keyed">§ 6.3 Glyph Keyed</a>: a collection of opaque binary blobs, each associated with a glyph id and table.</p>
   </ul>
   <p>More detailed descriptions of each algorithm can be found in the following sections.</p>
   <p>The following format numbers are used to identify the patch format and invalidation mode in the <a href="#patch-map-table">§ 5.3 Patch Map Table</a>:</p>
   <table>
    <tbody>
     <tr>
      <th>Format Number
      <th>Name
      <th>Invalidation
     <tr>
      <td>1
      <td><a href="#table-keyed">§ 6.2 Table Keyed</a>
      <td><a data-link-type="dfn" href="#full-invalidation" id="ref-for-full-invalidation①">Full Invalidation</a>
     <tr>
      <td>2
      <td><a href="#table-keyed">§ 6.2 Table Keyed</a>
      <td><a data-link-type="dfn" href="#partial-invalidation" id="ref-for-partial-invalidation①">Partial Invalidation</a>
     <tr>
      <td>3
      <td><a href="#glyph-keyed">§ 6.3 Glyph Keyed</a>
      <td><a data-link-type="dfn" href="#no-invalidation" id="ref-for-no-invalidation">No Invalidation</a>
   </table>
   <h3 class="heading settled" data-level="6.2" id="table-keyed"><span class="secno">6.2. </span><span class="content">Table Keyed</span><a class="self-link" href="#table-keyed"></a></h3>
   <p>A table keyed patch contains a collection of patches which are applied to the individual <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">font tables</a> in the input font file. Each table patch is encoded with <a data-link-type="biblio" href="#biblio-rfc7932" title="Brotli Compressed Data Format">brotli compression</a> using the corresponding table from the input font file as a <a href="https://datatracker.ietf.org/doc/html/draft-vandevenne-shared-brotli-format-15#section-3.2">shared LZ77 dictionary</a>. A table keyed encoded patch consists of a short header followed
by one or more brotli encoded patches. In addition to patching tables, patches may also replace (existing table data is not used)
or remove tables in a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①③">font subset</a>.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="table-keyed-patch">Table keyed patch</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>Tag
      <td>format
      <td>Identifies the format as table keyed, must be set to 'iftk'
     <tr>
      <td>uint32
      <td>reserved
      <td>Reserved for future use, set to 0.
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="Table keyed patch" data-dfn-type="dfn" data-noexport id="table-keyed-patch-compatibilityid">compatibilityId</dfn>[4]
      <td>The id of the <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①④">font subset</a> which this patch can be applied too. See <a href="#font-patch-invalidations">§ 4.1 Patch Invalidations</a>.
     <tr>
      <td>uint16
      <td>patchesCount
      <td>The number of entries in the patches array.
     <tr>
      <td>Offset32
      <td><dfn class="dfn-paneled" data-dfn-for="Table keyed patch" data-dfn-type="dfn" data-noexport id="table-keyed-patch-patches">patches</dfn>[patchesCount+1]
      <td>Each entry is an offset from the start of this table to a <a data-link-type="dfn" href="#tablepatch" id="ref-for-tablepatch">TablePatch</a>. Offsets must be sorted in ascending order.
   </table>
   <p>The difference between two consecutive offsets in the <a data-link-type="dfn" href="#table-keyed-patch-patches" id="ref-for-table-keyed-patch-patches">patches</a> array gives the size
of that <a data-link-type="dfn" href="#tablepatch" id="ref-for-tablepatch①">TablePatch</a>.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="tablepatch">TablePatch</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>Tag
      <td><dfn class="dfn-paneled" data-dfn-for="TablePatch" data-dfn-type="dfn" data-noexport id="tablepatch-tag">tag</dfn>
      <td>The tag that identifies the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">font table</a> this patch applies too.
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="TablePatch" data-dfn-type="dfn" data-noexport id="tablepatch-flags">flags</dfn>
      <td>Bit-field. If bit 0 (least significant bit) is set this patch replaces the existing table. If bit 1 is set this table is removed.
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="TablePatch" data-dfn-type="dfn" data-noexport id="tablepatch-maxuncompressedlength">maxUncompressedLength</dfn>
      <td>The maximum uncompressed length of <a data-link-type="dfn" href="#tablepatch-brotlistream" id="ref-for-tablepatch-brotlistream">brotliStream</a>.
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="TablePatch" data-dfn-type="dfn" data-noexport id="tablepatch-brotlistream">brotliStream</dfn>[variable]
      <td>Brotli encoded byte stream.
   </table>
   <h4 class="heading settled algorithm" data-algorithm="Applying Table Keyed Patches" data-level="6.2.1" id="apply-table-keyed"><span class="secno">6.2.1. </span><span class="content">Applying Table Keyed Patches</span><a class="self-link" href="#apply-table-keyed"></a></h4>
   <p>This <a data-link-type="dfn" href="#patch-application-algorithm" id="ref-for-patch-application-algorithm">patch application algorithm</a> is used to apply a table keyed patch to extend a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⑤">font subset</a> to cover additional code points,
features, and/or design-variation space.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-apply-table-keyed-patch">Apply table keyed patch</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>base font subset</var>: a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⑥">font subset</a> which is to be extended.</p>
    <li data-md>
     <p><var>patch</var>: a <a data-link-type="dfn" href="#table-keyed-patch" id="ref-for-table-keyed-patch">table keyed patch</a> to be applied to <var>base font subset</var>.</p>
    <li data-md>
     <p><var>compatibility id</var>: The ID number from the 'IFT ' or 'IFTX' table of <var>base font subset</var> which listed this patch.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>extended font subset</var>: a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⑦">font subset</a> that has been extended by the <var>patch</var>.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Initialize <var>extended font subset</var> to be an empty font with no tables.</p>
    <li data-md>
     <p>Check that the <var>patch</var> is valid according to the requirements in <a href="#table-keyed">§ 6.2 Table Keyed</a> (requirements are marked with a
"must") and all <a data-link-type="dfn" href="#tablepatch" id="ref-for-tablepatch②">TablePatch</a>’s are contained within <var>patch</var>. Otherwise, return an error</p>
    <li data-md>
     <p>Check that the <a data-link-type="dfn" href="#table-keyed-patch-compatibilityid" id="ref-for-table-keyed-patch-compatibilityid">compatibilityId</a> field in <var>patch</var> is equal to <var>compatibility id</var>.
If there is no match, or <var>base font subset</var> does not have either an 'IFT ' or 'IFTX' table, then patch application
has failed, return an error.</p>
    <li data-md>
     <p>In the following steps, adding a table to <var>extended font subset</var> consists of adding the table’s data to the font and
inserting a new entry into the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table directory</a> according to the requirements of the open
type specification. That entry includes a checksum for the table data. When an existing table is copied unmodified, the client
can re-use the checksum from the entry in the source font. Otherwise a new checksum will need to be computed.</p>
    <li data-md>
     <p>For each entry in <a data-link-type="dfn" href="#table-keyed-patch-patches" id="ref-for-table-keyed-patch-patches①">patches</a>, with index <var>i</var>:</p>
     <ul>
      <li data-md>
       <p>Find the <a data-link-type="dfn" href="#tablepatch" id="ref-for-tablepatch③">TablePatch</a> associated with index <var>i</var>. The object starts at the offset <a data-link-type="dfn" href="#table-keyed-patch-patches" id="ref-for-table-keyed-patch-patches②">patches[i]</a> (inclusive) and ends at the offset <a data-link-type="dfn" href="#table-keyed-patch-patches" id="ref-for-table-keyed-patch-patches③">patches[i+1]</a> (exclusive). Both offsets are relative to the start of
the <var>patch</var>.</p>
      <li data-md>
       <p>If an entry in <a data-link-type="dfn" href="#table-keyed-patch-patches" id="ref-for-table-keyed-patch-patches④">patches</a> was previously applied that has the same <a data-link-type="dfn" href="#tablepatch-tag" id="ref-for-tablepatch-tag">tag</a> as
this entry, then ignore this entry and continue the iteration to the next one. Entries are processed in same order as they
are listed in the <a data-link-type="dfn" href="#table-keyed-patch-patches" id="ref-for-table-keyed-patch-patches⑤">patches</a> array.</p>
      <li data-md>
       <p>If bit 1 of <a data-link-type="dfn" href="#tablepatch-flags" id="ref-for-tablepatch-flags">flags</a> is set, then do not copy or add a <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a> to <var>extended font subset</var> identified by <a data-link-type="dfn" href="#tablepatch-tag" id="ref-for-tablepatch-tag①">tag</a>. Continue to the next entry.</p>
      <li data-md>
       <p>If bit 0 (least significant bit) of <a data-link-type="dfn" href="#tablepatch-flags" id="ref-for-tablepatch-flags①">flags</a> is set, then decode <a data-link-type="dfn" href="#tablepatch-brotlistream" id="ref-for-tablepatch-brotlistream①">brotliStream</a> following <a href="https://www.rfc-editor.org/rfc/rfc7932#section-10">Brotli Compressed Data Format § section-10</a>. No shared dictionary is used. If the decoded data is larger than <a data-link-type="dfn" href="#tablepatch-maxuncompressedlength" id="ref-for-tablepatch-maxuncompressedlength">maxUncompressedLength</a> return an error. If there is any data in <a data-link-type="dfn" href="#tablepatch-brotlistream" id="ref-for-tablepatch-brotlistream②">brotliStream</a> which was not used by the decoding process return an error.
Add a <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a> to <var>extended font subset</var> identified by <a data-link-type="dfn" href="#tablepatch-tag" id="ref-for-tablepatch-tag②">tag</a> with it’s contents set to the decoded <a data-link-type="dfn" href="#tablepatch-brotlistream" id="ref-for-tablepatch-brotlistream③">brotliStream</a>. Continue to the next entry.</p>
      <li data-md>
       <p>Otherwise, decode <a data-link-type="dfn" href="#tablepatch-brotlistream" id="ref-for-tablepatch-brotlistream④">brotliStream</a> following <a href="https://www.rfc-editor.org/rfc/rfc7932#section-10">Brotli Compressed Data Format § section-10</a> and using the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a> identified by <a data-link-type="dfn" href="#tablepatch-tag" id="ref-for-tablepatch-tag③">tag</a> in <var>base font subset</var> as a <a href="https://datatracker.ietf.org/doc/html/draft-vandevenne-shared-brotli-format-15#section-3.2">shared LZ77 dictionary</a>. If no such table exists return an error. If the decoded data is
larger than <a data-link-type="dfn" href="#tablepatch-maxuncompressedlength" id="ref-for-tablepatch-maxuncompressedlength①">maxUncompressedLength</a> return an error. If there is any data in <a data-link-type="dfn" href="#tablepatch-brotlistream" id="ref-for-tablepatch-brotlistream⑤">brotliStream</a> which was
not used by the decoding process return an error. Add a <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a> to <var>extended font subset</var> identified by <a data-link-type="dfn" href="#tablepatch-tag" id="ref-for-tablepatch-tag④">tag</a> with it’s contents set to the decoded <a data-link-type="dfn" href="#tablepatch-brotlistream" id="ref-for-tablepatch-brotlistream⑥">brotliStream</a>.</p>
     </ul>
    <li data-md>
     <p>For each <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a> in <var>base font subset</var> which has a tag that was not found in any of
the entries processed in step 5, add a copy of that table to <var>extended font subset</var>.</p>
   </ol>
   <h3 class="heading settled" data-level="6.3" id="glyph-keyed"><span class="secno">6.3. </span><span class="content">Glyph Keyed</span><a class="self-link" href="#glyph-keyed"></a></h3>
   <p>A glyph keyed patch contains a collection of data chunks that are each associated with a glyph index and a <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">font table</a>. The encoded data replaces any existing data for that glyph index in the referenced <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a>. Glyph keyed patches can encode data for <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/glyf#">glyf</a>/<a href="https://learn.microsoft.com/en-us/typography/opentype/spec/loca#">loca</a>, <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/gvar#">gvar</a>, <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/cff#">CFF</a>, and <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/cff2#">CFF2</a> tables.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="glyph-keyed-patch">Glyph keyed patch</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>Tag
      <td>format
      <td>Identifies the format as glyph keyed, must be set to 'ifgk'
     <tr>
      <td>uint32
      <td>reserved
      <td>Reserved for future use, set to 0.
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Glyph keyed patch" data-dfn-type="dfn" data-noexport id="glyph-keyed-patch-flags">flags</dfn>
      <td>Bit-field. If bit 0 (least significant bit) is set then <a data-link-type="dfn" href="#glyphpatches-glyphids" id="ref-for-glyphpatches-glyphids">glyphIds</a> uses uint24’s, otherwise it uses uint16’s.
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="Glyph keyed patch" data-dfn-type="dfn" data-noexport id="glyph-keyed-patch-compatibilityid">compatibilityId</dfn>[4]
      <td>The compatibility id of the <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⑧">font subset</a> which this patch can be applied too. See <a href="#font-patch-invalidations">§ 4.1 Patch Invalidations</a>.
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="Glyph keyed patch" data-dfn-type="dfn" data-noexport id="glyph-keyed-patch-maxuncompressedlength">maxUncompressedLength</dfn>
      <td>The maximum uncompressed length of <a data-link-type="dfn" href="#glyph-keyed-patch-brotlistream" id="ref-for-glyph-keyed-patch-brotlistream">brotliStream</a>.
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="Glyph keyed patch" data-dfn-type="dfn" data-noexport id="glyph-keyed-patch-brotlistream">brotliStream</dfn>[variable]
      <td>Brotli encoded <a data-link-type="dfn" href="#glyphpatches" id="ref-for-glyphpatches">GlyphPatches</a> table.
   </table>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="glyphpatches">GlyphPatches</dfn> encoding:</p>
   <table>
    <tbody>
     <tr>
      <th>Type
      <th>Name
      <th>Description
     <tr>
      <td>uint32
      <td><dfn class="dfn-paneled" data-dfn-for="GlyphPatches" data-dfn-type="dfn" data-noexport id="glyphpatches-glyphcount">glyphCount</dfn>
      <td>The number of glyphs encoded in the patch.
     <tr>
      <td>uint8
      <td>tableCount
      <td> The number of <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">tables</a> the patch has data for. 
     <tr>
      <td>uint16/uint24
      <td><dfn class="dfn-paneled" data-dfn-for="GlyphPatches" data-dfn-type="dfn" data-noexport id="glyphpatches-glyphids">glyphIds</dfn>[glyphCount]
      <td> An array of glyph indices included in the patch. Elements are uint24’s if bit 0 (least significant bit) of <a data-link-type="dfn" href="#glyph-keyed-patch-flags" id="ref-for-glyph-keyed-patch-flags">flags</a> is set, otherwise elements are uint16’s. Must be in ascending sorted order and must not
      contain any duplicate values. 
     <tr>
      <td>Tag
      <td><dfn class="dfn-paneled" data-dfn-for="GlyphPatches" data-dfn-type="dfn" data-noexport id="glyphpatches-tables">tables</dfn>[tableCount]
      <td>An array of <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">tables</a> (by tag) included in the patch. Must be in ascending sorted
      order and must not contain any duplicate values. For sorting tag values are interpreted as a 4 byte big endian
      unsigned integer and sorted by the integer value.
     <tr>
      <td>Offset32
      <td><dfn class="dfn-paneled" data-dfn-for="GlyphPatches" data-dfn-type="dfn" data-noexport id="glyphpatches-glyphdataoffsets">glyphDataOffsets</dfn>[glyphCount * tableCount + 1]
      <td> An array of offsets of to glyph data for each table. The first <a data-link-type="dfn" href="#glyphpatches-glyphcount" id="ref-for-glyphpatches-glyphcount">glyphCount</a> offsets corresponding to <a data-link-type="dfn" href="#glyphpatches-tables" id="ref-for-glyphpatches-tables">tables[0]</a>, the next <a data-link-type="dfn" href="#glyphpatches-glyphcount" id="ref-for-glyphpatches-glyphcount①">glyphCount</a> offsets (if present) corresponding to <a data-link-type="dfn" href="#glyphpatches-tables" id="ref-for-glyphpatches-tables①">tables[1]</a>, and so on. All offsets are from the start of the <a data-link-type="dfn" href="#glyphpatches" id="ref-for-glyphpatches①">GlyphPatches</a> table.
      Offsets must be sorted in ascending order. 
     <tr>
      <td>uint8
      <td><dfn class="dfn-paneled" data-dfn-for="GlyphPatches" data-dfn-type="dfn" data-noexport id="glyphpatches-glyphdata">glyphData</dfn>[variable]
      <td> The actual glyph data picked out by the offsets. 
   </table>
   <p>The difference between two consecutive offsets in the <a data-link-type="dfn" href="#glyphpatches-glyphdataoffsets" id="ref-for-glyphpatches-glyphdataoffsets">glyphDataOffsets</a> array gives the size
of that glyph data.</p>
   <h4 class="heading settled algorithm" data-algorithm="Applying Glyph Keyed Patches" data-level="6.3.1" id="apply-glyph-keyed"><span class="secno">6.3.1. </span><span class="content">Applying Glyph Keyed Patches</span><a class="self-link" href="#apply-glyph-keyed"></a></h4>
   <p>This <a data-link-type="dfn" href="#patch-application-algorithm" id="ref-for-patch-application-algorithm①">patch application algorithm</a> is used to apply a glyph keyed patch to extend a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset①⑨">font subset</a> to cover additional code points,
features, and/or design-variation space.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-apply-glyph-keyed-patch">Apply glyph keyed patch</dfn></p>
   <p>The inputs to this algorithm are:</p>
   <ul>
    <li data-md>
     <p><var>base font subset</var>: a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②⓪">font subset</a> which is to be extended.</p>
    <li data-md>
     <p><var>patch</var>: a <a data-link-type="dfn" href="#glyph-keyed-patch" id="ref-for-glyph-keyed-patch">glyph keyed patch</a> to be applied to <var>base font subset</var>.</p>
    <li data-md>
     <p><var>patch URL string</var>: the URL string where the patch data is located.</p>
    <li data-md>
     <p><var>compatibility id</var>: The compatibility ID from the 'IFT ' or 'IFTX' table of <var>base font subset</var> which listed this patch.</p>
   </ul>
   <p>The algorithm outputs:</p>
   <ul>
    <li data-md>
     <p><var>extended font subset</var>: a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②①">font subset</a> that has been extended by the <var>patch</var>.</p>
   </ul>
   <p>The algorithm:</p>
   <ol>
    <li data-md>
     <p>Check that the <var>patch</var> is valid according to the requirements in <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> (requirements are marked with a
"must"). Otherwise, return an error</p>
    <li data-md>
     <p>Check that the <a data-link-type="dfn" href="#glyph-keyed-patch-compatibilityid" id="ref-for-glyph-keyed-patch-compatibilityid">compatibilityId</a> field in <var>patch</var> is equal to <var>compatibility id</var>.
If there is no match, or <var>base font subset</var> does not have either an 'IFT ' or 'IFTX' table, then patch application has
failed, return an error.</p>
    <li data-md>
     <p>Decode the brotli encoded data in <a data-link-type="dfn" href="#glyph-keyed-patch-brotlistream" id="ref-for-glyph-keyed-patch-brotlistream①">brotliStream</a> following <a href="https://www.rfc-editor.org/rfc/rfc7932#section-10">Brotli Compressed Data Format § section-10</a>. The
decoded data is a <a data-link-type="dfn" href="#glyphpatches" id="ref-for-glyphpatches②">GlyphPatches</a> table. If the decoded data is larger than <a data-link-type="dfn" href="#glyph-keyed-patch-maxuncompressedlength" id="ref-for-glyph-keyed-patch-maxuncompressedlength">maxUncompressedLength</a> return an
error</p>
    <li data-md>
     <p>For each <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">font table</a> listed in <a data-link-type="dfn" href="#glyphpatches-tables" id="ref-for-glyphpatches-tables②">tables</a>, with index <code>i</code>:</p>
     <ul>
      <li data-md>
       <p>Using the corresponding table in <var>base font subset</var>, synthesize
a new table where the data for each glyph is replaced with the data corresponding to that glyph index
from <a data-link-type="dfn" href="#glyphpatches-glyphdata" id="ref-for-glyphpatches-glyphdata">glyphData</a> if present, otherwise copied from the corresponding table in <var>base font subset</var> for
that glyph index.</p>
      <li data-md>
       <p>The patch glyph data for a glyph index is located by finding <a data-link-type="dfn" href="#glyphpatches-glyphids" id="ref-for-glyphpatches-glyphids①">glyphIds[j]</a> equal to the glyph index. The
offset to the associated glyph data is <a data-link-type="dfn" href="#glyphpatches-glyphdataoffsets" id="ref-for-glyphpatches-glyphdataoffsets①">glyphDataOffsets[i * glyphCount + j]</a>. The length
of the associated glyph data is <a data-link-type="dfn" href="#glyphpatches-glyphdataoffsets" id="ref-for-glyphpatches-glyphdataoffsets②">glyphDataOffsets[i * glyphCount + j + 1]</a> minus <a data-link-type="dfn" href="#glyphpatches-glyphdataoffsets" id="ref-for-glyphpatches-glyphdataoffsets③">glyphDataOffsets[i * glyphCount + j]</a>.</p>
      <li data-md>
       <p>The specific process for synthesizing the new table, depends on the specified format of the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a>. Any non-glyph associated data should be copied from the table in <var>base font subset</var>. Tables of the type <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/glyf#">glyf</a>, <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/gvar#">gvar</a>, <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/cff#">CFF</a>, or <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/cff2#">CFF2</a> are supported. Entries for tables
of any other types must be ignored. When updating <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/glyf#">glyf</a> the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/loca#">loca</a> table must be updated as
well. No other tables in the font can be modified as a result of this step. Notably this means that a patch cannot add glyphs
with indices beyond the numGlyphs specified in <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/maxp#">maxp</a>.</p>
       <p><a href="https://learn.microsoft.com/en-us/typography/opentype/spec/cff#">CFF</a>, <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/cff2#">CFF2</a>, and <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/gvar#">gvar</a> have variable sized offsets to per glyph data. If
necessary when synthesizing a new table the offset sizes can be increased as needed. For <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/glyf#">glyf</a>/<a href="https://learn.microsoft.com/en-us/typography/opentype/spec/loca#">loca</a> offset sizes cannot be changed because the offset size is specified in the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/head#">head</a> table. If during synthesis an offset
is generated which exceeds the maximum possible offset value (after increasing offset size if possible), then patch application has
failed. Return an error.</p>
      <li data-md>
       <p>If <var>base font subset</var> does not have a matching table, return an error.</p>
      <li data-md>
       <p>Insert the synthesized table into <var>extended font subset</var>.</p>
     </ul>
    <li data-md>
     <p>Locate the <a href="#patch-map-table">§ 5.3 Patch Map Table</a> which has the same <a data-link-type="dfn" href="#glyph-keyed-patch-compatibilityid" id="ref-for-glyph-keyed-patch-compatibilityid①">compatibilityId</a> as <var>compatibility id</var>. If it is a
format 1 patch map then, invoke <a data-link-type="abstract-op" href="#abstract-opdef-remove-entries-from-format-1-patch-map" id="ref-for-abstract-opdef-remove-entries-from-format-1-patch-map">Remove Entries from Format 1 Patch Map</a> with the patch map table and <var>patch URL string</var> as an
input. Otherwise if it is a format 2 patch map then, invoke <a data-link-type="abstract-op" href="#abstract-opdef-remove-entries-from-format-2-patch-map" id="ref-for-abstract-opdef-remove-entries-from-format-2-patch-map">Remove Entries from Format 2 Patch Map</a> with the patch map table and <var>patch URL string</var> as an input. Copy the modified patch map table into <var>extended font subset</var>.</p>
    <li data-md>
     <p>For each <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">table</a> in <var>base font subset</var> which has a tag that was not found in any of
the entries processed in step 4 or 5, add a copy of that table to <var>extended font subset</var>.</p>
    <li data-md>
     <p>If the contents of any <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">font table</a> was modified during the previous steps then,
for each modified table: update the checksums in the <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">fonts table directory</a> to match the table’s
new contents.</p>
   </ol>
   <h2 class="heading settled" data-level="7" id="encoding"><span class="secno">7. </span><span class="content">Encoding</span><a class="self-link" href="#encoding"></a></h2>
   <p>An encoder is a tool which produces an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font⑨">incremental font</a> and set of associated <a data-link-type="dfn" href="#font-patch" id="ref-for-font-patch②">patches</a>. "Encoding" refers to the
process of using an encoder, including whatever parameters an encoder requires or allows to influence the result in a particular
case.
The <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font①⓪">incremental font</a> and associated patches produced by a compliant encoder:</p>
   <ol>
    <li data-md>
     <p>Must meet all of the requirements in <a href="#font-format-extensions">§ 5 Extensions to the Font Format</a> and <a href="#font-patch-formats">§ 6 Font Patch Formats</a>.</p>
    <li data-md>
     <p>Must be consistent, that is: for any possible <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition①③">font subset definition</a> the result of invoking <a data-link-type="abstract-op" href="#abstract-opdef-extend-an-incremental-font-subset" id="ref-for-abstract-opdef-extend-an-incremental-font-subset①⓪">Extend an Incremental Font Subset</a> with that subset definition and the <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font①①">incremental font</a> must always be the same regardless of the particular order
of patch selection chosen in step 8 of <a data-link-type="abstract-op" href="#abstract-opdef-extend-an-incremental-font-subset" id="ref-for-abstract-opdef-extend-an-incremental-font-subset①①">Extend an Incremental Font Subset</a>.</p>
    <li data-md>
     <p>Must respect patch invalidation criteria. Any patch which is part of an IFT encoding when applied to a compatible <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②②">font subset</a> must only make changes to the <a data-link-type="dfn" href="#patch-map" id="ref-for-patch-map①⓪">patch map</a> compatibility IDs which are compliant with the <a href="#font-patch-invalidations">§ 4.1 Patch Invalidations</a> criteria
 for the invalidation mode declared by the associated <a data-link-type="dfn" href="#patch-map-entries" id="ref-for-patch-map-entries①①">patch map entries</a>.</p>
    <li data-md>
     <p>When an encoder is used to transform an existing font into an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font①②">incremental font</a> the associated <a data-link-type="abstract-op" href="#abstract-opdef-fully-expand-a-font-subset" id="ref-for-abstract-opdef-fully-expand-a-font-subset①">fully expanded font</a> should be equivalent to the existing font. An equivalent fully expanded font
 should have all of the same <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory">tables</a> as the existing font (excluding the incremental IFT/IFTX
 tables) and each of those tables should be functionally equivalent to the corresponding table in the existing font. Note: the fully
 expanded may not always be an exact binary match with the existing font.</p>
    <li data-md>
     <p>Should preserve the functionality of the fully expanded font throughout the augmentation process, that is:
 given the <a data-link-type="abstract-op" href="#abstract-opdef-fully-expand-a-font-subset" id="ref-for-abstract-opdef-fully-expand-a-font-subset②">fully expanded font</a> derived from the <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font①③">incremental font</a> and any content, then the <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②③">font subset</a> produced by invoking <a data-link-type="abstract-op" href="#abstract-opdef-extend-an-incremental-font-subset" id="ref-for-abstract-opdef-extend-an-incremental-font-subset①②">Extend an Incremental Font Subset</a> with the <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font①④">incremental font</a> and the minimal subset definition covering that content should
 render identically to the fully expanded font for that content.</p>
   </ol>
   <p>When an encoder is used to transform an existing font file into and <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font①⑤">incremental font</a> and a client is implemented according to the
other sections of this document, the intent of the IFT specification is that appearance and behavior of the font in the client will be the
same as if the entire file were transferred to the client. A primary goal of the IFT specification is that the IFT format and protocol can
serve as a neutral medium for font transfer, comparable to WOFF2. If an encoder produces an encoding from a source font which meets all of
the above requirements (1. through 5.), then the encoding will preserve all of the functionality of the original font. Requirement 4 above
ensures that all of the functionality in the original font can be reached. This works in conjunction with requirement 5, which requires
that partial versions of an IFT font have equivalent functionality as the full version (original font here) for content which is a subset
of the subset definition used to derive the partial font.</p>
   <p>This may be important for cases where a foundry or other rights-owner of a font wants be confident that the encoding and transfer of that
font using IFT will not change its behavior and therefore the intent of the font’s creators. Licenses or contracts might then include
requirements about IFT conformance, and situations in which re-encoding a font in WOFF2 format is de facto permissible due to its
content-neutrality might also permit IFT encoding of that font.</p>
   <p>However, nothing about these requirements on encoding conformance is meant to rule out or deprecate the possibility and practical use of
encodings that do not preserve all of the functionality of a source font. Any encoding meeting the minimum requirements (1., 2. and 3. above)
is valid and may have an appropriate use. Under some circumstances it might be desirable for an encoded font to omit support for some
functionality/data from all of its patch files even if those were included in the original font file. In other cases a font might be
directly encoded into the IFT format from font authoring source files. In cases where an encoder chooses not to meet requirement 4 above
it is still strongly encouraged to meet 5, which ensures consistent behavior of the font throughout the augmentation process.</p>
   <h3 class="heading settled" data-level="7.1" id="encoding-considerations"><span class="secno">7.1. </span><span class="content">Encoding Considerations</span><a class="self-link" href="#encoding-considerations"></a></h3>
   <p><em>This section is not normative.</em></p>
   <p>The details of the encoding process may differ by encoder and are beyond the scope of this document. However, this section provides
guidance that encoder implementations may want to consider, and that can be important to reproducing the appearance and behavior of
an existing font file when producing an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font①⑥">incremental</a> version of that font. The guidance provided in this section
is based on the experience of building an encoder implementation during development of this specification. It represents the  best
understanding (at the time of writing) of how to generate a high performance encoding which meets requirements 1 through 4 of <a href="#encoding">§ 7 Encoding</a> and thus preserves all functionality/behavior of the original font being encoded.</p>
   <p><b>About <a href="#table-keyed">§ 6.2 Table Keyed</a> patches</b></p>
   <p>A <a href="#table-keyed">§ 6.2 Table Keyed</a> patch can change the contents of some font tables and not others. Each patched table typically needs to be
relative to a specific table content, but other tables can have different contents. Therefore as long as a <a href="#table-keyed">§ 6.2 Table Keyed</a> patch does not alter the tables containing glyph data it can be compatible with <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patches and therefore be only <a data-link-type="dfn" href="#partial-invalidation" id="ref-for-partial-invalidation②">Partially Invalidating</a> (in that it will invalidate other <a href="#table-keyed">§ 6.2 Table Keyed</a> patches but not <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patches). Additionally two sets of <a href="#table-keyed">§ 6.2 Table Keyed</a> patches can be independent of each other if they do not
modify any of the same tables.  For example, one could use <a href="#table-keyed">§ 6.2 Table Keyed</a> patches for all
content other than the glyph tables but then use another set of <a href="#table-keyed">§ 6.2 Table Keyed</a> patches for those tables rather than <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patches, and each of these could in theory be <a data-link-type="dfn" href="#partial-invalidation" id="ref-for-partial-invalidation③">Partially Invalidating</a>—leaving them
mutually dependent but independent of one another.</p>
   <p>An application of a <a href="#table-keyed">§ 6.2 Table Keyed</a> patch will typically alter the IFT or IFTX table it was was listed in to add a new set
of patches to further extend the font. This means that the total set of <a href="#table-keyed">§ 6.2 Table Keyed</a> patches forms a graph,
in which each font subset in the segmentation is a node and each patch is an edge. This also means that patches of these types
are typically downloaded and applied in series, which has implications for the performance of this patch type relative to latency.</p>
   <p><b>About <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patches</b></p>
   <p><a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patches are quite distinct from the other patch types. First, <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patches can only modify
tables containing glyph outline data, and therefore an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font①⑦">incremental font</a> that only uses <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> must include all
other font table data in the initial font file. Second, <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patches are <a data-link-type="dfn" href="#no-invalidation" id="ref-for-no-invalidation①">not Invalidating</a>,
and can therefore be downloaded and applied independently. This independence means multiple patches can be downloaded in parallel
which can significantly reduce the number of round trips needed relative to the invalidating patch types.</p>
   <p><b>Choosing patch formats for an encoding</b></p>
   <p>All encodings must chose one or more patch types to use. <a href="#table-keyed">§ 6.2 Table Keyed</a> patches allow
all types of data in the font to be patched, but because this type is at least <a data-link-type="dfn" href="#partial-invalidation" id="ref-for-partial-invalidation④">Partially Invalidating</a>,
the total number of patches needed increases exponentially with the number of segments rather than linearly. <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patches
are limited to updating outline and variation delta data but the number needed scales linearly with number of segments.</p>
   <p>In addition to the number of patches, the encoder should also consider the number of network round trips that will be needed to
get patches for typical content. For invalidating patch types it is necessary to make patch requests in series. This means that if some
content requires multiple segments then, multiple network round trips may be needed. Glyph keyed patches on the other hand are not
invalidating and the patches can be fetched in parallel, needing only a single round trip.</p>
   <p>At the extremes of the two types, <a href="#table-keyed">§ 6.2 Table Keyed</a> patches, are most appropriate for fonts with sizable non-outline data that only require
a small number of patches. <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patches are most appropriate for fonts where the vast majority of data consists of glyph
outlines, which is true of many existing CJK fonts.</p>
   <p>For fonts that are in-between, or in cases where fine-grained segmentation of glyph data is desired but segmentation of data
in other tables is still needed, it can be desirable to mix the <a href="#table-keyed">§ 6.2 Table Keyed</a> and <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patch types in this
way:</p>
   <ol>
    <li data-md>
     <p>Keep all table keyed patch entries in one mapping table and all glyph keyed entries in the other mapping table.</p>
    <li data-md>
     <p>Use table keyed patches to update all tables except for the tables touched by the glyph keyed patches (outline,
variation deltas, and the glyph keyed patch mapping table). These patches should use a small number of large segments to keep
the patch count reasonable.</p>
    <li data-md>
     <p>Because glyph keyed patches reference the specific glyph IDs that are updated, the table keyed patches must not change
the glyph to glyph ID assignments used in the original font; otherwise, the glyph IDs listed in the glyph keyed patches may
become incorrect. In font subsetters this is often available as an option called "retain glyph IDs".</p>
    <li data-md>
     <p>Lastly, use glyph keyed patches to update the remaining tables, here much smaller fine-grained segments can be utilized without
requiring too many patches.</p>
   </ol>
   <p>The mixed patch type encoding is expected to be a commonly used approach since many fonts will fall somewhere in between the two
extremes.</p>
   <p><b>Reducing round trips with invalidating patches</b></p>
   <p>One way to reduce the number of round trips needed with a segmentation that uses one of the invalidating patch types is to provide
patches that add multiple segments at once (in addition to patches for single segments). For example consider a font which has 4 segments:
A, B, C, and D. The patch table could list patches that add: A, B, C, D, A + B, A + C, A + D, B + C, B + D, and C + D. This would
allow any two segments to be added in a single round trip. The downside to this approach is that it further increases the number of unique
patches needed.</p>
   <p><b>Entry order in encoded patch mappings</b></p>
   <p>In <a href="#invalidating-patch-selection">§ 4.4 Selecting Invalidating Patches</a> the client uses the order of an entry in the patch map to break ties when selecting which patches to load and apply.
Clients are aiming to reduce total transfer sizes so when multiple entries are tied in intersection size it’s generally in the client’s interest to choose
the patch which has the smallest total transfer size. As a result encoders should place entries in the patch map ordered from smallest to largest size in
bytes. This will ensure clients that when clients follow <a href="#invalidating-patch-selection">§ 4.4 Selecting Invalidating Patches</a> they bias towards smaller patches and maximize performance.</p>
   <p><b>Managing the number of patches</b></p>
   <p>Using <a href="#table-keyed">§ 6.2 Table Keyed</a> patches along side a large number of segments can result in a very large number of patches needed, which can have two
negative effects. First, the storage space needed for all of the pre-generated patches could be undesirably large. Second, more 
patches will generally mean lower CDN cache performance, because a higher number of patches represents a higher number of paths
from a given subset to a given subset, with different paths being taken by different users depending on the content they access.
There are some techniques which can be used to reduce the total number of pre-generated patches:</p>
   <ol>
    <li data-md>
     <p>Use a maximum depth for the patch graph, once this limit is reached the font is patched to add all remaining parts of the full
original font. This will cause the whole remaining font to be loaded after a certain number of segments have been added. Limiting
the depth of the graph will reduced the combinatorial explosion of patches at the lower depths.</p>
    <li data-md>
     <p>Alternatively, at lower depths the encoder could begin combining multiple segments into single patches to reduce the fan out at each
level.</p>
   </ol>
   <p><b>Choosing segmentations</b></p>
   <p>One of the most important and complex decisions an encoder needs to make is how to segment the data in the encoded font. The discussion
above focused on the number of segments, but the performance of an <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font①⑧">incremental font</a> depends much more on the grouping of data
within segments. To maximize efficiency an encoder needs to group data (eg. code points) that are commonly used together into the same
segments. This will reduce the amount of unneeded data load by clients when extending the font. The encoder must also decide the size
of segments. Smaller segments will produce more patches, and thus incur more overhead by requiring more network requests, but will
typically result in less unneeded data in each segment compared to larger segments. When segmenting code points, data on code point usage
frequency can be helpful to guide segmentation.</p>
   <p>Some code points may have self-evident segmentations, or at least there may be little question as to what code points to group together.
For example, upper and lowercase letters of the Latin alphabet form a natural group. Other cases may be more complicated. For example,
Chinese, Japanese, and Korean share some code points, but a code point that is high-frequency in Japanese may be lower-frequency in
Chinese. In some cases one might choose to optimize an encoding for a single language. Another approach is to produce a compromise
encoding. For example, when segmenting an encoder could put code points that are frequent in Japanese, Chinese, and Korean into one
segment, and then those that are frequent only in Japanese and Chinese into another segment, and so on. Then the code points that
are frequent in only one language can be handled in the usual way. This will result in less even segment sizes, but means that 
loading high-frequency patches for any one of the languages will not pull in lower-frequency glyphs.</p>
   <p><b>Include default layout features</b></p>
   <p><a href="#feature-tag-list">Appendix A: Default Feature Tags</a> collects a list of <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/featuretags#">layout features</a> which are commonly used by default. Since the features
in this list will typically always be used by shapers, for best performance encoders should typically not make any of these features
optional in the encoding of a font.</p>
   <p><b>Maintaining Functional Equivalence</b></p>
   <p>As discussed in <a href="#encoding">§ 7 Encoding</a> an encoder should preserve the functionality of the original font. Fonts are complex
and often contain interactions between code points so maintaining functional equivalence with a partial copy of the font can be tricky.
The next two subsections discuss maintaining functional equivalent using the different patch types.</p>
   <p><b>Table keyed patches</b></p>
   <p>When preparing <a href="#table-keyed">§ 6.2 Table Keyed</a> patches, one means of achieving functional equivalence is to leverage an
existing font subsetter implementation to produce font subsets that retain the functionality of the original font. The IFT patches
can then be derived from these subsets.</p>
   <p>A font subsetter produces a <a data-link-type="dfn" href="#font-subset" id="ref-for-font-subset②④">font subset</a> from an input font based on a desired <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition①④">font subset definition</a>. The practice of reliably
subsetting a font is well understood and has multiple open-source implementations (a full formal description is
beyond the scope of this document). It typically involves a reachability analysis, where the data in tables is examined
relative to the font subset definition to see which portions can be reached by any possible content covered by the subset definition.
Any reachable data is retained in the generated font subset, while any unreachable data may be removed.</p>
   <p>In the following example pseudo code a font subsetter is used to generate an IFT encoded font that utilizes only table keyed patches:</p>
<pre class="highlight"><c- c1># Encode a font (full_font) into an incremental font that starts at base_subset_def</c->
<c- c1># and can incrementally add any of subset_definitions. Returns the IFT encoded font</c->
<c- c1># and set of associated patches.</c->
<c- n>encode_as_ift</c-><c- p>(</c-><c- n>full_font</c-><c- p>,</c-> <c- n>base_subset_def</c-><c- p>,</c-> <c- n>subset_definitions</c-><c- p>):</c->
  <c- n>base_font</c-> <c- o>=</c-> <c- n>subset</c-><c- p>(</c-><c- n>full_font</c-><c- p>,</c-> <c- n>base_subset_def</c-><c- p>)</c->
  <c- n>base_font</c-><c- p>,</c-> <c- n>patches</c->  <c- o>=</c-> <c- n>encode_node</c-><c- p>(</c-><c- n>full_font</c-><c- p>,</c-> <c- n>base_font</c-><c- p>,</c-> <c- n>base_subset_def</c-><c- p>,</c-> <c- n>subset_definitions</c-><c- p>)</c->
  <c- k>return</c-> <c- n>base_font</c-><c- p>,</c-> <c- n>patches</c->

<c- c1># Update base_font to add all of the ift patch mappings to reach any of</c->
<c- c1># subset_definitions and produces the associated patches.</c->
<c- n>encode_node</c-><c- p>(</c-><c- n>full_font</c-><c- p>,</c-> <c- n>base_font</c-><c- p>,</c-> <c- n>cur_def</c-><c- p>,</c-> <c- n>subset_definitions</c-><c- p>):</c->
  <c- n>patches</c-> <c- o>=</c-> <c- p>[]</c->
  <c- n>next_fonts</c-> <c- o>=</c-> <c- p>[]</c->
  
  <c- k>for</c-> <c- n>each</c-> <c- n>subset_def</c-> <c- ow>in</c-> <c- n>subset_definitions</c-> <c- ow>not</c-> <c- n>fully</c-> <c- n>covered</c-> <c- n>by</c-> <c- n>cur_def</c-><c- p>:</c->
    <c- n>next_def</c-> <c- o>=</c-> <c- n>subset_def</c-> <c- n>union</c-> <c- n>cur_def</c->
    <c- n>next_font</c-> <c- o>=</c-> <c- n>subset</c-><c- p>(</c-><c- n>full_font</c-><c- p>,</c-> <c- n>next_def</c-><c- p>)</c->
    <c- n>let</c-> <c- n>patch_url</c-> <c- n>be</c-> <c- n>a</c-> <c- n>new</c-> <c- n>unique</c-> <c- n>url</c->

    <c- n>add</c-> <c- n>a</c-> <c- n>mapping</c-> <c- n>from</c-><c- p>,</c-> <c- p>(</c-><c- n>subset_def</c-> <c- o>-</c-> <c- n>cur_def</c-><c- p>)</c-> <c- n>to</c-> <c- n>patch_url</c-><c- p>,</c-> <c- n>into</c-> <c- n>base_font</c->
    <c- n>next_font</c-><c- p>,</c-> <c- n>patches</c-> <c- o>+=</c-> <c- n>encode_node</c-><c- p>(</c-><c- n>full_font</c-><c- p>,</c-> <c- n>next_font</c-><c- p>,</c-> <c- n>next_def</c-><c- p>,</c-> <c- n>subset_definitions</c-><c- p>)</c->

    <c- n>next_fonts</c-> <c- o>+=</c-> <c- p>(</c-><c- n>next_font</c-><c- p>,</c-> <c- n>next_def</c-><c- p>,</c-> <c- n>patch_url</c-><c- p>)</c->

  <c- k>for</c-> <c- n>each</c-> <c- p>(</c-><c- n>next_font</c-><c- p>,</c-> <c- n>next_def</c-><c- p>,</c-> <c- n>patch_url</c-><c- p>)</c-> <c- ow>in</c-> <c- n>next_fonts</c-><c- p>:</c->
    <c- n>patch</c-> <c- o>=</c-> <c- n>table_keyed_patch_diff</c-><c- p>(</c-><c- n>base_font</c-><c- p>,</c-> <c- n>next_font</c-><c- p>)</c->
    <c- n>patches</c-> <c- o>+=</c-> <c- p>(</c-><c- n>patch</c-><c- p>,</c-> <c- n>patch_url</c-><c- p>)</c->
  
  <c- k>return</c-> <c- n>base_font</c-><c- p>,</c-> <c- n>patches</c->
</pre>
   <p>In this example implementation, if the union of the input base subset definition and the list of subset definitions fully covers the input
full font, and the subsetter implementation used correctly retains all functionality then, the above implementation should meet the
requirements in <a href="#encoding">§ 7 Encoding</a> to be a neutral encoding. This basic encoder implementation is for demonstration purposes and not meant
to be representative of all possible encoder implementations. Notably it does not make use of nor demonstrate utilizing glyph keyed
patches. Most encoders will likely be more complex and need to consider additional factors some of which are discussed in the remaining
sections.</p>
   <p><b><a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patches</b></p>
   <p>Specifically because they are parameterized by code points and feature tags but can be applied independently of one another, <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patches have additional requirements and cannot be directly derived by using a subsetter implementation.  However,
such an implementation can help clarify what an encoder needs to do to maintain functional equivalence when producing this type
of patch. Consider the result of producing the subset of a font relative to a given <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition①⑤">font subset definition</a>. We can define
the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="glyph-closure">glyph closure</dfn> of that <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition①⑥">font subset definition</a> as the full set of glyphs included in the subset, which the
subsetter has determined is needed to render any combination of the described code points and layout features.</p>
   <p>Using that definition, the <b>glyph closure requirement</b> on the full set <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patches is:</p>
   <ul>
    <li data-md>
     <p>The set of glyphs contained in the patches loaded for a <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition①⑦">font subset definition</a> through the patch map tables must be a superset
of those in the <a data-link-type="dfn" href="#glyph-closure" id="ref-for-glyph-closure">glyph closure</a> of the <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition①⑧">font subset definition</a>.</p>
   </ul>
   <p>Assuming the subsetter does its job accurately, the glyph closure requirement is a consequence of the requirement for equivalent
behavior: Suppose there is a <a data-link-type="dfn" href="#font-subset-definition" id="ref-for-font-subset-definition①⑨">font subset definition</a> such that the subsetter includes glyph *i* in its subset, but an encoder that
produces <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patches omits glyph *i* from the set of patches that correspond to that definition. If the subsetter is
right, that glyph must be present to retain equivalent behavior when rendering some combination of the code points and features in 
the definition, which means that the <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font①⑨">incremental font</a> will not behave equivalently when rendering that combination.</p>
   <p>Therefore, when generating an encoding utilizing glyph-keyed patches the encoder must determine how to distribute glyphs between all
of the patches in a way that meets the glyph closure requirement. This is primarily a matter of looking at the code points assigned
to a segment and determining what other glyphs must be included in the patch that corresponds to it, as when a glyph variant can
be substituted for a glyph included in the segment by code point.  In some cases a glyph might only be needed when multiple segments
have been loaded, in which case that glyph can be added to the patch corresponding to any of those segments. (This can be true of 
a ligature or a pre-composed accented character.) Finally, after the initial analysis of segments the same glyph might be needed 
when loading the patches for two or more segments.  There are five main strategies for dealing with that situation:</p>
   <ol>
    <li data-md>
     <p>Two or more segments can be combined to be contained within a single patch. This avoids duplicating the common glyphs, but
 increases the segment’s size.</p>
    <li data-md>
     <p>The common glyphs can be placed in their own patch and then mapping entries set up to trigger the load of that common patch along side
 any of the segments that will need it. For example if 'c' is a common segment needed by segments 'a' and 'b' then, you could
 have the following mapping entries (via a format 2 mapping table):</p>
     <ul>
      <li data-md>
       <p>subset definition a → segment a</p>
      <li data-md>
       <p>subset definition b → segment b</p>
      <li data-md>
       <p>subset definition a union subset definition b → segment c</p>
     </ul>
    <li data-md>
     <p>In some cases, such as with <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/cmap#format-14-unicode-variation-sequences">Unicode variation selectors</a>, there will be a
 modifier code point which triggers a glyph substitution when paired with many other code points. Given the large number of alternate
 glyphs it’s desirable to keep them in their own patches which are only loaded when both the modifier code point and appropriate base
 code point(s) are present. This can be achieved by using a <a href="#patch-map-format-2">Format 2 Patch Map</a> and multiple entry matching
 via <a data-link-type="dfn" href="#mapping-entry-childentryindices" id="ref-for-mapping-entry-childentryindices③">childEntryIndices</a>. See <a href="#appendix-b-example-2">Example 2: Glyph Keyed Patches with Child Entries</a> for an example of how this can be set up.</p>
    <li data-md>
     <p>Alternatively, the glyph can be included in more than one of the patches that correspond to those segments at the cost of duplicating
 the glyph’s data into multiple patches.</p>
    <li data-md>
     <p>Lastly, the common glyph can be moved into the initial font. This avoids increasing segment sizes and duplicating the glyph data,
 but will increase the size of the initial font. It also means that the glyph’s data is always loaded, even when not needed. This
 can be useful for glyphs that are required in many segments or are otherwise complicating the segmentation.</p>
   </ol>
   <p><b>Pre-loading data in the Initial Font</b></p>
   <p>In some cases it might be desirable to avoid the overhead of applying patches to an initial file. For example, it could
be desirable that the font loaded on a company home page already be able to render the content on that page. The main benefit
of such a file is reduced rendering latency: the content can be rendered after a single round-trip.</p>
   <p>There are two approaches to including data in the downloaded font file. One is to simply encode the <a data-link-type="dfn" href="#incremental-font" id="ref-for-incremental-font②⓪">incremental font</a> as a whole so that the data is in the initial file. Any such data will always be available in any patched version of the font.
This can be helpful in cases when the same data would otherwise be needed in many different segments.</p>
   <p>The other approach is to download an already-patched font. That is, one can encode a font with little or no data in the "base"
file but then apply patches to that file on the server side, so that the file downloaded already includes the data contained
in those patches.</p>
   <p>When only one pre-loaded version of a font is needed these strategies will have roughly equivalent results, but the first is both
simpler and in some cases more specific. However, when more than one pre-loaded font is needed the pre-patching approach will often
be better. When using the first approach, one would need to produce multiple encodings, one for each preloaded file. When using
the second approach, all of the preloaded files will still share the same overall patch graph, which both reduces the total space
needed to store the patches and improves CDN cache efficiency, as all the pre-loaded files will choose subsequent patches from the
same set.</p>
   <p><b>Table ordering</b></p>
   <p>In the initial font file (whether encoded as woff2 or not) it is possible to customize the order of the actual table bytes within
the file. Encoders should consider placing the mapping tables (IFT and IFTX) plus any additional tables needed to decode the
mapping tables (cmap) as early as possible in the file. This will allow optimized client implementations to access the 
patch mapping prior to receiving all of the font data and potentially initiate requests for any required patches earlier.</p>
   <p>Likewise table keyed patches have a separate brotli stream for each patched table and the format allows these streams to be placed
in any order in the patch file. So for the same reasons encoders should consider placing updates to the mapping tables plus any
additional tables needed to decode the mapping tables as early as possible in the patch file.</p>
   <p><b>Choosing the input ID encoding</b></p>
   <p>The specification supports two encodings for embedding patch IDs in the URL template. The first is <a href="https://www.rfc-editor.org/rfc/rfc4648#section-7">base32hex</a>,
which is a good match for pre-generated patches that will typically be stored in a filesystem. Base32hex encoding only uses the
letters 0-9 and A-V, which are safe letters for a file name in every commonly used filesystem, with no risk of collisions due to
case-insensitivity. Because the string is embedded without padding this format cannot be reliably decoded, so it may be a poor
choice for dynamically generated patches. The other encoding is <a href="https://www.rfc-editor.org/rfc/rfc4648#section-5">base64url</a>, a variant of base64 encoding
appropriate for embedding in a URL or case-sensitive filesystem. When using this encoding the id is embedded with padding so that
the value can be reliably decoded.</p>
   <p>The individual character selectors d1 through d4 are relative to the base32hex encoded id only. These are typically used to
reduce the number of files stored in a single filesystem directory by spreading related files out into one or more levels of
subdirectory according to the trailing letters of the id encoding. These will tend to be evenly distributed among the digits
when using integer ids, but may be unevenly distributed or even constant for string ids. Encoders that wish to use string ids with
d1 through d4 should take care to make the ends of the id strings vary.  It is valid to mix d1 through d4 with a base64url-encoded
id.</p>
   <h2 class="heading settled" data-level="8" id="priv"><span class="secno">8. </span><span class="content">Privacy Considerations</span><a class="self-link" href="#priv"></a></h2>
   <h3 class="heading settled" data-level="8.1" id="content-inference-from-character-set"><span class="secno">8.1. </span><span class="content">Content inference from character set</span><a class="self-link" href="#content-inference-from-character-set"></a></h3>
   <p>IFT exposes, to the server hosting a Web font, information on the set of characters that the browser wants to render with the font (for
details, see <a href="#extending-font-subset">§ 4 Extending a Font Subset</a>).</p>
   <p>For some languages, which use a very large character set (Chinese and Japanese are examples) the vast reduction in total
bytes transferred means that Web fonts become usable, including on mobile networks, for the first time. However, for those languages, it
is <em>possible</em> that individual requests might be analyzed by a rogue font server to obtain intelligence about the type of content
which is being read. It is unclear how feasible this attack is, or the computational complexity required to exploit it, unless the
characters being requested are very unusual.</p>
   <p>More specifically, a IFT font includes a collection of unicode code point groups and requests will be made for groups that intersect
content being rendered. This provides information to the hosting server that at least one code point in a group was needed, but does not
contain information on which specific code points within a group were needed. This is functionally quite similar to the existing <a href="https://www.w3.org/TR/css-fonts-4/#unicode-range-desc"><cite>CSS Fonts 4</cite> § 4.5 Character range: the unicode-range descriptor</a> and has the same privacy implications. Discussion of the privacy implication of unicode-range can be
found in the CSS Fonts 4 specification:</p>
   <ul>
    <li data-md>
     <p><a href="https://www.w3.org/TR/css-fonts-4/#sp201"><cite>CSS Fonts 4</cite> § 15.1 What information might this feature expose to Web sites or other parties, and for what purposes is that exposure necessary?</a>. For especially privacy-sensitive-contexts this recommends the user agent download all web fonts in a document.
For IFT fonts, utilizing <a href="#fully-expanding-a-font">§ 4.7 Fully Expanding a Font</a> will fetch the entire available IFT font without providing any information about
the specific content present. Alternatively, in a privacy sensitive contexts a user agent could randomly select additional patches
that are not required by the current content to provide obfuscation of what patches are actually needed.</p>
    <li data-md>
     <p><a href="https://www.w3.org/TR/css-fonts-4/#sp208"><cite>CSS Fonts 4</cite> § 15.8 What data does this specification expose to an origin? Please also document what data is identical to data exposed by other features, in the same or different contexts.</a></p>
   </ul>
   <h3 class="heading settled" data-level="8.2" id="per-origin"><span class="secno">8.2. </span><span class="content">Per-origin restriction avoids fingerprinting</span><a class="self-link" href="#per-origin"></a></h3>
   <p>As required by <a data-link-type="biblio" href="#biblio-css-fonts-4" title="CSS Fonts Module Level 4">[css-fonts-4]</a>:</p>
   <p>"A Web Font must not be accessible in any other Document from the one which either is associated with
  the @font-face rule or owns the FontFaceSet. Other applications on the device must not be able to access
  Web Fonts." - <a href="https://www.w3.org/TR/css-fonts-4/#web-fonts"><cite>CSS Fonts 4</cite> § 10.2 Web Fonts</a></p>
   <p>Since IFT fonts are treated the same as regular fonts in CSS (<a href="#opt-in">§ 2 Opt-In Mechanism</a>) these requirements apply and avoid information leaking across
  origins.</p>
   <p>Similar requirements apply to font palette values:</p>
   <p>"An author-defined font color palette must only be available to the documents that reference it. Using an author-defined color palette
  outside of the documents that reference it would constitute a security leak since the contents of one page would be able to
  affect other pages, something an attacker could use as an attack vector." - <a href="https://www.w3.org/TR/css-fonts-4/#font-palette-values"><cite>CSS Fonts 4</cite> § 9.2 User-defined font color palettes: The @font-palette-values rule</a></p>
   <h2 class="heading settled" data-level="9" id="sec"><span class="secno">9. </span><span class="content">Security Considerations</span><a class="self-link" href="#sec"></a></h2>
   <p>One security concern is that IFT fonts could potentially generate a large number of network requests for patches. This could cause
problems on the client or the service hosting the patches. The IFT specification contains a couple of mitigations to limit excessive
number of requests:</p>
   <ol>
    <li data-md>
     <p><a href="#extending-font-subset">§ 4 Extending a Font Subset</a>: disallows re-requesting the same URL multiple times and has limits on the total number of requests
 that can be issued during the extension process.</p>
    <li data-md>
     <p><a data-link-type="abstract-op" href="#abstract-opdef-load-patch-file" id="ref-for-abstract-opdef-load-patch-file②">Load patch file</a>: specifies the use of <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a> in implementing web browsers and matches the CORS settings for the initial
 font load. As a result cross-origin requests for patch files are disallowed unless the hosting service opts in via the appropriate
 access control headers.</p>
   </ol>
   <h2 class="heading settled" data-level="10" id="changes"><span class="secno">10. </span><span class="content">Changes</span><a class="self-link" href="#changes"></a></h2>
   <p>Since the <a href="https://www.w3.org/TR/2024/WD-IFT-20240709/">Working
  Draft of 09 July 2024</a> (see <a href="https://github.com/w3c/IFT/commits/main/Overview.bs">commit history</a>):</p>
   <ul>
    <li>Added an extension example to appendix B that utilizes child entries
    <li>Keep prior entries separate from the filtered list for output in format 2 interpretation.
    <li>Called the referenced entries in a mapping entry, child entries.
    <li>Reworked the copy indices mechanism in terms of whether the referenced entries would intersect
    <li>Modifications to format 1 and format 2 patch map encodings based on implementation work (eg. clarifications, error handling, and
      fixes to oversights).
    <li>Added section on caching of incremental fonts.
    <li>Added guidance around default layout features.
    <li>Removed the pure brotli patch format, remaining patch formats are now table keyed and glyph keyed.
    <li>Add a procedure to check what content an IFT font can render.
    <li>Explicit pre-fetching added to the extension algorithm.
    <li>Appendix B added which contains extension algorithm example executions.
   </ul>
   <h2 class="heading settled" id="feature-tag-list"><span class="content"> Appendix A: Default Feature Tags</span><a class="self-link" href="#feature-tag-list"></a></h2>
   <p><em>This appendix is not normative.</em> It provides a list of <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/featuretags#">layout features</a> which are considered
to be used by default in most shaper implementations. This list was assembled from:</p>
   <ul>
    <li data-md>
     <p><a href="https://learn.microsoft.com/en-us/typography/opentype/spec/featurelist#">OpenType Layout Feature Registry</a></p>
    <li data-md>
     <p>Features which are listed as "default on" in <a data-link-type="biblio" href="#biblio-enabling-typography" title="Enabling Typography: towards a general model of OpenType Layout">[enabling-typography]</a></p>
    <li data-md>
     <p>Features which are in default set in the <a href="https://github.com/harfbuzz/harfbuzz/blob/main/src/hb-subset-input.cc">harfbuzz subsetter</a>.</p>
   </ul>
   <p><b>Layout Features used by Default in Shapers</b></p>
   <table>
    <tbody>
     <tr>
      <th>Tag
      <th>Name
     <tr>
      <td>abvf
      <td>Above-base Forms
     <tr>
      <td>abvm
      <td>Above-base Mark Positioning
     <tr>
      <td>abvs
      <td>Above-base Substitutions
     <tr>
      <td>akhn
      <td>Akhand
     <tr>
      <td>blwf
      <td>Below-base Forms
     <tr>
      <td>blwm
      <td>Below-base Mark Positioning
     <tr>
      <td>blws
      <td>Below-base Substitutions
     <tr>
      <td>calt
      <td>Contextual Alternates
     <tr>
      <td>ccmp
      <td>Glyph Composition / Decomposition
     <tr>
      <td>cfar
      <td>Conjunct Form After Ro
     <tr>
      <td>chws
      <td>Contextual Half-width Spacing
     <tr>
      <td>cjct
      <td>Conjunct Forms
     <tr>
      <td>clig
      <td>Contextual Ligatures
     <tr>
      <td>cswh
      <td>Contextual Swash
     <tr>
      <td>curs
      <td>Cursive Positioning
     <tr>
      <td>dist
      <td>Distances
     <tr>
      <td>dnom
      <td>Denominators
     <tr>
      <td>dtls
      <td>Dotless Forms
     <tr>
      <td>fin2
      <td>Terminal Forms #2
     <tr>
      <td>fin3
      <td>Terminal Forms #3
     <tr>
      <td>fina
      <td>Terminal Forms
     <tr>
      <td>flac
      <td>Flattened accent forms
     <tr>
      <td>frac
      <td>Fractions
     <tr>
      <td>half
      <td>Half Forms
     <tr>
      <td>haln
      <td>Halant Forms
     <tr>
      <td>init
      <td>Initial Forms
     <tr>
      <td>isol
      <td>Isolated Forms
     <tr>
      <td>jalt
      <td>Justification Alternates
     <tr>
      <td>kern
      <td>Kerning
     <tr>
      <td>liga
      <td>Standard Ligatures
     <tr>
      <td>ljmo
      <td>Leading Jamo Forms
     <tr>
      <td>locl
      <td>Localized Forms
     <tr>
      <td>ltra
      <td>Left-to-right alternates
     <tr>
      <td>ltrm
      <td>Left-to-right mirrored forms
     <tr>
      <td>mark
      <td>Mark Positioning
     <tr>
      <td>med2
      <td>Medial Forms #2
     <tr>
      <td>medi
      <td>Medial Forms
     <tr>
      <td>mkmk
      <td>Mark to Mark Positioning
     <tr>
      <td>mset
      <td>Mark Positioning via Substitution
     <tr>
      <td>nukt
      <td>Nukta Forms
     <tr>
      <td>numr
      <td>Numerators
     <tr>
      <td>pref
      <td>Pre-Base Forms
     <tr>
      <td>pres
      <td>Pre-base Substitutions
     <tr>
      <td>pstf
      <td>Post-base Forms
     <tr>
      <td>psts
      <td>Post-base Substitutions
     <tr>
      <td>rand
      <td>Randomize
     <tr>
      <td>rclt
      <td>Required Contextual Alternates
     <tr>
      <td>rkrf
      <td>Rakar Forms
     <tr>
      <td>rlig
      <td>Required Ligatures
     <tr>
      <td>rphf
      <td>Reph Forms
     <tr>
      <td>rtla
      <td>Right-to-left alternates
     <tr>
      <td>rtlm
      <td>Right-to-left mirrored forms
     <tr>
      <td>rvrn
      <td>Required Variation Alternates
     <tr>
      <td>ssty
      <td>Math script style alternates
     <tr>
      <td>stch
      <td>Stretching Glyph Decomposition
     <tr>
      <td>tjmo
      <td>Trailing Jamo Forms
     <tr>
      <td>valt
      <td>Alternate Vertical Metrics
     <tr>
      <td>vatu
      <td>Vattu Variants
     <tr>
      <td>vchw
      <td>Vertical Contextual Half-width Spacing
     <tr>
      <td>vert
      <td>Vertical Writing
     <tr>
      <td>vjmo
      <td>Vowel Jamo Forms
     <tr>
      <td>vkrn
      <td>Vertical Kerning
     <tr>
      <td>vpal
      <td>Proportional Alternate Vertical Metrics
     <tr>
      <td>vrt2
      <td>Vertical Alternates and Rotation
     <tr>
      <td>vrtr
      <td>Vertical Alternates for Rotation
   </table>
   <h2 class="heading settled" id="extension-example"><span class="content"> Appendix B: Extension Algorithm Example Execution</span><a class="self-link" href="#extension-example"></a></h2>
   <p>This appendix provides examples of how a typical IFT font would be processed by the <a href="#extend-font-subset">§ 4.3 Incremental Font Extension Algorithm</a> algorithm.</p>
   <h3 class="heading settled" id="appendix-b-example-1"><span class="content">Example 1: Table and Glyph Keyed Patches</span><a class="self-link" href="#appendix-b-example-1"></a></h3>
   <p>In this example the IFT font contains a mix of both <a href="#table-keyed">§ 6.2 Table Keyed</a> and <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patches.</p>
   <p><b>Initial font</b>: contains the following IFT and IFTX patch mappings. Note: when features and design space sets are unspecified in a subset definition
they are defaulted to an empty set.</p>
   <table>
    <tbody>
     <tr>
      <th>Table = "IFT "
      <th colspan="2">Compatibility ID = 0x0000_0000_0000_0001
     <tr>
      <th>Subset Definition
      <th>URL
      <th>Format Number
     <tr>
      <td>
<pre>code points: { 'a', 'b', ..., 'z' }
</pre>
      <td>//foo.bar/01.tk
      <td> 2, Table Keyed - Partial Invalidation 
     <tr>
      <td>
<pre>code points: { 'A', 'B', ..., 'Z' }
</pre>
      <td>//foo.bar/02.tk
      <td> 2, Table Keyed - Partial Invalidation 
     <tr>
      <td>
<pre>code points: { '0', '1', ..., '9' }
</pre>
      <td>//foo.bar/03.tk
      <td> 2, Table Keyed - Partial Invalidation 
     <tr>
      <td>
<pre>code points: { 'a', 'b', ..., 'z',
               'A', 'B', ..., 'Z' }
</pre>
      <td>//foo.bar/04.tk
      <td> 2, Table Keyed - Partial Invalidation 
     <tr>
      <td>
<pre>code points: { 'a', 'b', ..., 'z',
               'A', 'B', ..., 'Z',
               '0', '1', ..., '9' }
</pre>
      <td>//foo.bar/05.tk
      <td> 2, Table Keyed - Partial Invalidation 
   </table>
    <br> 
   <table>
    <tbody>
     <tr>
      <th>Table = "IFTX"
      <th colspan="2">Compatibility ID = 0x0000_0000_0000_0002
     <tr>
      <th>Subset Definition
      <th>URL
      <th>Format Number
     <tr>
      <td>
<pre>code points: { 'a', 'b', ..., 'm' }
</pre>
      <td>//foo.bar/01.gk
      <td> 3, Glyph Keyed 
     <tr>
      <td>
<pre>code points: { 'n', 'o', ..., 'z' }
</pre>
      <td>//foo.bar/02.gk
      <td> 3, Glyph Keyed 
     <tr>
      <td>
<pre>code points: { 'A', 'B', ..., 'M' }
</pre>
      <td>//foo.bar/03.gk
      <td> 3, Glyph Keyed 
     <tr>
      <td>
<pre>code points: { 'N', 'O', ..., 'Z' }
</pre>
      <td>//foo.bar/04.gk
      <td> 3, Glyph Keyed 
     <tr>
      <td>
<pre>code points: { '0', '1', ..., '9' }
</pre>
      <td>//foo.bar/05.gk
      <td> 3, Glyph Keyed 
   </table>
   <p><b>Optimized Extension Example</b></p>
   <p class="note" role="note"><span class="marker">Note:</span> this example execution is described as it would be implemented in an optimized client which aims to reduce the number of round trips needing to be
      made to extend the font for a target subset definition. This optimized execution is fully compliant with the extension algorithm but 
      loads some URLs (the glyph keyed URLs) earlier than specified in the extension algorithm. This is allowed because these patches
      will not be invalidated by the preceding table keyed patch.</p>
   <p>Inputs:</p>
   <ul>
    <li data-md>
     <p>Initial font with the IFT and IFTX tables as defined above.</p>
    <li data-md>
     <p>Target subset definition: code points = {'f', 'P'}</p>
   </ul>
   <p>Iteration 1:</p>
   <ul>
    <li data-md>
     <p>Steps 1 through 6 - applying the <a data-link-type="abstract-op" href="#abstract-opdef-check-entry-intersection" id="ref-for-abstract-opdef-check-entry-intersection③">Check entry intersection</a> check to all entries in the initial font, the following patch entries intersect:</p>
     <ul>
      <li data-md>
       <p>//foo.bar/01.tk</p>
      <li data-md>
       <p>//foo.bar/02.tk</p>
      <li data-md>
       <p>//foo.bar/04.tk</p>
      <li data-md>
       <p>//foo.bar/05.tk</p>
      <li data-md>
       <p>//foo.bar/01.gk</p>
      <li data-md>
       <p>//foo.bar/04.gk</p>
     </ul>
    <li data-md>
     <p>Step 8 - one entry from that set must be picked. There a no full invalidation entries, so one partial invalidation entry (//foo.bar/*.tk) must be
selected. Following <a href="#invalidating-patch-selection">§ 4.4 Selecting Invalidating Patches</a> the candidate entries have the following intersections with the target subset definition:</p>
     <ul>
      <li data-md>
       <p>//foo.bar/01.tk - {'f'}</p>
      <li data-md>
       <p>//foo.bar/02.tk - {'P'}</p>
      <li data-md>
       <p>//foo.bar/04.tk - {'f', 'P'}</p>
      <li data-md>
       <p>//foo.bar/05.tk - {'f', 'P'}</p>
     </ul>
     <p>The intersections for //foo.bar/01.tk and //foo.bar/02.tk are both strict subsets of //foo.bar/04.tk and //foo.bar/05.tk, so they don’t meet selection
criteria. That leaves either //foo.bar/04.tk or //foo.bar/05.tk. Since //foo.bar/04.tk is listed first in the patch map it is selected.</p>
    <li data-md>
     <p>Step 9 - the selected patch, //foo.bar/04.tk, is fetched. Additionally as an optimization fetches are simultaneously started for the two glyph keyed
patches //foo.bar/01.gk and //foo.bar/04.gk. The table keyed patch //foo.bar/04.tk is partially invalidating which means the two glyph keyed patches
will be remain valid after the application of //foo.bar/04.tk. Thus the client can expect that the two glyph keyed patches will be required in future
iterations and begin the loads for those two patches at this time.</p>
    <li data-md>
     <p>Step 10 - The fetched patch //foo.bar/04.tk is applied to the initial font. This patch updates all tables except for glyf and loca
to add support for code points 'a' through 'Z'. Additionally the mapping in the "IFT " table is updated to the following:</p>
     <table>
      <tbody>
       <tr>
        <th>Table = "IFT "
        <th colspan="2">Compatibility ID = 0x0000_0000_0000_0006
       <tr>
        <th>Subset Definition
        <th>URL
        <th>Format Number
       <tr>
        <td>
<pre>code points: { '0', '1', ..., '9' }
</pre>
        <td>//foo.bar/08.tk
        <td> 2, Table Keyed - Partial Invalidation 
     </table>
     <p>Note the following changes:</p>
     <ul>
      <li data-md>
       <p>All entries that have data for 'a', ... 'z', and 'A', ..., 'Z' have been removed. Leaving just one entry for the remaining '0', ..., '9' code points.</p>
      <li data-md>
       <p>The font binary has changed and thus the previously listed table keyed patches are no longer valid. As a result the compatibility ID has changed and
the URL for the remaining '0', ..., '9' entry has changed. The patch at the new URL, //foo.bar/08.tk, is compatible with the updated font.</p>
     </ul>
   </ul>
   <p>Iteration 2:</p>
   <ul>
    <li data-md>
     <p>Steps 2 through 6 - applying the <a data-link-type="abstract-op" href="#abstract-opdef-check-entry-intersection" id="ref-for-abstract-opdef-check-entry-intersection④">Check entry intersection</a> check to all entries in the updated font from the previous iteration, the following patch
entries intersect:</p>
     <ul>
      <li data-md>
       <p>//foo.bar/01.gk</p>
      <li data-md>
       <p>//foo.bar/04.gk</p>
     </ul>
    <li data-md>
     <p>Step 8 - one entry from that set must be picked. Only no invalidation patches remain, the client is free to pick either one. In this case it selects
the first one //foo.bar/01.gk.</p>
    <li data-md>
     <p>Step 9 - the fetch for //foo.bar/01.gk was previously started during iteration 1.</p>
    <li data-md>
     <p>Step 10 - The fetched patch //foo.bar/01.gk is applied to the current font subset. This patch adds glyph data for code points 'a' through 'm'
to the glyf and loca tables. Additionally the mapping in the "IFTX" table is updated to removed the entry for //foo.bar/01.gk. The compatibility ID
and URLs for other entries are unchanged.</p>
   </ul>
   <p>Iteration 3:</p>
   <ul>
    <li data-md>
     <p>Steps 2 through 6 - applying the <a data-link-type="abstract-op" href="#abstract-opdef-check-entry-intersection" id="ref-for-abstract-opdef-check-entry-intersection⑤">Check entry intersection</a> check to all entries in the updated font from the previous iteration, the following patch
entries intersect:</p>
     <ul>
      <li data-md>
       <p>//foo.bar/04.gk</p>
     </ul>
    <li data-md>
     <p>Step 8 - one entry remains, it is selected.</p>
    <li data-md>
     <p>Step 9 - the fetch for //foo.bar/04.gk was previously started during iteration 1.</p>
    <li data-md>
     <p>Step 10 - The fetched patch //foo.bar/04.gk is applied to the current font subset. This patch adds glyph data for code points 'N' through 'Z'
to the glyf and loca tables. Additionally the mapping in the "IFTX" table is updated to removed the entry for //foo.bar/04.gk. The compatibility ID
and URLs for other entries are unchanged.</p>
   </ul>
   <p>Iteration 4:</p>
   <ul>
    <li data-md>
     <p>Steps 2 through 6 - there are no remaining intersecting entries so the algorithm terminates. The font subset is returned and now ready to render any
content covered by the target subset definition.</p>
   </ul>
   <h3 class="heading settled" id="appendix-b-example-2"><span class="content">Example 2: Glyph Keyed Patches with Child Entries</span><a class="self-link" href="#appendix-b-example-2"></a></h3>
   <p>In this example the IFT font contains a set of <a href="#glyph-keyed">§ 6.3 Glyph Keyed</a> patches which utilize child entries to correctly handle the inclusion of patches
for <a href="https://learn.microsoft.com/en-us/typography/opentype/spec/cmap#format-14-unicode-variation-sequences">UVS</a> substitutions. For each set of base glyphs there are a set of alternate glyphs
which are substituted in via a variation selector. These are kept in a separate patch. The alternate glyph patches are configured (via child entries)
to load only when the base glyphs and the variation selector are present simultaneously.</p>
   <p><b>Initial font</b>: contains the following IFT  patch mapping. Note: when codepoint, features, design space, or child entry sets are unspecified in
a subset definition they are defaulted to an empty set.</p>
   <table>
    <tbody>
     <tr>
      <th>Table = "IFT "
      <th colspan="2">Compatibility ID = 0x0000_0000_0000_0001
     <tr>
      <th>Subset Definition
      <th>URL
      <th>Format Number
      <th>Ignored?
      <th>Notes
     <tr>
      <td>
<pre>code points:
  { 'a', 'b', ..., 'm' }
</pre>
      <td>//foo.bar/01.gk
      <td> 3, Glyph Keyed 
      <td>No
      <td>
     <tr>
      <td>
<pre>code points:
  { 'n', 'o', ..., 'z' }
</pre>
      <td>//foo.bar/02.gk
      <td> 3, Glyph Keyed 
      <td>No
      <td>
     <tr>
      <td>
<pre>code points: { VS1 }
</pre>
      <td>N/A
      <td> 3, Glyph Keyed 
      <td>Yes
     <tr>
      <td>
<pre>child entries: [0, 2],
match mode: conjunctive
</pre>
      <td>//foo.bar/03.gk
      <td> 3, Glyph Keyed 
      <td>No
      <td>Has alternate glyphs for {'a', ..., 'm'} that are activated by VS1
     <tr>
      <td>
<pre>child entries: [1, 2],
match mode: conjunctive
</pre>
      <td>//foo.bar/04.gk
      <td> 3, Glyph Keyed 
      <td>No
      <td>Has alternate glyphs for {'n', ..., 'z'} that are activated by VS1
   </table>
   <p><b>Extension Example 1</b></p>
   <p>Inputs:</p>
   <ul>
    <li data-md>
     <p>Initial font with an IFT table as defined above.</p>
    <li data-md>
     <p>Target subset definition: code points = {'f'}</p>
   </ul>
   <p>Iteration 1:</p>
   <ul>
    <li data-md>
     <p>Steps 1 through 6 - applying the <a data-link-type="abstract-op" href="#abstract-opdef-check-entry-intersection" id="ref-for-abstract-opdef-check-entry-intersection⑥">Check entry intersection</a> check to all entries in the initial font, the following patch entries intersect:</p>
     <ul>
      <li data-md>
       <p>//foo.bar/01.gk</p>
     </ul>
    <li data-md>
     <p>Step 8 through 10 - there is only one patch, //foo.bar/01.gk, is is selected, loaded, and applied.</p>
   </ul>
   <p>Iteration 2:</p>
   <ul>
    <li data-md>
     <p>Steps 2 through 6 - there are no remaining intersecting entries so the algorithm terminates. The font subset is returned and now ready to render any
content covered by the target subset definition.</p>
   </ul>
   <p><b>Extension Example 2</b></p>
   <p>Inputs:</p>
   <ul>
    <li data-md>
     <p>Initial font with an IFT table as defined above.</p>
    <li data-md>
     <p>Target subset definition: code points = {'f', VS1}</p>
   </ul>
   <p>Iteration 1:</p>
   <ul>
    <li data-md>
     <p>Steps 1 through 6 - applying the <a data-link-type="abstract-op" href="#abstract-opdef-check-entry-intersection" id="ref-for-abstract-opdef-check-entry-intersection⑦">Check entry intersection</a> check to all entries in the initial font, the following patch entries intersect:</p>
     <ul>
      <li data-md>
       <p>//foo.bar/01.gk</p>
      <li data-md>
       <p>//foo.bar/03.gk</p>
     </ul>
    <li data-md>
     <p>Step 8 - one entry must be selected, in this case the client implementation is free to pick either. //foo.bar/01.gk is selected.</p>
    <li data-md>
     <p>Step 9 - since both intersecting entries are no invalidation both can be simultaneously loaded.</p>
    <li data-md>
     <p>Step 10 - //foo.bar/01.gk is applied to the font. The mapping table is updated to mark the entry for //foo.bar/01.gk as ignored.</p>
   </ul>
   <p>Iteration 2:</p>
   <ul>
    <li data-md>
     <p>Steps 1 through 6 - applying the <a data-link-type="abstract-op" href="#abstract-opdef-check-entry-intersection" id="ref-for-abstract-opdef-check-entry-intersection⑧">Check entry intersection</a> check to all entries in the current font, the following patch entries intersect:</p>
     <ul>
      <li data-md>
       <p>//foo.bar/03.gk</p>
     </ul>
    <li data-md>
     <p>Step 8 through 10 - there is only one patch, //foo.bar/03.gk, is is selected, and applied (it was loaded during the previous iteration).</p>
   </ul>
   <p>Iteration 3:</p>
   <ul>
    <li data-md>
     <p>Steps 2 through 6 - there are no remaining intersecting entries so the algorithm terminates. The font subset is returned and now ready to render any
content covered by the target subset definition.</p>
   </ul>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
   <section>
    <h3 class="no-ref no-num heading settled" id="w3c-conformant-algorithms"><span class="content">Conformant Algorithms</span><a class="self-link" href="#w3c-conformant-algorithms"></a></h3>
    <p>Requirements phrased in the imperative as part of algorithms
    (such as "strip any leading space characters"
    or "return false and abort these steps")
    are to be interpreted with the meaning of the key word
    ("must", "should", "may", etc)
    used in introducing the algorithm. </p>
    <p>Conformance requirements phrased as algorithms or specific steps
    can be implemented in any manner,
    so long as the end result is equivalent.
    In particular, the algorithms defined in this specification
    are intended to be easy to understand
    and are not intended to be performant.
    Implementers are encouraged to optimize. </p>
   </section>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#format-1-patch-map-appliedentriesbitmap">appliedEntriesBitMap</a><span>, in § 5.3.1</span>
   <li><a href="#abstract-opdef-apply-glyph-keyed-patch">Apply glyph keyed patch</a><span>, in § 6.3.1</span>
   <li><a href="#abstract-opdef-apply-table-keyed-patch">Apply table keyed patch</a><span>, in § 6.2.1</span>
   <li><a href="#mapping-entry-bias">bias</a><span>, in § 5.3.2</span>
   <li><a href="#branch-factor-encoding">Branch Factor Encoding</a><span>, in § 5.3.2.3</span>
   <li>
    brotliStream
    <ul>
     <li><a href="#glyph-keyed-patch-brotlistream">dfn for Glyph keyed patch</a><span>, in § 6.3</span>
     <li><a href="#tablepatch-brotlistream">dfn for TablePatch</a><span>, in § 6.2</span>
    </ul>
   <li>
    cff2CharStringsOffset
    <ul>
     <li><a href="#format-1-patch-map-cff2charstringsoffset">dfn for Format 1 Patch Map</a><span>, in § 5.3.1</span>
     <li><a href="#format-2-patch-map-cff2charstringsoffset">dfn for Format 2 Patch Map</a><span>, in § 5.3.2</span>
    </ul>
   <li>
    cffCharStringsOffset
    <ul>
     <li><a href="#format-1-patch-map-cffcharstringsoffset">dfn for Format 1 Patch Map</a><span>, in § 5.3.1</span>
     <li><a href="#format-2-patch-map-cffcharstringsoffset">dfn for Format 2 Patch Map</a><span>, in § 5.3.2</span>
    </ul>
   <li><a href="#abstract-opdef-check-entry-intersection">Check entry intersection</a><span>, in § 4.3</span>
   <li><a href="#mapping-entry-childentryindices">childEntryIndices</a><span>, in § 5.3.2</span>
   <li><a href="#mapping-entry-childentrymatchmodeandcount">childEntryMatchModeAndCount</a><span>, in § 5.3.2</span>
   <li><a href="#mapping-entry-codepoints">codePoints</a><span>, in § 5.3.2</span>
   <li>
    compatibilityId
    <ul>
     <li><a href="#format-1-patch-map-compatibilityid">dfn for Format 1 Patch Map</a><span>, in § 5.3.1</span>
     <li><a href="#format-2-patch-map-compatibilityid">dfn for Format 2 Patch Map</a><span>, in § 5.3.2</span>
     <li><a href="#glyph-keyed-patch-compatibilityid">dfn for Glyph keyed patch</a><span>, in § 6.3</span>
     <li><a href="#table-keyed-patch-compatibilityid">dfn for Table keyed patch</a><span>, in § 6.2</span>
    </ul>
   <li><a href="#abstract-opdef-decoding-sparse-bit-set-treedata">Decoding sparse bit set treeData</a><span>, in § 5.3.2.3</span>
   <li><a href="#format-2-patch-map-defaultpatchformat">defaultPatchFormat</a><span>, in § 5.3.2</span>
   <li><a href="#mapping-entry-designspacecount">designSpaceCount</a><span>, in § 5.3.2</span>
   <li><a href="#design-space-segment">Design Space Segment</a><span>, in § 5.3.2</span>
   <li><a href="#mapping-entry-designspacesegments">designSpaceSegments</a><span>, in § 5.3.2</span>
   <li><a href="#design-space-segment-end">end</a><span>, in § 5.3.2</span>
   <li>
    entries
    <ul>
     <li><a href="#format-2-patch-map-entries">dfn for Format 2 Patch Map</a><span>, in § 5.3.2</span>
     <li><a href="#mapping-entries-entries">dfn for Mapping Entries</a><span>, in § 5.3.2</span>
    </ul>
   <li><a href="#format-2-patch-map-entrycount">entryCount</a><span>, in § 5.3.2</span>
   <li><a href="#mapping-entry-entryiddelta">entryIdDelta</a><span>, in § 5.3.2</span>
   <li><a href="#format-2-patch-map-entryidstringdata">entryIdStringData</a><span>, in § 5.3.2</span>
   <li><a href="#mapping-entry-entryidstringlength">entryIdStringLength</a><span>, in § 5.3.2</span>
   <li><a href="#glyph-map-entryindex">entryIndex</a><span>, in § 5.3.1</span>
   <li><a href="#featurerecord-entrymapcount">entryMapCount</a><span>, in § 5.3.1</span>
   <li><a href="#entrymaprecord">EntryMapRecord</a><span>, in § 5.3.1</span>
   <li><a href="#feature-map-entrymaprecords">entryMapRecords</a><span>, in § 5.3.1</span>
   <li><a href="#abstract-opdef-expand-url-template">Expand URL Template</a><span>, in § 5.3.3</span>
   <li><a href="#abstract-opdef-extend-an-incremental-font-subset">Extend an Incremental Font Subset</a><span>, in § 4.3</span>
   <li><a href="#mapping-entry-featurecount">featureCount</a><span>, in § 5.3.2</span>
   <li><a href="#feature-map">Feature Map</a><span>, in § 5.3.1</span>
   <li><a href="#format-1-patch-map-featuremapoffset">featureMapOffset</a><span>, in § 5.3.1</span>
   <li><a href="#featurerecord">FeatureRecord</a><span>, in § 5.3.1</span>
   <li><a href="#feature-map-featurerecords">featureRecords</a><span>, in § 5.3.1</span>
   <li><a href="#featurerecord-featuretag">featureTag</a><span>, in § 5.3.1</span>
   <li><a href="#mapping-entry-featuretags">featureTags</a><span>, in § 5.3.2</span>
   <li><a href="#entrymaprecord-firstentryindex">firstEntryIndex</a><span>, in § 5.3.1</span>
   <li><a href="#glyph-map-firstmappedglyph">firstMappedGlyph</a><span>, in § 5.3.1</span>
   <li><a href="#featurerecord-firstnewentryindex">firstNewEntryIndex</a><span>, in § 5.3.1</span>
   <li>
    flags
    <ul>
     <li><a href="#format-1-patch-map-flags">dfn for Format 1 Patch Map</a><span>, in § 5.3.1</span>
     <li><a href="#format-2-patch-map-flags">dfn for Format 2 Patch Map</a><span>, in § 5.3.2</span>
     <li><a href="#glyph-keyed-patch-flags">dfn for Glyph keyed patch</a><span>, in § 6.3</span>
     <li><a href="#tablepatch-flags">dfn for TablePatch</a><span>, in § 6.2</span>
    </ul>
   <li><a href="#font-patch">font patch</a><span>, in § 3.2</span>
   <li><a href="#font-subset">font subset</a><span>, in § 3.1</span>
   <li><a href="#font-subset-definition">font subset definition</a><span>, in § 3.1</span>
   <li>
    format
    <ul>
     <li><a href="#format-1-patch-map-format">dfn for Format 1 Patch Map</a><span>, in § 5.3.1</span>
     <li><a href="#format-2-patch-map-format">dfn for Format 2 Patch Map</a><span>, in § 5.3.2</span>
    </ul>
   <li><a href="#format-1-patch-map">Format 1 Patch Map</a><span>, in § 5.3.1</span>
   <li><a href="#format-2-patch-map">Format 2 Patch Map</a><span>, in § 5.3.2</span>
   <li><a href="#mapping-entry-formatflags">formatFlags</a><span>, in § 5.3.2</span>
   <li><a href="#full-invalidation">Full Invalidation</a><span>, in § 4.1</span>
   <li><a href="#abstract-opdef-fully-expand-a-font-subset">Fully Expand a Font Subset</a><span>, in § 4.7</span>
   <li><a href="#glyph-closure">glyph closure</a><span>, in § 7.1</span>
   <li>
    glyphCount
    <ul>
     <li><a href="#format-1-patch-map-glyphcount">dfn for Format 1 Patch Map</a><span>, in § 5.3.1</span>
     <li><a href="#glyphpatches-glyphcount">dfn for GlyphPatches</a><span>, in § 6.3</span>
    </ul>
   <li><a href="#glyphpatches-glyphdata">glyphData</a><span>, in § 6.3</span>
   <li><a href="#glyphpatches-glyphdataoffsets">glyphDataOffsets</a><span>, in § 6.3</span>
   <li><a href="#glyphpatches-glyphids">glyphIds</a><span>, in § 6.3</span>
   <li><a href="#glyph-keyed-patch">Glyph keyed patch</a><span>, in § 6.3</span>
   <li><a href="#glyph-map">Glyph Map</a><span>, in § 5.3.1</span>
   <li><a href="#glyphpatches">GlyphPatches</a><span>, in § 6.3</span>
   <li><a href="#abstract-opdef-handle-errors">Handle errors</a><span>, in § 4.3</span>
   <li><a href="#incremental-font">incremental font</a><span>, in § 1.2</span>
   <li><a href="#abstract-opdef-interpret-format-1-patch-map">Interpret Format 1 Patch Map</a><span>, in § 5.3.1.1</span>
   <li><a href="#abstract-opdef-interpret-format-2-patch-map">Interpret Format 2 Patch Map</a><span>, in § 5.3.2.1</span>
   <li><a href="#abstract-opdef-interpret-format-2-patch-map-entry">Interpret Format 2 Patch Map Entry</a><span>, in § 5.3.2.1</span>
   <li><a href="#entrymaprecord-lastentryindex">lastEntryIndex</a><span>, in § 5.3.1</span>
   <li><a href="#abstract-opdef-load-patch-file">Load patch file</a><span>, in § 4.3</span>
   <li><a href="#mapping-entries">Mapping Entries</a><span>, in § 5.3.2</span>
   <li><a href="#mapping-entry">Mapping Entry</a><span>, in § 5.3.2</span>
   <li><a href="#format-1-patch-map-maxentryindex">maxEntryIndex</a><span>, in § 5.3.1</span>
   <li><a href="#format-1-patch-map-maxglyphmapentryindex">maxGlyphMapEntryIndex</a><span>, in § 5.3.1</span>
   <li>
    maxUncompressedLength
    <ul>
     <li><a href="#glyph-keyed-patch-maxuncompressedlength">dfn for Glyph keyed patch</a><span>, in § 6.3</span>
     <li><a href="#tablepatch-maxuncompressedlength">dfn for TablePatch</a><span>, in § 6.2</span>
    </ul>
   <li><a href="#no-invalidation">No Invalidation</a><span>, in § 4.1</span>
   <li><a href="#partial-invalidation">Partial Invalidation</a><span>, in § 4.1</span>
   <li><a href="#patch-application-algorithm">patch application algorithm</a><span>, in § 3.2</span>
   <li><a href="#table-keyed-patch-patches">patches</a><span>, in § 6.2</span>
   <li><a href="#patch-format">patch format</a><span>, in § 3.2</span>
   <li>
    patchFormat
    <ul>
     <li><a href="#format-1-patch-map-patchformat">dfn for Format 1 Patch Map</a><span>, in § 5.3.1</span>
     <li><a href="#mapping-entry-patchformat">dfn for Mapping Entry</a><span>, in § 5.3.2</span>
    </ul>
   <li><a href="#patch-map">patch map</a><span>, in § 3.3</span>
   <li><a href="#patch-map-entries">patch map entries</a><span>, in § 3.3</span>
   <li><a href="#abstract-opdef-remove-entries-from-format-1-patch-map">Remove Entries from Format 1 Patch Map</a><span>, in § 5.3.1.2</span>
   <li><a href="#abstract-opdef-remove-entries-from-format-2-patch-map">Remove Entries from Format 2 Patch Map</a><span>, in § 5.3.2.2</span>
   <li><a href="#sparse-bit-set">Sparse Bit Set</a><span>, in § 5.3.2.3</span>
   <li><a href="#design-space-segment-start">start</a><span>, in § 5.3.2</span>
   <li><a href="#table-keyed-patch">Table keyed patch</a><span>, in § 6.2</span>
   <li><a href="#tablepatch">TablePatch</a><span>, in § 6.2</span>
   <li><a href="#glyphpatches-tables">tables</a><span>, in § 6.3</span>
   <li>
    tag
    <ul>
     <li><a href="#design-space-segment-tag">dfn for Design Space Segment</a><span>, in § 5.3.2</span>
     <li><a href="#tablepatch-tag">dfn for TablePatch</a><span>, in § 6.2</span>
    </ul>
   <li>
    urlTemplate
    <ul>
     <li><a href="#format-1-patch-map-urltemplate">dfn for Format 1 Patch Map</a><span>, in § 5.3.1</span>
     <li><a href="#format-2-patch-map-urltemplate">dfn for Format 2 Patch Map</a><span>, in § 5.3.2</span>
    </ul>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[FETCH]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="857d5516">client</span>
     <li><span class="dfn-paneled" id="3ae34c95">destination</span>
     <li><span class="dfn-paneled" id="a33db89a">fetch</span>
     <li><span class="dfn-paneled" id="7b0b4fa0">initiator type</span>
     <li><span class="dfn-paneled" id="50b05fad">method</span>
     <li><span class="dfn-paneled" id="cb98f71f">mode</span>
     <li><span class="dfn-paneled" id="08b51e40">processResponseConsumeBody</span>
     <li><span class="dfn-paneled" id="358f1dbd">referrer</span>
     <li><span class="dfn-paneled" id="55213b5b">request</span>
     <li><span class="dfn-paneled" id="dc1cd39b">URL</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-css-fonts-4">[CSS-FONTS-4]
   <dd>Chris Lilley. <a href="https://www.w3.org/TR/css-fonts-4/"><cite>CSS Fonts Module Level 4</cite></a>. 1 February 2024. WD. URL: <a href="https://www.w3.org/TR/css-fonts-4/">https://www.w3.org/TR/css-fonts-4/</a>
   <dt id="biblio-fetch">[FETCH]
   <dd>Anne van Kesteren. <a href="https://fetch.spec.whatwg.org/"><cite>Fetch Standard</cite></a>. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-iso14496-22">[ISO14496-22]
   <dd><a href="https://www.iso.org/standard/87621.html"><cite>Information technology — Coding of audio-visual objects — Part 22: Open Font Format</cite></a>. Under development. URL: <a href="https://www.iso.org/standard/87621.html">https://www.iso.org/standard/87621.html</a>
   <dt id="biblio-open-type">[OPEN-TYPE]
   <dd><a href="https://learn.microsoft.com/en-us/typography/opentype/spec"><cite>OpenType Specification</cite></a>. May 2024. Note. URL: <a href="https://learn.microsoft.com/en-us/typography/opentype/spec">https://learn.microsoft.com/en-us/typography/opentype/spec</a>
   <dt id="biblio-pfe-report">[PFE-report]
   <dd>Chris Lilley. <a href="https://www.w3.org/TR/PFE-evaluation/"><cite>Progressive Font Enrichment: Evaluation Report</cite></a>. 15 October 2020. Note. URL: <a href="https://www.w3.org/TR/PFE-evaluation/">https://www.w3.org/TR/PFE-evaluation/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-rfc4648">[RFC4648]
   <dd>S. Josefsson. <a href="https://www.rfc-editor.org/rfc/rfc4648"><cite>The Base16, Base32, and Base64 Data Encodings</cite></a>. October 2006. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc4648">https://www.rfc-editor.org/rfc/rfc4648</a>
   <dt id="biblio-rfc6570">[RFC6570]
   <dd>J. Gregorio; et al. <a href="https://www.rfc-editor.org/rfc/rfc6570"><cite>URI Template</cite></a>. March 2012. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc6570">https://www.rfc-editor.org/rfc/rfc6570</a>
   <dt id="biblio-rfc7932">[RFC7932]
   <dd>J. Alakuijala; Z. Szabadka. <a href="https://www.rfc-editor.org/rfc/rfc7932"><cite>Brotli Compressed Data Format</cite></a>. July 2016. Informational. URL: <a href="https://www.rfc-editor.org/rfc/rfc7932">https://www.rfc-editor.org/rfc/rfc7932</a>
   <dt id="biblio-shared-brotli">[Shared-Brotli]
   <dd>J. Alakuijala; et al. <a href="https://datatracker.ietf.org/doc/html/draft-vandevenne-shared-brotli-format-15"><cite>Shared Brotli Compressed Data Format</cite></a>. Feb 2025. Internet Draft. URL: <a href="https://datatracker.ietf.org/doc/html/draft-vandevenne-shared-brotli-format-15">https://datatracker.ietf.org/doc/html/draft-vandevenne-shared-brotli-format-15</a>
   <dt id="biblio-unicode">[UNICODE]
   <dd><a href="https://www.unicode.org/versions/latest/"><cite>The Unicode Standard</cite></a>. URL: <a href="https://www.unicode.org/versions/latest/">https://www.unicode.org/versions/latest/</a>
   <dt id="biblio-utf-8">[UTF-8]
   <dd>F. Yergeau. <a href="https://www.rfc-editor.org/rfc/rfc3629"><cite>UTF-8, a transformation format of ISO 10646</cite></a>. November 2003. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc3629">https://www.rfc-editor.org/rfc/rfc3629</a>
   <dt id="biblio-whatwg-url">[WHATWG-URL]
   <dd>Anne van Kesteren. <a href="https://url.spec.whatwg.org/"><cite>URL Standard</cite></a>. Living Standard. URL: <a href="https://url.spec.whatwg.org/">https://url.spec.whatwg.org/</a>
   <dt id="biblio-woff2">[WOFF2]
   <dd>Vladimir Levantovsky. <a href="https://www.w3.org/TR/WOFF2/"><cite>WOFF File Format 2.0</cite></a>. 8 August 2024. REC. URL: <a href="https://www.w3.org/TR/WOFF2/">https://www.w3.org/TR/WOFF2/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-css-conditional-5">[CSS-CONDITIONAL-5]
   <dd>Chris Lilley; et al. <a href="https://www.w3.org/TR/css-conditional-5/"><cite>CSS Conditional Rules Module Level 5</cite></a>. 5 November 2024. WD. URL: <a href="https://www.w3.org/TR/css-conditional-5/">https://www.w3.org/TR/css-conditional-5/</a>
   <dt id="biblio-enabling-typography">[ENABLING-TYPOGRAPHY]
   <dd>John Hudson. <a href="https://www.tiro.com/articles/enabling-typography"><cite>Enabling Typography: towards a general model of OpenType Layout</cite></a>. April 15th, 2014. Note. URL: <a href="https://www.tiro.com/articles/enabling-typography">https://www.tiro.com/articles/enabling-typography</a>
   <dt id="biblio-rfc9113">[RFC9113]
   <dd>M. Thomson, Ed.; C. Benfield, Ed.. <a href="https://httpwg.org/specs/rfc9113.html"><cite>HTTP/2</cite></a>. June 2022. Proposed Standard. URL: <a href="https://httpwg.org/specs/rfc9113.html">https://httpwg.org/specs/rfc9113.html</a>
   <dt id="biblio-rfc9114">[RFC9114]
   <dd>M. Bishop, Ed.. <a href="https://httpwg.org/specs/rfc9114.html"><cite>HTTP/3</cite></a>. June 2022. Proposed Standard. URL: <a href="https://httpwg.org/specs/rfc9114.html">https://httpwg.org/specs/rfc9114.html</a>
   <dt id="biblio-woff">[WOFF]
   <dd>Jonathan Kew; Tal Leming; Erik van Blokland. <a href="https://www.w3.org/TR/WOFF/"><cite>WOFF File Format 1.0</cite></a>. 13 December 2012. REC. URL: <a href="https://www.w3.org/TR/WOFF/">https://www.w3.org/TR/WOFF/</a>
  </dl>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"08b51e40": {"dfnID":"08b51e40","dfnText":"processResponseConsumeBody","external":true,"refSections":[{"refs":[{"id":"ref-for-process-response-end-of-body"},{"id":"ref-for-process-response-end-of-body\u2460"}],"title":"4.3. Incremental Font Extension Algorithm"}],"url":"https://fetch.spec.whatwg.org/#process-response-end-of-body"},
"358f1dbd": {"dfnID":"358f1dbd","dfnText":"referrer","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-referrer"}],"title":"4.3. Incremental Font Extension Algorithm"}],"url":"https://fetch.spec.whatwg.org/#concept-request-referrer"},
"3ae34c95": {"dfnID":"3ae34c95","dfnText":"destination","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-destination"}],"title":"4.3. Incremental Font Extension Algorithm"}],"url":"https://fetch.spec.whatwg.org/#concept-request-destination"},
"50b05fad": {"dfnID":"50b05fad","dfnText":"method","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-method"}],"title":"4.3. Incremental Font Extension Algorithm"}],"url":"https://fetch.spec.whatwg.org/#concept-request-method"},
"55213b5b": {"dfnID":"55213b5b","dfnText":"request","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request"}],"title":"4.3. Incremental Font Extension Algorithm"}],"url":"https://fetch.spec.whatwg.org/#concept-request"},
"7b0b4fa0": {"dfnID":"7b0b4fa0","dfnText":"initiator type","external":true,"refSections":[{"refs":[{"id":"ref-for-request-initiator-type"}],"title":"4.3. Incremental Font Extension Algorithm"}],"url":"https://fetch.spec.whatwg.org/#request-initiator-type"},
"857d5516": {"dfnID":"857d5516","dfnText":"client","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-client"}],"title":"4.3. Incremental Font Extension Algorithm"}],"url":"https://fetch.spec.whatwg.org/#concept-request-client"},
"a33db89a": {"dfnID":"a33db89a","dfnText":"fetch","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-fetch"}],"title":"4.3. Incremental Font Extension Algorithm"}],"url":"https://fetch.spec.whatwg.org/#concept-fetch"},
"abstract-opdef-apply-glyph-keyed-patch": {"dfnID":"abstract-opdef-apply-glyph-keyed-patch","dfnText":"Apply glyph keyed patch","external":false,"refSections":[],"url":"#abstract-opdef-apply-glyph-keyed-patch"},
"abstract-opdef-apply-table-keyed-patch": {"dfnID":"abstract-opdef-apply-table-keyed-patch","dfnText":"Apply table keyed patch","external":false,"refSections":[],"url":"#abstract-opdef-apply-table-keyed-patch"},
"abstract-opdef-check-entry-intersection": {"dfnID":"abstract-opdef-check-entry-intersection","dfnText":"Check entry intersection","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-check-entry-intersection"},{"id":"ref-for-abstract-opdef-check-entry-intersection\u2460"}],"title":"4.3. Incremental Font Extension Algorithm"},{"refs":[{"id":"ref-for-abstract-opdef-check-entry-intersection\u2461"}],"title":"4.7. Fully Expanding a Font"},{"refs":[{"id":"ref-for-abstract-opdef-check-entry-intersection\u2462"},{"id":"ref-for-abstract-opdef-check-entry-intersection\u2463"},{"id":"ref-for-abstract-opdef-check-entry-intersection\u2464"}],"title":"Example 1: Table and Glyph Keyed Patches"},{"refs":[{"id":"ref-for-abstract-opdef-check-entry-intersection\u2465"},{"id":"ref-for-abstract-opdef-check-entry-intersection\u2466"},{"id":"ref-for-abstract-opdef-check-entry-intersection\u2467"}],"title":"Example 2: Glyph Keyed Patches with Child Entries"}],"url":"#abstract-opdef-check-entry-intersection"},
"abstract-opdef-decoding-sparse-bit-set-treedata": {"dfnID":"abstract-opdef-decoding-sparse-bit-set-treedata","dfnText":"Decoding sparse bit set treeData","external":false,"refSections":[],"url":"#abstract-opdef-decoding-sparse-bit-set-treedata"},
"abstract-opdef-expand-url-template": {"dfnID":"abstract-opdef-expand-url-template","dfnText":"Expand URL Template","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-expand-url-template"},{"id":"ref-for-abstract-opdef-expand-url-template\u2460"}],"title":"5.3.1.1. Interpreting Format 1"},{"refs":[{"id":"ref-for-abstract-opdef-expand-url-template\u2461"}],"title":"5.3.1.2. Remove Entries from Format 1"},{"refs":[{"id":"ref-for-abstract-opdef-expand-url-template\u2462"},{"id":"ref-for-abstract-opdef-expand-url-template\u2463"},{"id":"ref-for-abstract-opdef-expand-url-template\u2464"},{"id":"ref-for-abstract-opdef-expand-url-template\u2465"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#abstract-opdef-expand-url-template"},
"abstract-opdef-extend-an-incremental-font-subset": {"dfnID":"abstract-opdef-extend-an-incremental-font-subset","dfnText":"Extend an Incremental Font Subset","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-extend-an-incremental-font-subset"}],"title":"4.3. Incremental Font Extension Algorithm"},{"refs":[{"id":"ref-for-abstract-opdef-extend-an-incremental-font-subset\u2460"},{"id":"ref-for-abstract-opdef-extend-an-incremental-font-subset\u2461"},{"id":"ref-for-abstract-opdef-extend-an-incremental-font-subset\u2462"}],"title":"4.4. Selecting Invalidating Patches"},{"refs":[{"id":"ref-for-abstract-opdef-extend-an-incremental-font-subset\u2463"}],"title":"4.5. Target Subset Definition"},{"refs":[{"id":"ref-for-abstract-opdef-extend-an-incremental-font-subset\u2464"},{"id":"ref-for-abstract-opdef-extend-an-incremental-font-subset\u2465"},{"id":"ref-for-abstract-opdef-extend-an-incremental-font-subset\u2466"}],"title":"4.6. Determining what Content a Font can Render"},{"refs":[{"id":"ref-for-abstract-opdef-extend-an-incremental-font-subset\u2467"}],"title":"4.7. Fully Expanding a Font"},{"refs":[{"id":"ref-for-abstract-opdef-extend-an-incremental-font-subset\u2468"}],"title":"5.3. Patch Map Table"},{"refs":[{"id":"ref-for-abstract-opdef-extend-an-incremental-font-subset\u2460\u24ea"},{"id":"ref-for-abstract-opdef-extend-an-incremental-font-subset\u2460\u2460"},{"id":"ref-for-abstract-opdef-extend-an-incremental-font-subset\u2460\u2461"}],"title":"7. Encoding"}],"url":"#abstract-opdef-extend-an-incremental-font-subset"},
"abstract-opdef-fully-expand-a-font-subset": {"dfnID":"abstract-opdef-fully-expand-a-font-subset","dfnText":"Fully Expand a Font Subset","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-fully-expand-a-font-subset"}],"title":"2.1. Offline Usage"},{"refs":[{"id":"ref-for-abstract-opdef-fully-expand-a-font-subset\u2460"},{"id":"ref-for-abstract-opdef-fully-expand-a-font-subset\u2461"}],"title":"7. Encoding"}],"url":"#abstract-opdef-fully-expand-a-font-subset"},
"abstract-opdef-handle-errors": {"dfnID":"abstract-opdef-handle-errors","dfnText":"Handle errors","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-handle-errors"},{"id":"ref-for-abstract-opdef-handle-errors\u2460"},{"id":"ref-for-abstract-opdef-handle-errors\u2461"},{"id":"ref-for-abstract-opdef-handle-errors\u2462"}],"title":"4.3. Incremental Font Extension Algorithm"}],"url":"#abstract-opdef-handle-errors"},
"abstract-opdef-interpret-format-1-patch-map": {"dfnID":"abstract-opdef-interpret-format-1-patch-map","dfnText":"Interpret Format 1 Patch Map","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-interpret-format-1-patch-map"}],"title":"4.3. Incremental Font Extension Algorithm"}],"url":"#abstract-opdef-interpret-format-1-patch-map"},
"abstract-opdef-interpret-format-2-patch-map": {"dfnID":"abstract-opdef-interpret-format-2-patch-map","dfnText":"Interpret Format 2 Patch Map","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-interpret-format-2-patch-map"}],"title":"4.3. Incremental Font Extension Algorithm"},{"refs":[{"id":"ref-for-abstract-opdef-interpret-format-2-patch-map\u2460"},{"id":"ref-for-abstract-opdef-interpret-format-2-patch-map\u2461"},{"id":"ref-for-abstract-opdef-interpret-format-2-patch-map\u2462"}],"title":"5.3.2.2. Remove Entries from Format 2"}],"url":"#abstract-opdef-interpret-format-2-patch-map"},
"abstract-opdef-interpret-format-2-patch-map-entry": {"dfnID":"abstract-opdef-interpret-format-2-patch-map-entry","dfnText":"Interpret Format 2 Patch Map Entry","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-interpret-format-2-patch-map-entry"}],"title":"5.3.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-abstract-opdef-interpret-format-2-patch-map-entry\u2460"}],"title":"5.3.2.1. Interpreting Format 2"},{"refs":[{"id":"ref-for-abstract-opdef-interpret-format-2-patch-map-entry\u2461"}],"title":"5.3.2.2. Remove Entries from Format 2"}],"url":"#abstract-opdef-interpret-format-2-patch-map-entry"},
"abstract-opdef-load-patch-file": {"dfnID":"abstract-opdef-load-patch-file","dfnText":"Load patch file","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-load-patch-file"},{"id":"ref-for-abstract-opdef-load-patch-file\u2460"}],"title":"4.3. Incremental Font Extension Algorithm"},{"refs":[{"id":"ref-for-abstract-opdef-load-patch-file\u2461"}],"title":"9. Security Considerations"}],"url":"#abstract-opdef-load-patch-file"},
"abstract-opdef-remove-entries-from-format-1-patch-map": {"dfnID":"abstract-opdef-remove-entries-from-format-1-patch-map","dfnText":"Remove Entries from Format 1 Patch Map","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-remove-entries-from-format-1-patch-map"}],"title":"6.3.1. Applying Glyph Keyed Patches"}],"url":"#abstract-opdef-remove-entries-from-format-1-patch-map"},
"abstract-opdef-remove-entries-from-format-2-patch-map": {"dfnID":"abstract-opdef-remove-entries-from-format-2-patch-map","dfnText":"Remove Entries from Format 2 Patch Map","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-remove-entries-from-format-2-patch-map"}],"title":"6.3.1. Applying Glyph Keyed Patches"}],"url":"#abstract-opdef-remove-entries-from-format-2-patch-map"},
"branch-factor-encoding": {"dfnID":"branch-factor-encoding","dfnText":"Branch Factor Encoding","external":false,"refSections":[{"refs":[{"id":"ref-for-branch-factor-encoding"},{"id":"ref-for-branch-factor-encoding\u2460"}],"title":"5.3.2.3. Sparse Bit Set"}],"url":"#branch-factor-encoding"},
"cb98f71f": {"dfnID":"cb98f71f","dfnText":"mode","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-mode"}],"title":"4.3. Incremental Font Extension Algorithm"}],"url":"https://fetch.spec.whatwg.org/#concept-request-mode"},
"dc1cd39b": {"dfnID":"dc1cd39b","dfnText":"URL","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-url"}],"title":"4.3. Incremental Font Extension Algorithm"}],"url":"https://fetch.spec.whatwg.org/#concept-request-url"},
"design-space-segment": {"dfnID":"design-space-segment","dfnText":"Design Space Segment","external":false,"refSections":[{"refs":[{"id":"ref-for-design-space-segment"}],"title":"5.3.2. Patch Map Table: Format 2"}],"url":"#design-space-segment"},
"design-space-segment-end": {"dfnID":"design-space-segment-end","dfnText":"end","external":false,"refSections":[{"refs":[{"id":"ref-for-design-space-segment-end"},{"id":"ref-for-design-space-segment-end\u2460"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#design-space-segment-end"},
"design-space-segment-start": {"dfnID":"design-space-segment-start","dfnText":"start","external":false,"refSections":[{"refs":[{"id":"ref-for-design-space-segment-start"},{"id":"ref-for-design-space-segment-start\u2460"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#design-space-segment-start"},
"design-space-segment-tag": {"dfnID":"design-space-segment-tag","dfnText":"tag","external":false,"refSections":[{"refs":[{"id":"ref-for-design-space-segment-tag"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#design-space-segment-tag"},
"entrymaprecord": {"dfnID":"entrymaprecord","dfnText":"EntryMapRecord","external":false,"refSections":[{"refs":[{"id":"ref-for-entrymaprecord"},{"id":"ref-for-entrymaprecord\u2460"}],"title":"5.3.1. Patch Map Table: Format 1"},{"refs":[{"id":"ref-for-entrymaprecord\u2461"},{"id":"ref-for-entrymaprecord\u2462"},{"id":"ref-for-entrymaprecord\u2463"},{"id":"ref-for-entrymaprecord\u2464"},{"id":"ref-for-entrymaprecord\u2465"},{"id":"ref-for-entrymaprecord\u2466"},{"id":"ref-for-entrymaprecord\u2467"}],"title":"5.3.1.1. Interpreting Format 1"}],"url":"#entrymaprecord"},
"entrymaprecord-firstentryindex": {"dfnID":"entrymaprecord-firstentryindex","dfnText":"firstEntryIndex","external":false,"refSections":[{"refs":[{"id":"ref-for-entrymaprecord-firstentryindex"},{"id":"ref-for-entrymaprecord-firstentryindex\u2460"}],"title":"5.3.1.1. Interpreting Format 1"}],"url":"#entrymaprecord-firstentryindex"},
"entrymaprecord-lastentryindex": {"dfnID":"entrymaprecord-lastentryindex","dfnText":"lastEntryIndex","external":false,"refSections":[{"refs":[{"id":"ref-for-entrymaprecord-lastentryindex"},{"id":"ref-for-entrymaprecord-lastentryindex\u2460"}],"title":"5.3.1.1. Interpreting Format 1"}],"url":"#entrymaprecord-lastentryindex"},
"feature-map": {"dfnID":"feature-map","dfnText":"Feature Map","external":false,"refSections":[{"refs":[{"id":"ref-for-feature-map"}],"title":"5.3.1. Patch Map Table: Format 1"}],"url":"#feature-map"},
"feature-map-entrymaprecords": {"dfnID":"feature-map-entrymaprecords","dfnText":"entryMapRecords","external":false,"refSections":[{"refs":[{"id":"ref-for-feature-map-entrymaprecords"}],"title":"5.3.1.1. Interpreting Format 1"}],"url":"#feature-map-entrymaprecords"},
"feature-map-featurerecords": {"dfnID":"feature-map-featurerecords","dfnText":"featureRecords","external":false,"refSections":[{"refs":[{"id":"ref-for-feature-map-featurerecords"},{"id":"ref-for-feature-map-featurerecords\u2460"}],"title":"5.3.1. Patch Map Table: Format 1"},{"refs":[{"id":"ref-for-feature-map-featurerecords\u2461"}],"title":"5.3.1.1. Interpreting Format 1"}],"url":"#feature-map-featurerecords"},
"featurerecord": {"dfnID":"featurerecord","dfnText":"FeatureRecord","external":false,"refSections":[{"refs":[{"id":"ref-for-featurerecord"}],"title":"5.3.1. Patch Map Table: Format 1"},{"refs":[{"id":"ref-for-featurerecord\u2460"},{"id":"ref-for-featurerecord\u2461"},{"id":"ref-for-featurerecord\u2462"},{"id":"ref-for-featurerecord\u2463"}],"title":"5.3.1.1. Interpreting Format 1"}],"url":"#featurerecord"},
"featurerecord-entrymapcount": {"dfnID":"featurerecord-entrymapcount","dfnText":"entryMapCount","external":false,"refSections":[{"refs":[{"id":"ref-for-featurerecord-entrymapcount"}],"title":"5.3.1. Patch Map Table: Format 1"},{"refs":[{"id":"ref-for-featurerecord-entrymapcount\u2460"}],"title":"5.3.1.1. Interpreting Format 1"}],"url":"#featurerecord-entrymapcount"},
"featurerecord-featuretag": {"dfnID":"featurerecord-featuretag","dfnText":"featureTag","external":false,"refSections":[{"refs":[{"id":"ref-for-featurerecord-featuretag"}],"title":"5.3.1. Patch Map Table: Format 1"},{"refs":[{"id":"ref-for-featurerecord-featuretag\u2460"},{"id":"ref-for-featurerecord-featuretag\u2461"},{"id":"ref-for-featurerecord-featuretag\u2462"}],"title":"5.3.1.1. Interpreting Format 1"}],"url":"#featurerecord-featuretag"},
"featurerecord-firstnewentryindex": {"dfnID":"featurerecord-firstnewentryindex","dfnText":"firstNewEntryIndex","external":false,"refSections":[{"refs":[{"id":"ref-for-featurerecord-firstnewentryindex"},{"id":"ref-for-featurerecord-firstnewentryindex\u2460"},{"id":"ref-for-featurerecord-firstnewentryindex\u2461"}],"title":"5.3.1.1. Interpreting Format 1"}],"url":"#featurerecord-firstnewentryindex"},
"font-patch": {"dfnID":"font-patch","dfnText":"font patch","external":false,"refSections":[{"refs":[{"id":"ref-for-font-patch"},{"id":"ref-for-font-patch\u2460"}],"title":"3.2. Font Patch"},{"refs":[{"id":"ref-for-font-patch\u2461"}],"title":"7. Encoding"}],"url":"#font-patch"},
"font-subset": {"dfnID":"font-subset","dfnText":"font subset","external":false,"refSections":[{"refs":[{"id":"ref-for-font-subset"}],"title":"3.1. Font Subset"},{"refs":[{"id":"ref-for-font-subset\u2460"},{"id":"ref-for-font-subset\u2461"},{"id":"ref-for-font-subset\u2462"},{"id":"ref-for-font-subset\u2463"}],"title":"3.2. Font Patch"},{"refs":[{"id":"ref-for-font-subset\u2464"}],"title":"4. Extending a Font Subset"},{"refs":[{"id":"ref-for-font-subset\u2465"}],"title":"4.1. Patch Invalidations"},{"refs":[{"id":"ref-for-font-subset\u2466"},{"id":"ref-for-font-subset\u2467"}],"title":"4.3. Incremental Font Extension Algorithm"},{"refs":[{"id":"ref-for-font-subset\u2468"}],"title":"4.7. Fully Expanding a Font"},{"refs":[{"id":"ref-for-font-subset\u2460\u24ea"}],"title":"5.3.1.1. Interpreting Format 1"},{"refs":[{"id":"ref-for-font-subset\u2460\u2460"}],"title":"6. Font Patch Formats"},{"refs":[{"id":"ref-for-font-subset\u2460\u2461"}],"title":"6.1. Formats Summary"},{"refs":[{"id":"ref-for-font-subset\u2460\u2462"},{"id":"ref-for-font-subset\u2460\u2463"}],"title":"6.2. Table Keyed"},{"refs":[{"id":"ref-for-font-subset\u2460\u2464"},{"id":"ref-for-font-subset\u2460\u2465"},{"id":"ref-for-font-subset\u2460\u2466"}],"title":"6.2.1. Applying Table Keyed Patches"},{"refs":[{"id":"ref-for-font-subset\u2460\u2467"}],"title":"6.3. Glyph Keyed"},{"refs":[{"id":"ref-for-font-subset\u2460\u2468"},{"id":"ref-for-font-subset\u2461\u24ea"},{"id":"ref-for-font-subset\u2461\u2460"}],"title":"6.3.1. Applying Glyph Keyed Patches"},{"refs":[{"id":"ref-for-font-subset\u2461\u2461"},{"id":"ref-for-font-subset\u2461\u2462"}],"title":"7. Encoding"},{"refs":[{"id":"ref-for-font-subset\u2461\u2463"}],"title":"7.1. Encoding Considerations"}],"url":"#font-subset"},
"font-subset-definition": {"dfnID":"font-subset-definition","dfnText":"font subset definition","external":false,"refSections":[{"refs":[{"id":"ref-for-font-subset-definition"},{"id":"ref-for-font-subset-definition\u2460"}],"title":"3.3. Patch Map"},{"refs":[{"id":"ref-for-font-subset-definition\u2461"}],"title":"4.2. Default Layout Features"},{"refs":[{"id":"ref-for-font-subset-definition\u2462"},{"id":"ref-for-font-subset-definition\u2463"}],"title":"4.3. Incremental Font Extension Algorithm"},{"refs":[{"id":"ref-for-font-subset-definition\u2464"}],"title":"4.6. Determining what Content a Font can Render"},{"refs":[{"id":"ref-for-font-subset-definition\u2465"}],"title":"5.3. Patch Map Table"},{"refs":[{"id":"ref-for-font-subset-definition\u2466"},{"id":"ref-for-font-subset-definition\u2467"}],"title":"5.3.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-font-subset-definition\u2468"},{"id":"ref-for-font-subset-definition\u2460\u24ea"},{"id":"ref-for-font-subset-definition\u2460\u2460"},{"id":"ref-for-font-subset-definition\u2460\u2461"}],"title":"5.3.2.1. Interpreting Format 2"},{"refs":[{"id":"ref-for-font-subset-definition\u2460\u2462"}],"title":"7. Encoding"},{"refs":[{"id":"ref-for-font-subset-definition\u2460\u2463"},{"id":"ref-for-font-subset-definition\u2460\u2464"},{"id":"ref-for-font-subset-definition\u2460\u2465"},{"id":"ref-for-font-subset-definition\u2460\u2466"},{"id":"ref-for-font-subset-definition\u2460\u2467"},{"id":"ref-for-font-subset-definition\u2460\u2468"}],"title":"7.1. Encoding Considerations"}],"url":"#font-subset-definition"},
"format-1-patch-map": {"dfnID":"format-1-patch-map","dfnText":"Format 1 Patch Map","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map"}],"title":"5.3.1.1. Interpreting Format 1"},{"refs":[{"id":"ref-for-format-1-patch-map\u2460"}],"title":"5.3.1.2. Remove Entries from Format 1"}],"url":"#format-1-patch-map"},
"format-1-patch-map-appliedentriesbitmap": {"dfnID":"format-1-patch-map-appliedentriesbitmap","dfnText":"appliedEntriesBitMap","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-appliedentriesbitmap"},{"id":"ref-for-format-1-patch-map-appliedentriesbitmap\u2460"},{"id":"ref-for-format-1-patch-map-appliedentriesbitmap\u2461"}],"title":"5.3.1.1. Interpreting Format 1"},{"refs":[{"id":"ref-for-format-1-patch-map-appliedentriesbitmap\u2462"},{"id":"ref-for-format-1-patch-map-appliedentriesbitmap\u2463"}],"title":"5.3.1.2. Remove Entries from Format 1"}],"url":"#format-1-patch-map-appliedentriesbitmap"},
"format-1-patch-map-cff2charstringsoffset": {"dfnID":"format-1-patch-map-cff2charstringsoffset","dfnText":"cff2CharStringsOffset","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-cff2charstringsoffset"}],"title":"5.2. CFF and CFF2 Incremental Fonts"},{"refs":[{"id":"ref-for-format-1-patch-map-cff2charstringsoffset\u2460"}],"title":"5.3.1. Patch Map Table: Format 1"}],"url":"#format-1-patch-map-cff2charstringsoffset"},
"format-1-patch-map-cffcharstringsoffset": {"dfnID":"format-1-patch-map-cffcharstringsoffset","dfnText":"cffCharStringsOffset","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-cffcharstringsoffset"}],"title":"5.2. CFF and CFF2 Incremental Fonts"},{"refs":[{"id":"ref-for-format-1-patch-map-cffcharstringsoffset\u2460"}],"title":"5.3.1. Patch Map Table: Format 1"}],"url":"#format-1-patch-map-cffcharstringsoffset"},
"format-1-patch-map-compatibilityid": {"dfnID":"format-1-patch-map-compatibilityid","dfnText":"compatibilityId","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-compatibilityid"},{"id":"ref-for-format-1-patch-map-compatibilityid\u2460"}],"title":"5.3.1.1. Interpreting Format 1"}],"url":"#format-1-patch-map-compatibilityid"},
"format-1-patch-map-featuremapoffset": {"dfnID":"format-1-patch-map-featuremapoffset","dfnText":"featureMapOffset","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-featuremapoffset"}],"title":"5.3.1.1. Interpreting Format 1"}],"url":"#format-1-patch-map-featuremapoffset"},
"format-1-patch-map-flags": {"dfnID":"format-1-patch-map-flags","dfnText":"flags","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-flags"},{"id":"ref-for-format-1-patch-map-flags\u2460"}],"title":"5.3.1. Patch Map Table: Format 1"}],"url":"#format-1-patch-map-flags"},
"format-1-patch-map-format": {"dfnID":"format-1-patch-map-format","dfnText":"format","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-format"}],"title":"5.3.1.1. Interpreting Format 1"},{"refs":[{"id":"ref-for-format-1-patch-map-format\u2460"}],"title":"5.3.1.2. Remove Entries from Format 1"}],"url":"#format-1-patch-map-format"},
"format-1-patch-map-glyphcount": {"dfnID":"format-1-patch-map-glyphcount","dfnText":"glyphCount","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-glyphcount"},{"id":"ref-for-format-1-patch-map-glyphcount\u2460"}],"title":"5.3.1. Patch Map Table: Format 1"}],"url":"#format-1-patch-map-glyphcount"},
"format-1-patch-map-maxentryindex": {"dfnID":"format-1-patch-map-maxentryindex","dfnText":"maxEntryIndex","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-maxentryindex"},{"id":"ref-for-format-1-patch-map-maxentryindex\u2460"},{"id":"ref-for-format-1-patch-map-maxentryindex\u2461"},{"id":"ref-for-format-1-patch-map-maxentryindex\u2462"},{"id":"ref-for-format-1-patch-map-maxentryindex\u2463"}],"title":"5.3.1. Patch Map Table: Format 1"},{"refs":[{"id":"ref-for-format-1-patch-map-maxentryindex\u2464"},{"id":"ref-for-format-1-patch-map-maxentryindex\u2465"}],"title":"5.3.1.1. Interpreting Format 1"}],"url":"#format-1-patch-map-maxentryindex"},
"format-1-patch-map-maxglyphmapentryindex": {"dfnID":"format-1-patch-map-maxglyphmapentryindex","dfnText":"maxGlyphMapEntryIndex","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-maxglyphmapentryindex"},{"id":"ref-for-format-1-patch-map-maxglyphmapentryindex\u2460"},{"id":"ref-for-format-1-patch-map-maxglyphmapentryindex\u2461"}],"title":"5.3.1.1. Interpreting Format 1"}],"url":"#format-1-patch-map-maxglyphmapentryindex"},
"format-1-patch-map-patchformat": {"dfnID":"format-1-patch-map-patchformat","dfnText":"patchFormat","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-patchformat"},{"id":"ref-for-format-1-patch-map-patchformat\u2460"}],"title":"5.3.1.1. Interpreting Format 1"}],"url":"#format-1-patch-map-patchformat"},
"format-1-patch-map-urltemplate": {"dfnID":"format-1-patch-map-urltemplate","dfnText":"urlTemplate","external":false,"refSections":[{"refs":[{"id":"ref-for-format-1-patch-map-urltemplate"},{"id":"ref-for-format-1-patch-map-urltemplate\u2460"}],"title":"5.3.1.1. Interpreting Format 1"},{"refs":[{"id":"ref-for-format-1-patch-map-urltemplate\u2461"}],"title":"5.3.1.2. Remove Entries from Format 1"}],"url":"#format-1-patch-map-urltemplate"},
"format-2-patch-map": {"dfnID":"format-2-patch-map","dfnText":"Format 2 Patch Map","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map"}],"title":"5.3.2.1. Interpreting Format 2"},{"refs":[{"id":"ref-for-format-2-patch-map\u2460"}],"title":"5.3.2.2. Remove Entries from Format 2"},{"refs":[{"id":"ref-for-format-2-patch-map\u2461"}],"title":"5.3.2.3. Sparse Bit Set"}],"url":"#format-2-patch-map"},
"format-2-patch-map-cff2charstringsoffset": {"dfnID":"format-2-patch-map-cff2charstringsoffset","dfnText":"cff2CharStringsOffset","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map-cff2charstringsoffset"}],"title":"5.2. CFF and CFF2 Incremental Fonts"},{"refs":[{"id":"ref-for-format-2-patch-map-cff2charstringsoffset\u2460"}],"title":"5.3.2. Patch Map Table: Format 2"}],"url":"#format-2-patch-map-cff2charstringsoffset"},
"format-2-patch-map-cffcharstringsoffset": {"dfnID":"format-2-patch-map-cffcharstringsoffset","dfnText":"cffCharStringsOffset","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map-cffcharstringsoffset"}],"title":"5.2. CFF and CFF2 Incremental Fonts"},{"refs":[{"id":"ref-for-format-2-patch-map-cffcharstringsoffset\u2460"}],"title":"5.3.2. Patch Map Table: Format 2"}],"url":"#format-2-patch-map-cffcharstringsoffset"},
"format-2-patch-map-compatibilityid": {"dfnID":"format-2-patch-map-compatibilityid","dfnText":"compatibilityId","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map-compatibilityid"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#format-2-patch-map-compatibilityid"},
"format-2-patch-map-defaultpatchformat": {"dfnID":"format-2-patch-map-defaultpatchformat","dfnText":"defaultPatchFormat","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map-defaultpatchformat"}],"title":"5.3.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-format-2-patch-map-defaultpatchformat\u2460"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#format-2-patch-map-defaultpatchformat"},
"format-2-patch-map-entries": {"dfnID":"format-2-patch-map-entries","dfnText":"entries","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map-entries"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#format-2-patch-map-entries"},
"format-2-patch-map-entrycount": {"dfnID":"format-2-patch-map-entrycount","dfnText":"entryCount","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map-entrycount"}],"title":"5.3.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-format-2-patch-map-entrycount\u2460"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#format-2-patch-map-entrycount"},
"format-2-patch-map-entryidstringdata": {"dfnID":"format-2-patch-map-entryidstringdata","dfnText":"entryIdStringData","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map-entryidstringdata"},{"id":"ref-for-format-2-patch-map-entryidstringdata\u2460"},{"id":"ref-for-format-2-patch-map-entryidstringdata\u2461"},{"id":"ref-for-format-2-patch-map-entryidstringdata\u2462"},{"id":"ref-for-format-2-patch-map-entryidstringdata\u2463"}],"title":"5.3.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-format-2-patch-map-entryidstringdata\u2464"},{"id":"ref-for-format-2-patch-map-entryidstringdata\u2465"},{"id":"ref-for-format-2-patch-map-entryidstringdata\u2466"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#format-2-patch-map-entryidstringdata"},
"format-2-patch-map-flags": {"dfnID":"format-2-patch-map-flags","dfnText":"flags","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map-flags"},{"id":"ref-for-format-2-patch-map-flags\u2460"}],"title":"5.3.2. Patch Map Table: Format 2"}],"url":"#format-2-patch-map-flags"},
"format-2-patch-map-format": {"dfnID":"format-2-patch-map-format","dfnText":"format","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map-format"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#format-2-patch-map-format"},
"format-2-patch-map-urltemplate": {"dfnID":"format-2-patch-map-urltemplate","dfnText":"urlTemplate","external":false,"refSections":[{"refs":[{"id":"ref-for-format-2-patch-map-urltemplate"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#format-2-patch-map-urltemplate"},
"full-invalidation": {"dfnID":"full-invalidation","dfnText":"Full Invalidation","external":false,"refSections":[{"refs":[{"id":"ref-for-full-invalidation"}],"title":"4.3. Incremental Font Extension Algorithm"},{"refs":[{"id":"ref-for-full-invalidation\u2460"}],"title":"6.1. Formats Summary"}],"url":"#full-invalidation"},
"glyph-closure": {"dfnID":"glyph-closure","dfnText":"glyph closure","external":false,"refSections":[{"refs":[{"id":"ref-for-glyph-closure"}],"title":"7.1. Encoding Considerations"}],"url":"#glyph-closure"},
"glyph-keyed-patch": {"dfnID":"glyph-keyed-patch","dfnText":"Glyph keyed patch","external":false,"refSections":[{"refs":[{"id":"ref-for-glyph-keyed-patch"}],"title":"6.3.1. Applying Glyph Keyed Patches"}],"url":"#glyph-keyed-patch"},
"glyph-keyed-patch-brotlistream": {"dfnID":"glyph-keyed-patch-brotlistream","dfnText":"brotliStream","external":false,"refSections":[{"refs":[{"id":"ref-for-glyph-keyed-patch-brotlistream"}],"title":"6.3. Glyph Keyed"},{"refs":[{"id":"ref-for-glyph-keyed-patch-brotlistream\u2460"}],"title":"6.3.1. Applying Glyph Keyed Patches"}],"url":"#glyph-keyed-patch-brotlistream"},
"glyph-keyed-patch-compatibilityid": {"dfnID":"glyph-keyed-patch-compatibilityid","dfnText":"compatibilityId","external":false,"refSections":[{"refs":[{"id":"ref-for-glyph-keyed-patch-compatibilityid"},{"id":"ref-for-glyph-keyed-patch-compatibilityid\u2460"}],"title":"6.3.1. Applying Glyph Keyed Patches"}],"url":"#glyph-keyed-patch-compatibilityid"},
"glyph-keyed-patch-flags": {"dfnID":"glyph-keyed-patch-flags","dfnText":"flags","external":false,"refSections":[{"refs":[{"id":"ref-for-glyph-keyed-patch-flags"}],"title":"6.3. Glyph Keyed"}],"url":"#glyph-keyed-patch-flags"},
"glyph-keyed-patch-maxuncompressedlength": {"dfnID":"glyph-keyed-patch-maxuncompressedlength","dfnText":"maxUncompressedLength","external":false,"refSections":[{"refs":[{"id":"ref-for-glyph-keyed-patch-maxuncompressedlength"}],"title":"6.3.1. Applying Glyph Keyed Patches"}],"url":"#glyph-keyed-patch-maxuncompressedlength"},
"glyph-map": {"dfnID":"glyph-map","dfnText":"Glyph Map","external":false,"refSections":[{"refs":[{"id":"ref-for-glyph-map"},{"id":"ref-for-glyph-map\u2460"},{"id":"ref-for-glyph-map\u2461"}],"title":"5.3.1. Patch Map Table: Format 1"}],"url":"#glyph-map"},
"glyph-map-entryindex": {"dfnID":"glyph-map-entryindex","dfnText":"entryIndex","external":false,"refSections":[{"refs":[{"id":"ref-for-glyph-map-entryindex"}],"title":"5.3.1.1. Interpreting Format 1"},{"refs":[{"id":"ref-for-glyph-map-entryindex\u2460"}],"title":"5.3.1.2. Remove Entries from Format 1"}],"url":"#glyph-map-entryindex"},
"glyph-map-firstmappedglyph": {"dfnID":"glyph-map-firstmappedglyph","dfnText":"firstMappedGlyph","external":false,"refSections":[{"refs":[{"id":"ref-for-glyph-map-firstmappedglyph"}],"title":"5.3.1. Patch Map Table: Format 1"}],"url":"#glyph-map-firstmappedglyph"},
"glyphpatches": {"dfnID":"glyphpatches","dfnText":"GlyphPatches","external":false,"refSections":[{"refs":[{"id":"ref-for-glyphpatches"},{"id":"ref-for-glyphpatches\u2460"}],"title":"6.3. Glyph Keyed"},{"refs":[{"id":"ref-for-glyphpatches\u2461"}],"title":"6.3.1. Applying Glyph Keyed Patches"}],"url":"#glyphpatches"},
"glyphpatches-glyphcount": {"dfnID":"glyphpatches-glyphcount","dfnText":"glyphCount","external":false,"refSections":[{"refs":[{"id":"ref-for-glyphpatches-glyphcount"},{"id":"ref-for-glyphpatches-glyphcount\u2460"}],"title":"6.3. Glyph Keyed"}],"url":"#glyphpatches-glyphcount"},
"glyphpatches-glyphdata": {"dfnID":"glyphpatches-glyphdata","dfnText":"glyphData","external":false,"refSections":[{"refs":[{"id":"ref-for-glyphpatches-glyphdata"}],"title":"6.3.1. Applying Glyph Keyed Patches"}],"url":"#glyphpatches-glyphdata"},
"glyphpatches-glyphdataoffsets": {"dfnID":"glyphpatches-glyphdataoffsets","dfnText":"glyphDataOffsets","external":false,"refSections":[{"refs":[{"id":"ref-for-glyphpatches-glyphdataoffsets"}],"title":"6.3. Glyph Keyed"},{"refs":[{"id":"ref-for-glyphpatches-glyphdataoffsets\u2460"},{"id":"ref-for-glyphpatches-glyphdataoffsets\u2461"},{"id":"ref-for-glyphpatches-glyphdataoffsets\u2462"}],"title":"6.3.1. Applying Glyph Keyed Patches"}],"url":"#glyphpatches-glyphdataoffsets"},
"glyphpatches-glyphids": {"dfnID":"glyphpatches-glyphids","dfnText":"glyphIds","external":false,"refSections":[{"refs":[{"id":"ref-for-glyphpatches-glyphids"}],"title":"6.3. Glyph Keyed"},{"refs":[{"id":"ref-for-glyphpatches-glyphids\u2460"}],"title":"6.3.1. Applying Glyph Keyed Patches"}],"url":"#glyphpatches-glyphids"},
"glyphpatches-tables": {"dfnID":"glyphpatches-tables","dfnText":"tables","external":false,"refSections":[{"refs":[{"id":"ref-for-glyphpatches-tables"},{"id":"ref-for-glyphpatches-tables\u2460"}],"title":"6.3. Glyph Keyed"},{"refs":[{"id":"ref-for-glyphpatches-tables\u2461"}],"title":"6.3.1. Applying Glyph Keyed Patches"}],"url":"#glyphpatches-tables"},
"incremental-font": {"dfnID":"incremental-font","dfnText":"incremental font","external":false,"refSections":[{"refs":[{"id":"ref-for-incremental-font"}],"title":"1.2. Overview"},{"refs":[{"id":"ref-for-incremental-font\u2460"}],"title":"3.3. Patch Map"},{"refs":[{"id":"ref-for-incremental-font\u2461"}],"title":"4. Extending a Font Subset"},{"refs":[{"id":"ref-for-incremental-font\u2462"},{"id":"ref-for-incremental-font\u2463"},{"id":"ref-for-incremental-font\u2464"},{"id":"ref-for-incremental-font\u2465"}],"title":"4.3. Incremental Font Extension Algorithm"},{"refs":[{"id":"ref-for-incremental-font\u2466"}],"title":"4.7. Fully Expanding a Font"},{"refs":[{"id":"ref-for-incremental-font\u2467"}],"title":"5. Extensions to the Font Format"},{"refs":[{"id":"ref-for-incremental-font\u2468"},{"id":"ref-for-incremental-font\u2460\u24ea"},{"id":"ref-for-incremental-font\u2460\u2460"},{"id":"ref-for-incremental-font\u2460\u2461"},{"id":"ref-for-incremental-font\u2460\u2462"},{"id":"ref-for-incremental-font\u2460\u2463"},{"id":"ref-for-incremental-font\u2460\u2464"}],"title":"7. Encoding"},{"refs":[{"id":"ref-for-incremental-font\u2460\u2465"},{"id":"ref-for-incremental-font\u2460\u2466"},{"id":"ref-for-incremental-font\u2460\u2467"},{"id":"ref-for-incremental-font\u2460\u2468"},{"id":"ref-for-incremental-font\u2461\u24ea"}],"title":"7.1. Encoding Considerations"}],"url":"#incremental-font"},
"mapping-entries": {"dfnID":"mapping-entries","dfnText":"Mapping Entries","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entries"}],"title":"5.3.2. Patch Map Table: Format 2"}],"url":"#mapping-entries"},
"mapping-entries-entries": {"dfnID":"mapping-entries-entries","dfnText":"entries","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entries-entries"}],"title":"4.3. Incremental Font Extension Algorithm"},{"refs":[{"id":"ref-for-mapping-entries-entries\u2460"}],"title":"4.4. Selecting Invalidating Patches"},{"refs":[{"id":"ref-for-mapping-entries-entries\u2461"},{"id":"ref-for-mapping-entries-entries\u2462"}],"title":"5.3.2. Patch Map Table: Format 2"}],"url":"#mapping-entries-entries"},
"mapping-entry": {"dfnID":"mapping-entry","dfnText":"Mapping Entry","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry"},{"id":"ref-for-mapping-entry\u2460"}],"title":"5.3.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-mapping-entry\u2461"},{"id":"ref-for-mapping-entry\u2462"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#mapping-entry"},
"mapping-entry-bias": {"dfnID":"mapping-entry-bias","dfnText":"bias","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-bias"},{"id":"ref-for-mapping-entry-bias\u2460"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#mapping-entry-bias"},
"mapping-entry-childentryindices": {"dfnID":"mapping-entry-childentryindices","dfnText":"childEntryIndices","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-childentryindices"},{"id":"ref-for-mapping-entry-childentryindices\u2460"},{"id":"ref-for-mapping-entry-childentryindices\u2461"}],"title":"5.3.2.1. Interpreting Format 2"},{"refs":[{"id":"ref-for-mapping-entry-childentryindices\u2462"}],"title":"7.1. Encoding Considerations"}],"url":"#mapping-entry-childentryindices"},
"mapping-entry-childentrymatchmodeandcount": {"dfnID":"mapping-entry-childentrymatchmodeandcount","dfnText":"childEntryMatchModeAndCount","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-childentrymatchmodeandcount"},{"id":"ref-for-mapping-entry-childentrymatchmodeandcount\u2460"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#mapping-entry-childentrymatchmodeandcount"},
"mapping-entry-codepoints": {"dfnID":"mapping-entry-codepoints","dfnText":"codePoints","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-codepoints"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#mapping-entry-codepoints"},
"mapping-entry-designspacecount": {"dfnID":"mapping-entry-designspacecount","dfnText":"designSpaceCount","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-designspacecount"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#mapping-entry-designspacecount"},
"mapping-entry-designspacesegments": {"dfnID":"mapping-entry-designspacesegments","dfnText":"designSpaceSegments","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-designspacesegments"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#mapping-entry-designspacesegments"},
"mapping-entry-entryiddelta": {"dfnID":"mapping-entry-entryiddelta","dfnText":"entryIdDelta","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-entryiddelta"}],"title":"5.3.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-mapping-entry-entryiddelta\u2460"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#mapping-entry-entryiddelta"},
"mapping-entry-entryidstringlength": {"dfnID":"mapping-entry-entryidstringlength","dfnText":"entryIdStringLength","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-entryidstringlength"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#mapping-entry-entryidstringlength"},
"mapping-entry-featurecount": {"dfnID":"mapping-entry-featurecount","dfnText":"featureCount","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-featurecount"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#mapping-entry-featurecount"},
"mapping-entry-featuretags": {"dfnID":"mapping-entry-featuretags","dfnText":"featureTags","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-featuretags"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#mapping-entry-featuretags"},
"mapping-entry-formatflags": {"dfnID":"mapping-entry-formatflags","dfnText":"formatFlags","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-formatflags"},{"id":"ref-for-mapping-entry-formatflags\u2460"},{"id":"ref-for-mapping-entry-formatflags\u2461"},{"id":"ref-for-mapping-entry-formatflags\u2462"},{"id":"ref-for-mapping-entry-formatflags\u2463"},{"id":"ref-for-mapping-entry-formatflags\u2464"},{"id":"ref-for-mapping-entry-formatflags\u2465"},{"id":"ref-for-mapping-entry-formatflags\u2466"},{"id":"ref-for-mapping-entry-formatflags\u2467"},{"id":"ref-for-mapping-entry-formatflags\u2468"}],"title":"5.3.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-mapping-entry-formatflags\u2460\u24ea"},{"id":"ref-for-mapping-entry-formatflags\u2460\u2460"},{"id":"ref-for-mapping-entry-formatflags\u2460\u2461"},{"id":"ref-for-mapping-entry-formatflags\u2460\u2462"},{"id":"ref-for-mapping-entry-formatflags\u2460\u2463"},{"id":"ref-for-mapping-entry-formatflags\u2460\u2464"},{"id":"ref-for-mapping-entry-formatflags\u2460\u2465"},{"id":"ref-for-mapping-entry-formatflags\u2460\u2466"},{"id":"ref-for-mapping-entry-formatflags\u2460\u2467"},{"id":"ref-for-mapping-entry-formatflags\u2460\u2468"}],"title":"5.3.2.1. Interpreting Format 2"},{"refs":[{"id":"ref-for-mapping-entry-formatflags\u2461\u24ea"}],"title":"5.3.2.2. Remove Entries from Format 2"}],"url":"#mapping-entry-formatflags"},
"mapping-entry-patchformat": {"dfnID":"mapping-entry-patchformat","dfnText":"patchFormat","external":false,"refSections":[{"refs":[{"id":"ref-for-mapping-entry-patchformat"},{"id":"ref-for-mapping-entry-patchformat\u2460"}],"title":"5.3.2.1. Interpreting Format 2"}],"url":"#mapping-entry-patchformat"},
"no-invalidation": {"dfnID":"no-invalidation","dfnText":"No Invalidation","external":false,"refSections":[{"refs":[{"id":"ref-for-no-invalidation"}],"title":"6.1. Formats Summary"},{"refs":[{"id":"ref-for-no-invalidation\u2460"}],"title":"7.1. Encoding Considerations"}],"url":"#no-invalidation"},
"partial-invalidation": {"dfnID":"partial-invalidation","dfnText":"Partial Invalidation","external":false,"refSections":[{"refs":[{"id":"ref-for-partial-invalidation"}],"title":"4.3. Incremental Font Extension Algorithm"},{"refs":[{"id":"ref-for-partial-invalidation\u2460"}],"title":"6.1. Formats Summary"},{"refs":[{"id":"ref-for-partial-invalidation\u2461"},{"id":"ref-for-partial-invalidation\u2462"},{"id":"ref-for-partial-invalidation\u2463"}],"title":"7.1. Encoding Considerations"}],"url":"#partial-invalidation"},
"patch-application-algorithm": {"dfnID":"patch-application-algorithm","dfnText":"patch application algorithm","external":false,"refSections":[{"refs":[{"id":"ref-for-patch-application-algorithm"}],"title":"6.2.1. Applying Table Keyed Patches"},{"refs":[{"id":"ref-for-patch-application-algorithm\u2460"}],"title":"6.3.1. Applying Glyph Keyed Patches"}],"url":"#patch-application-algorithm"},
"patch-format": {"dfnID":"patch-format","dfnText":"patch format","external":false,"refSections":[{"refs":[{"id":"ref-for-patch-format"},{"id":"ref-for-patch-format\u2460"}],"title":"3.2. Font Patch"}],"url":"#patch-format"},
"patch-map": {"dfnID":"patch-map","dfnText":"patch map","external":false,"refSections":[{"refs":[{"id":"ref-for-patch-map"}],"title":"3.3. Patch Map"},{"refs":[{"id":"ref-for-patch-map\u2460"},{"id":"ref-for-patch-map\u2461"}],"title":"4.3. Incremental Font Extension Algorithm"},{"refs":[{"id":"ref-for-patch-map\u2462"},{"id":"ref-for-patch-map\u2463"}],"title":"4.4. Selecting Invalidating Patches"},{"refs":[{"id":"ref-for-patch-map\u2464"}],"title":"5. Extensions to the Font Format"},{"refs":[{"id":"ref-for-patch-map\u2465"}],"title":"5.2. CFF and CFF2 Incremental Fonts"},{"refs":[{"id":"ref-for-patch-map\u2466"}],"title":"5.3. Patch Map Table"},{"refs":[{"id":"ref-for-patch-map\u2467"},{"id":"ref-for-patch-map\u2468"}],"title":"5.3.2.1. Interpreting Format 2"},{"refs":[{"id":"ref-for-patch-map\u2460\u24ea"}],"title":"7. Encoding"}],"url":"#patch-map"},
"patch-map-entries": {"dfnID":"patch-map-entries","dfnText":"patch map entries","external":false,"refSections":[{"refs":[{"id":"ref-for-patch-map-entries"},{"id":"ref-for-patch-map-entries\u2460"}],"title":"3.3. Patch Map"},{"refs":[{"id":"ref-for-patch-map-entries\u2461"}],"title":"4.3. Incremental Font Extension Algorithm"},{"refs":[{"id":"ref-for-patch-map-entries\u2462"},{"id":"ref-for-patch-map-entries\u2463"},{"id":"ref-for-patch-map-entries\u2464"},{"id":"ref-for-patch-map-entries\u2465"},{"id":"ref-for-patch-map-entries\u2466"}],"title":"5.3.1.1. Interpreting Format 1"},{"refs":[{"id":"ref-for-patch-map-entries\u2467"},{"id":"ref-for-patch-map-entries\u2468"},{"id":"ref-for-patch-map-entries\u2460\u24ea"}],"title":"5.3.2.1. Interpreting Format 2"},{"refs":[{"id":"ref-for-patch-map-entries\u2460\u2460"}],"title":"7. Encoding"}],"url":"#patch-map-entries"},
"sparse-bit-set": {"dfnID":"sparse-bit-set","dfnText":"Sparse Bit Set","external":false,"refSections":[{"refs":[{"id":"ref-for-sparse-bit-set"}],"title":"5.3.2. Patch Map Table: Format 2"},{"refs":[{"id":"ref-for-sparse-bit-set\u2460"}],"title":"5.3.2.3. Sparse Bit Set"}],"url":"#sparse-bit-set"},
"table-keyed-patch": {"dfnID":"table-keyed-patch","dfnText":"Table keyed patch","external":false,"refSections":[{"refs":[{"id":"ref-for-table-keyed-patch"}],"title":"6.2.1. Applying Table Keyed Patches"}],"url":"#table-keyed-patch"},
"table-keyed-patch-compatibilityid": {"dfnID":"table-keyed-patch-compatibilityid","dfnText":"compatibilityId","external":false,"refSections":[{"refs":[{"id":"ref-for-table-keyed-patch-compatibilityid"}],"title":"6.2.1. Applying Table Keyed Patches"}],"url":"#table-keyed-patch-compatibilityid"},
"table-keyed-patch-patches": {"dfnID":"table-keyed-patch-patches","dfnText":"patches","external":false,"refSections":[{"refs":[{"id":"ref-for-table-keyed-patch-patches"}],"title":"6.2. Table Keyed"},{"refs":[{"id":"ref-for-table-keyed-patch-patches\u2460"},{"id":"ref-for-table-keyed-patch-patches\u2461"},{"id":"ref-for-table-keyed-patch-patches\u2462"},{"id":"ref-for-table-keyed-patch-patches\u2463"},{"id":"ref-for-table-keyed-patch-patches\u2464"}],"title":"6.2.1. Applying Table Keyed Patches"}],"url":"#table-keyed-patch-patches"},
"tablepatch": {"dfnID":"tablepatch","dfnText":"TablePatch","external":false,"refSections":[{"refs":[{"id":"ref-for-tablepatch"},{"id":"ref-for-tablepatch\u2460"}],"title":"6.2. Table Keyed"},{"refs":[{"id":"ref-for-tablepatch\u2461"},{"id":"ref-for-tablepatch\u2462"}],"title":"6.2.1. Applying Table Keyed Patches"}],"url":"#tablepatch"},
"tablepatch-brotlistream": {"dfnID":"tablepatch-brotlistream","dfnText":"brotliStream","external":false,"refSections":[{"refs":[{"id":"ref-for-tablepatch-brotlistream"}],"title":"6.2. Table Keyed"},{"refs":[{"id":"ref-for-tablepatch-brotlistream\u2460"},{"id":"ref-for-tablepatch-brotlistream\u2461"},{"id":"ref-for-tablepatch-brotlistream\u2462"},{"id":"ref-for-tablepatch-brotlistream\u2463"},{"id":"ref-for-tablepatch-brotlistream\u2464"},{"id":"ref-for-tablepatch-brotlistream\u2465"}],"title":"6.2.1. Applying Table Keyed Patches"}],"url":"#tablepatch-brotlistream"},
"tablepatch-flags": {"dfnID":"tablepatch-flags","dfnText":"flags","external":false,"refSections":[{"refs":[{"id":"ref-for-tablepatch-flags"},{"id":"ref-for-tablepatch-flags\u2460"}],"title":"6.2.1. Applying Table Keyed Patches"}],"url":"#tablepatch-flags"},
"tablepatch-maxuncompressedlength": {"dfnID":"tablepatch-maxuncompressedlength","dfnText":"maxUncompressedLength","external":false,"refSections":[{"refs":[{"id":"ref-for-tablepatch-maxuncompressedlength"},{"id":"ref-for-tablepatch-maxuncompressedlength\u2460"}],"title":"6.2.1. Applying Table Keyed Patches"}],"url":"#tablepatch-maxuncompressedlength"},
"tablepatch-tag": {"dfnID":"tablepatch-tag","dfnText":"tag","external":false,"refSections":[{"refs":[{"id":"ref-for-tablepatch-tag"},{"id":"ref-for-tablepatch-tag\u2460"},{"id":"ref-for-tablepatch-tag\u2461"},{"id":"ref-for-tablepatch-tag\u2462"},{"id":"ref-for-tablepatch-tag\u2463"}],"title":"6.2.1. Applying Table Keyed Patches"}],"url":"#tablepatch-tag"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#abstract-opdef-check-entry-intersection": {"displayText":"Check entry intersection","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Check entry intersection","type":"abstract-op","url":"#abstract-opdef-check-entry-intersection"},
"#abstract-opdef-expand-url-template": {"displayText":"Expand URL Template","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Expand URL Template","type":"abstract-op","url":"#abstract-opdef-expand-url-template"},
"#abstract-opdef-extend-an-incremental-font-subset": {"displayText":"Extend an Incremental Font Subset","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Extend an Incremental Font Subset","type":"abstract-op","url":"#abstract-opdef-extend-an-incremental-font-subset"},
"#abstract-opdef-fully-expand-a-font-subset": {"displayText":"Fully Expand a Font Subset","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Fully Expand a Font Subset","type":"abstract-op","url":"#abstract-opdef-fully-expand-a-font-subset"},
"#abstract-opdef-handle-errors": {"displayText":"Handle errors","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Handle errors","type":"abstract-op","url":"#abstract-opdef-handle-errors"},
"#abstract-opdef-interpret-format-1-patch-map": {"displayText":"Interpret Format 1 Patch Map","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Interpret Format 1 Patch Map","type":"abstract-op","url":"#abstract-opdef-interpret-format-1-patch-map"},
"#abstract-opdef-interpret-format-2-patch-map": {"displayText":"Interpret Format 2 Patch Map","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Interpret Format 2 Patch Map","type":"abstract-op","url":"#abstract-opdef-interpret-format-2-patch-map"},
"#abstract-opdef-interpret-format-2-patch-map-entry": {"displayText":"Interpret Format 2 Patch Map Entry","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Interpret Format 2 Patch Map Entry","type":"abstract-op","url":"#abstract-opdef-interpret-format-2-patch-map-entry"},
"#abstract-opdef-load-patch-file": {"displayText":"Load patch file","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Load patch file","type":"abstract-op","url":"#abstract-opdef-load-patch-file"},
"#abstract-opdef-remove-entries-from-format-1-patch-map": {"displayText":"Remove Entries from Format 1 Patch Map","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Remove Entries from Format 1 Patch Map","type":"abstract-op","url":"#abstract-opdef-remove-entries-from-format-1-patch-map"},
"#abstract-opdef-remove-entries-from-format-2-patch-map": {"displayText":"Remove Entries from Format 2 Patch Map","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"Remove Entries from Format 2 Patch Map","type":"abstract-op","url":"#abstract-opdef-remove-entries-from-format-2-patch-map"},
"#branch-factor-encoding": {"displayText":"branch factor encoding","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"branch factor encoding","type":"dfn","url":"#branch-factor-encoding"},
"#design-space-segment": {"displayText":"design space segment","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"design space segment","type":"dfn","url":"#design-space-segment"},
"#design-space-segment-end": {"displayText":"end","export":true,"for_":["Design Space Segment"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"end","type":"dfn","url":"#design-space-segment-end"},
"#design-space-segment-start": {"displayText":"start","export":true,"for_":["Design Space Segment"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"start","type":"dfn","url":"#design-space-segment-start"},
"#design-space-segment-tag": {"displayText":"tag","export":true,"for_":["Design Space Segment"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"tag","type":"dfn","url":"#design-space-segment-tag"},
"#entrymaprecord": {"displayText":"entrymaprecord","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entrymaprecord","type":"dfn","url":"#entrymaprecord"},
"#entrymaprecord-firstentryindex": {"displayText":"firstentryindex","export":true,"for_":["EntryMapRecord"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"firstentryindex","type":"dfn","url":"#entrymaprecord-firstentryindex"},
"#entrymaprecord-lastentryindex": {"displayText":"lastentryindex","export":true,"for_":["EntryMapRecord"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"lastentryindex","type":"dfn","url":"#entrymaprecord-lastentryindex"},
"#feature-map": {"displayText":"feature map","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"feature map","type":"dfn","url":"#feature-map"},
"#feature-map-entrymaprecords": {"displayText":"entrymaprecords","export":true,"for_":["Feature Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entrymaprecords","type":"dfn","url":"#feature-map-entrymaprecords"},
"#feature-map-featurerecords": {"displayText":"featurerecords","export":true,"for_":["Feature Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"featurerecords","type":"dfn","url":"#feature-map-featurerecords"},
"#featurerecord": {"displayText":"featurerecord","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"featurerecord","type":"dfn","url":"#featurerecord"},
"#featurerecord-entrymapcount": {"displayText":"entrymapcount","export":true,"for_":["FeatureRecord"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entrymapcount","type":"dfn","url":"#featurerecord-entrymapcount"},
"#featurerecord-featuretag": {"displayText":"featuretag","export":true,"for_":["FeatureRecord"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"featuretag","type":"dfn","url":"#featurerecord-featuretag"},
"#featurerecord-firstnewentryindex": {"displayText":"firstnewentryindex","export":true,"for_":["FeatureRecord"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"firstnewentryindex","type":"dfn","url":"#featurerecord-firstnewentryindex"},
"#font-patch": {"displayText":"font patch","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"font patch","type":"dfn","url":"#font-patch"},
"#font-subset": {"displayText":"font subset","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"font subset","type":"dfn","url":"#font-subset"},
"#font-subset-definition": {"displayText":"font subset definition","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"font subset definition","type":"dfn","url":"#font-subset-definition"},
"#format-1-patch-map": {"displayText":"format 1 patch map","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"format 1 patch map","type":"dfn","url":"#format-1-patch-map"},
"#format-1-patch-map-appliedentriesbitmap": {"displayText":"appliedentriesbitmap","export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"appliedentriesbitmap","type":"dfn","url":"#format-1-patch-map-appliedentriesbitmap"},
"#format-1-patch-map-cff2charstringsoffset": {"displayText":"cff2charstringsoffset","export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"cff2charstringsoffset","type":"dfn","url":"#format-1-patch-map-cff2charstringsoffset"},
"#format-1-patch-map-cffcharstringsoffset": {"displayText":"cffcharstringsoffset","export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"cffcharstringsoffset","type":"dfn","url":"#format-1-patch-map-cffcharstringsoffset"},
"#format-1-patch-map-compatibilityid": {"displayText":"compatibilityid","export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"compatibilityid","type":"dfn","url":"#format-1-patch-map-compatibilityid"},
"#format-1-patch-map-featuremapoffset": {"displayText":"featuremapoffset","export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"featuremapoffset","type":"dfn","url":"#format-1-patch-map-featuremapoffset"},
"#format-1-patch-map-flags": {"displayText":"flags","export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"flags","type":"dfn","url":"#format-1-patch-map-flags"},
"#format-1-patch-map-format": {"displayText":"format","export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"format","type":"dfn","url":"#format-1-patch-map-format"},
"#format-1-patch-map-glyphcount": {"displayText":"glyphcount","export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"glyphcount","type":"dfn","url":"#format-1-patch-map-glyphcount"},
"#format-1-patch-map-maxentryindex": {"displayText":"maxentryindex","export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"maxentryindex","type":"dfn","url":"#format-1-patch-map-maxentryindex"},
"#format-1-patch-map-maxglyphmapentryindex": {"displayText":"maxglyphmapentryindex","export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"maxglyphmapentryindex","type":"dfn","url":"#format-1-patch-map-maxglyphmapentryindex"},
"#format-1-patch-map-patchformat": {"displayText":"patchformat","export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"patchformat","type":"dfn","url":"#format-1-patch-map-patchformat"},
"#format-1-patch-map-urltemplate": {"displayText":"urltemplate","export":true,"for_":["Format 1 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"urltemplate","type":"dfn","url":"#format-1-patch-map-urltemplate"},
"#format-2-patch-map": {"displayText":"format 2 patch map","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"format 2 patch map","type":"dfn","url":"#format-2-patch-map"},
"#format-2-patch-map-cff2charstringsoffset": {"displayText":"cff2charstringsoffset","export":true,"for_":["Format 2 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"cff2charstringsoffset","type":"dfn","url":"#format-2-patch-map-cff2charstringsoffset"},
"#format-2-patch-map-cffcharstringsoffset": {"displayText":"cffcharstringsoffset","export":true,"for_":["Format 2 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"cffcharstringsoffset","type":"dfn","url":"#format-2-patch-map-cffcharstringsoffset"},
"#format-2-patch-map-compatibilityid": {"displayText":"compatibilityid","export":true,"for_":["Format 2 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"compatibilityid","type":"dfn","url":"#format-2-patch-map-compatibilityid"},
"#format-2-patch-map-defaultpatchformat": {"displayText":"defaultpatchformat","export":true,"for_":["Format 2 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"defaultpatchformat","type":"dfn","url":"#format-2-patch-map-defaultpatchformat"},
"#format-2-patch-map-entries": {"displayText":"entries","export":true,"for_":["Format 2 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entries","type":"dfn","url":"#format-2-patch-map-entries"},
"#format-2-patch-map-entrycount": {"displayText":"entrycount","export":true,"for_":["Format 2 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entrycount","type":"dfn","url":"#format-2-patch-map-entrycount"},
"#format-2-patch-map-entryidstringdata": {"displayText":"entryidstringdata","export":true,"for_":["Format 2 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entryidstringdata","type":"dfn","url":"#format-2-patch-map-entryidstringdata"},
"#format-2-patch-map-flags": {"displayText":"flags","export":true,"for_":["Format 2 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"flags","type":"dfn","url":"#format-2-patch-map-flags"},
"#format-2-patch-map-format": {"displayText":"format","export":true,"for_":["Format 2 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"format","type":"dfn","url":"#format-2-patch-map-format"},
"#format-2-patch-map-urltemplate": {"displayText":"urltemplate","export":true,"for_":["Format 2 Patch Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"urltemplate","type":"dfn","url":"#format-2-patch-map-urltemplate"},
"#full-invalidation": {"displayText":"full invalidation","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"full invalidation","type":"dfn","url":"#full-invalidation"},
"#glyph-closure": {"displayText":"glyph closure","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"glyph closure","type":"dfn","url":"#glyph-closure"},
"#glyph-keyed-patch": {"displayText":"glyph keyed patch","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"glyph keyed patch","type":"dfn","url":"#glyph-keyed-patch"},
"#glyph-keyed-patch-brotlistream": {"displayText":"brotlistream","export":true,"for_":["Glyph keyed patch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"brotlistream","type":"dfn","url":"#glyph-keyed-patch-brotlistream"},
"#glyph-keyed-patch-compatibilityid": {"displayText":"compatibilityid","export":true,"for_":["Glyph keyed patch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"compatibilityid","type":"dfn","url":"#glyph-keyed-patch-compatibilityid"},
"#glyph-keyed-patch-flags": {"displayText":"flags","export":true,"for_":["Glyph keyed patch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"flags","type":"dfn","url":"#glyph-keyed-patch-flags"},
"#glyph-keyed-patch-maxuncompressedlength": {"displayText":"maxuncompressedlength","export":true,"for_":["Glyph keyed patch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"maxuncompressedlength","type":"dfn","url":"#glyph-keyed-patch-maxuncompressedlength"},
"#glyph-map": {"displayText":"glyph map","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"glyph map","type":"dfn","url":"#glyph-map"},
"#glyph-map-entryindex": {"displayText":"entryindex","export":true,"for_":["Glyph Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entryindex","type":"dfn","url":"#glyph-map-entryindex"},
"#glyph-map-firstmappedglyph": {"displayText":"firstmappedglyph","export":true,"for_":["Glyph Map"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"firstmappedglyph","type":"dfn","url":"#glyph-map-firstmappedglyph"},
"#glyphpatches": {"displayText":"glyphpatches","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"glyphpatches","type":"dfn","url":"#glyphpatches"},
"#glyphpatches-glyphcount": {"displayText":"glyphcount","export":true,"for_":["GlyphPatches"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"glyphcount","type":"dfn","url":"#glyphpatches-glyphcount"},
"#glyphpatches-glyphdata": {"displayText":"glyphdata","export":true,"for_":["GlyphPatches"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"glyphdata","type":"dfn","url":"#glyphpatches-glyphdata"},
"#glyphpatches-glyphdataoffsets": {"displayText":"glyphdataoffsets","export":true,"for_":["GlyphPatches"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"glyphdataoffsets","type":"dfn","url":"#glyphpatches-glyphdataoffsets"},
"#glyphpatches-glyphids": {"displayText":"glyphids","export":true,"for_":["GlyphPatches"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"glyphids","type":"dfn","url":"#glyphpatches-glyphids"},
"#glyphpatches-tables": {"displayText":"tables","export":true,"for_":["GlyphPatches"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"tables","type":"dfn","url":"#glyphpatches-tables"},
"#incremental-font": {"displayText":"incremental font","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"incremental font","type":"dfn","url":"#incremental-font"},
"#mapping-entries": {"displayText":"mapping entries","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"mapping entries","type":"dfn","url":"#mapping-entries"},
"#mapping-entries-entries": {"displayText":"entries","export":true,"for_":["Mapping Entries"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entries","type":"dfn","url":"#mapping-entries-entries"},
"#mapping-entry": {"displayText":"mapping entry","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"mapping entry","type":"dfn","url":"#mapping-entry"},
"#mapping-entry-bias": {"displayText":"bias","export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"bias","type":"dfn","url":"#mapping-entry-bias"},
"#mapping-entry-childentryindices": {"displayText":"childentryindices","export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"childentryindices","type":"dfn","url":"#mapping-entry-childentryindices"},
"#mapping-entry-childentrymatchmodeandcount": {"displayText":"childentrymatchmodeandcount","export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"childentrymatchmodeandcount","type":"dfn","url":"#mapping-entry-childentrymatchmodeandcount"},
"#mapping-entry-codepoints": {"displayText":"codepoints","export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"codepoints","type":"dfn","url":"#mapping-entry-codepoints"},
"#mapping-entry-designspacecount": {"displayText":"designspacecount","export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"designspacecount","type":"dfn","url":"#mapping-entry-designspacecount"},
"#mapping-entry-designspacesegments": {"displayText":"designspacesegments","export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"designspacesegments","type":"dfn","url":"#mapping-entry-designspacesegments"},
"#mapping-entry-entryiddelta": {"displayText":"entryiddelta","export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entryiddelta","type":"dfn","url":"#mapping-entry-entryiddelta"},
"#mapping-entry-entryidstringlength": {"displayText":"entryidstringlength","export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"entryidstringlength","type":"dfn","url":"#mapping-entry-entryidstringlength"},
"#mapping-entry-featurecount": {"displayText":"featurecount","export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"featurecount","type":"dfn","url":"#mapping-entry-featurecount"},
"#mapping-entry-featuretags": {"displayText":"featuretags","export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"featuretags","type":"dfn","url":"#mapping-entry-featuretags"},
"#mapping-entry-formatflags": {"displayText":"formatflags","export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"formatflags","type":"dfn","url":"#mapping-entry-formatflags"},
"#mapping-entry-patchformat": {"displayText":"patchformat","export":true,"for_":["Mapping Entry"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"patchformat","type":"dfn","url":"#mapping-entry-patchformat"},
"#no-invalidation": {"displayText":"no invalidation","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"no invalidation","type":"dfn","url":"#no-invalidation"},
"#partial-invalidation": {"displayText":"partial invalidation","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"partial invalidation","type":"dfn","url":"#partial-invalidation"},
"#patch-application-algorithm": {"displayText":"patch application algorithm","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"patch application algorithm","type":"dfn","url":"#patch-application-algorithm"},
"#patch-format": {"displayText":"patch format","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"patch format","type":"dfn","url":"#patch-format"},
"#patch-map": {"displayText":"patch map","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"patch map","type":"dfn","url":"#patch-map"},
"#patch-map-entries": {"displayText":"patch map entries","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"patch map entries","type":"dfn","url":"#patch-map-entries"},
"#sparse-bit-set": {"displayText":"sparse bit set","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"sparse bit set","type":"dfn","url":"#sparse-bit-set"},
"#table-keyed-patch": {"displayText":"table keyed patch","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"table keyed patch","type":"dfn","url":"#table-keyed-patch"},
"#table-keyed-patch-compatibilityid": {"displayText":"compatibilityid","export":true,"for_":["Table keyed patch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"compatibilityid","type":"dfn","url":"#table-keyed-patch-compatibilityid"},
"#table-keyed-patch-patches": {"displayText":"patches","export":true,"for_":["Table keyed patch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"patches","type":"dfn","url":"#table-keyed-patch-patches"},
"#tablepatch": {"displayText":"tablepatch","export":true,"for_":[],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"tablepatch","type":"dfn","url":"#tablepatch"},
"#tablepatch-brotlistream": {"displayText":"brotlistream","export":true,"for_":["TablePatch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"brotlistream","type":"dfn","url":"#tablepatch-brotlistream"},
"#tablepatch-flags": {"displayText":"flags","export":true,"for_":["TablePatch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"flags","type":"dfn","url":"#tablepatch-flags"},
"#tablepatch-maxuncompressedlength": {"displayText":"maxuncompressedlength","export":true,"for_":["TablePatch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"maxuncompressedlength","type":"dfn","url":"#tablepatch-maxuncompressedlength"},
"#tablepatch-tag": {"displayText":"tag","export":true,"for_":["TablePatch"],"level":"","normative":true,"shortname":"ift","spec":"ift","status":"local","text":"tag","type":"dfn","url":"#tablepatch-tag"},
"https://fetch.spec.whatwg.org/#concept-fetch": {"displayText":"fetch","export":true,"for_":[],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"fetch","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-fetch"},
"https://fetch.spec.whatwg.org/#concept-request": {"displayText":"request","export":true,"for_":[],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"request","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request"},
"https://fetch.spec.whatwg.org/#concept-request-client": {"displayText":"client","export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"client","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-client"},
"https://fetch.spec.whatwg.org/#concept-request-destination": {"displayText":"destination","export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"destination","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-destination"},
"https://fetch.spec.whatwg.org/#concept-request-method": {"displayText":"method","export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"method","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-method"},
"https://fetch.spec.whatwg.org/#concept-request-mode": {"displayText":"mode","export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"mode","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-mode"},
"https://fetch.spec.whatwg.org/#concept-request-referrer": {"displayText":"referrer","export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"referrer","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-referrer"},
"https://fetch.spec.whatwg.org/#concept-request-url": {"displayText":"URL","export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"url","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-url"},
"https://fetch.spec.whatwg.org/#process-response-end-of-body": {"displayText":"processResponseConsumeBody","export":true,"for_":["fetch"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"processresponseconsumebody","type":"dfn","url":"https://fetch.spec.whatwg.org/#process-response-end-of-body"},
"https://fetch.spec.whatwg.org/#request-initiator-type": {"displayText":"initiator type","export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"initiator type","type":"dfn","url":"https://fetch.spec.whatwg.org/#request-initiator-type"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.displayText.toLowerCase() != linkText.toLowerCase()) {
        // Give the original term if it's being displayed in a different way.
        // But allow casing differences, they're insignificant.
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.displayText)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const refHintKey = link.getAttribute("data-refhint-key");
    let key = url;
    if(refHintKey) {
        key = refHintKey + "_" + url;
    }
    const ref = refsData[key];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>
<script>/* Boilerplate: script-var-click-highlighting */
"use strict";
{
/*
Color-choosing design:

* Colors are ordered by goodness.
* On clicking a var, give it the earliest color
    with the lowest usage in the algorithm.
* On re-clicking, re-use the var's most recent color
    if that's not currently being used elsewhere.
*/

const COLOR_COUNT = 7;

document.addEventListener("click", e=>{
    if(e.target.nodeName == "VAR") {
        highlightSameAlgoVars(e.target);
    }
});

function highlightSameAlgoVars(v) {
    // Find the algorithm container.
    let algoContainer = findAlgoContainer(v);

    // Not highlighting document-global vars,
    // too likely to be unrelated.
    if(algoContainer == null) return;

    const varName = nameFromVar(v);
    if(!v.hasAttribute("data-var-color")) {
        const newColor = chooseHighlightColor(algoContainer, v);
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.setAttribute("data-var-color", newColor);
                el.setAttribute("data-var-last-color", newColor);
            }
        }
    } else {
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.removeAttribute("data-var-color");
            }
        }
    }
}
function findAlgoContainer(el) {
    while(el != document.body) {
        if(el.hasAttribute("data-algorithm")) return el;
        el = el.parentNode;
    }
    return null;
}
function nameFromVar(el) {
    return el.textContent.replace(/(\s|\xa0)+/g, " ").trim();
}
function colorCountsFromContainer(container) {
    const namesFromColor = Array.from({length:COLOR_COUNT}, x=>new Set());
    for(let v of container.querySelectorAll("var[data-var-color]")) {
        let color = +v.getAttribute("data-var-color");
        namesFromColor[color].add(nameFromVar(v));
    }

    return namesFromColor.map(x=>x.size);
}
function leastUsedColor(colors) {
    // Find the earliest color with the lowest count.
    let minCount = Infinity;
    let minColor = null;
    for(var i = 0; i < colors.length; i++) {
        if(colors[i] < minCount) {
            minColor = i;
            minCount = colors[i];
        }
    }
    return minColor;
}
function chooseHighlightColor(container, v) {
    const colorCounts = colorCountsFromContainer(container);
    if(v.hasAttribute("data-var-last-color")) {
        let color = +v.getAttribute("data-var-last-color");
        if(colorCounts[color] == 0) return color;
    }
    return leastUsedColor(colorCounts);
}
}
</script>